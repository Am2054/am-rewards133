 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>إنشاء حساب | Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #FFD369;
      --accent-2: #34d399;
      --card-bg: rgba(12, 18, 40, 0.82);
      --glass-bg: rgba(255, 255, 255, 0.10);
      --glass-border: rgba(255, 255, 255, 0.17);
      --muted: #b8c2cf;
      --error: #ff6b6b;
      --success: #4ade80;
      --radius: 22px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Cairo", sans-serif; color: #f1f6fb; min-height: 100vh; margin: 0;
      background: linear-gradient(120deg, #0f2027 0%, #2c5364 100%), url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1500&q=80');
      background-size: cover; background-attachment: fixed; background-blend-mode: overlay;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .center-wrap { width: 100%; max-width: 1100px; display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; z-index: 2; background: rgba(0,0,0,0.2); border-radius: var(--radius); backdrop-filter: blur(10px); overflow: hidden; border: 1px solid var(--glass-border); }
    .hero { padding: 40px; display: flex; flex-direction: column; justify-content: center; background: var(--card-bg); }
    .hero h2 { font-size: 32px; color: var(--accent); margin-bottom: 15px; }
    .signup-card { padding: 40px; background: var(--glass-bg); display: flex; flex-direction: column; }
    label { font-size: 14px; color: var(--muted); margin-top: 10px; }
    input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(30, 41, 59, 0.5); color: #fff; outline: none; transition: 0.3s; margin-top: 5px; }
    input:focus { border-color: var(--accent-2); background: rgba(30, 41, 59, 0.8); }
    .btn-primary { margin-top: 25px; width: 100%; padding: 15px; border-radius: 12px; border: 0; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #000; font-weight: 900; cursor: pointer; transition: 0.3s; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    .status { margin-top: 15px; text-align: center; font-weight: bold; min-height: 24px; font-size: 15px; }
    .status.error { color: var(--error); }
    .status.success { color: var(--success); }
    @media (max-width: 900px) { .center-wrap { grid-template-columns: 1fr; } .hero { display: none; } }
  </style>
</head>
<body>

  <div class="center-wrap">
    <div class="hero">
      <h2>Am Rewards</h2>
      <p>انضم إلينا الآن وابدأ بجمع النقاط وتحويلها لأرباح حقيقية. نظامنا يضمن لك الشفافية والأمان التام.</p>
    </div>

    <form class="signup-card" id="signupForm">
      <h3 style="text-align: center; margin-bottom: 5px;">إنشاء حساب جديد</h3>
      
      <div class="form-row">
        <label>الاسم الكامل</label>
        <input id="name" type="text" placeholder="اسمك الثلاثي" required />

        <label>رقم الهاتف</label>
        <input id="phone" type="text" placeholder="01xxxxxxxxx" maxlength="11" required />

        <label>البريد الإلكتروني</label>
        <input id="email" type="email" placeholder="mail@example.com" required />

        <label>كلمة المرور</label>
        <input id="password" type="password" placeholder="6 أحرف على الأقل" required />

        <label>كود الإحالة (اختياري)</label>
        <input id="refCode" type="text" placeholder="أدخل كود الداعي" />
      </div>

      <button id="signupBtn" class="btn-primary" type="submit">إنشاء الحساب الآن</button>
      <div id="status" class="status"></div>

      <div style="margin-top: 20px; text-align: center; font-size: 14px;">
        <a href="login.html" style="color: var(--accent); text-decoration: none;">لديك حساب بالفعل؟ سجل دخولك</a>
      </div>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const errorMap = {
      "DEVICE_USED": "عذراً، هذا الجهاز مسجل به حساب آخر بالفعل.",
      "IP_USED": "تم تجاوز حد الحسابات المسموح بها لهذه الشبكة.",
      "EMAIL_EXISTS": "هذا البريد الإلكتروني مسجل بالفعل.",
      "INVALID_PHONE": "يرجى إدخال رقم هاتف مصري صحيح (01xxxxxxxxx).",
      "auth/email-already-in-use": "البريد الإلكتروني مستخدم بالفعل."
    };

    const getDeviceId = () => {
      let id = localStorage.getItem('appDeviceId');
      if (!id) { id = crypto.randomUUID(); localStorage.setItem('appDeviceId', id); }
      return id;
    };

    document.getElementById('signupForm').onsubmit = async (e) => {
      e.preventDefault();
      const status = document.getElementById('status');
      const btn = document.getElementById('signupBtn');
      
      // منع النقرات المتعددة (Double Submit Protection)
      if (btn.disabled) return;

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const phone = document.getElementById('phone').value.trim();
      const name = document.getElementById('name').value.trim();
      // تحسين رقم 2: توحيد كود الإحالة (Uppercase)
      const refCode = document.getElementById('refCode').value.trim().toUpperCase();
      const deviceId = getDeviceId();

      // تحسين رقم 1: فحص طول كلمة المرور (UX)
      if (password.length < 6) {
        status.textContent = "❌ كلمة المرور يجب ألا تقل عن 6 أحرف";
        status.className = "status error";
        return;
      }

      if (!/^01[0-9]{9}$/.test(phone)) {
        status.textContent = "❌ " + errorMap.INVALID_PHONE;
        status.className = "status error";
        return;
      }

      btn.disabled = true;
      status.textContent = "⏳ جاري المعالجة...";
      status.className = "status";

      try {
        // الفحص الأمني
        const secCheck = await fetch('/api/secureSignup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, deviceId })
        });
        const secRes = await secCheck.json();
        
        // تحسين الملاحظة الأساسية: دعم errorCode أو reason
        if (!secCheck.ok) throw new Error(secRes.errorCode || secRes.reason || "SEC_ERR");

        // إنشاء الحساب
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        
        // تخزين البيانات
        const createRes = await fetch('/api/createUser', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: userCred.user.uid,
            name, email, phone, deviceId, referralCode: refCode
          })
        });

        if (!createRes.ok) {
          const errData = await createRes.json();
          await deleteUser(userCred.user);
          throw new Error(errData.errorCode || errData.reason || "CREATE_ERR");
        }

        status.textContent = "✅ تم إنشاء حسابك بنجاح!";
        status.className = "status success";
        setTimeout(() => window.location.href = "dashboard.html", 1500);

      } catch (err) {
        btn.disabled = false;
        const msg = errorMap[err.message] || errorMap[err.code] || err.message;
        status.textContent = "❌ " + msg;
        status.className = "status error";
      }
    };
  </script>
</body>
</html>
