<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>إنشاء حساب | Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent:#FFD369; --accent-2:#34d399;
      --glass-bg:rgba(255,255,255,0.10);
      --glass-border:rgba(255,255,255,0.17);
      --muted:#b8c2cf; --error:#ff6b6b; --success:#4ade80;
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      font-family:Cairo,sans-serif;
      background:linear-gradient(120deg,#0f2027,#2c5364);
      min-height:100vh;margin:0;
      display:flex;align-items:center;justify-content:center;
      color:#fff;padding:20px
    }
    .card{
      width:100%;max-width:520px;
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      border-radius:var(--radius);
      padding:32px
    }
    h2{color:var(--accent);margin-bottom:10px}
    label{font-size:14px;color:var(--muted);margin-top:12px;display:block}
    input{
      width:100%;padding:13px;margin-top:6px;
      border-radius:12px;border:1px solid rgba(255,255,255,0.2);
      background:rgba(0,0,0,0.25);color:#fff
    }
    .btn{
      width:100%;margin-top:20px;padding:15px;
      border-radius:14px;border:0;
      font-weight:900;cursor:pointer;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#0b1320
    }
    .spinner{
      width:20px;height:20px;border:3px solid rgba(0,0,0,.1);
      border-top:3px solid #000;border-radius:50%;
      animation:spin .8s linear infinite;display:none;margin:auto
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .status{margin-top:14px;text-align:center;font-weight:bold;min-height:22px}
    .status.error{color:var(--error)}
    .status.success{color:var(--success)}
  </style>
</head>

<body>

<div class="card">
  <h2>إنشاء حساب جديد</h2>

  <form id="signupForm">
    <label>الاسم</label>
    <input id="name" required>

    <label>رقم الهاتف</label>
    <input id="phone" maxlength="11" required placeholder="01xxxxxxxxx">

    <label>البريد الإلكتروني</label>
    <input id="email" type="email" required>

    <label>كلمة المرور</label>
    <input id="password" type="password" required>

    <label>كود الإحالة (اختياري)</label>
    <input id="refCode">

    <button class="btn" id="signupBtn" type="submit">
      <span id="btnText">إنشاء الحساب</span>
      <div id="loader" class="spinner"></div>
    </button>

    <div id="status" class="status"></div>
  </form>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const statusEl = document.getElementById("status");

  const getDeviceId = () => {
    let id = localStorage.getItem("deviceId");
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem("deviceId", id);
    }
    return id;
  };

  function showErr(msg) {
    statusEl.className = "status error";
    statusEl.textContent = "❌ " + msg;
  }

  function showSuccess(msg) {
    statusEl.className = "status success";
    statusEl.textContent = msg;
  }

  document.getElementById("signupForm").onsubmit = async (e) => {
    e.preventDefault();

    const btn = document.getElementById("signupBtn");
    const btnText = document.getElementById("btnText");
    const loader = document.getElementById("loader");

    const email = emailEl.value.trim();
    const password = passwordEl.value;
    const phone = phoneEl.value.trim();
    const name = nameEl.value.trim();
    const referralCode = refCodeEl.value.trim().toUpperCase();
    const deviceId = getDeviceId();

    if (!/^01\d{9}$/.test(phone)) {
      showErr("رقم الهاتف غير صحيح");
      return;
    }

    btn.disabled = true;
    loader.style.display = "block";
    btnText.textContent = "جاري التحقق...";

    try {
      // 1️⃣ Secure Signup
      const sec = await fetch("/api/secureSignup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, deviceId })
      });

      if (!sec.ok) {
        const r = await sec.json();
        throw new Error(r.reason || "فشل التحقق");
      }

      // 2️⃣ Firebase Auth
      btnText.textContent = "إنشاء الحساب...";
      const cred = await createUserWithEmailAndPassword(auth, email, password);

      // 3️⃣ Firestore User
      btnText.textContent = "تجهيز الحساب...";
      const create = await fetch("/api/createUser", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          uid: cred.user.uid,
          email, phone, name, deviceId,
          referralCode
        })
      });

      if (!create.ok) {
        await deleteUser(cred.user);
        throw new Error("فشل إنشاء الحساب");
      }

      showSuccess("✅ تم إنشاء الحساب بنجاح");
      setTimeout(() => location.href = "dashboard.html", 1500);

    } catch (err) {
      btn.disabled = false;
      loader.style.display = "none";
      btnText.textContent = "إنشاء الحساب";
      showErr(err.message);
    }
  };

  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  const phoneEl = document.getElementById("phone");
  const nameEl = document.getElementById("name");
  const refCodeEl = document.getElementById("refCode");
</script>

</body>
</html>
