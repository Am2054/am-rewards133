<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>إنشاء حساب | Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #FFD369;
      --accent-2: #34d399;
      --card-bg: rgba(12, 18, 40, 0.82);
      --glass-bg: rgba(255, 255, 255, 0.10);
      --glass-border: rgba(255, 255, 255, 0.17);
      --muted: #b8c2cf;
      --error: #ff6b6b;
      --success: #4ade80;
      --shadow: 0 8px 32px 0 rgba(2,6,23,0.35);
      --radius: 22px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Cairo", sans-serif; color: #f1f6fb; min-height: 100vh; margin: 0;
      background: linear-gradient(120deg, #0f2027 0%, #2c5364 100%), url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1500&q=80');
      background-size: cover; background-attachment: fixed; background-blend-mode: overlay;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }

    .center-wrap { width: 100%; max-width: 1150px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 42px; align-items: stretch; z-index: 2; background: rgba(255,255,255,0.02); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--glass-border); }

    .hero { background: var(--card-bg); padding: 54px 38px; display: flex; flex-direction: column; justify-content: center; position: relative; }
    .hero h2 { font-family: "Montserrat", sans-serif; font-size: 38px; color: var(--accent); margin: 0 0 16px 0; font-weight: 800; }
    .hero p { color: var(--muted); font-size: 16.5px; line-height: 1.7; margin-bottom: 22px; }
    
    .bullets { display: flex; flex-direction: column; gap: 13px; margin-bottom: 24px; }
    .bullet { display: flex; align-items: center; gap: 12px; font-size: 17px; color: #e5f7ff; }
    .dot { width: 13px; height: 13px; border-radius: 50%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); border: 2.5px solid #fff2; }

    .signup-card { background: var(--glass-bg); padding: 38px 32px; display: flex; flex-direction: column; backdrop-filter: blur(16px); }
    .signup-card h3 { margin: 0 0 10px 0; text-align: center; color: #e6f7ff; font-size: 24px; font-weight: 700; }
    
    label { font-size: 14px; color: var(--muted); margin-top: 12px; display: block; text-align: right; }
    input { width: 100%; padding: 13px; border-radius: 12px; border: 1.5px solid rgba(255,255,255,0.15); background: rgba(32,40,74,0.32); color: #fff; outline: none; margin-top: 5px; transition: 0.2s; }
    input:focus { border-color: var(--accent-2); background: rgba(32,40,74,0.48); }

    /* --- Password Strength Meter --- */
    .strength-meter { height: 4px; width: 100%; background: rgba(255,255,255,0.1); margin-top: 8px; border-radius: 2px; overflow: hidden; }
    .strength-bar { height: 100%; width: 0; transition: 0.3s; }

    .btn-primary { 
      margin-top: 20px; width: 100%; padding: 15px; border-radius: 13px; border: 0; 
      color: #0b1320; background: linear-gradient(90deg, var(--accent), var(--accent-2)); 
      font-weight: 900; font-size: 17px; cursor: pointer; transition: 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    /* --- Loading Spinner --- */
    .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid #0b1320; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .status { margin-top: 15px; text-align: center; font-size: 15px; font-weight: 600; min-height: 24px; }
    .status.error { color: var(--error); }
    .status.success { color: var(--success); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-content { background: var(--card-bg); border: 1.5px solid var(--glass-border); border-radius: var(--radius); padding: 30px; width: 90%; max-width: 600px; text-align: right; }
    .modal-close { background: var(--error); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; margin-top: 20px; font-weight: bold; width: 100%; }

    @media (max-width: 1100px) { .center-wrap { grid-template-columns: 1fr; } .hero { display: none; } }
  </style>
</head>
<body>

  <div class="center-wrap">
    <div class="hero">
      <h2>Am Rewards<span style="color:#fff;font-size:13px;"> — اربح بثقة</span></h2>
      <p>منصة مكافآت حديثة تجمع بين الشفافية، الأمان وسهولة الاستخدام. أكسب نقاطك بوضوح، اسحبها بسرعة، وشارك أصدقاءك بنظام إحالات متطور.</p>
      <div class="bullets">
        <div class="bullet"><span class="dot"></span><div>سحب سريع وآمن بضغطة واحدة</div></div>
        <div class="bullet"><span class="dot"></span><div>مهام يومية متنوعة — اربح وقتما تشاء</div></div>
        <div class="bullet"><span class="dot"></span><div>نظام إحالات شفاف (للفرق فقط)</div></div>
      </div>
    </div>

    <form class="signup-card" id="signupForm">
      <h3>إنشاء حساب جديد</h3>
      
      <div class="form-row">
        <label>الاسم الكامل</label>
        <input id="name" type="text" placeholder="ادخل اسمك الكامل" required />

        <label>رقم الهاتف</label>
        <input id="phone" type="text" placeholder="01xxxxxxxxx" maxlength="11" required />

        <label>البريد الإلكتروني</label>
        <input id="email" type="email" placeholder="example@mail.com" required />

        <label>كلمة المرور</label>
        <input id="password" type="password" placeholder="الحد الأدنى 6 أحرف" required oninput="checkStrength(this.value)" />
        <div class="strength-meter"><div id="strengthBar" class="strength-bar"></div></div>

        <label>كود الإحالة (اختياري)</label>
        <input id="refCode" type="text" placeholder="أدخل كود الداعي هنا" />
      </div>

      <div style="display:flex; align-items:center; gap:10px; margin-top:15px;">
        <input id="agree" type="checkbox" style="width:18px; height:18px; margin:0;" required />
        <label for="agree" style="margin:0; font-size:13px;">أوافق على <a href="#" onclick="document.getElementById('policyModal').classList.add('open')" style="color:var(--accent); text-decoration:none;">سياسة الاستخدام</a></label>
      </div>

      <button id="signupBtn" class="btn-primary" type="submit">
        <span id="btnText">إنشاء الحساب — ابدأ الآن</span>
        <div id="loader" class="spinner"></div>
      </button>
      <div id="status" class="status"></div>
    </form>
  </div>

  <div id="policyModal" class="modal-overlay">
    <div class="modal-content">
      <h1>سياسة الاستخدام</h1>
      <ul style="color:var(--muted); line-height:1.8;">
        <li>يُمنع استخدام أي برامج تلاعب أو VPN.</li>
        <li>يُسمح بحساب واحد فقط لكل جهاز.</li>
      </ul>
      <button class="modal-close" onclick="document.getElementById('policyModal').classList.remove('open')">إغلاق</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", authDomain: "am--rewards.firebaseapp.com", projectId: "am--rewards" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // قياس قوة كلمة المرور
    window.checkStrength = (p) => {
        const bar = document.getElementById('strengthBar');
        let strength = 0;
        if(p.length > 5) strength += 30;
        if(/[A-Z]/.test(p)) strength += 30;
        if(/[0-9]/.test(p)) strength += 40;
        
        bar.style.width = strength + '%';
        bar.style.background = strength < 40 ? 'var(--error)' : strength < 70 ? 'var(--accent)' : 'var(--success)';
    }

    const getDeviceId = () => {
        let id = localStorage.getItem('appDeviceId');
        if (!id) { id = crypto.randomUUID(); localStorage.setItem('appDeviceId', id); }
        return id;
    };

    document.getElementById('signupForm').onsubmit = async (e) => {
      e.preventDefault();
      const status = document.getElementById('status');
      const btn = document.getElementById('signupBtn');
      const loader = document.getElementById('loader');
      const btnText = document.getElementById('btnText');
      
      if (btn.disabled) return;

      const password = document.getElementById('password').value;
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const deviceId = getDeviceId();

      if (password.length < 6 || !/^01[0-9]{9}$/.test(phone)) {
        status.textContent = "❌ تأكد من صحة البيانات (كلمة المرور + الهاتف)";
        status.className = "status error";
        return;
      }

      // تفعيل حالة التحميل (Loading State)
      btn.disabled = true;
      loader.style.display = 'block';
      btnText.textContent = "جاري المعالجة...";
      status.textContent = "";

      try {
        const secRes = await fetch('/api/secureSignup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, deviceId }) });
        const secData = await secRes.json();
        if (!secRes.ok) throw new Error(secData.errorCode || secData.reason || "SEC_ERR");

        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        
        const createRes = await fetch('/api/createUser', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
            uid: userCred.user.uid,
            name: document.getElementById('name').value.trim(),
            email, phone, deviceId, referralCode: document.getElementById('refCode').value.trim().toUpperCase()
        })});

        if (!createRes.ok) { await deleteUser(userCred.user); throw new Error("CREATE_ERR"); }

        status.textContent = "✅ تم بنجاح!";
        status.className = "status success";
        setTimeout(() => window.location.href = "dashboard.html", 1000);

      } catch (err) {
        btn.disabled = false;
        loader.style.display = 'none';
        btnText.textContent = "إنشاء الحساب — ابدأ الآن";
        status.textContent = "❌ حدث خطأ: " + err.message;
        status.className = "status error";
      }
    };
  </script>
</body>
</html>
