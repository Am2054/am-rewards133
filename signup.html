<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>إنشاء حساب | Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#FFD369;
      --accent-2:#34d399;
      --primary-bg: #05132f;
      --card-bg: rgba(12,18,40,0.82);
      --glass-bg: rgba(255,255,255,0.10);
      --glass-border: rgba(255,255,255,0.17);
      --muted: #b8c2cf;
      --error: #ff6b6b;
      --success: #4ade80;
      --shadow: 0 8px 32px 0 rgba(2,6,23,0.35);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html, body{ margin:0; padding:0; scroll-behavior:smooth; }
    body{
      font-family:"Cairo", "Montserrat", sans-serif;
      color:#f1f6fb; min-height:100vh;
      background: linear-gradient(120deg, #0f2027 0%, #2c5364 100%), url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1500&q=80');
      background-size:cover; background-attachment:fixed; background-blend-mode:overlay;
      display:flex; align-items:flex-start; justify-content:center; padding:20px 0;
    }
    /* ... باقي CSS بدون تعديل ... */
  </style>
</head>
<body>
  <div class="animated-bg"></div>
  <div class="center-wrap">
    <div class="hero">
      <!-- محتوى الهيرو بدون تعديل -->
    </div>

    <form class="signup-card" onsubmit="event.preventDefault(); window.signup();">
      <h3>إنشاء حساب جديد</h3>
      <p class="lead">سجّل وانضم لمنصة المكافآت الأسرع نمواً في مصر</p>

      <div class="form-row">
        <!-- الحقول بدون تعديل -->
      </div>

      <div class="checkbox-row">
        <input id="agree" type="checkbox" required />
        <label for="agree" style="font-size:13px;">أوافق على <a href="#" onclick="document.getElementById('policyModal').classList.add('open')" style="color:var(--accent);">سياسة الاستخدام</a></label>
      </div>

      <button id="signupBtn" class="btn-primary" type="submit">إنشاء الحساب — ابدأ الآن</button>
      <div id="status" class="status"></div>

      <div class="links" style="margin-top:15px; text-align:center;">
        <a href="login.html" style="color:var(--accent-2); text-decoration:none; font-weight:700;">هل لديك حساب؟ تسجيل الدخول</a>
      </div>
      <footer style="margin-top:20px; font-size:12px; opacity:0.6;">© 2025 Am Rewards — جميع الحقوق محفوظة</footer>
    </form>
  </div>

  <div id="policyModal" class="modal-overlay">
    <!-- محتوى المودال بدون تعديل -->
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain: "am--rewards.firebaseapp.com",
  projectId: "am--rewards",
  storageBucket: "am--rewards.appspot.com",
  messagingSenderId: "428582312150",
  appId: "1:428582312150:web:44e35a70e457e7db4c45df"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

window.togglePasswordVisibility = function(id) {
    const input = document.getElementById(id);
    const icon = input.nextElementSibling;
    input.type = input.type === "password" ? "text" : "password";
    icon.classList.toggle('visible');
}

function getDeviceId() {
    let id = localStorage.getItem('appDeviceId');
    if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem('appDeviceId', id);
    }
    return id;
}

function populateReferralFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get('ref');
    if (ref) {
        document.getElementById('refCode').value = ref.toUpperCase();
    }
}
populateReferralFromURL();

window.signup = async function(){
  const statusEl = document.getElementById('status');
  const signupBtn = document.getElementById('signupBtn');

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const phone = document.getElementById('phone').value.trim();
  const name = document.getElementById('name').value.trim();
  const referralCode = document.getElementById('refCode').value.trim().toUpperCase();
  const deviceId = getDeviceId();

  signupBtn.disabled = true;
  statusEl.textContent = "";

  // التحقق من رقم الهاتف
  if (!/^01\d{9}$/.test(phone)) {
      statusEl.textContent = "❌ رقم الهاتف غير صحيح (01XXXXXXXXX)";
      statusEl.className = "status error";
      signupBtn.disabled = false;
      return;
  }

  if (password.length < 6) {
      statusEl.textContent = "❌ كلمة المرور قصيرة جدًا (6 أحرف على الأقل)";
      statusEl.className = "status error";
      signupBtn.disabled = false;
      return;
  }

  if (password !== confirmPassword) {
      statusEl.textContent = "❌ كلمات المرور غير متطابقة";
      statusEl.className = "status error";
      signupBtn.disabled = false;
      return;
  }

  try {
    statusEl.textContent = "⏳ جاري إنشاء الحساب عبر الخادم...";
    // 1️⃣ إنشاء الحساب أولاً على Firebase
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCred.user;

    // 2️⃣ تسجيل الحساب في backend
    const registerRes = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid: user.uid,
        email,
        name,
        phone,
        deviceId,
        referralCode
      })
    });

    let registerData = {};
    try { registerData = await registerRes.json(); } catch(e){ registerData = { message: 'حدث خطأ في الخادم' }; }

    if (!registerRes.ok) {
        // إذا فشل التسجيل في backend، احذف الحساب من Firebase
        await deleteUser(user);
        statusEl.textContent = "❌ " + (registerData.message || 'فشل تسجيل البيانات، حاول لاحقاً');
        statusEl.className = "status error";
        signupBtn.disabled = false;
        return;
    }

    // تسجيل ناجح
    statusEl.textContent = "✅ " + (registerData.message || "تم التسجيل بنجاح!");
    statusEl.className = "status success";
    setTimeout(()=> window.location.href="dashboard.html", 1500);

  } catch(err) {
    statusEl.textContent = "❌ " + (err.message || err);
    statusEl.className = "status error";
    signupBtn.disabled = false;
  }
};
</script>
</body>
          </html>
