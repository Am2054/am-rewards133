<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ | Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #FFD369; --accent-2: #34d399; --card-bg: rgba(12, 18, 40, 0.82);
      --glass-bg: rgba(255, 255, 255, 0.10); --glass-border: rgba(255, 255, 255, 0.17);
      --muted: #b8c2cf; --error: #ff6b6b; --success: #4ade80;
      --shadow: 0 8px 32px 0 rgba(2,6,23,0.35); --radius: 22px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Cairo", sans-serif; color: #f1f6fb; min-height: 100vh; margin: 0;
      background: linear-gradient(120deg, #0f2027 0%, #2c5364 100%), url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1500&q=80');
      background-size: cover; background-attachment: fixed; background-blend-mode: overlay;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .center-wrap { width: 100%; max-width: 1150px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 42px; align-items: stretch; z-index: 2; background: rgba(255,255,255,0.02); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--glass-border); overflow: hidden; }
    .hero { background: var(--card-bg); padding: 54px 38px; display: flex; flex-direction: column; justify-content: center; }
    .hero h2 { font-family: "Montserrat", sans-serif; font-size: 38px; color: var(--accent); margin-bottom: 16px; font-weight: 800; }
    .signup-card { background: var(--glass-bg); padding: 38px 32px; display: flex; flex-direction: column; backdrop-filter: blur(16px); position: relative; }
    label { font-size: 14px; color: var(--muted); margin-top: 12px; display: block; text-align: right; }
    .input-group { position: relative; width: 100%; }
    input { width: 100%; padding: 13px; border-radius: 12px; border: 1.5px solid rgba(255,255,255,0.15); background: rgba(32,40,74,0.32); color: #fff; outline: none; margin-top: 5px; transition: 0.2s; }
    input:focus { border-color: var(--accent-2); }
    .password-toggle { position: absolute; left: 12px; top: 18px; cursor: pointer; background: none; border: none; font-size: 18px; color: var(--muted); }
    .strength-meter { height: 4px; width: 100%; background: rgba(255,255,255,0.1); margin-top: 8px; border-radius: 2px; }
    .strength-bar { height: 100%; width: 0; transition: 0.3s; }
    .btn-primary { margin-top: 20px; width: 100%; padding: 15px; border-radius: 13px; border: 0; color: #0b1320; background: linear-gradient(90deg, var(--accent), var(--accent-2)); font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid #0b1320; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .status { margin-top: 15px; text-align: center; font-size: 14px; min-height: 24px; font-weight: bold; }
    .status.error { color: var(--error); }
    .status.success { color: var(--success); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal-content { background: #161d31; padding: 25px; border-radius: 15px; max-width: 600px; text-align: right; border: 1px solid var(--glass-border); }
    @media (max-width: 1100px) { .center-wrap { grid-template-columns: 1fr; } .hero { display: none; } }
  </style>
</head>
<body>

  <div class="center-wrap">
    <div class="hero">
      <h2>Am Rewards</h2>
      <p style="color:var(--muted); line-height:1.7;">Ù…Ù†ØµØ© Ù…ÙƒØ§ÙØ¢Øª Ø­Ø¯ÙŠØ«Ø© ØªØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø´ÙØ§ÙÙŠØ©ØŒ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</p>
    </div>

    <form class="signup-card" id="signupForm">
      <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input id="name" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø³Ø­Ø¨" required />
      
      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
      <input id="phone" type="text" placeholder="01xxxxxxxxx" maxlength="11" required />

      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input id="email" type="email" placeholder="mail@example.com" required />

      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <div class="input-group">
        <input id="password" type="password" placeholder="6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„" required oninput="checkStrength(this.value)" />
        <button type="button" class="password-toggle" id="togglePass">ğŸ‘ï¸</button>
      </div>
      <div class="strength-meter"><div id="strengthBar" class="strength-bar"></div></div>

      <label>ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="refCode" type="text" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø§Ø¹ÙŠ" />

      <div style="display:flex; align-items:center; gap:10px; margin-top:15px;">
        <input id="agree" type="checkbox" required />
        <label for="agree" style="margin:0; font-size:13px;">Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ <a href="#" onclick="document.getElementById('policyModal').classList.add('open')" style="color:var(--accent); text-decoration:none;">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</a></label>
      </div>

      <button id="signupBtn" class="btn-primary" type="submit">
        <span id="btnText">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</span>
        <div id="loader" class="spinner"></div>
      </button>

      <div id="status" class="status"></div>
      <div style="text-align:center; margin-top:15px; color:var(--muted); font-size:14px;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="login.html" style="color:var(--accent-2); text-decoration:none; font-weight:bold;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</a></div>
    </form>
  </div>

  <div id="policyModal" class="modal-overlay">
    <div class="modal-content">
      <h2 style="color:var(--accent)">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h2>
      <ul style="color:var(--muted); line-height: 1.8; padding-right: 20px; font-size: 14px;">
        <li>ÙŠÙØ­Ø¸Ø± ØªÙ…Ø§Ù…Ù‹Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø£Ùˆ VPN.</li>
        <li>ÙŠØ³Ù…Ø­ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„ÙƒÙ„ Ø´Ø®Øµ/Ø¬Ù‡Ø§Ø².</li>
        <li>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ 200 Ø¬Ù†ÙŠÙ‡ Ø¨Ø®ØµÙ… 10% Ø±Ø³ÙˆÙ… Ø¥Ø¯Ø§Ø±ÙŠØ©.</li>
        <li>Ø³Ø¹Ø± Ø§Ù„Ù†Ù‚Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹: 0.07 Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ.</li>
      </ul>
      <button class="btn-primary" onclick="document.getElementById('policyModal').classList.remove('open')">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", authDomain: "am--rewards.firebaseapp.com", projectId: "am--rewards" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Ø§Ù„ØªØ­Ø³ÙŠÙ† 3: ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù€ onsubmit Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù€ Scope
    const statusEl = document.getElementById('status');
    const signupBtn = document.getElementById('signupBtn');
    const loader = document.getElementById('loader');
    const btnText = document.getElementById('btnText');

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Device ID
    const getDeviceId = () => {
      let id = localStorage.getItem('appDeviceId');
      if (!id) { id = crypto.randomUUID(); localStorage.setItem('appDeviceId', id); }
      return id;
    };

    document.getElementById('togglePass').onclick = () => {
      const p = document.getElementById('password');
      p.type = p.type === 'password' ? 'text' : 'password';
    };

    window.checkStrength = (p) => {
      const bar = document.getElementById('strengthBar');
      let s = 0;
      if(p.length > 5) s += 30; if(/[A-Z]/.test(p)) s += 30; if(/[0-9]/.test(p)) s += 40;
      bar.style.width = s + '%';
      bar.style.background = s < 40 ? '#ff6b6b' : s < 70 ? '#FFD369' : '#4ade80';
    };

    document.getElementById('signupForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const phone = document.getElementById('phone').value.trim();
      const name = document.getElementById('name').value.trim();
      const refCode = document.getElementById('refCode').value.trim().toUpperCase();
      const deviceId = getDeviceId();

      // Ø§Ù„ØªØ­Ø³ÙŠÙ† 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
      if (password.length < 6) { showErr("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }
      if (!/^01[0-9]{9}$/.test(phone)) { showErr("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (01XXXXXXXXX)"); return; }

      // Ø¨Ø¯Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      signupBtn.disabled = true; loader.style.display = 'block'; btnText.textContent = "Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†...";
      statusEl.textContent = ""; statusEl.className = "status";

      try {
        // 1ï¸âƒ£ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ (Secure Signup)
        const secRes = await fetch('/api/secureSignup', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, deviceId })
        });
        if (!secRes.ok) {
          const r = await secRes.json();
          throw new Error(r.errorCode || r.reason || 'SEC_ERR');
        }

        btnText.textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...";
        // 2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Auth
        const userCred = await createUserWithEmailAndPassword(auth, email, password);

        btnText.textContent = "ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        // 3ï¸âƒ£ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore Ø¹Ø¨Ø± Ø§Ù„Ù€ API
        const createRes = await fetch('/api/createUser', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: userCred.user.uid, email, phone, name, deviceId, referralCode: refCode
          })
        });

        if (!createRes.ok) {
          // 4ï¸âƒ£ Rollback Ø°ÙƒÙŠ: Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ†
          await deleteUser(userCred.user);
          throw new Error("CREATE_ERR");
        }

        statusEl.className = "status success";
        statusEl.textContent = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...";
        setTimeout(() => window.location.href = "dashboard.html", 1500);

      } catch (err) {
        signupBtn.disabled = false; loader.style.display = 'none'; btnText.textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†";
        showErr(translateError(err.code || err.message));
      }
    };

    function showErr(m) {
      statusEl.className = "status error";
      statusEl.textContent = "âŒ " + m;
    }

    function translateError(code) {
      const errors = {
        'auth/email-already-in-use': 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„',
        'auth/invalid-email': 'Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­',
        'auth/weak-password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©',
        'DEVICE_ALREADY_EXISTS': 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙƒØ«Ø± Ù…Ù† Ø­Ø³Ø§Ø¨ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²',
        'SEC_ERR': 'ÙØ´Ù„ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹',
        'CREATE_ERR': 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'
      };
      return errors[code] || code;
    }
  </script>
</body>
</html>
