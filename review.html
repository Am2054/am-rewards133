<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø© â€” Ø¥Ø¯Ø§Ø±Ø© Am Rewards</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <style>
        /* ------------------------------------------- */
        /* ------------ Base Styles & Vars ----------- */
        /* ------------------------------------------- */
        :root{
            --bg:#070707; 
            --card:#1a1a1b;
            --gold:#f5c542; 
            --muted:#b0b7c0;
            --text:#eef2f7;
            --accent:#00fa9a;
            --blue:#3b82f6; 
            --red:#ef4444; 
            --orange:#f97316;
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }
        * {box-sizing:border-box;}
        body{
            font-family:"Cairo",sans-serif;
            background:linear-gradient(180deg,var(--bg),#0b0b0b);
            color:var(--text);
            margin:0;padding:20px;
        }
        .wrap{max-width:1000px;margin:0 auto;}
        
        /* ------------------------------------------- */
        /* ---------------- Cards & Inputs ----------- */
        /* ------------------------------------------- */
        .card{
            background:var(--card);
            padding:25px;
            border-radius:15px;
            border:1px solid rgba(245,197,66,0.15);
            box-shadow: var(--shadow);
            margin-bottom:25px;
            text-align: right;
        }
        .controls{display:flex;gap:15px;align-items:center;flex-wrap:wrap;}
        .controls input{
            flex-grow: 1;
            padding:12px 15px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,0.1);
            background:#262626;
            color:var(--text);
            outline:none;
        }
        .controls input:focus { border-color: var(--gold); box-shadow: 0 0 8px rgba(245, 197, 66, 0.5); }
        .btn-primary{background:var(--blue);border-color:var(--blue);font-weight:700; color: #fff; padding: 12px 20px; border-radius: 10px; border: 1px solid; cursor: pointer;}
        .btn-danger{background:var(--red);border-color:var(--red);font-weight:700; color: #fff; padding: 12px 20px; border-radius: 10px; border: 1px solid; cursor: pointer;}
        .btn-primary:hover:not(:disabled), .btn-danger:hover:not(:disabled) {opacity: 0.9; transform: translateY(-1px);}
        .btn-primary:disabled, .btn-danger:disabled {opacity: 0.6; cursor: not-allowed;} /* ğŸŸ¢ ØªØ­Ø³ÙŠÙ† Ø¨ØµØ±ÙŠ */

        h2 { color: var(--gold); border-bottom: 2px solid rgba(245, 197, 66, 0.3); padding-bottom: 8px; margin-top: 0; font-size: 20px; }

        /* ------------------------------------------- */
        /* ---------------- Data Rows ---------------- */
        /* ------------------------------------------- */
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 15px;
        }
        .data-row strong { color: var(--muted); }
        .data-row span { color: var(--text); font-weight: 700; }
        .data-row .status-badge { font-weight: 900; }
        .banned-status { color: var(--red) !important; font-weight: 900; }
        .active-status { color: var(--accent) !important; font-weight: 900; }

        /* ------------------------------------------- */
        /* ---------------- Tables ------------------- */
        /* ------------------------------------------- */
        .history-table-container{overflow:auto;margin-top:15px}
        .history-table{
            width:100%;
            border-collapse:collapse;
            min-width:700px; 
            direction: rtl; 
        }
        .history-table th, .history-table td{
            padding:10px 12px;
            text-align:right; 
            border-bottom:1px solid rgba(255,255,255,0.05);
            white-space: nowrap;
            font-size: 14px;
        }
        .history-table th{
            background:rgba(245,197,66,0.05);
            color:var(--gold);
            font-weight: 700;
            position: sticky; top: 0;
        }
        .status-pending{background:var(--orange);color:#000; padding:4px 8px; border-radius: 8px;}
        .status-completed{background:var(--accent);color:#000; padding:4px 8px; border-radius: 8px;}
        .status-rejected{background:var(--red);color:#fff; padding:4px 8px; border-radius: 8px;}
        
        #loadingMsg { text-align: center; color: var(--muted); padding: 20px; }

        /* ğŸŸ¢ ØªÙ†Ø³ÙŠÙ‚ Loader Ø¨Ø³ÙŠØ· */
        .loader {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body style="min-height: 100vh; display: none;" id="mainBody"> <div class="wrap">
        <header>
            <h1 style="color:var(--gold); font-weight:900;">ğŸ‘¤ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</h1>
        </header>

        <div class="card">
            <div class="controls">
                <input id="searchQuery" placeholder="Ø£Ø¯Ø®Ù„ UID Ø£Ùˆ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
                <button id="searchBtn" class="btn-primary">ğŸ” Ø¨Ø­Ø«</button>
                <button id="banUnbanBtn" class="btn-danger" style="display:none;" disabled>ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            </div>
        </div>
        
        <div id="resultsArea" style="display:none;">
            
            <div class="card">
                <h2>ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
                <div id="basicData">
                    <div class="data-row"><strong>UID:</strong><span id="displayUid">N/A</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ø§Ø³Ù…:</strong><span id="displayName">N/A</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong><span id="displayEmail">N/A</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ):</strong><span id="displayPoints" style="color: var(--accent);">0</span></div>
                    <div class="data-row"><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±:</strong><span id="displayBanStatus" class="active-status">Ù†Ø´Ø·</span></div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ”— Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h2>
                <div id="referralData">
                    <div class="data-row"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©:</strong><span id="referralsCount" style="color: var(--blue);">0</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø© Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª:</strong><span id="referralsPoints" style="color: var(--gold);">0</span></div>
                </div>
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                <th>Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ù„</th>
                                <th>ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</th> 
                                <th>UID Ø§Ù„Ù…Ø­Ø§Ù„</th>
                            </tr>
                        </thead>
                        <tbody id="referralTbody">
                            <tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ’¸ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (<span id="withdrawalsCount">0</span> Ø¹Ù…Ù„ÙŠØ©)</h2>
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº (EGP)</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTbody">
                            <tr><td colspan="7" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ“ˆ Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h2>
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="pointsSummaryTbody">
                            <tr><td colspan="3" style="text-align:center; color: var(--muted);">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø®Øµ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2>â­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø§Ù„ØªÙØµÙŠÙ„ÙŠ)</h2>
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</th>
                                <th>UID Ø§Ù„Ù…Ù‡Ù…Ø©</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="pointsHistoryTbody">
                            <tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¬Ù„Ø©.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        
        <p id="loadingMsg" style="display:none;">... Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ...</p>
        <p id="errorMsg" style="text-align: center; color: var(--red); display: none;">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/UID Ø§Ù„Ù…Ø¯Ø®Ù„.</p>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
          getFirestore, collection, query, where, getDocs, orderBy, doc, updateDoc, Timestamp, limit
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // ============== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¯ÙŠÙƒ) ==============
        const firebaseConfig = {
            apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
            authDomain: "am--rewards.firebaseapp.com",
            databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
            projectId: "am--rewards",
            storageBucket: "am--rewards.firebasestorage.app",
            messagingSenderId: "744783579735",
            appId: "1:744783579735:web:45e00de9998893bbc9b112",
            measurementId: "G-CV3GLT2TTJ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ğŸŸ¢ 6. Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© (Admin Access Check)
        const adminEmail = "amirfg992005@gmail.com";
        const mainBody = document.getElementById('mainBody');

        onAuthStateChanged(auth, user => {
            if (!user || user.email !== adminEmail) {
                document.body.innerHTML = "<h2 style='text-align:center;color:var(--red);padding:50px;'>ğŸš« ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©. Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·.</h2>";
            } else {
                mainBody.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
            }
        });

        // ğŸŸ¢ 2. Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø±Ø¦ÙŠ Ù…Ø¤Ù‚Øª (Toast)
        function showToast(msg, color = "var(--accent)") {
            const toast = document.createElement('div');
            toast.textContent = msg;
            toast.style.cssText = `
                position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
                background:${color};color:#000;padding:10px 20px;border-radius:8px;
                font-weight:700;box-shadow:0 0 15px rgba(0,0,0,0.4);z-index:9999;
                transition: opacity 0.3s ease-in-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // ============== Ø«ÙˆØ§Ø¨Øª DOM ==============
        const searchQueryInput = document.getElementById('searchQuery');
        const searchBtn = document.getElementById('searchBtn');
        const banUnbanBtn = document.getElementById('banUnbanBtn');
        const resultsArea = document.getElementById('resultsArea');
        const loadingMsg = document.getElementById('loadingMsg');
        const errorMsg = document.getElementById('errorMsg');
        
        const displayUid = document.getElementById('displayUid');
        const displayName = document.getElementById('displayName');
        const displayEmail = document.getElementById('displayEmail');
        const displayPoints = document.getElementById('displayPoints');
        const displayBanStatus = document.getElementById('displayBanStatus');
        
        // Referral DOM elements
        const referralsCount = document.getElementById('referralsCount');
        const referralsPoints = document.getElementById('referralsPoints');
        const referralTbody = document.getElementById('referralTbody');

        const withdrawalsCount = document.getElementById('withdrawalsCount');
        const withdrawalsTbody = document.getElementById('withdrawalsTbody');
        const pointsHistoryTbody = document.getElementById('pointsHistoryTbody');
        const pointsSummaryTbody = document.getElementById('pointsSummaryTbody');

        // ğŸŸ¢ 4. Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ø§Ù…
        const colorMap = { "shortlinks": "var(--accent)", "surveys": "var(--blue)", "apps": "var(--gold)", "offers": "var(--orange)" };

        // State
        let targetUID = null;
        let isUserBanned = false;
        
        // ============== Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¶Ø§ÙØ© (safe function) ==============
        const safe = (v, fallback = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯") => {
            if (v === null || v === undefined) {
                return fallback;
            }
            if (v.toDate && typeof v.toDate === 'function') {
                return v.toDate();
            }
            return v;
        };

        // Helpers
        function toDateSafe(ts) {
            const date = safe(ts);
            if (date instanceof Date) return date;
            if (date.seconds) return new Date(date.seconds * 1000);
            return null;
        }
        function fmtCurrency(n) {
            return Number(safe(n, 0)).toLocaleString('ar-EG', {minimumFractionDigits:2});
        }
        function fmtNumber(n) { return Number(safe(n, 0)).toLocaleString('en-US'); }
        function fmtDate(ts) {
            const date = toDateSafe(ts);
            return date ? date.toLocaleString('ar-EG', {day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'N/A';
        }
        function translateStatus(status) {
            status = (safe(status, '')).toString().toLowerCase();
            if (status === 'pending') return `<span class="status-pending">Ù…Ø¹Ù„Ù‘Ù‚</span>`;
            if (status === 'completed') return `<span class="status-completed">Ù…ÙƒØªÙ…Ù„</span>`;
            if (status === 'rejected') return `<span class="status-rejected">Ù…Ø±ÙÙˆØ¶</span>`;
            return status || 'N/A';
        }

        // =======================================================
        // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID/Email)
        // =======================================================
        async function findUser(queryValue) {
            resultsArea.style.display = 'none';
            errorMsg.style.display = 'none';
            loadingMsg.style.display = 'block';
            banUnbanBtn.style.display = 'none';
            
            // ğŸŸ¢ 5. ØªØ­Ø³ÙŠÙ† Ø¨ØµØ±ÙŠ Ù„Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            searchBtn.innerHTML = '<span class="loader"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
            searchBtn.disabled = true;

            let userQuery;
            if (queryValue.includes('@') && queryValue.includes('.')) {
                userQuery = query(collection(db, 'users'), where('email', '==', queryValue));
            } else { 
                userQuery = query(collection(db, 'users'), where('__name__', '==', queryValue));
            }

            try {
                const userSnap = await getDocs(userQuery);
                if (userSnap.empty) {
                    loadingMsg.style.display = 'none';
                    errorMsg.style.display = 'block';
                    targetUID = null;
                    return null;
                }
                
                const userDoc = userSnap.docs[0];
                targetUID = userDoc.id;
                const userData = userDoc.data();
                
                displayBasicData(userData);
                
                // Load detailed history concurrently
                await Promise.all([
                    loadWithdrawalsHistory(targetUID),
                    loadPointsHistory(targetUID),
                    loadReferralHistory(targetUID)
                ]);
                
                loadingMsg.style.display = 'none';
                resultsArea.style.display = 'block';

            } catch (err) {
                console.error("Error finding user:", err);
                loadingMsg.style.display = 'none';
                errorMsg.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}`;
                errorMsg.style.display = 'block';
                targetUID = null;
            } finally {
                // ğŸŸ¢ 5. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„Ø²Ø±
                searchBtn.innerHTML = "ğŸ” Ø¨Ø­Ø«";
                searchBtn.disabled = false;
            }
        }

        // =======================================================
        // 2. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
        // =======================================================
        function displayBasicData(userData) {
            const isBanned = safe(userData.isBanned, false);
            isUserBanned = isBanned;
            
            displayUid.textContent = targetUID;
            displayName.textContent = safe(userData.name, 'ØºÙŠØ± Ù…ØªÙˆÙØ±');
            displayEmail.textContent = safe(userData.email, 'ØºÙŠØ± Ù…ØªÙˆÙØ±');
            displayPoints.textContent = fmtNumber(userData.points);
            
            referralsCount.textContent = fmtNumber(userData.referralCount);
            referralsPoints.textContent = fmtNumber(userData.referralPoints);


            if (isBanned) {
                displayBanStatus.textContent = 'Ù…Ø­Ø¸ÙˆØ± ğŸš«';
                displayBanStatus.className = 'banned-status';
                banUnbanBtn.textContent = 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±';
                banUnbanBtn.classList.remove('btn-danger');
                banUnbanBtn.classList.add('btn-primary');
            } else {
                displayBanStatus.textContent = 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                displayBanStatus.className = 'active-status';
                banUnbanBtn.classList.remove('btn-primary');
                banUnbanBtn.classList.add('btn-danger');
            }
            banUnbanBtn.disabled = false;
            banUnbanBtn.style.display = 'inline-block';
        }

        // =======================================================
        // 3. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (ØªÙ… Ø¥Ø¶Ø§ÙØ© limit Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡)
        // =======================================================
        async function loadReferralHistory(uid) {
            referralTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--gold);">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

            try {
                // ğŸŸ¢ 3. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ (limit)
                const referredSnap = await getDocs(query(
                    collection(db, "referralLogs"), 
                    where("referrerUid", "==", uid),
                    orderBy('date', 'desc'),
                    limit(100) 
                ));

                if (referredSnap.empty) {
                    referralTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.</td></tr>';
                    return;
                }

                referralTbody.innerHTML = referredSnap.docs.map(d => {
                    const data = d.data();
                    return `
                        <tr>
                            <td>${fmtDate(data.date)}</td>
                            <td>${safe(data.email, 'N/A')}</td>
                            <td style="color: var(--blue);">${safe(data.referralCode, 'N/A')}</td>
                            <td style="font-size: 10px;">${safe(data.referredUid, 'N/A')}</td>
                        </tr>
                    `;
                }).join('');
                
                // ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                if (referredSnap.docs.length >= 100) {
                     referralTbody.innerHTML += `<tr><td colspan="4" style="text-align:center; color: var(--orange); font-style: italic;">*ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¢Ø®Ø± 100 Ø¥Ø­Ø§Ù„Ø© ÙÙ‚Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙŠØ²Ø© "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©.*</td></tr>`;
                }


            } catch (err) {
                console.error("Error loading referral data:", err);
                referralTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--red);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª.</td></tr>';
            }
        }


        // =======================================================
        // 4. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (ØªÙ… Ø¥Ø¶Ø§ÙØ© limit Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡)
        // =======================================================
        async function loadWithdrawalsHistory(uid) {
            withdrawalsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--gold);">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª...</td></tr>';
            try {
                // ğŸŸ¢ 3. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ (limit)
                const q = query(collection(db, 'withdrawals'), where('userId', '==', uid), orderBy('date', 'desc'), limit(100));
                const snap = await getDocs(q);
                const withdrawals = snap.docs.map(d => d.data());
                
                withdrawalsCount.textContent = fmtNumber(withdrawals.length);
                
                if (withdrawals.length === 0) {
                    withdrawalsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø­Ø¨ Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                    return;
                }
                
                withdrawalsTbody.innerHTML = withdrawals.map(w => `
                    <tr>
                        <td>${fmtDate(w.date)}</td>
                        <td>${fmtCurrency(w.net)}</td>
                        <td>${fmtNumber(w.pts || w.points)}</td>
                        <td>${safe(w.method, 'N/A')}</td>
                        <td>${safe(w.wallet, 'N/A')}</td>
                        <td>${translateStatus(w.status)}</td>
                        <td style="font-size: 11px; color: ${safe(w.rejectionReason) !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? 'var(--red)' : 'var(--muted)'};">${safe(w.rejectionReason, 'N/A')}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error("Error loading withdrawals:", err);
                withdrawalsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--red);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª.</td></tr>';
            }
        }

        // =======================================================
        // 5. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ù…Ø¹ Ø§Ù„Ù…Ù„Ø®Øµ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª)
        // =======================================================
        async function loadPointsHistory(uid) {
            pointsHistoryTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--gold);">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù…...</td></tr>';
            pointsSummaryTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--gold);">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø®Øµ...</td></tr>';

            try {
                // ğŸŸ¢ 3. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ (limit)
                const q = query(collection(db, 'tasksCompleted'), where('userId', '==', uid), orderBy('date', 'desc'), limit(100));
                const snap = await getDocs(q);
                const history = snap.docs.map(d => d.data());
                
                if (history.length === 0) {
                    const noDataMsg = '<tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                    pointsHistoryTbody.innerHTML = noDataMsg;
                    pointsSummaryTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                    return;
                }

                // 1. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                const summary = history.reduce((acc, h) => {
                    const type = safe(h.taskType, 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                    const points = safe(h.pointsEarned, 0);

                    if (!acc[type]) {
                        acc[type] = { count: 0, points: 0 };
                    }
                    acc[type].count += 1;
                    acc[type].points += points;
                    return acc;
                }, {});
                
                // 2. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ
                pointsSummaryTbody.innerHTML = Object.entries(summary).map(([type, stats]) => {
                    const taskColor = colorMap[type.toLowerCase()] || "var(--text)"; // ğŸŸ¢ 4. Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                    return `
                        <tr>
                            <td style="font-weight: 700; color: ${taskColor};">${type}</td>
                            <td>${fmtNumber(stats.count)}</td>
                            <td style="color: var(--accent); font-weight: 700;">+${fmtNumber(stats.points)}</td>
                        </tr>
                    `;
                }).join('');

                // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ 
                pointsHistoryTbody.innerHTML = history.map(h => {
                    const type = safe(h.taskType, 'N/A');
                    const taskColor = colorMap[type.toLowerCase()] || "var(--text)"; // ğŸŸ¢ 4. Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                    return `
                        <tr>
                            <td>${fmtDate(h.date)}</td>
                            <td style="color: var(--accent); font-weight: 700;">+${fmtNumber(safe(h.pointsEarned, 0))}</td> 
                            <td>${safe(h.taskId, 'N/A')}</td>
                            <td style="color: ${taskColor}; font-weight: 700;">${type}</td> 
                        </tr>
                    `;
                }).join('');
                
                // ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                if (snap.docs.length >= 100) {
                     pointsHistoryTbody.innerHTML += `<tr><td colspan="4" style="text-align:center; color: var(--orange); font-style: italic;">*ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¢Ø®Ø± 100 Ø³Ø¬Ù„ Ù…Ù‡Ø§Ù… ÙÙ‚Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙŠØ²Ø© "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©.*</td></tr>`;
                }

            } catch (err) {
                console.error("Error loading tasks history:", err);
                pointsHistoryTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--red);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù….</td></tr>';
                pointsSummaryTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--red);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù‡Ø§Ù….</td></tr>';
            }
        }

        // =======================================================
        // 6. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø± (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ alert Ø¨Ù€ showToast)
        // =======================================================
        async function toggleBan() {
            if (!targetUID) return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯.", "var(--red)");
            
            const action = isUserBanned ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±" : "Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
            const newBanStatus = !isUserBanned;
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ: ${action}`)) return;

            banUnbanBtn.disabled = true;
            banUnbanBtn.textContent = `Ø¬Ø§Ø±ÙŠ ${action}...`;

            try {
                const userRef = doc(db, 'users', targetUID);
                await updateDoc(userRef, {
                    isBanned: newBanStatus,
                    bannedAt: newBanStatus ? Timestamp.fromDate(new Date()) : null,
                    bannedBy: newBanStatus ? (auth.currentUser ? auth.currentUser.uid : 'admin-web') : null 
                });
                
                showToast(`âœ… ØªÙ… ${action} Ø¨Ù†Ø¬Ø§Ø­.`, "var(--accent)"); // ğŸŸ¢ 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Toast
                
                await findUser(targetUID); 
                
            } catch (err) {
                console.error(`Error toggling ban status:`, err);
                showToast(`âŒ ÙØ´Ù„ ${action}. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ.`, "var(--red)"); // ğŸŸ¢ 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Toast
                banUnbanBtn.disabled = false;
                banUnbanBtn.textContent = isUserBanned ? 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            }
        }

        // =======================================================
        // Events
        // =======================================================
        searchBtn.addEventListener('click', () => {
            const queryValue = searchQueryInput.value.trim();
            if (queryValue) {
                findUser(queryValue);
            } else {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ UID Ø£Ùˆ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.", "var(--red)");
            }
        });
        
        // ğŸŸ¢ 1. Ø¥Ø¶Ø§ÙØ© ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Enter
        searchQueryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchBtn.click();
        });
        
        banUnbanBtn.addEventListener('click', toggleBan);
        
    </script>
</body>
</html>
