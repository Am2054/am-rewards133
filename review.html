<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø© â€” Ø¥Ø¯Ø§Ø±Ø© Am Rewards</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <style>
        /* ------------------------------------------- */
        /* ------------ Base Styles & Vars ----------- */
        /* ------------------------------------------- */
        :root{
            --bg:#070707; 
            --card:#1a1a1b;
            --gold:#f5c542; 
            --muted:#b0b7c0;
            --text:#eef2f7;
            --accent:#00fa9a;
            --blue:#3b82f6; 
            --red:#ef4444; 
            --orange:#f97316;
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }
        * {box-sizing:border-box;}
        body{
            font-family:"Cairo",sans-serif;
            background:linear-gradient(180deg,var(--bg),#0b0b0b);
            color:var(--text);
            margin:0;padding:20px;
        }
        .wrap{max-width:1000px;margin:0 auto;}
        
        /* ------------------------------------------- */
        /* ---------------- Cards & Inputs ----------- */
        /* ------------------------------------------- */
        .card{
            background:var(--card);
            padding:25px;
            border-radius:15px;
            border:1px solid rgba(245,197,66,0.15);
            box-shadow: var(--shadow);
            margin-bottom:25px;
            text-align: right;
        }
        .controls{display:flex;gap:15px;align-items:center;flex-wrap:wrap;}
        .controls input{
            flex-grow: 1;
            padding:12px 15px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,0.1);
            background:#262626;
            color:var(--text);
            outline:none;
        }
        .controls input:focus { border-color: var(--gold); box-shadow: 0 0 8px rgba(245, 197, 66, 0.5); }
        .btn-primary{background:var(--blue);border-color:var(--blue);font-weight:700; color: #fff; padding: 12px 20px; border-radius: 10px; border: 1px solid;}
        .btn-danger{background:var(--red);border-color:var(--red);font-weight:700; color: #fff; padding: 12px 20px; border-radius: 10px; border: 1px solid;}
        .btn-primary:hover, .btn-danger:hover {opacity: 0.9; transform: translateY(-1px);}

        h2 { color: var(--gold); border-bottom: 2px solid rgba(245, 197, 66, 0.3); padding-bottom: 8px; margin-top: 0; font-size: 20px; }

        /* ------------------------------------------- */
        /* ---------------- Data Rows ---------------- */
        /* ------------------------------------------- */
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 15px;
        }
        .data-row strong { color: var(--muted); }
        .data-row span { color: var(--text); font-weight: 700; }
        .data-row .status-badge { font-weight: 900; }
        .banned-status { color: var(--red) !important; font-weight: 900; }
        .active-status { color: var(--accent) !important; font-weight: 900; }

        /* ------------------------------------------- */
        /* ---------------- Tables ------------------- */
        /* ------------------------------------------- */
        .history-table-container{overflow:auto;margin-top:15px}
        .history-table{width:100%;border-collapse:collapse;min-width:700px; direction: rtl;}
        .history-table th, .history-table td{
            padding:10px 12px;
            text-align:right; 
            border-bottom:1px solid rgba(255,255,255,0.05);
            white-space: nowrap;
            font-size: 14px;
        }
        .history-table th{
            background:rgba(245,197,66,0.05);
            color:var(--gold);
            font-weight: 700;
            position: sticky; top: 0;
        }
        .status-pending{background:var(--orange);color:#000; padding:4px 8px; border-radius: 8px;}
        .status-completed{background:var(--accent);color:#000; padding:4px 8px; border-radius: 8px;}
        .status-rejected{background:var(--red);color:#fff; padding:4px 8px; border-radius: 8px;}
        
        #loadingMsg { text-align: center; color: var(--muted); padding: 20px; }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <h1 style="color:var(--gold); font-weight:900;">ğŸ‘¤ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</h1>
        </header>

        <div class="card">
            <div class="controls">
                <input id="searchQuery" placeholder="Ø£Ø¯Ø®Ù„ UID Ø£Ùˆ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
                <button id="searchBtn" class="btn-primary">ğŸ” Ø¨Ø­Ø«</button>
                <button id="banUnbanBtn" class="btn-danger" style="display:none;" disabled>ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            </div>
        </div>
        
        <div id="resultsArea" style="display:none;">
            
            <div class="card">
                <h2>ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
                <div id="basicData">
                    <div class="data-row"><strong>UID:</strong><span id="displayUid">N/A</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ø§Ø³Ù…:</strong><span id="displayName">N/A</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong><span id="displayEmail">N/A</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ):</strong><span id="displayPoints" style="color: var(--accent);">0</span></div>
                    <div class="data-row"><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±:</strong><span id="displayBanStatus" class="active-status">Ù†Ø´Ø·</span></div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ”— Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h2>
                <div id="referralData">
                    <div class="data-row"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©:</strong><span id="referralsCount" style="color: var(--blue);">0</span></div>
                    <div class="data-row"><strong>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø© Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª:</strong><span id="referralsPoints" style="color: var(--gold);">0</span></div>
                </div>
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                <th>Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ù„</th>
                                <th>ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</th> 
                                <th>UID Ø§Ù„Ù…Ø­Ø§Ù„</th>
                            </tr>
                        </thead>
                        <tbody id="referralTbody">
                            <tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <div class="card">
                <h2>ğŸ’¸ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (<span id="withdrawalsCount">0</span> Ø¹Ù…Ù„ÙŠØ©)</h2>
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº (EGP)</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTbody">
                            <tr><td colspan="7" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2>â­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h2>
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</th>
                                <th>UID Ø§Ù„Ù…Ù‡Ù…Ø©</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="pointsHistoryTbody">
                            <tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¬Ù„Ø©.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        
        <p id="loadingMsg" style="display:none;">... Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ...</p>
        <p id="errorMsg" style="text-align: center; color: var(--red); display: none;">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/UID Ø§Ù„Ù…Ø¯Ø®Ù„.</p>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
          getFirestore, collection, query, where, getDocs, orderBy, doc, updateDoc, Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // ============== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¯ÙŠÙƒ) ==============
        const firebaseConfig = {
            apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
            authDomain: "am--rewards.firebaseapp.com",
            databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
            projectId: "am--rewards",
            storageBucket: "am--rewards.firebasestorage.app",
            messagingSenderId: "744783579735",
            appId: "1:744783579735:web:45e00de9998893bbc9b112",
            measurementId: "G-CV3GLT2TTJ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ============== Ø«ÙˆØ§Ø¨Øª DOM ==============
        const searchQueryInput = document.getElementById('searchQuery');
        const searchBtn = document.getElementById('searchBtn');
        const banUnbanBtn = document.getElementById('banUnbanBtn');
        const resultsArea = document.getElementById('resultsArea');
        const loadingMsg = document.getElementById('loadingMsg');
        const errorMsg = document.getElementById('errorMsg');
        
        const displayUid = document.getElementById('displayUid');
        const displayName = document.getElementById('displayName');
        const displayEmail = document.getElementById('displayEmail');
        const displayPoints = document.getElementById('displayPoints');
        const displayBanStatus = document.getElementById('displayBanStatus');
        
        // Referral DOM elements
        const referralsCount = document.getElementById('referralsCount');
        const referralsPoints = document.getElementById('referralsPoints');
        const referralTbody = document.getElementById('referralTbody');

        const withdrawalsCount = document.getElementById('withdrawalsCount');
        const withdrawalsTbody = document.getElementById('withdrawalsTbody');
        const pointsHistoryTbody = document.getElementById('pointsHistoryTbody');

        // State
        let targetUID = null;
        let isUserBanned = false;
        
        // ============== Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¶Ø§ÙØ© (safe function) ==============
        const safe = (v, fallback = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯") => {
            if (v === null || v === undefined) {
                return fallback;
            }
            // Ù„ØªØ­ÙˆÙŠÙ„ timestamp Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø¢Ù…Ù†
            if (v.toDate && typeof v.toDate === 'function') {
                return v.toDate();
            }
            return v;
        };

        // Helpers
        function toDateSafe(ts) {
            const date = safe(ts);
            if (date instanceof Date) return date;
            if (date.seconds) return new Date(date.seconds * 1000);
            return null;
        }
        function fmtCurrency(n) {
            return Number(safe(n, 0)).toLocaleString('ar-EG', {minimumFractionDigits:2});
        }
        function fmtNumber(n) { return Number(safe(n, 0)).toLocaleString('en-US'); }
        function fmtDate(ts) {
            const date = toDateSafe(ts);
            return date ? date.toLocaleString('ar-EG', {day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'N/A';
        }
        function translateStatus(status) {
            status = (safe(status, '')).toString().toLowerCase();
            if (status === 'pending') return `<span class="status-pending">Ù…Ø¹Ù„Ù‘Ù‚</span>`;
            if (status === 'completed') return `<span class="status-completed">Ù…ÙƒØªÙ…Ù„</span>`;
            if (status === 'rejected') return `<span class="status-rejected">Ù…Ø±ÙÙˆØ¶</span>`;
            return status || 'N/A';
        }

        // =======================================================
        // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID/Email)
        // =======================================================
        async function findUser(queryValue) {
            resultsArea.style.display = 'none';
            errorMsg.style.display = 'none';
            loadingMsg.style.display = 'block';
            banUnbanBtn.style.display = 'none';

            let userQuery;
            if (queryValue.includes('@') && queryValue.includes('.')) {
                userQuery = query(collection(db, 'users'), where('email', '==', queryValue));
            } else { 
                userQuery = query(collection(db, 'users'), where('__name__', '==', queryValue));
            }

            try {
                const userSnap = await getDocs(userQuery);
                if (userSnap.empty) {
                    loadingMsg.style.display = 'none';
                    errorMsg.style.display = 'block';
                    targetUID = null;
                    return null;
                }
                
                const userDoc = userSnap.docs[0];
                targetUID = userDoc.id;
                const userData = userDoc.data();
                
                // Show Basic Data
                displayBasicData(userData);
                
                // Load detailed history concurrently
                await Promise.all([
                    loadWithdrawalsHistory(targetUID),
                    loadPointsHistory(targetUID),
                    loadReferralHistory(targetUID)
                ]);
                
                loadingMsg.style.display = 'none';
                resultsArea.style.display = 'block';

            } catch (err) {
                console.error("Error finding user:", err);
                loadingMsg.style.display = 'none';
                errorMsg.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}`;
                errorMsg.style.display = 'block';
                targetUID = null;
            }
        }

        // =======================================================
        // 2. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // =======================================================
        function displayBasicData(userData) {
            const isBanned = safe(userData.isBanned, false);
            isUserBanned = isBanned;
            
            displayUid.textContent = targetUID;
            displayName.textContent = safe(userData.name, 'ØºÙŠØ± Ù…ØªÙˆÙØ±');
            displayEmail.textContent = safe(userData.email, 'ØºÙŠØ± Ù…ØªÙˆÙØ±');
            displayPoints.textContent = fmtNumber(userData.points);
            
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            referralsCount.textContent = fmtNumber(userData.referralCount);
            referralsPoints.textContent = fmtNumber(userData.referralPoints);


            if (isBanned) {
                displayBanStatus.textContent = 'Ù…Ø­Ø¸ÙˆØ± ğŸš«';
                displayBanStatus.className = 'banned-status';
                banUnbanBtn.textContent = 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±';
                banUnbanBtn.classList.remove('btn-danger');
                banUnbanBtn.classList.add('btn-primary');
            } else {
                displayBanStatus.textContent = 'Ù†Ø´Ø·';
                displayBanStatus.className = 'active-status';
                banUnbanBtn.textContent = 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                banUnbanBtn.classList.remove('btn-primary');
                banUnbanBtn.classList.add('btn-danger');
            }
            banUnbanBtn.disabled = false;
            banUnbanBtn.style.display = 'inline-block';
        }

        // =======================================================
        // 3. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (referralLogs) - ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯
        // =======================================================
        async function loadReferralHistory(uid) {
            const referralTbody = document.getElementById('referralTbody');
            referralTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--gold);">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

            try {
                // ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ referrerUid
                const referredSnap = await getDocs(query(
                    collection(db, "referralLogs"), 
                    where("referrerUid", "==", uid),
                    orderBy('date', 'desc') 
                ));

                if (referredSnap.empty) {
                    referralTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.</td></tr>';
                    return;
                }

                referralTbody.innerHTML = referredSnap.docs.map(d => {
                    const data = d.data();
                    return `
                        <tr>
                            <td>${fmtDate(data.date)}</td>
                            <td>${safe(data.email, 'N/A')}</td>
                            <td>${safe(data.referralCode, 'N/A')}</td>
                            <td style="font-size: 10px;">${safe(data.referredUid, 'N/A')}</td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error("Error loading referral data:", err);
                referralTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--red);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª.</td></tr>';
            }
        }


        // =======================================================
        // 4. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (withdrawals)
        // =======================================================
        async function loadWithdrawalsHistory(uid) {
            withdrawalsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--gold);">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª...</td></tr>';
            try {
                const q = query(collection(db, 'withdrawals'), where('userId', '==', uid), orderBy('date', 'desc'));
                const snap = await getDocs(q);
                const withdrawals = snap.docs.map(d => d.data());
                
                withdrawalsCount.textContent = fmtNumber(withdrawals.length);
                
                if (withdrawals.length === 0) {
                    withdrawalsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø­Ø¨ Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                    return;
                }
                
                withdrawalsTbody.innerHTML = withdrawals.map(w => `
                    <tr>
                        <td>${fmtDate(w.date)}</td>
                        <td>${fmtCurrency(w.net)}</td>
                        <td>${fmtNumber(w.pts || w.points)}</td>
                        <td>${safe(w.method, 'N/A')}</td>
                        <td>${safe(w.wallet, 'N/A')}</td>
                        <td>${translateStatus(w.status)}</td>
                        <td style="font-size: 11px; color: ${safe(w.rejectionReason) !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? 'var(--red)' : 'var(--muted)'};">${safe(w.rejectionReason, 'N/A')}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error("Error loading withdrawals:", err);
                withdrawalsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--red);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª.</td></tr>';
            }
        }

        // =======================================================
        // 5. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (tasksCompleted) - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        // =======================================================
        async function loadPointsHistory(uid) {
            pointsHistoryTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--gold);">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù…...</td></tr>';
            try {
                // ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ userId
                const q = query(collection(db, 'tasksCompleted'), where('userId', '==', uid), orderBy('date', 'desc'));
                const snap = await getDocs(q);
                const history = snap.docs.map(d => d.data());
                
                if (history.length === 0) {
                    pointsHistoryTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                    return;
                }
                
                pointsHistoryTbody.innerHTML = history.map(h => `
                    <tr>
                        <td>${fmtDate(h.date)}</td>
                        <td style="color: var(--accent); font-weight: 700;">+${fmtNumber(safe(h.pointsEarned, 0))}</td> <td>${safe(h.taskId, 'N/A')}</td>
                        <td>${safe(h.taskType, 'N/A')}</td> 
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error("Error loading tasks history:", err);
                pointsHistoryTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--red);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù….</td></tr>';
            }
        }

        // =======================================================
        // 6. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±
        // =======================================================
        async function toggleBan() {
            if (!targetUID) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯.");
            
            const action = isUserBanned ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±" : "Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
            const newBanStatus = !isUserBanned;
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ: ${action}`)) return;

            banUnbanBtn.disabled = true;
            banUnbanBtn.textContent = `Ø¬Ø§Ø±ÙŠ ${action}...`;

            try {
                const userRef = doc(db, 'users', targetUID);
                await updateDoc(userRef, {
                    isBanned: newBanStatus,
                    bannedAt: newBanStatus ? Timestamp.fromDate(new Date()) : null,
                    bannedBy: newBanStatus ? (auth.currentUser ? auth.currentUser.uid : 'admin-web') : null 
                });
                
                alert(`ØªÙ… ${action} Ø¨Ù†Ø¬Ø§Ø­.`);
                
                await findUser(targetUID); 
                
            } catch (err) {
                console.error(`Error toggling ban status:`, err);
                alert(`âŒ ÙØ´Ù„ ${action}. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ (Console Ù„Ù„Ù…Ø²ÙŠØ¯).`);
                banUnbanBtn.disabled = false;
                banUnbanBtn.textContent = isUserBanned ? 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            }
        }

        // =======================================================
        // Events
        // =======================================================
        searchBtn.addEventListener('click', () => {
            const queryValue = searchQueryInput.value.trim();
            if (queryValue) {
                findUser(queryValue);
            } else {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ UID Ø£Ùˆ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
            }
        });
        
        banUnbanBtn.addEventListener('click', toggleBan);
        
    </script>
</body>
</html>
