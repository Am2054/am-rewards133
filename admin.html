<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
        --color-primary: #f5c542; 
        --color-secondary: #00fa9a; 
        --color-danger: #ff6b6b; 
        --color-background: #0b0b0b;
        --color-card-bg: #1a1a1a;
        --text-light: #f0f2f5;
        --text-muted: #999;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    * {box-sizing: border-box;}
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background-color: var(--color-background);
      color: var(--text-light);
      min-height: 100vh;
      direction: rtl;
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px; }
    header {
      background-color: var(--color-card-bg);
      padding: 15px 20px;
      text-align: center;
      font-size: 1.8em;
      font-weight: 900;
      color: var(--color-primary);
      box-shadow: var(--shadow);
      border-radius: 15px;
      margin-bottom: 30px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }
    .card {
      background: var(--color-card-bg);
      border: 1px solid rgba(245, 197, 66, 0.4);
      border-radius: 15px;
      padding: 20px;
      text-align: right;
      box-shadow: 0 0 10px rgba(245, 197, 66, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .card::before { 
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0;
        width: 5px;
        background-color: var(--color-primary);
        border-radius: 0 15px 15px 0;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(245, 197, 66, 0.3);
    }
    .card h3 {
      margin-bottom: 15px;
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 400;
    }
    .card .main-value {
      font-size: 1.8em;
      font-weight: 900;
      color: var(--text-light);
      font-family: 'Montserrat', sans-serif;
      text-shadow: 0 0 8px rgba(245, 197, 66, 0.6);
      margin-bottom: 5px;
      /* ğŸ’¡ Ø¥Ø¶Ø§ÙØ©: ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙˆÙ‡Ø¬ */
      animation: glow 2s infinite alternate; 
    }
    @keyframes glow { 
        from { text-shadow: 0 0 8px rgba(245,197,66,0.4); }
        to { text-shadow: 0 0 20px rgba(245,197,66,0.9); }
    }
    .card .sub-value {
        display: block;
        font-size: 1em;
        color: var(--color-primary);
        font-weight: 700;
        font-family: 'Cairo', sans-serif;
    }
    .card.secondary { border-color: var(--color-secondary); }
    .card.secondary::before { background-color: var(--color-secondary); }
    .card.secondary .main-value { color: var(--color-secondary); text-shadow: 0 0 8px rgba(0, 250, 154, 0.6); }
    .card.danger { border-color: var(--color-danger); }
    .card.danger::before { background-color: var(--color-danger); }
    .card.danger .main-value { color: var(--color-danger); text-shadow: 0 0 8px rgba(255, 107, 107, 0.6); }
    .btn-container { text-align: center; margin: 30px 0; }
    .btn {
      background-color: var(--color-primary);
      color: var(--color-card-bg);
      border: none;
      padding: 12px 25px;
      font-size: 1em;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
      font-weight: 700;
    }
    .btn:hover { background-color: var(--text-light); transform: scale(1.05); }
    footer {
      text-align: center;
      padding: 15px;
      background-color: #111;
      color: #666;
      font-size: 0.9em;
      margin-top: 40px;
    }
    .error-message {
        color: var(--color-danger);
        font-weight: 700;
        text-align: center;
        padding: 10px;
        margin: 20px 0;
        border: 1px solid var(--color-danger);
        border-radius: 8px;
        background-color: rgba(255, 107, 107, 0.1);
    }
    #login-container {
        max-width: 400px; margin: 50px auto; padding: 30px; background-color: var(--color-card-bg);
        border-radius: 15px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--color-primary);
    }
    #login-container h2 { color: var(--color-primary); margin-bottom: 20px; font-weight: 700; }
    #login-container input {
        width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #444; background-color: #222;
        color: var(--text-light); border-radius: 8px;
    }
    #login-container button {
        width: 100%; padding: 12px; background-color: var(--color-secondary); color: #000; border: none;
        border-radius: 8px; cursor: pointer; font-weight: 700; transition: background 0.2s;
    }
    #login-container button:hover { background-color: var(--color-primary); }
    #loading-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9);
        color: var(--color-primary); display: flex; justify-content: center; align-items: center;
        flex-direction: column; z-index: 1000; font-size: 1.5em; font-weight: 700; transition: opacity 0.5s;
    }
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid var(--color-primary);
        border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...</p>
</div>

<div class="wrap">
    
    <div id="login-container" class="hidden">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ± ğŸ”’</h2>
        <input type="email" id="adminEmailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value="amirfg992005@gmail.com" required>
        <input type="password" id="adminPasswordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
        <button id="loginButton">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <p id="loginError" class="error-message hidden" style="margin-top: 15px;"></p>
    </div>

    <div id="dashboard-content" class="hidden">
        <header>
            Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Am Rewards ğŸ‘‘
        </header>

        <section class="dashboard">
            
            <div class="card secondary">
                <h3>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ</h3>
                <p id="totalUsers" class="main-value">0</p>
            </div>

            <div class="card">
                <h3>âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h3>
                <p id="totalCompletedTasks" class="main-value">0</p>
                </div>
            
            <div class="card">
                <h3>ğŸ”— Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h3>
                <p id="referrals" class="main-value">0</p>
            </div>

            <div class="card">
                <h3>ğŸŒŸ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h3>
                <p id="referralPoints" class="main-value">0</p>
                <span id="referralPointsEGP" class="sub-value">0 EGP</span>
            </div>

            <div class="card">
                <h3>ğŸ’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠØ©</h3>
                <p id="totalPoints" class="main-value">0</p>
                <span id="totalPointsEGPEl" class="sub-value">0 EGP</span>
            </div>

            <div class="card danger">
                <h3>ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© (Ø§Ù„ÙƒÙ„)</h3>
                <p id="totalWithdrawn" class="main-value">0 EGP</p>
                </div>

            <div class="card danger">
                <h3>â³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
                <p id="pendingWithdrawals" class="main-value">0</p>
            </div>
        </section>
        
        <div class="btn-container">
            <button class="btn" onclick="location.href='users.html'">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
            <button class="btn" onclick="location.href='tasksDone.html'">ğŸ§¾ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
            <button class="btn" onclick="location.href='referralsAdmin.html'">ğŸ”— Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</button>
            <button class="btn" onclick="location.href='withdrawalsAdmin.html'">ğŸ’° Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</button>
            <button class="btn" onclick="location.href='review.html'">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ù‡</button>
        </div>
    </div>
</div>

<footer>
    Â© 2025 Am Rewards â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø§ØµØ©
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
    // ğŸ›‘ **1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase**
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.firebasestorage.app",
      messagingSenderId: "744783579735",
      appId: "1:744783579735:web:45e00de9998893bbc9b112",
      measurementId: "G-CV3GLT2TTJ"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // **2. Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª**
    const adminEmail = "amirfg992005@gmail.com"; 
    const POINT_VALUE_EGP = 0.07; 

    // **3. Ø¹Ù†Ø§ØµØ± DOM**
    const loadingOverlay = document.getElementById('loading-overlay');
    const loginContainer = document.getElementById('login-container');
    const dashboardContent = document.getElementById('dashboard-content');
    const loginButton = document.getElementById('loginButton');
    const adminEmailInput = document.getElementById('adminEmailInput');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const loginError = document.getElementById('loginError');

    const totalUsersEl = document.getElementById("totalUsers");
    const totalCompletedTasksEl = document.getElementById("totalCompletedTasks"); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©
    const referralsEl = document.getElementById('referrals');
    const referralPointsEl = document.getElementById('referralPoints');
    const referralPointsEGPEl = document.getElementById('referralPointsEGP');
    const totalPointsEl = document.getElementById('totalPoints');
    const totalPointsEGPEl = document.getElementById('totalPointsEGPEl');
    const totalWithdrawnEl = document.getElementById('totalWithdrawn');
    const pendingWithdrawalsEl = document.getElementById('pendingWithdrawals');


    // ğŸ’¡ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    function formatNumber(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    function formatEGP(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 2 }) + " EGP";
    }
    
    function showLoading() {
        loadingOverlay.classList.remove('hidden');
    }
    function hideLoading() {
        loadingOverlay.classList.add('hidden');
    }
    
    function displayError(message) {
        const existingError = document.querySelector('.error-message');
        if (existingError) existingError.remove();

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `âŒ ${message}`;
        document.querySelector('.wrap').prepend(errorDiv);
        
        const errorText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
        totalUsersEl.textContent = errorText;
        totalCompletedTasksEl.textContent = errorText;
        referralsEl.textContent = errorText;
        referralPointsEl.textContent = errorText;
        referralPointsEGPEl.textContent = errorText;
        totalPointsEl.textContent = errorText;
        totalPointsEGPEl.textContent = errorText;
        totalWithdrawnEl.textContent = errorText;
        pendingWithdrawalsEl.textContent = errorText;
    }

    // **4. Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„**
    async function handleLogin() {
        const email = adminEmailInput.value;
        const password = adminPasswordInput.value;
        
        if (email !== adminEmail) {
            loginError.textContent = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù‡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ±.";
            loginError.classList.remove('hidden');
            return;
        }

        try {
            loginButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            loginButton.disabled = true;
            showLoading();
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error("Login error:", error);
            loginButton.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            loginButton.disabled = false;
            hideLoading();
            
            let errorMessage = "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
            if (error.code === 'auth/wrong-password') {
                errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
            } else if (error.code === 'auth/user-not-found') {
                errorMessage = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
            }
            loginError.textContent = errorMessage;
            loginError.classList.remove('hidden');
        }
    }


    // **5. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©)**
    async function loadDashboardData() {
        try {
            showLoading(); 
            
            // âš¡ï¸ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ
            const [
                usersSnap,
                tasksCompletedSnap,
                completedWithdrawalsSnap,
                pendingWithdrawalsSnap
            ] = await Promise.all([
                getDocs(collection(db, "users")),
                getDocs(collection(db, "tasksCompleted")), 
                getDocs(query(collection(db, "withdrawals"), where("status", "==", "completed"))),
                getDocs(query(collection(db, "withdrawals"), where("status", "==", "pending")))
            ]);


            // --- 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
            let totalReferralsCount = 0;
            let totalReferralPoints = 0;
            let totalPoints = 0; 

            usersSnap.forEach(doc => {
                const data = doc.data();
                
                totalReferralsCount += Number(data.referralCount || 0) || 0;
                totalReferralPoints += Number(data.referralPoints || 0) || 0;
                totalPoints += Number(data.points || 0) || 0; 
            });

            // --- 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© ---
            
            // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ
            totalUsersEl.textContent = formatNumber(usersSnap.size);

            // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø© (Ù…Ù† tasksCompleted)
            totalCompletedTasksEl.textContent = formatNumber(tasksCompletedSnap.size);

            // Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
            referralsEl.textContent = formatNumber(totalReferralsCount);

            // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù€ EGP)
            referralPointsEl.textContent = formatNumber(totalReferralPoints);
            referralPointsEGPEl.textContent = formatEGP(Number(totalReferralPoints || 0) * POINT_VALUE_EGP); 

            // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠØ© (Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù€ EGP)
            totalPointsEl.textContent = formatNumber(totalPoints);
            totalPointsEGPEl.textContent = formatEGP(Number(totalPoints || 0) * POINT_VALUE_EGP); 


            // --- 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ---
            let totalWithdrawnAmount = 0; 
            completedWithdrawalsSnap.forEach(doc => {
                const netAmount = doc.data().net ? Number(doc.data().net) : 0;
                totalWithdrawnAmount += netAmount;
            });
            totalWithdrawnEl.textContent = formatEGP(totalWithdrawnAmount);
            
            
            // --- 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ---
            pendingWithdrawalsEl.textContent = formatNumber(pendingWithdrawalsSnap.size);
            
            
            hideLoading(); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ

        } catch (err) {
            console.error("FATAL ERROR in loadDashboardData:", err);
            displayError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ù‚Ø§ØªÙ„ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Console.");
            hideLoading(); 
        }
    }

    // **6. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„**
    onAuthStateChanged(auth, async (user) => {
        if (user && user.email === adminEmail) {
            loginContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            await loadDashboardData();
        } else {
            loginContainer.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            if (user) await signOut(auth);
            hideLoading();
        }
    });
    
    // Ø±Ø¨Ø· Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
    loginButton.addEventListener('click', handleLogin);
    
    document.addEventListener('DOMContentLoaded', () => {
        hideLoading(); 
    });
</script>
</body>
</html>
