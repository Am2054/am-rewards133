<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>لوحة الإدارة | Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  
  <style>
    /* --- المتغيرات والتصميم --- */
    :root {
        --color-primary: #f5c542; 
        --color-secondary: #00fa9a; 
        --color-danger: #ff6b6b; 
        --color-background: #0b0b0b;
        --color-card-bg: #1a1a1a;
        --text-light: #f0f2f5;
        --text-muted: #999;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    /* --- الهيكل الأساسي --- */
    * {box-sizing: border-box;}
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background-color: var(--color-background);
      color: var(--text-light);
      min-height: 100vh;
      direction: rtl;
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px; }

    header {
      background-color: var(--color-card-bg);
      padding: 15px 20px;
      text-align: center;
      font-size: 1.8em;
      font-weight: 900;
      color: var(--color-primary);
      box-shadow: var(--shadow);
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    /* --- أقسام الإحصائيات (Grid) --- */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    /* --- بطاقات الإحصائيات الفردية --- */
    .card {
      background: var(--color-card-bg);
      border: 1px solid rgba(245, 197, 66, 0.4);
      border-radius: 15px;
      padding: 20px;
      text-align: right;
      box-shadow: 0 0 10px rgba(245, 197, 66, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .card::before { 
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0;
        width: 5px;
        background-color: var(--color-primary);
        border-radius: 0 15px 15px 0;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(245, 197, 66, 0.3);
    }

    .card h3 {
      margin-bottom: 15px;
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .card .main-value {
      font-size: 1.8em;
      font-weight: 900;
      color: var(--text-light);
      font-family: 'Montserrat', sans-serif;
      text-shadow: 0 0 8px rgba(245, 197, 66, 0.6);
      margin-bottom: 5px;
    }
    .card .sub-value {
        display: block;
        font-size: 1em;
        color: var(--color-primary);
        font-weight: 700;
        font-family: 'Cairo', sans-serif;
    }
    
    /* --- تعديلات الألوان للبطاقات الهامة --- */
    .card.secondary { border-color: var(--color-secondary); }
    .card.secondary::before { background-color: var(--color-secondary); }
    .card.secondary .main-value { color: var(--color-secondary); text-shadow: 0 0 8px rgba(0, 250, 154, 0.6); }

    .card.danger { border-color: var(--color-danger); }
    .card.danger::before { background-color: var(--color-danger); }
    .card.danger .main-value { color: var(--color-danger); text-shadow: 0 0 8px rgba(255, 107, 107, 0.6); }

    /* --- أزرار التوجيه (Buttons) --- */
    .btn-container {
      text-align: center;
      margin: 30px 0;
    }

    .btn {
      background-color: var(--color-primary);
      color: var(--color-card-bg);
      border: none;
      padding: 12px 25px;
      font-size: 1em;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
      font-weight: 700;
    }

    .btn:hover {
      background-color: var(--text-light);
      transform: scale(1.05);
    }

    /* --- Footers --- */
    footer {
      text-align: center;
      padding: 15px;
      background-color: #111;
      color: #666;
      font-size: 0.9em;
      margin-top: 40px;
    }
    
    .error-message {
        color: var(--color-danger);
        font-weight: 700;
        text-align: center;
        padding: 10px;
        margin: 20px 0;
        border: 1px solid var(--color-danger);
        border-radius: 8px;
        background-color: rgba(255, 107, 107, 0.1);
    }
  </style>
</head>
<body>

<div class="wrap">
    <header>
        لوحة إدارة Am Rewards 👑
    </header>

    <section class="dashboard">
        
        <div class="card secondary">
            <h3>👥 عدد المستخدمين الكلي</h3>
            <p id="totalUsers" class="main-value">0</p>
        </div>

        <div class="card secondary">
            <h3>🏃‍♂️ عدد المستخدمين النشطين (آخر 7 أيام)</h3>
            <p id="activeUsers" class="main-value">0</p>
        </div>
        
        <div class="card">
            <h3>🧾 إجمالي النقاط من المهام المنجزة</h3>
            <p id="totalTaskPoints" class="main-value">0</p>
            <span id="totalTaskPointsEGP" class="sub-value">0 EGP</span>
        </div>
        
        <div class="card">
            <h3>🔗 عدد الإحالات</h3>
            <p id="referrals" class="main-value">0</p>
        </div>

        <div class="card">
            <h3>🌟 مجموع النقاط من الإحالات</h3>
            <p id="referralPoints" class="main-value">0</p>
            <span id="referralPointsEGP" class="sub-value">0 EGP</span>
        </div>

        <div class="card">
            <h3>💎 إجمالي نقاط المستخدمين الكلية</h3>
            <p id="totalPoints" class="main-value">0</p>
            <span id="totalPointsEGP" class="sub-value">0 EGP</span>
        </div>

        <div class="card danger">
            <h3>💸 إجمالي المبالغ المسحوبة (الكل)</h3>
            <p id="totalWithdrawn" class="main-value">0 EGP</p>
        </div>

        <div class="card">
            <h3>💵 المبالغ المسحوبة اليوم</h3>
            <p id="withdrawTodayPoints" class="main-value">0 نقطة</p>
            <span id="withdrawTodayEGP" class="sub-value">0 EGP</span>
        </div>

        <div class="card danger">
            <h3>⏳ طلبات السحب المعلقة</h3>
            <p id="pendingWithdrawals" class="main-value">0</p>
        </div>
    </section>
    
    <div class="btn-container">
        <button class="btn" onclick="location.href='users.html'">👥 المستخدمين</button>
        <button class="btn" onclick="location.href='tasks.html'">🧾 المهام</button>
        <button class="btn" onclick="location.href='referrals.html'">🔗 الإحالات</button>
        <button class="btn" onclick="location.href='withdrawals.html'">💰 السحوبات</button>
        <button class="btn" onclick="location.href='pending.html'">⏳ المعلقة</button>
    </div>

</div>

<footer>
    © 2025 Am Rewards — لوحة الإدارة الخاصة
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
    // 🛑 **1. إعدادات Firebase**
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // **2. الثوابت والمتغيرات**
    const adminEmail = "amirfg992005@gmail.com"; 
    const POINT_VALUE_EGP = 0.07; 
    const ACTIVE_USERS_THRESHOLD = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000); // آخر 7 أيام

    // **3. عناصر DOM**
    const totalUsersEl = document.getElementById("totalUsers");
    const activeUsersEl = document.getElementById("activeUsers");
    const totalTaskPointsEl = document.getElementById("totalTaskPoints");
    const totalTaskPointsEGPEl = document.getElementById("totalTaskPointsEGP");
    const referralsEl = document.getElementById('referrals');
    const referralPointsEl = document.getElementById('referralPoints');
    const referralPointsEGPEl = document.getElementById('referralPointsEGP');
    const totalPointsEl = document.getElementById('totalPoints');
    const totalPointsEGPEl = document.getElementById('totalPointsEGP');
    const totalWithdrawnEl = document.getElementById('totalWithdrawn');
    const withdrawTodayPointsEl = document.getElementById("withdrawTodayPoints");
    const withdrawTodayEGPEl = document.getElementById("withdrawTodayEGP");
    const pendingWithdrawalsEl = document.getElementById('pendingWithdrawals');


    // 💡 دوال مساعدة
    function formatNumber(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    function formatEGP(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 2 }) + " EGP";
    }
    function getTodayStart() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today;
    }
    function displayError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `❌ ${message}`;
        document.querySelector('.wrap').prepend(errorDiv);
        
        const errorText = "خطأ في التحميل";
        totalUsersEl.textContent = errorText;
        activeUsersEl.textContent = errorText;
        totalTaskPointsEl.textContent = errorText;
        totalTaskPointsEGPEl.textContent = errorText;
        referralsEl.textContent = errorText;
        referralPointsEl.textContent = errorText;
        referralPointsEGPEl.textContent = errorText;
        totalPointsEl.textContent = errorText;
        totalPointsEGPEl.textContent = errorText;
        totalWithdrawnEl.textContent = errorText;
        withdrawTodayPointsEl.textContent = errorText;
        withdrawTodayEGPEl.textContent = errorText;
        pendingWithdrawalsEl.textContent = errorText;
    }

    // **4. جلب بيانات لوحة التحكم (الدالة الرئيسية)**
    async function loadDashboardData() {
      try {
        const todayStart = getTodayStart();
        
        // جلب بيانات جميع المستخدمين
        const usersSnap = await getDocs(collection(db, "users"));
        totalUsersEl.textContent = formatNumber(usersSnap.size);

        let totalReferralsCount = 0;
        let totalReferralPoints = 0;
        let totalWithdrawnAmount = 0;
        let totalPoints = 0; // إجمالي النقاط الكلية المتبقية في حسابات المستخدمين
        let totalTaskPoints = 0; // إجمالي النقاط التي حصل عليها المستخدمون من المهام
        let activeUsersCount = 0;

        // 🛑 الملاحظة الهامة: نفترض وجود حقول tasksPoints و referralPoints في وثيقة المستخدمين
        // إذا لم تكن موجودة، سيتم حساب tasksPoints تقديرياً من totalPoints - referralPoints
        usersSnap.forEach(doc => {
            const data = doc.data();
            
            totalReferralsCount += Number(data.referralCount || 0);
            totalReferralPoints += Number(data.referralPoints || 0); // مجموع نقاط الإحالات
            totalWithdrawnAmount += Number(data.totalWithdrawn || 0); 
            totalPoints += Number(data.points || 0); // النقاط المتبقية الكلية
            
            // حساب النقاط الكلية من المهام
            totalTaskPoints += Number(data.tasksPoints || 0); 
            
            // حساب المستخدمين النشطين
            if (data.lastLogin && data.lastLogin.toDate && data.lastLogin.toDate() >= ACTIVE_USERS_THRESHOLD) {
                activeUsersCount++;
            }
        });
        
        // إذا لم نجد حقل tasksPoints، نحاول حسابه بالمنطق التالي:
        if (totalTaskPoints === 0 && totalPoints > 0) {
            totalTaskPoints = totalPoints - totalReferralPoints; 
            if (totalTaskPoints < 0) totalTaskPoints = 0;
        }


        // تحديث الإحصائيات الشاملة (القيم المزدوجة)
        activeUsersEl.textContent = formatNumber(activeUsersCount);
        referralsEl.textContent = formatNumber(totalReferralsCount);

        // إجمالي النقاط من المهام المنجزة
        totalTaskPointsEl.textContent = formatNumber(totalTaskPoints);
        totalTaskPointsEGPEl.textContent = formatEGP(totalTaskPoints * POINT_VALUE_EGP);
        
        // مجموع النقاط من الإحالات
        referralPointsEl.textContent = formatNumber(totalReferralPoints);
        referralPointsEGPEl.textContent = formatEGP(totalReferralPoints * POINT_VALUE_EGP);
        
        // إجمالي نقاط المستخدمين الكلية (المتبقية)
        totalPointsEl.textContent = formatNumber(totalPoints);
        totalPointsEGPEl.textContent = formatEGP(totalPoints * POINT_VALUE_EGP);

        // إجمالي المبالغ المسحوبة
        totalWithdrawnEl.textContent = formatEGP(totalWithdrawnAmount);


        // طلبات السحب اليوم والمعلقة
        const withdrawTodayQuery = query(
          collection(db, "withdrawals"), 
          where("createdAt", ">=", todayStart),
          where("status", "in", ["pending", "completed"])
        );
        const withdrawTodaySnap = await getDocs(withdrawTodayQuery);
        
        let totalWithdrawnTodayPoints = 0;
        let pendingRequestsCount = 0;
        
        withdrawTodaySnap.forEach(doc => {
            const req = doc.data();
            const points = Number(req.points || 0);
            if (req.status === 'pending') {
                pendingRequestsCount++; 
            }
            totalWithdrawnTodayPoints += points;
        });
        
        // تحديث إحصائيات السحب اليوم
        const totalWithdrawnTodayEGP = totalWithdrawnTodayPoints * POINT_VALUE_EGP;
        withdrawTodayPointsEl.textContent = formatNumber(totalWithdrawnTodayPoints) + " نقطة";
        withdrawTodayEGPEl.textContent = formatEGP(totalWithdrawnTodayEGP);
        pendingWithdrawalsEl.textContent = formatNumber(pendingRequestsCount);

      } catch (err) {
        console.error("Error loading dashboard:", err);
        displayError("حدث خطأ في تحميل البيانات الرئيسية. تأكد من إعدادات Firebase والاتصال بالإنترنت.");
      }
    }
    
    // **5. منطق التحقق من الصلاحيات والتحميل**
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            displayError("غير مصرح لك بالدخول. الرجاء تسجيل الدخول أولاً كمدير.");
            return;
        }

        if (user.email !== adminEmail) {
            displayError("غير مصرح لك بالدخول. الإيميل المستخدم ليس إيميل المدير.");
            await signOut(auth);
            return;
        }
        
        // إذا كان مسجل الدخول وهو المدير
        loadDashboardData();
    });
</script>
</body>
</html>
