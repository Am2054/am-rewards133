<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  
  <style>
    /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… --- */
    :root {
        --color-primary: #f5c542; /* Ø§Ù„Ø°Ù‡Ø¨ÙŠ/Ø§Ù„Ø£ØµÙØ± Ø§Ù„Ù…Ù…ÙŠØ² */
        --color-secondary: #00fa9a; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Øª */
        --color-danger: #ff6b6b; /* Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·ÙˆØ±Ø© */
        --color-background: #0b0b0b;
        --color-card-bg: #1a1a1a;
        --text-light: #f0f2f5;
        --text-muted: #999;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    /* --- Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ --- */
    * {box-sizing: border-box;}
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background-color: var(--color-background);
      color: var(--text-light);
      min-height: 100vh;
      direction: rtl;
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px; }

    header {
      background-color: var(--color-card-bg);
      padding: 15px 20px;
      text-align: center;
      font-size: 1.8em;
      font-weight: 900;
      color: var(--color-primary);
      box-shadow: var(--shadow);
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    /* --- Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Grid) --- */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    /* --- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© --- */
    .card {
      background: var(--color-card-bg);
      border: 1px solid rgba(245, 197, 66, 0.4);
      border-radius: 15px;
      padding: 20px;
      text-align: right;
      box-shadow: 0 0 10px rgba(245, 197, 66, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .card::before { /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ù…Ù…ÙŠØ² */
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0;
        width: 5px;
        background-color: var(--color-primary);
        border-radius: 0 15px 15px 0;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(245, 197, 66, 0.3);
    }

    .card h3 {
      margin-bottom: 15px;
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .card p {
      font-size: 2em;
      font-weight: 900;
      color: var(--text-light);
      font-family: 'Montserrat', sans-serif;
      text-shadow: 0 0 8px rgba(245, 197, 66, 0.6);
    }
    
    /* --- ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù‡Ø§Ù…Ø© --- */
    /* Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± ÙˆØ§Ù„Ø®Ø·ÙˆØ±Ø© */
    .card.secondary { border-color: var(--color-secondary); }
    .card.secondary::before { background-color: var(--color-secondary); }
    .card.secondary p { color: var(--color-secondary); text-shadow: 0 0 8px rgba(0, 250, 154, 0.6); }

    .card.danger { border-color: var(--color-danger); }
    .card.danger::before { background-color: var(--color-danger); }
    .card.danger p { color: var(--color-danger); text-shadow: 0 0 8px rgba(255, 107, 107, 0.6); }

    /* --- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Buttons) --- */
    .btn-container {
      text-align: center;
      margin: 30px 0;
    }

    .btn {
      background-color: var(--color-primary);
      color: var(--color-card-bg);
      border: none;
      padding: 12px 25px;
      font-size: 1em;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
      font-weight: 700;
    }

    .btn:hover {
      background-color: var(--text-light);
      transform: scale(1.05);
    }

    /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª --- */
    h2 {
        font-size: 22px;
        color: var(--color-primary);
        margin-top: 35px;
        margin-bottom: 20px;
        border-bottom: 2px solid rgba(245, 197, 66, 0.3);
        padding-bottom: 5px;
    }
    .table-container {
        background: var(--color-card-bg);
        border: 1px solid rgba(245, 197, 66, 0.4);
        border-radius: 15px;
        padding: 15px;
        margin-top: 20px;
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ Ø¬ÙŠØ¯ */
    }
    thead th {
        font-size: 13px;
        color: var(--color-primary);
        border-bottom: 2px solid rgba(245, 197, 66, 0.4);
        padding: 12px;
        text-align: right;
    }
    tbody td {
        padding: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 14px;
        text-align: right;
        vertical-align: middle;
    }
    .btn-action {
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        border: none;
        font-weight: 700;
        transition: background 0.2s;
        margin-right: 5px;
    }
    .btn-action.approve { background-color: var(--color-secondary); color: #000; }
    .btn-action.reject { background-color: var(--color-danger); color: #fff; }
    .loading-text { text-align: center; color: var(--text-muted); padding: 20px; }
    
    /* --- Footers --- */
    footer {
      text-align: center;
      padding: 15px;
      background-color: #111;
      color: #666;
      font-size: 0.9em;
      margin-top: 40px;
    }
  </style>
</head>
<body>

<div class="wrap">
    <header>
        Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Am Rewards ğŸ‘‘
    </header>

    <section class="dashboard">
        <div class="card secondary">
            <h3>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <p id="totalUsers">0</p>
        </div>

        <div class="card">
            <h3>ğŸ§¾ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†ÙØ°Ø© (Ø§Ù„ÙƒÙ„)</h3>
            <p id="tasksCompleted">0</p>
        </div>

        <div class="card">
            <h3>ğŸ”— Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h3>
            <p id="referrals">0</p>
        </div>

        <div class="card"> 
            <h3>ğŸ’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <p id="referralPoints">0</p>
        </div>

        <div class="card danger">
            <h3>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©</h3>
            <p id="totalWithdrawn">0 EGP</p>
        </div>

        <div class="card">
            <h3>ğŸ’¸ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
            <p id="withdrawToday">0 EGP</p>
        </div>

        <div class="card danger">
            <h3>â³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
            <p id="pendingWithdrawals">0</p>
        </div>
    </section>

    <div id="metricsArea"></div>
    
    <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ğŸ›ï¸</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID)</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù†Ù‚Ø§Ø·)</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø¬)</th>
                    <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨</th>
                    <th>ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="withdrawTableBody">
                <tr><td colspan="6" class="loading-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="btn-container">
        <button class="btn" onclick="location.href='users.html'">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button class="btn" onclick="location.href='tasks.html'">ğŸ§¾ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
        <button class="btn" onclick="location.href='referrals.html'">ğŸ”— Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</button>
        <button class="btn" onclick="location.href='withdrawals.html'">ğŸ’° Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</button>
        <button class="btn" onclick="location.href='pending.html'">â³ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</button>
    </div>

</div>

<footer>
    Â© 2025 Am Rewards â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø§ØµØ©
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, query, where, getDocs, limit, doc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
    // ğŸ›‘ **1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase**
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // **2. Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª**
    const adminEmail = "amirfg992005@gmail.com"; // ğŸ›‘ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªØ­Ù‚Ù‚)
    const POINT_VALUE_EGP = 0.07; 
    const POINTS_PER_TASK = 10; 

    // **3. Ø¹Ù†Ø§ØµØ± DOM Ø¨Ø§Ù„Ù€ ID Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡**
    const totalUsersEl = document.getElementById("totalUsers");
    const tasksCompletedEl = document.getElementById("tasksCompleted"); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    const referralsEl = document.getElementById('referrals'); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
    const referralPointsEl = document.getElementById('referralPoints'); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠØ©
    const totalWithdrawnEl = document.getElementById('totalWithdrawn'); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©
    const withdrawTodayEl = document.getElementById("withdrawToday"); // Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…
    const pendingWithdrawalsEl = document.getElementById('pendingWithdrawals'); // Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Ø¹Ø¯Ø¯)
    const withdrawTableBody = document.getElementById('withdrawTableBody');

    // ğŸ’¡ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    function formatNumber(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    function formatEGP(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 2 }) + " EGP";
    }
    function formatTime(ts) {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' });
    }
    function getTodayStart() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today;
    }

    // **4. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)**
    async function loadDashboardData() {
      try {
        const todayStart = getTodayStart();
        
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const usersSnap = await getDocs(collection(db, "users"));
        totalUsersEl.textContent = formatNumber(usersSnap.size);

        let totalReferralsCount = 0;
        let totalWithdrawnAmount = 0;
        let totalPoints = 0;
        let totalCompletedTasks = 0; 

        usersSnap.forEach(doc => {
            const data = doc.data();
            totalReferralsCount += Number(data.referralCount || 0);
            totalWithdrawnAmount += Number(data.totalWithdrawn || 0);
            totalPoints += Number(data.points || 0);
            // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ÙƒÙ„ÙŠØ© ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙ†ØªØ§Ø¬Ù‡Ø§ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·
            totalCompletedTasks += Number(data.tasksCompletedCount || Math.floor(data.points / POINTS_PER_TASK) || 0); 
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        referralsEl.textContent = formatNumber(totalReferralsCount);
        totalWithdrawnEl.textContent = formatEGP(totalWithdrawnAmount);
        referralPointsEl.textContent = formatNumber(totalPoints); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ©
        tasksCompletedEl.textContent = formatNumber(totalCompletedTasks); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†ÙØ°Ø© (Ø§Ù„ÙƒÙ„)

        // Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ÙŠÙˆÙ… (Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©)
        const tasksQuery = query(
          collection(db, "tasks_completed"),
          where("date", ">=", todayStart)
        );
        const tasksSnap = await getDocs(tasksQuery);
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø© "Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…" ÙÙŠ ØªØµÙ…ÙŠÙ…ÙƒØŒ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„ØºØ±Ø¶ Ø¢Ø®Ø± Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª

        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…
        const withdrawTodayQuery = query(
          collection(db, "withdrawals"), 
          where("createdAt", ">=", todayStart),
          where("status", "in", ["pending", "completed"]) // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ø§Ù„ÙŠÙˆÙ…
        );
        const withdrawTodaySnap = await getDocs(withdrawTodayQuery);
        
        let totalWithdrawnToday = 0;
        withdrawTodaySnap.forEach(doc => {
            totalWithdrawnToday += (Number(doc.data().points || 0) * POINT_VALUE_EGP);
        });
        withdrawTodayEl.textContent = formatEGP(totalWithdrawnToday);


        await loadPendingWithdrawals(); // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©

      } catch (err) {
        console.error("Error loading dashboard:", err);
        const errorText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
        totalUsersEl.textContent = errorText;
        referralsEl.textContent = errorText;
        totalWithdrawnEl.textContent = errorText;
        referralPointsEl.textContent = errorText;
        tasksCompletedEl.textContent = errorText;
        withdrawTodayEl.textContent = errorText;
        pendingWithdrawalsEl.textContent = errorText;
      }
    }

    // **5. Ø¬Ø¯ÙˆÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©**
    async function loadPendingWithdrawals() {
        const q = query(collection(db, 'withdrawals'), where('status', '==', 'pending'), limit(50)); 
        const requestsSnap = await getDocs(q);
        
        pendingWithdrawalsEl.textContent = formatNumber(requestsSnap.size); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©

        withdrawTableBody.innerHTML = '';
        if (requestsSnap.empty) {
            withdrawTableBody.innerHTML = '<tr><td colspan="6" class="loading-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
        } else {
            requestsSnap.forEach(docSnap => {
                const req = docSnap.data();
                const reqId = docSnap.id;
                
                const egpValue = (Number(req.points || 0) * POINT_VALUE_EGP).toFixed(2);
                
                const row = `
                    <tr>
                        <td>${req.userId ? req.userId.substring(0, 8) + '...' : 'â€”'}</td>
                        <td>${formatNumber(req.points || 0)}</td>
                        <td>${egpValue} Ø¬</td>
                        <td>${req.method || 'â€”'}</td>
                        <td>${req.createdAt ? formatTime(req.createdAt) : 'â€”'}</td>
                        <td>
                            <button class="btn-action approve" data-id="${reqId}" data-action="approve">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                            <button class="btn-action reject" data-id="${reqId}" data-action="reject">Ø±ÙØ¶</button>
                        </td>
                    </tr>`;
                withdrawTableBody.innerHTML += row;
            });
            
            document.querySelectorAll('.btn-action').forEach(btn => {
                btn.addEventListener('click', handleWithdrawAction);
            });
        }
    }
    
    // **6. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø­Ø¨**
    async function handleWithdrawAction(event) {
        const reqId = event.target.dataset.id;
        const action = event.target.dataset.action;
        
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${action === 'approve' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Ø±ÙØ¶'} Ø§Ù„Ø·Ù„Ø¨ ${reqId}?`)) return;

        try {
            await updateDoc(doc(db, 'withdrawals', reqId), {
                status: action === 'approve' ? 'completed' : 'rejected',
                processedAt: new Date(),
                processedBy: auth.currentUser.uid 
            });

            alert(`ØªÙ… ${action === 'approve' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Ø±ÙØ¶'} Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.`);
            loadDashboardData(); 
        } catch (error) {
            console.error("Error processing request:", error);
            alert("ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨.");
        }
    }
    
    // **7. Ø¨Ù†Ø§Ø¡ Ù…Ù†Ø·Ù‚Ø© ÙØ­Øµ Ø§Ù„ØªÙ†Ø§Ø³Ù‚ (ÙƒØ£Ø¯Ø§Ø© Ø¥Ø¶Ø§ÙÙŠØ©)**
    function setupConsistencyCheck() {
        // (Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ ÙŠØ¶ÙŠÙ Ù…Ù†Ø·Ù‚Ø© ÙØ­Øµ Ø§Ù„ØªÙ†Ø§Ø³Ù‚ ÙƒØ£Ø¯Ø§Ø© Ù‡Ø§Ù…Ø© Ù„Ù„Ù…Ø¯ÙŠØ±)
        const container = document.getElementById("metricsArea");
        container.innerHTML = `
            <h2 style="margin-top: 40px;">ğŸ§® ÙØ­Øµ ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ù‡Ø§Ù… (Ø£Ø¯Ø§Ø© Ù…ØªÙ‚Ø¯Ù…Ø©)</h2>
            <div class="card" style="border-left-color: var(--color-secondary);">
                <h3>ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© ØªØ³ØªÙ‡Ù„Ùƒ Ù‚Ø±Ø§Ø¡Ø§Øª Firebase. Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø¹Ù†Ø§ÙŠØ©.</h3>
                <button id="refreshCheck" class="btn-action approve" style="margin-top:10px;">ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¢Ù†</button>
                <p id="consistencyStatus" style="font-size:1.2em; margin-top:10px;">Ø§Ù†Ù‚Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>
            </div>
        `;
        document.getElementById("refreshCheck").addEventListener('click', verifyPointsVsTasksNow);
    }
    
    // ** Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„ØªÙ†Ø§Ø³Ù‚ (Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§) **
    async function verifyPointsVsTasksNow() {
        const el = document.getElementById("consistencyStatus");
        el.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„... (Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ù…Ø­ØªÙˆÙ‰ Ø¯Ø§Ù„Ø© verifyPointsVsTasksNow Ù‡Ù†Ø§ Ù„Ù„Ø¹Ù…Ù„)";
        // ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¯Ø§Ù„Ø© Ù‡Ù†Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙØ¹Ù„ÙŠ
    }
  
    // **8. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… Ø§Ù„ØªØµØ±ÙŠØ­)**
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ ÙƒÙ…Ø¯ÙŠØ±.");
            // ÙŠÙØ¶Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
            return;
        }

        if (user.email !== adminEmail) {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±.");
            await signOut(auth);
            // ÙŠÙØ¶Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©/ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            return;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±
        loadDashboardData();
        setupConsistencyCheck();
    });
</script>
</body>
</html>
