<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #ffd369; /* gold */
      --accent: #111; /* dark */
      --success-color: #10b981;
      --danger-color: #ef4444;
      --bg-dark: #0b0b0b;
      --card-bg: linear-gradient(180deg,#0f0f0f,#171717);
      --text-light: #f6f3ea;
    }
    body{font-family:'Tajawal',sans-serif;background:var(--bg-dark);color:var(--text-light);margin:0;padding:0}
    .container{max-width:1200px;margin:20px auto;padding:16px}
    h1{color:var(--primary-color);text-align:center;margin-bottom:18px}
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
    .metric-card{background:var(--card-bg);padding:18px;border-radius:10px;border:1px solid rgba(255,211,105,0.07);box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    .metric-card h3{margin:0;color:#c9b97c;font-size:14px;text-align:right}
    .metric-card .value{font-weight:900;font-size:26px;margin-top:8px;text-align:right;color:var(--text-light)}
    .table-responsive{overflow:auto;background:transparent;margin-bottom:18px}
    table{width:100%;border-collapse:collapse;background:transparent}
    th,td{padding:10px;text-align:right;border-bottom:1px solid rgba(255,255,255,0.04);white-space:nowrap}
    th{background:linear-gradient(90deg,#2b2b2b, #1a1a1a);color:var(--primary-color);font-weight:800}
    .actions-cell button{margin-inline-start:8px;padding:6px 10px;border-radius:6px;border:0;cursor:pointer}
    .complete-btn{background:var(--success-color);color:#07101a}
    .reject-btn{background:var(--danger-color);color:white}
    .logout-btn{display:block;margin:18px auto;padding:10px 18px;border-radius:8px;background:#222;color:var(--primary-color);border:1px solid rgba(255,211,105,0.12);cursor:pointer}
    @media(max-width:700px){.metric-card .value{font-size:20px}}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù â€” Am Rewards</h1>

    <section id="metricsArea">
      <h2 style="color:var(--primary-color);margin:6px 0 12px 0">ğŸ“Š Ù…Ù‚Ø§ÙŠÙŠØ³ Ø³Ø±ÙŠØ¹Ø©</h2>
      <div class="metrics-grid" id="globalMetrics">
        <div class="metric-card total-users">
          <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ</h3>
          <div class="value" id="totalUsers">â€”</div>
        </div>
        <div class="metric-card active-users">
          <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† (Ø§Ù„ÙŠÙˆÙ…)</h3>
          <div class="value" id="activeUsers">â€”</div>
        </div>
        <div class="metric-card total-withdrawals">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© (Ø¬Ù†ÙŠÙ‡)</h3>
          <div class="value" id="totalWithdrawals">â€”</div>
        </div>
        <div class="metric-card total-points">
          <h3>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h3>
          <div class="value" id="referralPoints">â€”</div>
        </div>
        <div class="metric-card total-tasks">
          <h3>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†ÙØ°Ø© (ÙƒÙ„ÙŠ)</h3>
          <div class="value" id="totalTasks">â€”</div>
        </div>
        <div class="metric-card pending-requests">
          <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
          <div class="value" id="pendingRequestsCount">â€”</div>
        </div>
      </div>
    </section>

    <h2 style="color:var(--primary-color);margin:8px 0">ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
    <div id="statusMessage" style="margin-bottom:12px;color:#c9b97c">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <div class="table-responsive">
      <table id="withdrawalTable" style="display:none">
        <thead>
          <tr>
            <th style="text-align:center">ID</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬)</th>
            <th>Ø§Ù„ØµØ§ÙÙŠ</th>
            <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
            <th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
            <th>UID</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th style="text-align:center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="withdrawalList"></tbody>
      </table>
    </div>

    <button class="logout-btn" onclick="logoutAdmin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // === Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Ø¶Ø¹ Ù‡Ù†Ø§ UIDs Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠÙ†
    const ADMIN_UDS = ["YOUR_ADMIN_UID_1", "YOUR_ADMIN_UID_2"];

    // Ø¹Ù†Ø§ØµØ± DOM
    const totalUsersEl = document.getElementById('totalUsers');
    const activeUsersEl = document.getElementById('activeUsers');
    const totalWithdrawalsEl = document.getElementById('totalWithdrawals');
    const referralPointsEl = document.getElementById('referralPoints');
    const totalTasksEl = document.getElementById('totalTasks');
    const pendingRequestsCountEl = document.getElementById('pendingRequestsCount');
    const statusMessage = document.getElementById('statusMessage');
    const withdrawalTable = document.getElementById('withdrawalTable');
    const withdrawalList = document.getElementById('withdrawalList');

    // ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø£Ù…Ø§Ù†
    function toNumber(v){
      const n = Number(v);
      return isNaN(n) ? 0 : n;
    }
    function formatMoney(n){
      return Number(n || 0).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    // =========== Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø¹Ø§Ù…Ø© ===========
    async function fetchGlobalMetrics(){
      try {
        // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø³Ù‡Ù„)
        const usersSnap = await db.collection('users').get();
        totalUsersEl.textContent = usersSnap.size.toLocaleString();

        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„ÙŠÙˆÙ… -> ÙŠØ¹ØªÙ…Ø¯ ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ù„ lastActive Ø£Ùˆ lastLogin ÙÙŠ ÙƒÙ„ user
        // Ù‡Ù†Ø§ Ù†Ø¬Ø±Ø¨ Ø­Ø³Ø§Ø¨ Ù…Ù† Ø­Ù‚Ù„ lastLogin (timestamp) Ø¥Ù† ÙˆØ¬Ø¯
        const startOfDay = new Date();
        startOfDay.setHours(0,0,0,0);
        let activeCount = 0;
        usersSnap.forEach(d => {
          const data = d.data();
          if (data.lastLogin && data.lastLogin.toDate){
            const t = data.lastLogin.toDate();
            if (t >= startOfDay) activeCount++;
          }
        });
        activeUsersEl.textContent = activeCount.toLocaleString();

        // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© (completed)
        let totalWithdrawalsAmount = 0;
        const completedWithdrawalsSnap = await db.collection('withdrawals')
          .where('status', '==', 'completed')
          .get();
        completedWithdrawalsSnap.forEach(doc => {
          const w = doc.data();
          // Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø­Ù‚Ù„ stored as string Ø£Ùˆ numberØ› Ù„Ø°Ù„Ùƒ Ù†Ø­ÙˆÙ„ Ø¨Ø£Ù…Ø§Ù†
          totalWithdrawalsAmount += toNumber(w.net || w.amount || 0);
        });
        totalWithdrawalsEl.textContent = formatMoney(totalWithdrawalsAmount);

        // Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ù‚Ù„ referralPoints ÙÙŠ users Ø£Ùˆ Ø¬Ù…Ø¹ Ù…Ù† Ø³Ø¬Ù„ Ø¥Ø­Ø§Ù„Ø§Øª
        // Ø£ÙØ¶Ù„: Ø§Ø¬Ù…Ø¹ referralPoints Ù…Ù† users Ø¥Ø°Ø§ Ù…Ø®Ø²Ù†Ø© per-user
        let totalReferralPoints = 0;
        usersSnap.forEach(doc => {
          const u = doc.data();
          totalReferralPoints += toNumber(u.referralPoints || 0);
        });
        referralPointsEl.textContent = totalReferralPoints.toLocaleString();

        // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†ÙØ°Ø© (ØªØ­ØªØ§Ø¬ Ù…Ø¬Ù…ÙˆØ¹Ø© tasks_completed Ø£Ùˆ log)
        // Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ù…Ø¬Ù…ÙˆØ¹Ø© tasks_completed: Ø§Ø¬Ù…Ø¹_docs.size
        // Ù‡Ù†Ø§ Ù†Ø­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© tasks_completed Ø¥Ù† ÙˆÙØ¬Ø¯Øª
        try {
          const tasksSnap = await db.collection('tasks_completed').get();
          totalTasksEl.textContent = tasksSnap.size.toLocaleString();
        } catch (errTasks) {
          // Ù„Ùˆ Ù…Ø§ ÙÙŠØ´ Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©
          totalTasksEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª';
          console.warn('tasks_completed collection missing or not readable.', errTasks);
        }

        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        const pendingSnap = await db.collection('withdrawals').where('status','==','pending').get();
        pendingRequestsCountEl.textContent = pendingSnap.size.toLocaleString();

      } catch (err) {
        console.error('fetchGlobalMetrics error:', err);
        statusMessage.textContent = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø¹Ø§Ù…Ø©. ÙØªØ­ Ø§Ù„Ù€ Console Ù„Ù„Ù…Ø²ÙŠØ¯.';
        statusMessage.style.color = '#ff8a8a';
      }
    }

    // =========== Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§ ===========
    function fetchWithdrawalsRealtime(){
      statusMessage.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨...';
      db.collection('withdrawals')
        .where('status','==','pending')
        .orderBy('date','asc')
        .onSnapshot(snapshot => {
          withdrawalList.innerHTML = '';
          pendingRequestsCountEl.textContent = snapshot.size.toLocaleString();
          if (snapshot.empty) {
            statusMessage.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.';
            withdrawalTable.style.display = 'none';
            return;
          }
          statusMessage.textContent = '';
          withdrawalTable.style.display = 'table';
          snapshot.forEach(doc => {
            const w = doc.data();
            const id = doc.id;
            const tr = document.createElement('tr');
            const dateText = w.date && w.date.toDate ? (w.date.toDate()).toLocaleString('ar-EG') : '-';
            tr.innerHTML = `
              <td style="text-align:center">${id.substring(0,6)}...</td>
              <td>${formatMoney(toNumber(w.amount))}</td>
              <td>${formatMoney(toNumber(w.net))}</td>
              <td>${(toNumber(w.pts)).toLocaleString()}</td>
              <td>${w.wallet || '-'}</td>
              <td>${(w.userId||'-').substring(0,8)}...</td>
              <td>${dateText}</td>
              <td class="actions-cell" style="text-align:center">
                <button class="complete-btn" onclick="updateWithdrawalStatus('${id}','completed', this)">âœ… Ø¥ÙƒÙ…Ø§Ù„</button>
                <button class="reject-btn" onclick="updateWithdrawalStatus('${id}','rejected', this)">âŒ Ø±ÙØ¶</button>
              </td>`;
            withdrawalList.appendChild(tr);
          });
        }, error => {
          console.error('fetchWithdrawalsRealtime onSnapshot error:', error);
          statusMessage.textContent = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Firestore).';
          statusMessage.style.color = '#ff8a8a';
        });
    }

    // =========== ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ ===========
    async function updateWithdrawalStatus(docId, newStatus, btn){
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${newStatus === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ø±ÙÙˆØ¶'}ØŸ`)) return;
      // ØªØ¹Ø·Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø¤Ù‚ØªÙ‹Ø§
      const parent = btn.closest('.actions-cell');
      parent.querySelectorAll('button').forEach(b => b.disabled = true);

      try {
        const ref = db.collection('withdrawals').doc(docId);
        await ref.update({
          status: newStatus,
          processedDate: firebase.firestore.FieldValue.serverTimestamp(),
          processorId: auth.currentUser ? auth.currentUser.uid : 'admin'
        });

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ ØªÙ… 'rejected' ÙˆØªØ±Ø¬Ø¹ Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ° Ø°Ù„Ùƒ Ø¹Ø¨Ø± Cloud Function Ø¢Ù…Ù†
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.');
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        fetchGlobalMetrics();
      } catch (err) {
        console.error('updateWithdrawalStatus error:', err);
        alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Firestore Rules. ' + (err.message||''));
        parent.querySelectorAll('button').forEach(b => b.disabled = false);
      }
    }

    // =========== Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ===========
    auth.onAuthStateChanged(user => {
      if (!user) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„.');
        window.location.href = 'index.html';
        return;
      }
      // ØªØ­Ù‚Ù‚ Ø£Ù† UID ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
      if (!ADMIN_UDS.includes(user.uid)) {
        document.getElementById('statusMessage').textContent = 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.';
        document.getElementById('statusMessage').style.color = '#ff9b9b';
        return;
      }

      // Ù„Ùˆ ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ…Ø§Ù…ØŒ Ø´ØºÙ‘Ù„ Ø§Ù„Ù€ listeners
      fetchGlobalMetrics();
      fetchWithdrawalsRealtime();
    });

    function logoutAdmin(){
      auth.signOut().then(()=> window.location.href = 'index.html');
    }

    // Ø§Ø®ØªØµØ§Ø± Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ¬Ø±Ù‘Ø¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    window._adminHelpers = { fetchGlobalMetrics, fetchWithdrawalsRealtime, updateWithdrawalStatus };
  </script>
</body>
            </html>
