<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù | Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4f46e5; /* Indigo */
      --secondary-color: #f59e0b; /* Amber */
      --success-color: #10b981; /* Emerald */
      --danger-color: #ef4444; /* Red */
      --bg-dark: #0f172a; /* Slate 900 */
      --card-bg: #1e293b; /* Slate 800 */
      --text-light: #f1f5f9;
    }
    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      margin: 0; padding: 0;
    }
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 2.2rem;
      font-weight: 900;
      letter-spacing: 1px;
    }
    .loading-msg, .error-msg {
      text-align: center;
      margin-top: 50px;
      font-size: 1.2rem;
    }
    .error-msg { color: var(--danger-color); }

    /* ------------------- Metrics Cards ------------------- */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .metric-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border-right: 4px solid var(--primary-color);
      transition: transform 0.3s;
    }
    .metric-card:hover { transform: translateY(-5px); }
    .metric-card h3 {
      font-size: 1rem;
      color: #94a3b8;
      margin: 0 0 10px;
    }
    .metric-card .value {
      font-size: 2rem;
      font-weight: 900;
      color: var(--success-color);
    }
    .metric-card.total-users { border-color: var(--primary-color); }
    .metric-card.total-withdrawals { border-color: var(--danger-color); }
    .metric-card.pending-requests { border-color: var(--secondary-color); }
    .metric-card.total-points .value { color: var(--secondary-color); }

    /* ------------------- Withdrawals Table ------------------- */
    h2 {
      color: var(--primary-color);
      border-bottom: 1px solid #334155;
      padding-bottom: 10px;
      margin-top: 40px;
    }
    .table-responsive {
        overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #0f172a;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
    }
    th, td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #334155;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    th {
      background: var(--primary-color);
      color: white;
      font-weight: 700;
      text-align: center;
    }
    tr:nth-child(even) td { background: #1e293b; }
    tr:hover td { background: #334155; }
    
    .status-pending { color: var(--secondary-color); font-weight: bold; }
    .status-completed { color: var(--success-color); }
    .status-rejected { color: var(--danger-color); }

    .actions-cell button {
      margin: 3px;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.85rem;
      transition: opacity 0.2s;
    }
    .actions-cell button:disabled { opacity: 0.5; cursor: not-allowed; }
    .complete-btn { background: var(--success-color); color: var(--bg-dark); }
    .reject-btn { background: var(--danger-color); color: white; }

    .logout-btn {
        display: block;
        width: fit-content;
        margin: 40px auto 0;
        background: #9d174d; /* Rose */
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
    }
    .logout-btn:hover { background: #7c0a37; }
    
    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span style="color:var(--secondary-color);">ğŸ‘‘</span> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ù„ÙŠØ§</h1>
    
    <div id="metricsArea">
        <h2>ğŸ“Š Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h2>
        <div class="metrics-grid" id="globalMetrics">
            <div class="metric-card total-users">
                <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ</h3>
                <div class="value" id="totalUsers">0</div>
            </div>
            <div class="metric-card active-users">
                <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† (Ø§Ù„ÙŠÙˆÙ…)</h3>
                <div class="value" id="activeUsers">0</div>
            </div>
            <div class="metric-card total-withdrawals">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© (Ø¬Ù…)</h3>
                <div class="value" id="totalWithdrawals">0.00</div>
            </div>
            <div class="metric-card total-points">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØµØ±ÙˆÙØ©</h3>
                <div class="value" id="totalPointsSpent">0</div>
            </div>
            <div class="metric-card completed-tasks">
                <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†ÙØ°Ø© (ÙƒÙ„ÙŠ)</h3>
                <div class="value" id="totalTasks">0</div>
            </div>
             <div class="metric-card pending-requests">
                <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
                <div class="value" id="pendingRequestsCount">0</div>
            </div>
        </div>

        <h2>ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†ÙØ°Ø©</h2>
        <div class="metrics-grid" id="taskMetrics">
             </div>
    </div>
    
    <h2 id="pendingHeader">ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
    <div id="statusMessage" class="loading-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <div class="table-responsive">
        <table id="withdrawalTable" style="display:none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù…)</th>
              <th>Ø§Ù„ØµØ§ÙÙŠ</th>
              <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
              <th>UID</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th style="text-align: center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="withdrawalList">
            </tbody>
        </table>
    </div>

    <button class="logout-btn" onclick="logoutAdmin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ğŸš¨ğŸš¨ğŸš¨ ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ø§! ğŸš¨ğŸš¨ğŸš¨
    const ADMIN_UDS = ["YOUR_ADMIN_UID_1", "YOUR_ADMIN_UID_2"]; 
    
    const withdrawalList = document.getElementById('withdrawalList');
    const withdrawalTable = document.getElementById('withdrawalTable');
    const statusMessage = document.getElementById('statusMessage');
    const pendingRequestsCount = document.getElementById('pendingRequestsCount');
    const globalMetrics = document.getElementById('globalMetrics');
    const taskMetrics = document.getElementById('taskMetrics');

    // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    function formatNum(num) {
        return Number(num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    function formatDate(ts) {
        if (!ts || !ts.toDate) return "-";
        const dt = ts.toDate();
        return dt.toLocaleDateString("ar-EG") + " " + dt.toLocaleTimeString("ar-EG");
    }

    // ------------------- 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø¹Ø§Ù…Ø© -------------------
    async function fetchGlobalMetrics() {
        // ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ§Ù„ Cloud Functions Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª 
        // Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Aggregation Queries Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… SDK Ø£Ø­Ø¯Ø«ØŒ Ù„ÙƒÙ† Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ Firestore Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const usersSnapshot = await db.collection('users').get();
            document.getElementById('totalUsers').textContent = usersSnapshot.size.toLocaleString('en-US');

            // ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·/Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©ØŒ ÙŠØ¬Ø¨ Ø¬Ù„Ø¨Ù‡Ø§ ÙˆØªØ¬Ù…ÙŠØ¹Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹
            let totalWithdrawalsAmount = 0;
            let totalPointsSpent = 0;
            
            const completedWithdrawals = await db.collection('withdrawals')
                .where('status', '==', 'completed')
                .get();

            completedWithdrawals.forEach(doc => {
                const w = doc.data();
                totalWithdrawalsAmount += w.net || 0; // Ø§Ù„ØµØ§ÙÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©
                totalPointsSpent += w.pts || 0;
            });
            
            document.getElementById('totalWithdrawals').textContent = formatNum(totalWithdrawalsAmount);
            document.getElementById('totalPointsSpent').textContent = totalPointsSpent.toLocaleString('en-US').replace('.00', '');

        } catch (error) {
            console.error("Error fetching global metrics:", error);
            globalMetrics.innerHTML = `<div class="error-msg">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø¹Ø§Ù…Ø©.</div>`;
        }

        // ğŸ’¡ Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ø§Ù… (ÙŠØªØ·Ù„Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© tasks_completed)
        // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØªØ·Ù„Ø¨ Ù†Ø¸Ø§Ù… logging Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù‡Ø§Ù….
        // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¹Ø±Ø¶Ù‡ ÙƒÙ€ "Ù…ØªØ¨Ù‚ÙŠ" Ø­Ø§Ù„ÙŠØ§Ù‹:
        taskMetrics.innerHTML = `
            <div class="metric-card"><h3>Ø±ÙˆØ§Ø¨Ø· Ù…Ø®ØªØµØ±Ø©</h3><div class="value">ØªØ­ØªØ§Ø¬ Logging</div></div>
            <div class="metric-card"><h3>Ø¹Ø±ÙˆØ¶ CPA</h3><div class="value">ØªØ­ØªØ§Ø¬ Logging</div></div>
            <div class="metric-card"><h3>Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3><div class="value">ØªØ­ØªØ§Ø¬ Logging</div></div>
        `;
    }

    // ------------------- 2. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -------------------
    function fetchWithdrawals() {
      statusMessage.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨...";
      
      // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø°Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© "pending" ÙÙ‚Ø·
      db.collection("withdrawals")
        .where("status", "==", "pending")
        .orderBy("date", "asc")
        .onSnapshot(snapshot => {
          withdrawalList.innerHTML = "";
          pendingRequestsCount.textContent = snapshot.size; // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
          
          if (snapshot.empty) {
            statusMessage.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§. âœ…";
            statusMessage.style.display = 'block';
            withdrawalTable.style.display = 'none';
            return;
          }
          
          statusMessage.style.display = 'none';
          withdrawalTable.style.display = 'table';
          
          snapshot.forEach(doc => {
            const w = doc.data();
            const docId = doc.id;
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${docId.substring(0, 5)}...</td>
              <td>${w.amount.toFixed(2)}</td>
              <td>${w.net.toFixed(2)}</td>
              <td>${w.pts.toLocaleString('en-US').replace('.00', '')}</td>
              <td>${w.wallet}</td>
              <td>${w.userId.substring(0, 8)}...</td>
              <td>${formatDate(w.date)}</td>
              <td class="actions-cell" data-id="${docId}">
                <button class="complete-btn" onclick="updateWithdrawalStatus('${docId}', 'completed', this)">âœ… Ø¥ÙƒÙ…Ø§Ù„</button>
                <button class="reject-btn" onclick="updateWithdrawalStatus('${docId}', 'rejected', this)">âŒ Ø±ÙØ¶</button>
              </td>`;
            withdrawalList.appendChild(tr);
          });
        }, (error) => {
          console.error("FIREBASE ERROR:", error);
          statusMessage.textContent = "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: " + error.message;
          statusMessage.className = 'error-msg';
          withdrawalTable.style.display = 'none';
        });
    }

    // ------------------- 3. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø·Ù„Ø¨) -------------------
    async function updateWithdrawalStatus(docId, newStatus, button) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ${docId.substring(0, 5)}... Ø¥Ù„Ù‰ ${newStatus === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ø±ÙÙˆØ¶'}ØŸ`)) {
        return;
      }
      
      const actionsCell = button.closest('.actions-cell').querySelectorAll('button');
      actionsCell.forEach(btn => btn.disabled = true);
      
      try {
        const withdrawalRef = db.collection("withdrawals").doc(docId);
        
        // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© - ÙŠØ¬Ø¨ Ø£Ù† ØªØ³Ù…Ø­ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        await withdrawalRef.update({
          status: newStatus,
          processedDate: firebase.firestore.FieldValue.serverTimestamp(),
          processorId: auth.currentUser.uid 
        });
        
        // ğŸš¨ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¹Ù†Ø¯ 'rejected' ÙŠØ¬Ø¨ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·
        // Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ **ÙŠØ¬Ø¨** Ø£Ù† ÙŠØªÙ… Ø¹Ø¨Ø± Cloud Function Ù„Ø¶Ù…Ø§Ù† Ø£Ù…Ø§Ù† Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·.
        
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${newStatus}.`);
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø¨Ø¹Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
        fetchGlobalMetrics(); 
      } catch (error) {
        console.error("Error updating status:", error);
        alert("ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†. " + error.message);
        actionsCell.forEach(btn => btn.disabled = false);
      }
    }

    // ------------------- 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -------------------
    auth.onAuthStateChanged(user => {
      if (user) {
        if (ADMIN_UDS.includes(user.uid)) {
          // Ø§Ù„Ù…Ø´Ø±ÙØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
          fetchGlobalMetrics();
          fetchWithdrawals();
        } else {
          statusMessage.textContent = "ØºÙŠØ± Ù…ÙØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. â›”";
          statusMessage.className = 'error-msg';
        }
      } else {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ ÙƒÙ…Ø³Ø¤ÙˆÙ„.");
        window.location.href = "index.html"; 
      }
    });

    function logoutAdmin() {
        auth.signOut().then(() => {
            window.location.href = "index.html";
        });
    }

  </script>
</body>
</html>
