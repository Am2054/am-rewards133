<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم المشرف | Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4f46e5; /* Indigo */
      --secondary-color: #f59e0b; /* Amber */
      --success-color: #10b981; /* Emerald */
      --danger-color: #ef4444; /* Red */
      --bg-dark: #0f172a; /* Slate 900 */
      --card-bg: #1e293b; /* Slate 800 */
      --text-light: #f1f5f9;
    }
    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      margin: 0; padding: 0;
    }
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 2.2rem;
      font-weight: 900;
      letter-spacing: 1px;
    }
    .loading-msg, .error-msg {
      text-align: center;
      margin-top: 50px;
      font-size: 1.2rem;
    }
    .error-msg { color: var(--danger-color); }

    /* ------------------- Metrics Cards ------------------- */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .metric-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border-right: 4px solid var(--primary-color);
      transition: transform 0.3s;
    }
    .metric-card:hover { transform: translateY(-5px); }
    .metric-card h3 {
      font-size: 1rem;
      color: #94a3b8;
      margin: 0 0 10px;
    }
    .metric-card .value {
      font-size: 2rem;
      font-weight: 900;
      color: var(--success-color);
    }
    .metric-card.total-users { border-color: var(--primary-color); }
    .metric-card.total-withdrawals { border-color: var(--danger-color); }
    .metric-card.pending-requests { border-color: var(--secondary-color); }
    .metric-card.total-points .value { color: var(--secondary-color); }

    /* ------------------- Withdrawals Table ------------------- */
    h2 {
      color: var(--primary-color);
      border-bottom: 1px solid #334155;
      padding-bottom: 10px;
      margin-top: 40px;
    }
    .table-responsive {
        overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #0f172a;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
    }
    th, td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #334155;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    th {
      background: var(--primary-color);
      color: white;
      font-weight: 700;
      text-align: center;
    }
    tr:nth-child(even) td { background: #1e293b; }
    tr:hover td { background: #334155; }
    
    .status-pending { color: var(--secondary-color); font-weight: bold; }
    .status-completed { color: var(--success-color); }
    .status-rejected { color: var(--danger-color); }

    .actions-cell button {
      margin: 3px;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.85rem;
      transition: opacity 0.2s;
    }
    .actions-cell button:disabled { opacity: 0.5; cursor: not-allowed; }
    .complete-btn { background: var(--success-color); color: var(--bg-dark); }
    .reject-btn { background: var(--danger-color); color: white; }

    .logout-btn {
        display: block;
        width: fit-content;
        margin: 40px auto 0;
        background: #9d174d; /* Rose */
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
    }
    .logout-btn:hover { background: #7c0a37; }
    
    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span style="color:var(--secondary-color);">👑</span> لوحة تحكم المشرف العليا</h1>
    
    <div id="metricsArea">
        <h2>📊 مقاييس الأداء والإيرادات</h2>
        <div class="metrics-grid" id="globalMetrics">
            <div class="metric-card total-users">
                <h3>عدد المستخدمين الكلي</h3>
                <div class="value" id="totalUsers">0</div>
            </div>
            <div class="metric-card active-users">
                <h3>المستخدمون النشطون (اليوم)</h3>
                <div class="value" id="activeUsers">0</div>
            </div>
            <div class="metric-card total-withdrawals">
                <h3>إجمالي المبالغ المسحوبة (جم)</h3>
                <div class="value" id="totalWithdrawals">0.00</div>
            </div>
            <div class="metric-card total-points">
                <h3>إجمالي النقاط المصروفة</h3>
                <div class="value" id="totalPointsSpent">0</div>
            </div>
            <div class="metric-card completed-tasks">
                <h3>عدد المهام المنفذة (كلي)</h3>
                <div class="value" id="totalTasks">0</div>
            </div>
             <div class="metric-card pending-requests">
                <h3>طلبات السحب المعلقة</h3>
                <div class="value" id="pendingRequestsCount">0</div>
            </div>
        </div>

        <h2>📈 توزيع المهام المنفذة</h2>
        <div class="metrics-grid" id="taskMetrics">
             </div>
    </div>
    
    <h2 id="pendingHeader">💸 طلبات السحب المعلقة للمراجعة</h2>
    <div id="statusMessage" class="loading-msg">جاري تحميل البيانات...</div>

    <div class="table-responsive">
        <table id="withdrawalTable" style="display:none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>المبلغ (جم)</th>
              <th>الصافي</th>
              <th>النقاط</th>
              <th>رقم المحفظة</th>
              <th>UID</th>
              <th>التاريخ</th>
              <th style="text-align: center;">الإجراءات</th>
            </tr>
          </thead>
          <tbody id="withdrawalList">
            </tbody>
        </table>
    </div>

    <button class="logout-btn" onclick="logoutAdmin()">تسجيل الخروج</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 🚨🚨🚨 يجب تغيير هذا! 🚨🚨🚨
    const ADMIN_UDS = ["YOUR_ADMIN_UID_1", "YOUR_ADMIN_UID_2"]; 
    
    const withdrawalList = document.getElementById('withdrawalList');
    const withdrawalTable = document.getElementById('withdrawalTable');
    const statusMessage = document.getElementById('statusMessage');
    const pendingRequestsCount = document.getElementById('pendingRequestsCount');
    const globalMetrics = document.getElementById('globalMetrics');
    const taskMetrics = document.getElementById('taskMetrics');

    // دالة تنسيق الأرقام
    function formatNum(num) {
        return Number(num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // دالة تنسيق التاريخ
    function formatDate(ts) {
        if (!ts || !ts.toDate) return "-";
        const dt = ts.toDate();
        return dt.toLocaleDateString("ar-EG") + " " + dt.toLocaleTimeString("ar-EG");
    }

    // ------------------- 1. جلب المقاييس العامة -------------------
    async function fetchGlobalMetrics() {
        // 💡 ملاحظة: يتطلب هذا الاستعلام إنشاء دوال Cloud Functions لحساب الإجماليات 
        // أو استخدام Aggregation Queries إذا كنت تستخدم SDK أحدث، لكن سنستخدم هنا Firestore الأساسي
        
        try {
            // جلب المستخدمين
            const usersSnapshot = await db.collection('users').get();
            document.getElementById('totalUsers').textContent = usersSnapshot.size.toLocaleString('en-US');

            // 💡 ملاحظة: لحساب النقاط/المبالغ المسحوبة، يجب جلبها وتجميعها يدوياً
            let totalWithdrawalsAmount = 0;
            let totalPointsSpent = 0;
            
            const completedWithdrawals = await db.collection('withdrawals')
                .where('status', '==', 'completed')
                .get();

            completedWithdrawals.forEach(doc => {
                const w = doc.data();
                totalWithdrawalsAmount += w.net || 0; // الصافي هو المقياس الأكثر دقة
                totalPointsSpent += w.pts || 0;
            });
            
            document.getElementById('totalWithdrawals').textContent = formatNum(totalWithdrawalsAmount);
            document.getElementById('totalPointsSpent').textContent = totalPointsSpent.toLocaleString('en-US').replace('.00', '');

        } catch (error) {
            console.error("Error fetching global metrics:", error);
            globalMetrics.innerHTML = `<div class="error-msg">❌ فشل تحميل المقاييس العامة.</div>`;
        }

        // 💡 جلب إحصائيات المهام (يتطلب مجموعة tasks_completed)
        // هذا الجزء يتطلب نظام logging متكامل للمهام.
        // يمكننا عرضه كـ "متبقي" حالياً:
        taskMetrics.innerHTML = `
            <div class="metric-card"><h3>روابط مختصرة</h3><div class="value">تحتاج Logging</div></div>
            <div class="metric-card"><h3>عروض CPA</h3><div class="value">تحتاج Logging</div></div>
            <div class="metric-card"><h3>مشاهدة فيديوهات</h3><div class="value">تحتاج Logging</div></div>
        `;
    }

    // ------------------- 2. جلب وعرض طلبات السحب -------------------
    function fetchWithdrawals() {
      statusMessage.textContent = "جاري تحميل طلبات السحب...";
      
      // جلب الطلبات ذات الحالة "pending" فقط
      db.collection("withdrawals")
        .where("status", "==", "pending")
        .orderBy("date", "asc")
        .onSnapshot(snapshot => {
          withdrawalList.innerHTML = "";
          pendingRequestsCount.textContent = snapshot.size; // تحديث عداد الطلبات المعلقة
          
          if (snapshot.empty) {
            statusMessage.textContent = "لا يوجد طلبات سحب معلقة حاليًا. ✅";
            statusMessage.style.display = 'block';
            withdrawalTable.style.display = 'none';
            return;
          }
          
          statusMessage.style.display = 'none';
          withdrawalTable.style.display = 'table';
          
          snapshot.forEach(doc => {
            const w = doc.data();
            const docId = doc.id;
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${docId.substring(0, 5)}...</td>
              <td>${w.amount.toFixed(2)}</td>
              <td>${w.net.toFixed(2)}</td>
              <td>${w.pts.toLocaleString('en-US').replace('.00', '')}</td>
              <td>${w.wallet}</td>
              <td>${w.userId.substring(0, 8)}...</td>
              <td>${formatDate(w.date)}</td>
              <td class="actions-cell" data-id="${docId}">
                <button class="complete-btn" onclick="updateWithdrawalStatus('${docId}', 'completed', this)">✅ إكمال</button>
                <button class="reject-btn" onclick="updateWithdrawalStatus('${docId}', 'rejected', this)">❌ رفض</button>
              </td>`;
            withdrawalList.appendChild(tr);
          });
        }, (error) => {
          console.error("FIREBASE ERROR:", error);
          statusMessage.textContent = "❌ فشل تحميل الطلبات: " + error.message;
          statusMessage.className = 'error-msg';
          withdrawalTable.style.display = 'none';
        });
    }

    // ------------------- 3. دالة تحديث الحالة (معالج الطلب) -------------------
    async function updateWithdrawalStatus(docId, newStatus, button) {
      if (!confirm(`هل أنت متأكد من تغيير حالة الطلب ${docId.substring(0, 5)}... إلى ${newStatus === 'completed' ? 'مكتمل' : 'مرفوض'}؟`)) {
        return;
      }
      
      const actionsCell = button.closest('.actions-cell').querySelectorAll('button');
      actionsCell.forEach(btn => btn.disabled = true);
      
      try {
        const withdrawalRef = db.collection("withdrawals").doc(docId);
        
        // 💡 تحديث الوثيقة - يجب أن تسمح قواعد الأمان للمشرف فقط بهذا التحديث
        await withdrawalRef.update({
          status: newStatus,
          processedDate: firebase.firestore.FieldValue.serverTimestamp(),
          processorId: auth.currentUser.uid 
        });
        
        // 🚨 هام جداً: عند 'rejected' يجب إرجاع النقاط
        // هذا المنطق **يجب** أن يتم عبر Cloud Function لضمان أمان عملية إرجاع النقاط.
        
        alert(`تم تحديث حالة الطلب بنجاح إلى ${newStatus}.`);
        // تحديث المقاييس بعد التغيير
        fetchGlobalMetrics(); 
      } catch (error) {
        console.error("Error updating status:", error);
        alert("فشل في تحديث الحالة. تحقق من قواعد الأمان. " + error.message);
        actionsCell.forEach(btn => btn.disabled = false);
      }
    }

    // ------------------- 4. التحقق من المصادقة -------------------
    auth.onAuthStateChanged(user => {
      if (user) {
        if (ADMIN_UDS.includes(user.uid)) {
          // المشرف، قم بتحميل كل شيء
          fetchGlobalMetrics();
          fetchWithdrawals();
        } else {
          statusMessage.textContent = "غير مُصرح لك بالدخول إلى هذه الصفحة. ⛔";
          statusMessage.className = 'error-msg';
        }
      } else {
        alert("يرجى تسجيل الدخول أولاً كمسؤول.");
        window.location.href = "index.html"; 
      }
    });

    function logoutAdmin() {
        auth.signOut().then(() => {
            window.location.href = "index.html";
        });
    }

  </script>
</body>
</html>
