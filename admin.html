<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>لوحة الإدارة | Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  
  <style>
    /* ... (جميع الـ CSS كما هو) ... */
    :root {
        --color-primary: #f5c542; 
        --color-secondary: #00fa9a; 
        --color-danger: #ff6b6b; 
        --color-background: #0b0b0b;
        --color-card-bg: #1a1a1a;
        --text-light: #f0f2f5;
        --text-muted: #999;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    * {box-sizing: border-box;}
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background-color: var(--color-background);
      color: var(--text-light);
      min-height: 100vh;
      direction: rtl;
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px; }
    header {
      background-color: var(--color-card-bg);
      padding: 15px 20px;
      text-align: center;
      font-size: 1.8em;
      font-weight: 900;
      color: var(--color-primary);
      box-shadow: var(--shadow);
      border-radius: 15px;
      margin-bottom: 30px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }
    .card {
      background: var(--color-card-bg);
      border: 1px solid rgba(245, 197, 66, 0.4);
      border-radius: 15px;
      padding: 20px;
      text-align: right;
      box-shadow: 0 0 10px rgba(245, 197, 66, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .card::before { 
        content: '';
        position: absolute;
        top: 0; right: 0; bottom: 0;
        width: 5px;
        background-color: var(--color-primary);
        border-radius: 0 15px 15px 0;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(245, 197, 66, 0.3);
    }
    .card h3 {
      margin-bottom: 15px;
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 400;
    }
    .card .main-value {
      font-size: 1.8em;
      font-weight: 900;
      color: var(--text-light);
      font-family: 'Montserrat', sans-serif;
      text-shadow: 0 0 8px rgba(245, 197, 66, 0.6);
      margin-bottom: 5px;
    }
    .card .sub-value {
        display: block;
        font-size: 1em;
        color: var(--color-primary);
        font-weight: 700;
        font-family: 'Cairo', sans-serif;
    }
    .card.secondary { border-color: var(--color-secondary); }
    .card.secondary::before { background-color: var(--color-secondary); }
    .card.secondary .main-value { color: var(--color-secondary); text-shadow: 0 0 8px rgba(0, 250, 154, 0.6); }
    .card.danger { border-color: var(--color-danger); }
    .card.danger::before { background-color: var(--color-danger); }
    .card.danger .main-value { color: var(--color-danger); text-shadow: 0 0 8px rgba(255, 107, 107, 0.6); }
    .btn-container { text-align: center; margin: 30px 0; }
    .btn {
      background-color: var(--color-primary);
      color: var(--color-card-bg);
      border: none;
      padding: 12px 25px;
      font-size: 1em;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
      font-weight: 700;
    }
    .btn:hover { background-color: var(--text-light); transform: scale(1.05); }
    footer {
      text-align: center;
      padding: 15px;
      background-color: #111;
      color: #666;
      font-size: 0.9em;
      margin-top: 40px;
    }
    .error-message {
        color: var(--color-danger);
        font-weight: 700;
        text-align: center;
        padding: 10px;
        margin: 20px 0;
        border: 1px solid var(--color-danger);
        border-radius: 8px;
        background-color: rgba(255, 107, 107, 0.1);
    }
    #login-container {
        max-width: 400px; margin: 50px auto; padding: 30px; background-color: var(--color-card-bg);
        border-radius: 15px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--color-primary);
    }
    #login-container h2 { color: var(--color-primary); margin-bottom: 20px; font-weight: 700; }
    #login-container input {
        width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #444; background-color: #222;
        color: var(--text-light); border-radius: 8px;
    }
    #login-container button {
        width: 100%; padding: 12px; background-color: var(--color-secondary); color: #000; border: none;
        border-radius: 8px; cursor: pointer; font-weight: 700; transition: background 0.2s;
    }
    #login-container button:hover { background-color: var(--color-primary); }
    #loading-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9);
        color: var(--color-primary); display: flex; justify-content: center; align-items: center;
        flex-direction: column; z-index: 1000; font-size: 1.5em; font-weight: 700; transition: opacity 0.5s;
    }
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid var(--color-primary);
        border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p>جارِ تحميل لوحة الإدارة...</p>
</div>

<div class="wrap">
    
    <div id="login-container" class="hidden">
        <h2>تسجيل الدخول كمدير 🔒</h2>
        <input type="email" id="adminEmailInput" placeholder="البريد الإلكتروني" value="amirfg992005@gmail.com" required>
        <input type="password" id="adminPasswordInput" placeholder="كلمة المرور" required>
        <button id="loginButton">تسجيل الدخول</button>
        <p id="loginError" class="error-message hidden" style="margin-top: 15px;"></p>
    </div>

    <div id="dashboard-content" class="hidden">
        <header>
            لوحة إدارة Am Rewards 👑
        </header>

        <section class="dashboard">
            
            <div class="card secondary">
                <h3>👥 عدد المستخدمين الكلي</h3>
                <p id="totalUsers" class="main-value">0</p>
            </div>

            <div class="card secondary">
                <h3>🏃‍♂️ عدد المستخدمين النشطين (آخر 7 أيام)</h3>
                <p id="activeUsers" class="main-value">0</p>
            </div>
            
            <div class="card">
                <h3>🧾 إجمالي النقاط من المهام المنجزة</h3>
                <p id="totalTaskPoints" class="main-value">0</p>
                <span id="totalTaskPointsEGP" class="sub-value">0 EGP</span>
            </div>
            
            <div class="card">
                <h3>🔗 عدد الإحالات</h3>
                <p id="referrals" class="main-value">0</p>
            </div>

            <div class="card">
                <h3>🌟 مجموع النقاط من الإحالات</h3>
                <p id="referralPoints" class="main-value">0</p>
                <span id="referralPointsEGP" class="sub-value">0 EGP</span>
            </div>

            <div class="card">
                <h3>💎 إجمالي نقاط المستخدمين الكلية</h3>
                <p id="totalPoints" class="main-value">0</p>
                <span id="totalPointsEGPEl" class="sub-value">0 EGP</span>
            </div>

            <div class="card danger">
                <h3>💸 إجمالي المبالغ المسحوبة (الكل)</h3>
                <p id="totalWithdrawn" class="main-value">0 EGP</p>
            </div>

            <div class="card">
                <h3>💵 المبالغ المسحوبة اليوم</h3>
                <p id="withdrawTodayPoints" class="main-value">0 نقطة</p>
                <span id="withdrawTodayEGP" class="sub-value">0 EGP</span>
            </div>

            <div class="card danger">
                <h3>⏳ طلبات السحب المعلقة</h3>
                <p id="pendingWithdrawals" class="main-value">0</p>
            </div>
        </section>
        
        <div class="btn-container">
            <button class="btn" onclick="location.href='users.html'">👥 المستخدمين</button>
            <button class="btn" onclick="location.href='tasks.html'">🧾 المهام</button>
            <button class="btn" onclick="location.href='referrals.html'">🔗 الإحالات</button>
            <button class="btn" onclick="location.href='withdrawals.html'">💰 السحوبات</button>
            <button class="btn" onclick="location.href='pending.html'">⏳ المعلقة</button>
        </div>
    </div>
</div>

<footer>
    © 2025 Am Rewards — لوحة الإدارة الخاصة
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
    // 🛑 **1. إعدادات Firebase**
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.firebasestorage.app",
      messagingSenderId: "744783579735",
      appId: "1:744783579735:web:45e00de9998893bbc9b112",
      measurementId: "G-CV3GLT2TTJ"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // **2. الثوابت والمتغيرات**
    const adminEmail = "amirfg992005@gmail.com"; 
    const POINT_VALUE_EGP = 0.07; 
    const ACTIVE_USERS_THRESHOLD = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000); 

    // **3. عناصر DOM**
    const loadingOverlay = document.getElementById('loading-overlay');
    const loginContainer = document.getElementById('login-container');
    const dashboardContent = document.getElementById('dashboard-content');
    const loginButton = document.getElementById('loginButton');
    const adminEmailInput = document.getElementById('adminEmailInput');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const loginError = document.getElementById('loginError');

    const totalUsersEl = document.getElementById("totalUsers");
    const activeUsersEl = document.getElementById("activeUsers");
    const totalTaskPointsEl = document.getElementById("totalTaskPoints");
    const totalTaskPointsEGPEl = document.getElementById("totalTaskPointsEGP");
    const referralsEl = document.getElementById('referrals');
    const referralPointsEl = document.getElementById('referralPoints');
    const referralPointsEGPEl = document.getElementById('referralPointsEGP');
    const totalPointsEl = document.getElementById('totalPoints');
    const totalPointsEGPEl = document.getElementById('totalPointsEGPEl');
    const totalWithdrawnEl = document.getElementById('totalWithdrawn');
    const withdrawTodayPointsEl = document.getElementById("withdrawTodayPoints");
    const withdrawTodayEGPEl = document.getElementById("withdrawTodayEGP");
    const pendingWithdrawalsEl = document.getElementById('pendingWithdrawals');


    // 💡 دوال مساعدة
    function formatNumber(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    function formatEGP(num) {
        return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 2 }) + " EGP";
    }
    function getTodayStart() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today;
    }
    function showLoading() {
        loadingOverlay.classList.remove('hidden');
    }
    function hideLoading() {
        loadingOverlay.classList.add('hidden');
    }
    
    function displayError(message) {
        const existingError = document.querySelector('.error-message');
        if (existingError) existingError.remove();

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `❌ ${message}`;
        document.querySelector('.wrap').prepend(errorDiv);
        
        const errorText = "خطأ في التحميل";
        totalUsersEl.textContent = errorText;
        activeUsersEl.textContent = errorText;
        totalTaskPointsEl.textContent = errorText;
        totalTaskPointsEGPEl.textContent = errorText;
        referralsEl.textContent = errorText;
        referralPointsEl.textContent = errorText;
        referralPointsEGPEl.textContent = errorText;
        totalPointsEl.textContent = errorText;
        totalPointsEGPEl.textContent = errorText;
        totalWithdrawnEl.textContent = errorText;
        withdrawTodayPointsEl.textContent = errorText;
        withdrawTodayEGPEl.textContent = errorText;
        pendingWithdrawalsEl.textContent = errorText;
    }

    // **4. دالة تسجيل الدخول**
    async function handleLogin() {
        const email = adminEmailInput.value;
        const password = adminPasswordInput.value;
        
        if (email !== adminEmail) {
            loginError.textContent = "البريد الإلكتروني غير مصرح له بالدخول كمدير.";
            loginError.classList.remove('hidden');
            return;
        }

        try {
            loginButton.textContent = 'جاري التحميل...';
            loginButton.disabled = true;
            showLoading();
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error("Login error:", error);
            loginButton.textContent = 'تسجيل الدخول';
            loginButton.disabled = false;
            hideLoading();
            
            let errorMessage = "فشل تسجيل الدخول. تأكد من كلمة المرور.";
            if (error.code === 'auth/wrong-password') {
                errorMessage = "كلمة المرور غير صحيحة.";
            } else if (error.code === 'auth/user-not-found') {
                errorMessage = "المستخدم غير موجود.";
            }
            loginError.textContent = errorMessage;
            loginError.classList.remove('hidden');
        }
    }


    // **5. جلب بيانات لوحة التحكم (الإصدار النهائي المُصحَّح للسحب وحقل التاريخ)**
    async function loadDashboardData() {
        try {
            showLoading(); 
            const todayStart = getTodayStart();
            
            // --- 1. جلب بيانات المستخدمين والحسابات الكلية (للمستخدمين والإحالات والنقاط) ---
            let usersSnap = null;
            try {
                usersSnap = await getDocs(collection(db, "users"));
                totalUsersEl.textContent = formatNumber(usersSnap.size);
            } catch (err) {
                console.error("FIREBASE ERROR: Failed to fetch users collection.", err);
                displayError("فشل في جلب مجموعة المستخدمين (users).");
                hideLoading();
                return; 
            }
            
            let totalReferralsCount = 0;
            let totalReferralPoints = 0;
            let totalPoints = 0; 
            let totalTaskPoints = 0; 
            let activeUsersCount = 0;

            usersSnap.forEach(doc => {
                const data = doc.data();
                
                totalReferralsCount += Number(data.referralCount || 0) || 0;
                totalReferralPoints += Number(data.referralPoints || 0) || 0;
                
                totalPoints += Number(data.points || 0) || 0; 
                totalTaskPoints += Number(data.tasksPoints || 0) || 0; 
                
                // التعامل مع خاصية lastLogin
                let lastLoginDate = null;
                if (data.lastLogin) {
                    if (typeof data.lastLogin.toDate === 'function') {
                        lastLoginDate = data.lastLogin.toDate();
                    } else if (data.lastLogin instanceof Date) {
                        lastLoginDate = data.lastLogin;
                    }
                }

                if (lastLoginDate && lastLoginDate >= ACTIVE_USERS_THRESHOLD) {
                    activeUsersCount++;
                }
            });
            
            if (totalTaskPoints === 0 && totalPoints > 0) {
                totalTaskPoints = totalPoints - totalReferralPoints; 
                if (totalTaskPoints < 0) totalTaskPoints = 0;
            }

            // تحديث الإحصائيات الشاملة (للمستخدمين، النقاط، الإحالات)
            activeUsersEl.textContent = formatNumber(activeUsersCount);
            referralsEl.textContent = formatNumber(totalReferralsCount);
            totalTaskPointsEl.textContent = formatNumber(totalTaskPoints);
            totalTaskPointsEGPEl.textContent = formatEGP(totalTaskPoints * POINT_VALUE_EGP);
            referralPointsEl.textContent = formatNumber(totalReferralPoints);
            referralPointsEGPEl.textContent = formatEGP(totalReferralPoints * POINT_VALUE_EGP);
            totalPointsEl.textContent = formatNumber(totalPoints);
            totalPointsEGPEl.textContent = formatEGP(totalPoints * POINT_VALUE_EGP);


            // --- 2. جلب الإجمالي الكلي للمبالغ المسحوبة (من Withdrawals) ---
            let totalWithdrawnAmount = 0; 
            try {
                // استعلام لجمع جميع السحوبات المكتملة
                const allCompletedQuery = query(collection(db, "withdrawals"), where("state", "==", "completed")); 
                const completedSnap = await getDocs(allCompletedQuery);
                
                completedSnap.forEach(doc => {
                    // نجمع قيمة حقل 'net' (صافي المبلغ بالجنيه)
                    const netAmount = doc.data().net ? Number(doc.data().net) : 0;
                    totalWithdrawnAmount += netAmount;
                });
                
                // تحديث إجمالي المسحوبات (الكل)
                totalWithdrawnEl.textContent = formatEGP(totalWithdrawnAmount);

            } catch (err) {
                console.error("FIREBASE ERROR: Failed to fetch total withdrawn from withdrawals collection.", err);
                totalWithdrawnEl.textContent = "Error";
            }
            
            
            // --- 3. جلب طلبات السحب المعلقة ---
            let pendingSnap = null;
            try {
                // استخدام 'state' بدلاً من 'status'
                const pendingQuery = query(collection(db, "withdrawals"), where("state", "==", "pending")); 
                pendingSnap = await getDocs(pendingQuery);
                pendingWithdrawalsEl.textContent = formatNumber(pendingSnap.size);
            } catch (err) {
                console.error("FIREBASE ERROR: Failed to fetch pending withdrawals. Ignoring for dashboard integrity.", err);
                pendingWithdrawalsEl.textContent = "Error"; 
            }


            // --- 4. جلب طلبات السحب اليوم (تصحيح الحقل إلى date) ---
            let withdrawTodaySnap = null;
            try {
                const withdrawTodayQuery = query(
                  collection(db, "withdrawals"), 
                  // 🥳 تم التعديل إلى حقل 'date'
                  where("date", ">=", todayStart), 
                  where("state", "in", ["pending", "completed"]) 
                );
                withdrawTodaySnap = await getDocs(withdrawTodayQuery);

                let totalWithdrawnTodayPoints = 0;
                withdrawTodaySnap.forEach(doc => {
                    const points = doc.data().points ? Number(doc.data().points) : 0;
                    totalWithdrawnTodayPoints += points;
                });
                
                const totalWithdrawnTodayEGP = totalWithdrawnTodayPoints * POINT_VALUE_EGP;
                withdrawTodayPointsEl.textContent = formatNumber(totalWithdrawnTodayPoints) + " نقطة";
                withdrawTodayEGPEl.textContent = formatEGP(totalWithdrawnTodayEGP);
            } catch (err) {
                // ملاحظة: إذا فشل هذا الجزء الآن، فعليك التأكد أن الفهرس مركب على (date, state)
                console.error("FIREBASE ERROR: Failed to fetch today withdrawals. Index or date field type is the issue.", err);
                withdrawTodayPointsEl.textContent = "Error";
                withdrawTodayEGPEl.textContent = "Error";
            }

            
            hideLoading(); // إخفاء التحميل عند النجاح النهائي

        } catch (err) {
            console.error("FATAL ERROR in loadDashboardData:", err);
            displayError("حدث خطأ قاتل أثناء تحميل البيانات. الرجاء مراجعة Console.");
            hideLoading(); 
        }
    }

    // **6. منطق التحقق من الصلاحيات والتحميل**
    onAuthStateChanged(auth, async (user) => {
        if (user && user.email === adminEmail) {
            loginContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            await loadDashboardData();
        } else {
            loginContainer.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            if (user) await signOut(auth);
            hideLoading();
        }
    });
    
    // ربط زر تسجيل الدخول بالدالة
    loginButton.addEventListener('click', handleLogin);
    
    document.addEventListener('DOMContentLoaded', () => {
        hideLoading(); 
    });
</script>
</body>
</html>
