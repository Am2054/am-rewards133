<!-- âœ¨ Firebase Scripts -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, updateDoc, increment
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBO5HqF3-XBhOJJlZROecO4yAWrrJz1d3M",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
    storageBucket: "am--rewards.appspot.com",
    messagingSenderId: "647933512566",
    appId: "1:647933512566:web:b8ff3b759b121d00b4c3a0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const tasks = [
    { type: "ðŸ”— Ø±ÙˆØ§Ø¨Ø· Ù…Ø®ØªØµØ±Ø©", count: 60, pointsPerTask: 1.5, url: "shortlinks.html", class: "btn-shortlink" },
    { type: "ðŸ¤– Ø£Ø¯ÙˆØ§Øª AI ÙˆØªØ¬Ø±ÙŠØ¨ Ù…Ù†ØµØ§Øª", count: 30, pointsPerTask: 4, url: "ai-tools.html", class: "btn-ai" },
    { type: "ðŸ“‹ Ø¹Ø±ÙˆØ¶ CPA", count: 30, pointsPerTask: 10, url: "cpa-offers.html", class: "btn-cpa" },
    { type: "ðŸ“± Ø¹Ø±ÙˆØ¶ ØªØ·Ø¨ÙŠÙ‚Ø§Øª", count: 20, pointsPerTask: 15, url: "promote-apps.html", class: "btn-explore" },
    { type: "ðŸŒ Ø§Ø³ØªÙƒØ´Ø§Ù Ù…ÙˆØ§Ù‚Ø¹", count: 30, pointsPerTask: 3, url: "explore.html", class: "btn-explore" },
    { type: "ðŸ“Š Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª Ø±Ø£ÙŠ (CPX ÙˆØºÙŠØ±Ù‡Ø§)", count: 10, pointsPerTask: 20, url: "surveys.html", class: "btn-poll" },
    { type: "ðŸŽ Ù…ÙƒØ§ÙØ£Ø© Ø¥ØªÙ…Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…", count: 1, pointsPerTask: 500, url: "#", class: "btn-gift", locked: true }
  ];

  const totalTasks = tasks.reduce((sum, task) => sum + task.count, 0);
  const totalPoints = tasks.reduce((sum, task) => sum + (task.count * task.pointsPerTask), 0);
  const totalEgp = (totalPoints * 0.07).toFixed(2);
  document.getElementById("point-value").innerHTML =
    `ðŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø·Ø© = 0.07 Ø¬Ù†ÙŠÙ‡ | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…: ${totalTasks} | Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ: ${totalEgp} Ø¬Ù†ÙŠÙ‡`;

  const tbody = document.getElementById("tasksBody");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) return;

    const userData = userSnap.data();
    const completedTasks = userData.completedTasks || 0;
    const finalRewardGiven = userData.finalRewardGiven || false;

    // âœ… Ø¥Ø°Ø§ Ø£ØªÙ… 180 Ù…Ù‡Ù…Ø© ÙˆÙ„Ù… ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
    if (completedTasks >= 180 && !finalRewardGiven) {
      await updateDoc(userRef, {
        points: increment(500),
        finalRewardGiven: true
      });
      alert("ðŸŽ ØªÙ… Ù…Ù†Ø­Ùƒ 500 Ù†Ù‚Ø·Ø© Ù…ÙƒØ§ÙØ£Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…! âœ…");
      // ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
      tasks[tasks.length - 1].locked = false;
      tasks[tasks.length - 1].url = "final-reward.html";
    } else if (completedTasks >= 180 && finalRewardGiven) {
      // ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
      tasks[tasks.length - 1].locked = false;
      tasks[tasks.length - 1].url = "final-reward.html";
    }

    // ðŸ–Šï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    tasks.forEach(task => {
      const totalPts = (task.pointsPerTask * task.count).toFixed(1);
      const egp = (totalPts * 0.07).toFixed(2);
      const isLocked = task.locked;
      const btn = isLocked
        ? `<button class="task-btn ${task.class}" disabled>ðŸ”’ ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯</button>`
        : `<button class="task-btn ${task.class}" onclick="location.href='${task.url}'">Ø§Ø¨Ø¯Ø£</button>`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${task.type}</td>
        <td>${task.count}</td>
        <td>${task.pointsPerTask}</td>
        <td>${totalPts}</td>
        <td>${egp} Ø¬Ù†ÙŠÙ‡</td>
        <td>${btn}</td>
      `;
      tbody.appendChild(tr);
    });
  });
     </script>
