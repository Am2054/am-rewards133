<!-- ✨ Firebase Scripts -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, updateDoc, increment
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBO5HqF3-XBhOJJlZROecO4yAWrrJz1d3M",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
    storageBucket: "am--rewards.appspot.com",
    messagingSenderId: "647933512566",
    appId: "1:647933512566:web:b8ff3b759b121d00b4c3a0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const tasks = [
    { type: "🔗 روابط مختصرة", count: 60, pointsPerTask: 1.5, url: "shortlinks.html", class: "btn-shortlink" },
    { type: "🤖 أدوات AI وتجريب منصات", count: 30, pointsPerTask: 4, url: "ai-tools.html", class: "btn-ai" },
    { type: "📋 عروض CPA", count: 30, pointsPerTask: 10, url: "cpa-offers.html", class: "btn-cpa" },
    { type: "📱 عروض تطبيقات", count: 20, pointsPerTask: 15, url: "promote-apps.html", class: "btn-explore" },
    { type: "🌍 استكشاف مواقع", count: 30, pointsPerTask: 3, url: "explore.html", class: "btn-explore" },
    { type: "📊 استطلاعات رأي (CPX وغيرها)", count: 10, pointsPerTask: 20, url: "surveys.html", class: "btn-poll" },
    { type: "🎁 مكافأة إتمام جميع المهام", count: 1, pointsPerTask: 500, url: "#", class: "btn-gift", locked: true }
  ];

  const totalTasks = tasks.reduce((sum, task) => sum + task.count, 0);
  const totalPoints = tasks.reduce((sum, task) => sum + (task.count * task.pointsPerTask), 0);
  const totalEgp = (totalPoints * 0.07).toFixed(2);
  document.getElementById("point-value").innerHTML =
    `💰 قيمة النقطة = 0.07 جنيه | عدد المهام: ${totalTasks} | الربح اليومي: ${totalEgp} جنيه`;

  const tbody = document.getElementById("tasksBody");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) return;

    const userData = userSnap.data();
    const completedTasks = userData.completedTasks || 0;
    const finalRewardGiven = userData.finalRewardGiven || false;

    // ✅ إذا أتم 180 مهمة ولم يحصل على المكافأة
    if (completedTasks >= 180 && !finalRewardGiven) {
      await updateDoc(userRef, {
        points: increment(500),
        finalRewardGiven: true
      });
      alert("🎁 تم منحك 500 نقطة مكافأة لإتمام جميع المهام! ✅");
      // فتح المكافأة
      tasks[tasks.length - 1].locked = false;
      tasks[tasks.length - 1].url = "final-reward.html";
    } else if (completedTasks >= 180 && finalRewardGiven) {
      // فتح المكافأة (للعرض فقط)
      tasks[tasks.length - 1].locked = false;
      tasks[tasks.length - 1].url = "final-reward.html";
    }

    // 🖊️ عرض المهام بعد تحديث الحالة
    tasks.forEach(task => {
      const totalPts = (task.pointsPerTask * task.count).toFixed(1);
      const egp = (totalPts * 0.07).toFixed(2);
      const isLocked = task.locked;
      const btn = isLocked
        ? `<button class="task-btn ${task.class}" disabled>🔒 غير متاحة بعد</button>`
        : `<button class="task-btn ${task.class}" onclick="location.href='${task.url}'">ابدأ</button>`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${task.type}</td>
        <td>${task.count}</td>
        <td>${task.pointsPerTask}</td>
        <td>${totalPts}</td>
        <td>${egp} جنيه</td>
        <td>${btn}</td>
      `;
      tbody.appendChild(tr);
    });
  });
     </script>
