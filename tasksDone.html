<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AM REWARDS | TASKS ANALYTICS PRO</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #030712; --card: rgba(17, 24, 39, 0.7); --gold: #f5c542; 
      --border: rgba(245, 197, 66, 0.1); --text: #eef2f7; --accent: #00fa9a;
      --blue: #3b82f6; --red: #ef4444;
    }
    body { font-family: "Cairo", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; background-image: radial-gradient(circle at top right, #1e293b, #030712); min-height: 100vh; }
    .wrap { max-width: 1000px; margin: 0 auto; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; padding: 25px; background: var(--card); border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(15px); }
    header h1 { margin: 0; font-family: 'Syncopate'; color: var(--gold); font-size: 1.2rem; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-item { background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid var(--border); border-bottom: 3px solid var(--gold); text-align: center; transition: 0.3s; }
    .stat-item strong { display: block; font-size: 1.8rem; font-family: 'Syncopate'; color: #fff; margin-bottom: 5px; }
    .stat-item span { color: var(--gold); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .control-card { background: var(--card); border-radius: 28px; padding: 25px; border: 1px solid var(--border); backdrop-filter: blur(15px); margin-bottom: 30px; }
    .controls { display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap; }
    select, input[type="date"], .btn-main { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; padding: 10px 15px; border-radius: 12px; outline: none; font-family: 'Cairo'; cursor: pointer; }
    .btn-main { background: var(--gold); color: #000; font-weight: 900; border: none; font-family: 'Syncopate'; font-size: 0.7rem; padding: 12px 20px; }
    .chart-box { height: 300px; margin: 25px 0; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 15px; border: 1px solid var(--border); }
    .task-list { list-style: none; padding: 0; margin: 0; }
    .task-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; margin-bottom: 10px; background: rgba(255,255,255,0.03); border-radius: 18px; border: 1px solid transparent; transition: 0.3s; }
    .task-name { font-weight: 700; color: #fff; display: flex; align-items: center; gap: 10px; }
    .rank-badge { width: 28px; height: 28px; background: var(--gold); color: #000; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 900; font-size: 0.8rem; }
    .count-badge { background: #000; color: var(--accent); padding: 6px 15px; border-radius: 10px; font-family: 'Syncopate'; font-weight: 700; border: 1px solid rgba(0,250,154,0.2); }
    .loader { border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid var(--gold); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    #auth-gate { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 10000; }
  </style>
</head>
<body>

  <div id="auth-gate">
      <div style="text-align:center;">
          <div class="loader" style="width:40px; height:40px; margin:0 auto 20px;"></div>
          <p style="font-family:'Syncopate'; color:var(--gold);">VERIFYING AUTHORITY...</p>
      </div>
  </div>

  <div id="main-content" class="wrap hidden">
    <header>
      <h1>TASKS <span style="color:#64748b; font-size:0.9rem;">ANALYTICS PRO</span></h1>
      <a href="index.html" style="text-decoration:none; color:var(--accent); font-weight:700;">BACK TO HUB</a>
    </header>

    <div class="metrics">
      <div class="stat-item"><strong id="totalTasks">0</strong><span>Total Executions</span></div>
      <div class="stat-item" style="border-right-color:var(--accent);"><strong id="todayTasks">0</strong><span>Today's Tasks</span></div>
      <div class="stat-item" style="border-right-color:var(--blue);"><strong id="uniqueTasks">0</strong><span>Unique Types</span></div>
    </div>

    <div class="control-card">
      <div class="controls">
          <select id="timeFilter">
              <option value="today">Today</option>
              <option value="7days">7 Days</option>
              <option value="30days" selected>30 Days</option>
              <option value="custom">Custom Range</option>
              <option value="all">Lifetime</option>
          </select>
          <div id="customDateGroup" class="hidden" style="display:inline-flex; gap:5px;">
              <input type="date" id="dateFrom">
              <input type="date" id="dateTo">
          </div>
          <button id="refreshBtn" class="btn-main">REFRESH</button>
      </div>

      <div class="chart-box">
          <canvas id="taskDistributionChart"></canvas>
      </div>

      <div style="margin-top: 40px;">
        <h3 style="text-align: center; font-family: 'Syncopate'; font-size: 0.9rem; color: var(--gold); margin-bottom: 25px;">ðŸ¥‡ TOP PERFORMING TASKS</h3>
        <ul id="topTasksList" class="task-list"></ul>
      </div>

      <div style="text-align:center; margin-top:20px; font-size:0.7rem; color:#64748b;">
          <div id="loadingSpinner" class="loader hidden" style="display:inline-block; vertical-align:middle; margin-left:10px;"></div>
          <span id="statusText">System ready...</span>
          <div id="autoRefreshNotice" style="margin-top:5px; color:var(--accent); font-weight:700;">Auto-refresh: Active (60s)</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", authDomain: "am--rewards.firebaseapp.com", projectId: "am--rewards" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_EMAIL = "amirfg992005@gmail.com";
    let taskChart = null;

    // --- Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµØ§Ø±Ù…Ø© ---
    onAuthStateChanged(auth, user => {
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            fetchAndAnalyzeTasks();
            setInterval(fetchAndAnalyzeTasks, 60000); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        } else {
            window.location.href = "index.html";
        }
    });

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ---
    function updateChart(labels, data) {
        const ctx = document.getElementById('taskDistributionChart').getContext('2d');
        if (taskChart) taskChart.destroy();
        taskChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Executions',
                    data: data,
                    backgroundColor: 'rgba(245, 197, 66, 0.6)',
                    borderColor: '#f5c542',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                    x: { grid: { display: false }, ticks: { color: '#64748b' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    async function fetchAndAnalyzeTasks() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusText = document.getElementById('statusText');
        loadingSpinner.classList.remove('hidden');
        statusText.textContent = 'Updating live metrics...';

        const filter = document.getElementById('timeFilter').value;
        let startDate = null;
        let endDate = null;

        if (filter === 'today') startDate = new Date(new Date().setHours(0,0,0,0));
        else if (filter === '7days') startDate = new Date(Date.now() - 7*24*60*60*1000);
        else if (filter === '30days') startDate = new Date(Date.now() - 30*24*60*60*1000);
        else if (filter === 'custom') {
            startDate = new Date(document.getElementById('dateFrom').value);
            endDate = new Date(document.getElementById('dateTo').value);
            endDate.setHours(23,59,59,999);
        }

        try {
            let q = collection(db, 'tasksCompleted');
            if (startDate && filter !== 'all') {
                q = query(q, where('date', '>=', startDate));
                if (filter === 'custom' && endDate) q = query(q, where('date', '<=', endDate));
            }
            
            const snap = await getDocs(q);
            const taskCounts = {};
            let todayCount = 0;
            const todayStr = new Date().toDateString();

            snap.forEach(doc => {
                const d = doc.data();
                const type = d.taskType || d.taskId || 'Unknown';
                taskCounts[type] = (taskCounts[type] || 0) + 1;
                const dDate = d.date?.toDate ? d.date.toDate() : null;
                if (dDate && dDate.toDateString() === todayStr) todayCount++;
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('totalTasks').textContent = snap.size.toLocaleString();
            document.getElementById('todayTasks').textContent = todayCount.toLocaleString();
            document.getElementById('uniqueTasks').textContent = Object.keys(taskCounts).length;

            const sorted = Object.entries(taskCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            renderList(sorted);
            updateChart(sorted.map(s => s[0]), sorted.map(s => s[1]));

            statusText.textContent = 'Sync Complete: ' + new Date().toLocaleTimeString();
        } catch (e) {
            statusText.textContent = 'Error syncing data.';
            console.error(e);
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    function renderList(data) {
        const list = document.getElementById('topTasksList');
        list.innerHTML = data.map(([name, count], i) => `
            <li class="task-item">
                <div class="task-name"><div class="rank-badge">${i+1}</div>${name}</div>
                <div class="count-badge">${count.toLocaleString()}</div>
            </li>
        `).join('') || '<p style="text-align:center; opacity:0.5;">No data found</p>';
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
    document.getElementById('timeFilter').onchange = (e) => {
        document.getElementById('customDateGroup').classList.toggle('hidden', e.target.value !== 'custom');
        fetchAndAnalyzeTasks();
    };
    document.getElementById('refreshBtn').onclick = fetchAndAnalyzeTasks;
  </script>
</body>
</html>
