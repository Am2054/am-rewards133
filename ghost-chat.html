<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">  
    <title>Ø´Ø§Øª Ø§Ù„Ø£Ø´Ø¨Ø§Ø­ PRO | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>  
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">  
    <style>  
        :root {   
            --cyan: #00f2ff; --purple: #7000ff; --dark: #020617;   
            --danger: #ff4444; --system: #94a3b8; --success: #10b981;  
            --glass: rgba(2, 6, 23, 0.7);  
        }  
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }  
        input, .text { user-select: text; }  
        
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; color: #fff; }  
        body { 
            font-family: 'Tajawal', sans-serif; 
            display: flex; 
            flex-direction: column; 
            background: #020617 url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1500') no-repeat center center fixed; 
            background-size: cover; 
            user-select: none;
        }  
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45); z-index: -1; }  

        /* Overlay Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† */
        #rulesOverlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(20px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; transition: 0.5s all ease; }  
        .rules-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 30px; padding: 30px; max-width: 400px; width: 100%; text-align: center; }  
        .rules-card h3 { color: var(--cyan); margin: 0 0 20px; }  
        .rules-list { list-style: none; padding: 0; font-size: 13px; color: #cbd5e1; margin-bottom: 25px; text-align: right; }  
        .rules-list li { margin-bottom: 12px; padding-right: 25px; position: relative; }  
        .rules-list li::before { content: "âœ¦"; position: absolute; right: 0; color: var(--cyan); }  
        .agree-btn { width: 100%; background: linear-gradient(135deg, var(--cyan), var(--purple)); color: #fff; border: none; padding: 16px; border-radius: 50px; font-weight: 900; cursor: pointer; }  

        header { padding: env(safe-area-inset-top, 15px) 15px 15px; text-align: center; background: var(--glass); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(0, 242, 255, 0.1); z-index: 100; }  
        #status { font-size: 10px; color: var(--cyan); display: block; margin-top: 5px; opacity: 0.9; }  
        #onlineCounter { font-size: 11px; color: var(--success); font-weight: bold; margin-top: 4px; }

        #chatBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }  

        .msg { max-width: 80%; padding: 12px 16px; border-radius: 22px; font-size: 14px; backdrop-filter: blur(8px); animation: msgIn 0.4s ease; position: relative; }  
        @keyframes msgIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }  

        .msg-remote { align-self: flex-start; background: rgba(2, 6, 23, 0.75); border: 1px solid rgba(255,255,255,0.1); border-bottom-right-radius: 4px; }  
        .msg-me { align-self: flex-end; background: rgba(112, 0, 255, 0.75); border: 1px solid rgba(112, 0, 255, 0.3); border-bottom-left-radius: 4px; }  
        
        .msg-secret { background: linear-gradient(135deg, rgba(30, 27, 75, 0.9), rgba(49, 46, 129, 0.9)) !important; border: 1px solid var(--danger) !important; }  
        .msg-confession { background: linear-gradient(135deg, rgba(153, 27, 27, 0.9), rgba(69, 10, 10, 0.9)) !important; border: 1px solid var(--danger) !important; box-shadow: 0 0 15px rgba(255, 68, 68, 0.3); }

        .sender { font-size: 10px; font-weight: 900; color: var(--cyan); margin-bottom: 6px; display: flex; justify-content: space-between; }  
        .text { word-wrap: break-word; line-height: 1.4; }

        .input-area { padding: 15px; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: calc(15px + env(safe-area-inset-bottom)); }  
        .input-wrapper { display: flex; gap: 10px; align-items: center; max-width: 600px; margin: 0 auto; }  
        input { flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid #444; padding: 14px 20px; border-radius: 30px; color: #fff; outline: none; font-size: 16px; }  
        input:disabled { opacity: 0.5; }
        .send-btn { background: var(--cyan); border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 20px; color: #000; font-weight: bold; transition: 0.3s; }  
        .send-btn:disabled { background: #444; color: #777; opacity: 0.5; filter: grayscale(1); }  
    </style>
</head>  
<body>  

<div id="rulesOverlay">  
    <div class="rules-card">  
        <h3>ğŸ“œ Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø£Ø´Ø¨Ø§Ø­ v5.0</h3>  
        <ul class="rules-list">  
            <li><b>Ø§Ù„ØªØ´ÙÙŠØ±:</b> Ù‡ÙˆÙŠØªÙƒ Ù…ØªØºÙŠØ±Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙˆÙ…Ø­Ù…ÙŠØ© Ø¨Ø³ÙŠØ±ÙØ± Ø³Ø­Ø§Ø¨ÙŠ.</li>  
            <li><b>Ø§Ù„Ø§Ø¹ØªØ±Ø§Ù:</b> Ø§Ø³ØªØ®Ø¯Ù… <b>#Ø§Ø¹ØªØ±Ø§Ù</b> Ù„ÙŠØªÙˆÙ‡Ø¬ ÙƒÙ„Ø§Ù…Ùƒ Ø¨Ù„ÙˆÙ† Ø§Ù„Ø¯Ù….</li>  
            <li><b>Ø§Ù„ØªØ·Ù‡ÙŠØ±:</b> ÙŠØªÙ… Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ù‡Ù…Ø³Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©.</li>  
            <li><b>Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…:</b> Ø§Ù„Ø£Ø´Ø¨Ø§Ø­ ÙƒØ§Ø¦Ù†Ø§Øª Ø±Ø§Ù‚ÙŠØ©ØŒ Ø£ÙŠ ØªØ¬Ø§ÙˆØ² ÙŠØ¤Ø¯ÙŠ Ù„Ù„Ù†ÙÙŠ.</li>  
        </ul>  
        <button class="agree-btn" onclick="acceptRules()">Ø£Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙŠØ«Ø§Ù‚ ğŸ•¯ï¸</button>  
    </div>  
</div>  

<header>  
    <h2 style="margin:0; font-weight:900; font-size:18px;">GHOST CHAT <span style="color:var(--cyan)">ULTIMATE</span></h2>  
    <span id="status">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙƒÙŠØ§Ù†Ùƒ...</span>  
    <div id="onlineCounter">ğŸ‘ï¸ Ø£Ø´Ø¨Ø§Ø­ Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¢Ù†: 0</div>
</header>  

<div id="chatBox"></div>  

<div class="input-area">  
    <div class="input-wrapper">  
        <input type="text" id="msgInput" placeholder="Ø§Ù‡Ù…Ø³ Ø£Ùˆ Ø§Ø¹ØªØ±Ù Ø¨Ù€ #..." maxlength="200" autocomplete="off" disabled>  
        <button class="send-btn" id="sendBtn" disabled>âœ¦</button>  
    </div>  
</div>  

<script type="module">  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";  
    import { getDatabase, ref, onChildAdded, onValue, query, limitToLast, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";  
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

    const firebaseConfig = {  
        apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
        authDomain: "am--rewards.firebaseapp.com",  
        databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",  
        projectId: "am--rewards",  
        storageBucket: "am--rewards.firebasestorage.app",  
        messagingSenderId: "744783579735",  
        appId: "1:744783579735:web:45e00de9998893bbc9b112"  
    };  
  
    const app = initializeApp(firebaseConfig);  
    const db = getDatabase(app);  
    const auth = getAuth(app);  
    const functions = getFunctions(app);
    const sendSecureMessage = httpsCallable(functions, 'sendSecureMessage');

    let currentUser = null;
    let myGhostName = "";

    const getDailyIdentity = () => {
        const today = new Date().toDateString();
        const savedDate = localStorage.getItem('ghost_id_date');
        if (savedDate !== today) {
            const adjs = ["Ø§Ù„ØºØ§Ù…Ø¶", "Ø§Ù„Ø«Ø§Ø¦Ø±", "Ø§Ù„Ù‡Ø§Ø¯Ø¦", "Ø§Ù„Ù…Ø­Ø§Ø±Ø¨", "Ø§Ù„Ø¹Ø§Ø¨Ø±", "Ø§Ù„ØµØ§Ù…Øª"];  
            const names = ["Ø·ÙŠÙ", "ÙƒÙŠØ§Ù†", "Ø³Ø±Ø§Ø¨", "Ø¸Ù„", "Ù†ÙˆØ±", "ØµØ¯Ù‰"];  
            const newName = `${names[Math.floor(Math.random()*names.length)]} ${adjs[Math.floor(Math.random()*adjs.length)]} #${Math.floor(1000+Math.random()*9000)}`;
            localStorage.setItem('ghost_name', newName);
            localStorage.setItem('ghost_id_date', today);
            return newName;
        }
        return localStorage.getItem('ghost_name');
    };

    signInAnonymously(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            myGhostName = getDailyIdentity();
            document.getElementById('status').innerText = "ÙƒÙŠØ§Ù†Ùƒ Ø§Ù„ÙŠÙˆÙ…: " + myGhostName;
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            initChat();
        }
    });

    window.acceptRules = () => {  
        localStorage.setItem('ghost_rules_final_v5', 'true');  
        document.getElementById('rulesOverlay').style.opacity = '0';  
        setTimeout(() => document.getElementById('rulesOverlay').style.display = 'none', 500);  
    };  
    if(localStorage.getItem('ghost_rules_final_v5')) acceptRules();  

    async function send() {  
        const input = document.getElementById('msgInput');  
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();  
        if(!text || btn.disabled) return;  

        btn.disabled = true;  
        try {  
            await sendSecureMessage({ text: text, sender: myGhostName });  
            input.value = "";  
        } catch(e) {
            alert(e.message);
        } finally {  
            setTimeout(() => { btn.disabled = false; }, 3000);  
        }  
    }  
  
    function initChat() {
        // ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø¶ÙˆØ± (Presence) Ø§Ù„ÙØ¹Ù„ÙŠ
        const presenceRef = ref(db, `online_users/${currentUser.uid}`);
        onValue(ref(db, '.info/connected'), (snap) => {
            if (snap.val()) {
                onDisconnect(presenceRef).remove();
                set(presenceRef, { name: myGhostName, last_seen: serverTimestamp() });
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠ
        onValue(ref(db, 'online_users'), (snap) => {
            const count = snap.exists() ? Object.keys(snap.val()).length : 0;
            document.getElementById('onlineCounter').innerText = `ğŸ‘ï¸ Ø£Ø´Ø¨Ø§Ø­ Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¢Ù†: ${count}`;
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ø´Ø®ØµÙŠ
        onValue(ref(db, `banned_users/${currentUser.uid}`), (snap) => {
            if (snap.exists()) {
                document.getElementById('status').innerText = "ğŸš« ÙƒÙŠØ§Ù†Ùƒ Ù…Ù†ÙÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹";
                document.getElementById('msgInput').placeholder = "ØªÙ… Ø­Ø¸Ø±Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹..";
                document.getElementById('msgInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
        const q = query(ref(db, "messages/global"), limitToLast(40));
        onChildAdded(q, (snap) => {
            const data = snap.val();
            // Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©)
            if ((Date.now() - data.timestamp) < 86400000) {
                renderMsg(data, data.uid === currentUser.uid);
            }
        });
    }

    function renderMsg(data, isMe) {
        const chatBox = document.getElementById('chatBox');  
        const div = document.createElement('div');  
        
        let msgClass = isMe ? 'msg-me' : 'msg-remote';
        if(data.isSecret) msgClass += ' msg-secret';
        if(data.isConfession) msgClass += ' msg-confession';
        div.className = `msg ${msgClass}`;  

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø­Ù…Ø§ÙŠØ© XSS
        const senderDiv = document.createElement('div');
        senderDiv.className = 'sender';
        senderDiv.innerHTML = `<span>${isMe ? 'Ø£Ù†Øª' : data.sender}</span>`;
        if(data.isConfession) senderDiv.innerHTML += `<span style="font-size:8px;">ğŸ•¯ï¸ Ø§Ø¹ØªØ±Ø§Ù</span>`;

        const textDiv = document.createElement('div');
        textDiv.className = 'text';
        textDiv.textContent = data.text; // Ø­Ù…Ø§ÙŠØ© XSS Ø­Ù‚ÙŠÙ‚ÙŠØ©

        div.appendChild(senderDiv);
        div.appendChild(textDiv);
        
        chatBox.appendChild(div);  
        chatBox.scrollTop = chatBox.scrollHeight;  
    }
  
    document.getElementById('sendBtn').onclick = send;  
    document.getElementById('msgInput').onkeypress = (e) => e.key === 'Enter' && send();  
</script>  
</body>  
</html>
