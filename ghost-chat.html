<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">  
    <title>Ø´Ø§Øª Ø§Ù„Ø£Ø´Ø¨Ø§Ø­ PRO | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„</title>  
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">  
    <style>  
        :root {   
            --cyan: #00f2ff; --purple: #7000ff; --dark: #020617;   
            --danger: #ff4444; --system: #94a3b8; --success: #10b981;  
            --glass: rgba(2, 6, 23, 0.7);  
        }  
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }  
        input, .text { user-select: text; }  
        
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; color: #fff; }  
        body { 
            font-family: 'Tajawal', sans-serif; 
            display: flex; 
            flex-direction: column; 
            background: #020617 url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1500') no-repeat center center fixed; 
            background-size: cover; 
            user-select: none;
        }  
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45); z-index: -1; }  

        /* Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† v5 */
        #rulesOverlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(20px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; transition: 0.8s ease; }  
        .rules-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 30px; padding: 30px; max-width: 400px; width: 100%; text-align: center; }  
        .rules-card h3 { color: var(--cyan); margin: 0 0 20px; font-weight: 900; }  
        .rules-list { list-style: none; padding: 0; font-size: 14px; color: #cbd5e1; margin-bottom: 25px; text-align: right; }  
        .rules-list li { margin-bottom: 12px; padding-right: 25px; position: relative; }  
        .rules-list li::before { content: "âœ¦"; position: absolute; right: 0; color: var(--cyan); }  
        .agree-btn { width: 100%; background: linear-gradient(135deg, var(--cyan), var(--purple)); color: #fff; border: none; padding: 18px; border-radius: 50px; font-weight: 900; cursor: pointer; }  

        header { padding: env(safe-area-inset-top, 15px) 15px 15px; text-align: center; background: var(--glass); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(0, 242, 255, 0.1); z-index: 100; }  
        #status { font-size: 11px; color: var(--cyan); display: block; margin-top: 5px; font-weight: 900; }  
        #onlineCounter { font-size: 11px; color: var(--success); font-weight: bold; margin-top: 6px; background: rgba(16, 185, 129, 0.1); padding: 4px 12px; border-radius: 12px; }

        #chatBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }  

        .msg { max-width: 85%; padding: 14px 18px; border-radius: 24px; font-size: 15px; backdrop-filter: blur(10px); animation: msgIn 0.4s ease; position: relative; }  
        @keyframes msgIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }  

        .msg-remote { align-self: flex-start; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.08); border-bottom-right-radius: 4px; }  
        .msg-me { align-self: flex-end; background: linear-gradient(135deg, rgba(112, 0, 255, 0.5), rgba(70, 0, 255, 0.5)); border: 1px solid rgba(112, 0, 255, 0.3); border-bottom-left-radius: 4px; }  
        
        .msg-secret { background: linear-gradient(135deg, rgba(30, 27, 75, 0.95), rgba(49, 46, 129, 0.95)) !important; border: 1px solid var(--purple) !important; box-shadow: 0 0 15px rgba(112, 0, 255, 0.2); }  
        .msg-confession { background: linear-gradient(135deg, rgba(153, 27, 27, 0.9), rgba(69, 10, 10, 0.9)) !important; border: 1px solid var(--danger) !important; box-shadow: 0 0 20px rgba(255, 68, 68, 0.3); }

        .sender { font-size: 10px; font-weight: 900; color: var(--cyan); margin-bottom: 6px; display: flex; justify-content: space-between; }  
        .text { word-wrap: break-word; line-height: 1.5; }

        .input-area { padding: 15px; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: calc(15px + env(safe-area-inset-bottom)); }  
        .input-wrapper { display: flex; gap: 12px; align-items: center; max-width: 700px; margin: 0 auto; }  
        input { flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid #333; padding: 16px 22px; border-radius: 35px; color: #fff; outline: none; font-size: 16px; }  
        .send-btn { background: var(--cyan); border: none; width: 54px; height: 54px; border-radius: 50%; cursor: pointer; font-size: 22px; color: #000; font-weight: bold; transition: 0.3s; flex-shrink: 0; }  
        .send-btn:disabled { background: #334155; opacity: 0.5; }
    </style>
</head>  
<body>  

<div id="rulesOverlay">  
    <div class="rules-card">  
        <h3>ğŸ“œ Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø£Ø´Ø¨Ø§Ø­ v5.0</h3>  
        <ul class="rules-list">  
            <li><b>Ø§Ù„ØªØ´ÙÙŠØ±:</b> Ù‡ÙˆÙŠØªÙƒ ØªÙ…Ø± Ø¹Ø¨Ø± Ø®ÙˆØ§Ø¯Ù… Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø´ÙØ±Ø©.</li>  
            <li><b>Ø§Ù„Ø§Ø¹ØªØ±Ø§Ù:</b> Ø§Ø³ØªØ®Ø¯Ù… <b>#Ø§Ø¹ØªØ±Ø§Ù</b> Ù„ÙŠØªÙˆÙ‡Ø¬ Ù†ØµÙƒ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±.</li>  
            <li><b>Ø§Ù„ØªØ·Ù‡ÙŠØ±:</b> ØªÙØ­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©.</li>  
        </ul>  
        <button class="agree-btn" onclick="acceptRules()">Ø£Ø¯Ø®Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ•¯ï¸</button>  
    </div>  
</div>  

<header>  
    <h2 style="margin:0; font-weight:900; font-size:18px;">GHOST CHAT <span style="color:var(--cyan)">SERVER-SIDE</span></h2>  
    <span id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</span>  
    <div id="onlineCounter">ğŸ‘ï¸ Ø£Ø´Ø¨Ø§Ø­ Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¢Ù†: 0</div>
</header>  

<div id="chatBox"></div>  

<div class="input-area">  
    <div class="input-wrapper">  
        <input type="text" id="msgInput" placeholder="Ø§Ù‡Ù…Ø³ Ø£Ùˆ Ø§Ø¹ØªØ±Ù Ø¨Ù€ #..." maxlength="200" autocomplete="off" disabled>  
        <button class="send-btn" id="sendBtn" disabled>âœ¦</button>  
    </div>  
</div>  

<script type="module">  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";  
    import { getDatabase, ref, onChildAdded, onValue, query, limitToLast, set, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";  
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {  
        apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
        authDomain: "am--rewards.firebaseapp.com",  
        databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",  
        projectId: "am--rewards",  
        storageBucket: "am--rewards.firebasestorage.app",  
        messagingSenderId: "744783579735",  
        appId: "1:744783579735:web:45e00de9998893bbc9b112"  
    };  
  
    const app = initializeApp(firebaseConfig);  
    const db = getDatabase(app);  
    const auth = getAuth(app);  

    let currentUser = null;
    let myGhostName = "";
    const renderedMsgIds = new Set(); 

    const getDailyIdentity = () => {
        const today = new Date().toDateString();
        if (localStorage.getItem('ghost_id_date') !== today) {
            const adjs = ["Ø§Ù„ØºØ§Ù…Ø¶", "Ø§Ù„Ø«Ø§Ø¦Ø±", "Ø§Ù„Ù‡Ø§Ø¯Ø¦", "Ø§Ù„Ù…Ø­Ø§Ø±Ø¨", "Ø§Ù„Ø¹Ø§Ø¨Ø±", "Ø§Ù„ØµØ§Ù…Øª"];  
            const names = ["Ø·ÙŠÙ", "ÙƒÙŠØ§Ù†", "Ø³Ø±Ø§Ø¨", "Ø¸Ù„", "Ù†ÙˆØ±", "ØµØ¯Ù‰"];  
            const newName = `${names[Math.floor(Math.random()*names.length)]} ${adjs[Math.floor(Math.random()*adjs.length)]} #${Math.floor(1000+Math.random()*9000)}`;
            localStorage.setItem('ghost_name', newName);
            localStorage.setItem('ghost_id_date', today);
            return newName;
        }
        return localStorage.getItem('ghost_name');
    };

    setPersistence(auth, browserLocalPersistence).then(() => signInAnonymously(auth));

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            myGhostName = getDailyIdentity();
            document.getElementById('status').innerText = "ÙƒÙŠØ§Ù†Ùƒ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ: " + myGhostName;
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            initChat();
        }
    });

    // Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ù„Ø§Ø³Ù… Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
    window.addEventListener("beforeunload", () => {
        if (myGhostName) {
            remove(ref(db, `online_users/${myGhostName}`)); 
        }
    });

    window.acceptRules = () => {  
        localStorage.setItem('ghost_rules_v5', 'true');  
        document.getElementById('rulesOverlay').style.opacity = '0';  
        setTimeout(() => document.getElementById('rulesOverlay').style.display = 'none', 500);  
    };  
    if(localStorage.getItem('ghost_rules_v5')) acceptRules();  

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± ---
    async function send() {  
        const input = document.getElementById('msgInput');  
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();  
        if(!text || btn.disabled) return;  

        btn.disabled = true;  

        try {  
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø£Ù…Ø§Ù†
            const token = await auth.currentUser.getIdToken();
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ± (Vercel API)
            const response = await fetch('/api/sendMessage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text, 
                    sender: myGhostName, 
                    uid: currentUser.uid, 
                    token: token 
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±ÙØ¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
            }

            input.value = "";  
        } catch(e) { 
            alert("Ø®Ø·Ø£ Ø³Ø­Ø§Ø¨ÙŠ: " + e.message); 
        } finally {
            setTimeout(() => { btn.disabled = false; }, 1000);  
        }
    }  
  
    function initChat() {
        const presenceRef = ref(db, `online_users/${myGhostName}`);
        onValue(ref(db, '.info/connected'), (snap) => {
            if (snap.val() === true) {
                set(presenceRef, { name: myGhostName, uid: currentUser.uid, last_seen: serverTimestamp() });
                onDisconnect(presenceRef).remove();
            }
        });

        onValue(ref(db, 'online_users'), (snap) => {
            const count = snap.exists() ? Object.keys(snap.val()).length : 0;
            document.getElementById('onlineCounter').innerText = `ğŸ‘ï¸ Ø£Ø´Ø¨Ø§Ø­ Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¢Ù†: ${count}`;
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø¸Ø± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        onValue(ref(db, `banned_users/${currentUser.uid}`), (snap) => {
            if (snap.exists()) {
                document.getElementById('msgInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('status').innerText = "ğŸš« ÙƒÙŠØ§Ù†Ùƒ Ù…Ø·Ø±ÙˆØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±";
            }
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù‡Ù†Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù…Ø¬Ø±Ø¯ ÙƒØªØ§Ø¨ØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±)
        const q = query(ref(db, "messages/global"), limitToLast(40));
        onChildAdded(q, (snap) => {
            if (renderedMsgIds.has(snap.key)) return;
            renderedMsgIds.add(snap.key);
            const data = snap.val();
            renderMsg(data, data.sender === myGhostName);
        });
    }

    function renderMsg(data, isMe) {
        const chatBox = document.getElementById('chatBox');  
        const div = document.createElement('div');  
        let msgClass = isMe ? 'msg-me' : 'msg-remote';
        if(data.isSecret) msgClass += ' msg-secret';
        if(data.isConfession) msgClass += ' msg-confession';
        div.className = `msg ${msgClass}`;  
        div.innerHTML = `<div class="sender"><span>${isMe ? 'Ø£Ù†Øª' : data.sender}</span>${data.isConfession ? '<span style="font-size:9px; color: #ff8888;">ğŸ•¯ï¸ Ø§Ø¹ØªØ±Ø§Ù</span>' : ''}</div><div class="text">${data.text}</div>`;
        chatBox.appendChild(div);  
        chatBox.scrollTop = chatBox.scrollHeight;  
    }
  
    document.getElementById('sendBtn').onclick = send;  
    document.getElementById('msgInput').onkeypress = (e) => e.key === 'Enter' && send();  
</script>  
</body>  
</html>
