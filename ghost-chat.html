<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Ø´Ø§Øª Ø§Ù„Ø£Ø´Ø¨Ø§Ø­ PRO | Ø§Ù„Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø³Ø±ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --cyan: #00f2ff; --purple: #7000ff; --dark: #020617; 
            --danger: #ff4444; --system: #94a3b8; --success: #10b981;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        input, .text { user-select: text; }

        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--dark); color: #fff; }
        body { 
            font-family: 'Tajawal', sans-serif; 
            display: flex; flex-direction: column; 
            background-size: cover; background-position: center; transition: background 0.5s ease;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø«Ø¨Ø§Øª Ø§Ù„ØµÙˆØ± */
        #bgContainer {
            position: fixed; inset: 0; z-index: -1;
            background-size: cover; background-position: center;
            transition: 0.5s filter, 0.5s background-image;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ */
        #rulesOverlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px); z-index: 1000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            transition: 0.5s all ease;
        }

        .rules-card {
            background: var(--glass); border: 1px solid rgba(0, 242, 255, 0.2);
            border-radius: 30px; padding: 30px; max-width: 400px; width: 100%;
        }

        .rules-card h3 { color: var(--cyan); text-align: center; font-size: 24px; margin-top: 0; }
        .rules-list { list-style: none; padding: 0; font-size: 13px; color: #cbd5e1; margin: 20px 0; }
        .rules-list li { margin-bottom: 12px; padding-right: 25px; position: relative; }
        .rules-list li::before { content: "âœ¦"; position: absolute; right: 0; color: var(--cyan); }

        .agree-btn {
            width: 100%; background: linear-gradient(135deg, var(--cyan), var(--purple)); 
            color: #fff; border: none; padding: 16px; border-radius: 50px; 
            font-weight: 900; cursor: pointer; font-size: 16px;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ© */
        #themePanel {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(20px);
            border-top: 1px solid var(--cyan); z-index: 500;
            padding: 20px; border-radius: 30px 30px 0 0;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #themePanel.open { bottom: 0; }
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .theme-opt { 
            height: 80px; border-radius: 15px; border: 2px solid transparent; 
            cursor: pointer; background-size: cover; background-position: center;
            transition: 0.3s;
        }
        .theme-opt.active { border-color: var(--cyan); transform: scale(0.95); }

        header { 
            padding: env(safe-area-inset-top, 15px) 15px 15px; text-align: center; 
            background: rgba(2, 6, 23, 0.6); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 242, 255, 0.1); z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        #chatBox { 
            flex: 1; overflow-y: auto; padding: 20px; display: flex; 
            flex-direction: column; gap: 15px; scroll-behavior: smooth;
            background: transparent; /* Ø¬Ø¹Ù„ Ø§Ù„Ø´Ø§Øª Ø´ÙØ§ÙØ§Ù‹ Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ù„ÙÙŠØ© */
        }

        .msg { 
            max-width: 80%; padding: 12px 16px; border-radius: 22px; font-size: 14px; 
            position: relative; animation: msgIn 0.4s ease;
            backdrop-filter: blur(5px);
        }
        .msg-remote { align-self: flex-start; background: rgba(2, 6, 23, 0.7); border: 1px solid rgba(255,255,255,0.1); }
        .msg-me { align-self: flex-end; background: rgba(112, 0, 255, 0.7); border: 1px solid rgba(112, 0, 255, 0.3); }

        .input-area { 
            padding: 15px; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); 
            border-top: 1px solid rgba(255,255,255,0.05); 
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        .input-wrapper { display: flex; gap: 10px; align-items: center; max-width: 600px; margin: 0 auto; }
        input { flex: 1; background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 14px 20px; border-radius: 30px; color: #fff; outline: none; }
        
        .send-btn { background: var(--cyan); border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; color: #000; }
        
        .settings-icon { font-size: 20px; cursor: pointer; color: var(--cyan); }

        @keyframes msgIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="bgContainer"></div>

<div id="rulesOverlay">
    <div class="rules-card">
        <h3>ğŸ“œ Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø£Ø´Ø¨Ø§Ø­</h3>
        <ul class="rules-list">
            <li><b>Ø§Ù„ØªØ´ÙÙŠØ±:</b> Ù‡ÙˆÙŠØªÙƒ ØªØªØºÙŠØ± Ø¯ÙˆØ±ÙŠØ§Ù‹.</li>
            <li><b>Ø§Ù„Ø®ØµÙˆØµÙŠØ©:</b> ÙŠÙ…Ù†Ø¹ ÙˆØ¶Ø¹ Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø·.</li>
            <li><b>Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…:</b> Ù„Ø§ ØªÙƒÙ† Ù…Ø³ÙŠØ¦Ø§Ù‹.</li>
        </ul>
        <button class="agree-btn" onclick="acceptRules()">Ø£Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙŠØ«Ø§Ù‚ ğŸ•¯ï¸</button>
    </div>
</div>

<header>
    <div style="width:30px"></div> <div>
        <h2 style="margin:0; font-weight:900; font-size:18px;">GHOST CHAT PRO</h2>
        <span id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ÙÙŠØ±...</span>
    </div>
    <div class="settings-icon" onclick="toggleThemePanel()">ğŸ–¼ï¸</div>
</header>

<div id="chatBox"></div>

<div id="themePanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:900; color:var(--cyan)">Ø§Ø®ØªØ± Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‡Ù…Ø³:</span>
        <span onclick="toggleThemePanel()" style="cursor:pointer; font-size:20px;">âœ•</span>
    </div>
    <div class="theme-grid">
        <div class="theme-opt" onclick="setTheme(0)" style="background-image:url('https://images.unsplash.com/photo-1433086566005-c733227c4462?q=80&w=300')"></div>
        <div class="theme-opt" onclick="setTheme(1)" style="background-image:url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=300')"></div>
        <div class="theme-opt" onclick="setTheme(2)" style="background-image:url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=300')"></div>
        <div class="theme-opt" onclick="setTheme(3)" style="background-image:url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=300')"></div>
    </div>
</div>

<div class="input-area">
    <div class="input-wrapper">
        <input type="text" id="msgInput" placeholder="Ø§Ù‡Ù…Ø³ Ø¨Ø´ÙŠØ¡ Ù„Ù„Ø¸Ù„Ø§Ù…..." maxlength="200" autocomplete="off">
        <button class="send-btn" id="sendBtn">âœ¦</button>
    </div>
</div>

<script type="module">
    // --- ÙƒÙˆØ¯ Ø§Ù„Ù€ Firebase (ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø­Ø°Ù) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.firebasestorage.app",
      messagingSenderId: "744783579735",
      appId: "1:744783579735:web:45e00de9998893bbc9b112"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages/room_pro");

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª ---
    const themes = [
        "https://images.unsplash.com/photo-1433086566005-c733227c4462?q=80&w=1000", // Ø´Ù„Ø§Ù„
        "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1000", // ØºØ§Ø¨Ø©
        "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1000", // Ø¨Ø­Ø±
        "https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=1000"  // Ù†Ø¬ÙˆÙ…
    ];

    window.toggleThemePanel = () => {
        document.getElementById('themePanel').classList.toggle('open');
    };

    window.setTheme = (index) => {
        const bg = document.getElementById('bgContainer');
        bg.style.backgroundImage = `url('${themes[index]}')`;
        localStorage.setItem('ghost_theme_idx', index);
        
        // ØªØ¹Ø¯ÙŠÙ„ ØªØºØ¨ÙŠØ´ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ùˆ Ø§Ù„ØµÙˆØ±Ø© ÙØ§ØªØ­Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¸Ù‡Ø±
        bg.style.filter = index < 2 ? "brightness(0.6) blur(2px)" : "brightness(0.8)";
        
        document.querySelectorAll('.theme-opt').forEach((opt, i) => {
            opt.classList.toggle('active', i === index);
        });
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…ÙØ¶Ù„
    const savedTheme = localStorage.getItem('ghost_theme_idx') || 3;
    setTheme(parseInt(savedTheme));

    // --- Ø¨Ù‚ÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (Ø§Ù„Ù‡ÙˆÙŠØ©ØŒ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ØŒ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„) ÙƒÙ…Ø§ Ù‡Ùˆ ---
    const getIdentity = () => {
        const adjs = ["Ø§Ù„ØºØ§Ù…Ø¶", "Ø§Ù„Ø«Ø§Ø¦Ø±", "Ø§Ù„Ù‡Ø§Ø¯Ø¦", "Ø§Ù„Ù…Ø­Ø§Ø±Ø¨"];
        const names = ["Ø·ÙŠÙ", "ÙƒÙŠØ§Ù†", "Ø³Ø±Ø§Ø¨", "Ø¸Ù„"];
        return `${names[Math.floor(Math.random()*names.length)]} ${adjs[Math.floor(Math.random()*adjs.length)]} #${Math.floor(1000+Math.random()*9000)}`;
    };

    if(!localStorage.getItem('ghost_name')) localStorage.setItem('ghost_name', getIdentity());
    const myName = localStorage.getItem('ghost_name');
    document.getElementById('status').innerText = "ÙƒÙŠØ§Ù†Ùƒ: " + myName;

    window.acceptRules = () => {
        localStorage.setItem('ghost_rules_v2', 'true');
        document.getElementById('rulesOverlay').style.opacity = '0';
        setTimeout(() => document.getElementById('rulesOverlay').style.display = 'none', 500);
    };
    if(localStorage.getItem('ghost_rules_v2')) acceptRules();

    const sanitize = (text) => {
        const phonePattern = /(010|011|012|015|019)\d{8}/g;
        const linkPattern = /(http|https|www|com|net|org)/gi;
        return text.replace(phonePattern, " [Ø±Ù‚Ù… Ù…Ø­Ø¬ÙˆØ¨] ").replace(linkPattern, " [Ø±Ø§Ø¨Ø· Ù…Ø­Ø¬ÙˆØ¨] ");
    };

    let coolDown = false;
    async function send() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if(!text || coolDown) return;
        const cleanText = sanitize(text);
        coolDown = true;
        document.getElementById('sendBtn').disabled = true;
        try {
            await push(messagesRef, {
                sender: myName, text: cleanText, isSecret: text.includes("Ø³Ø±"), timestamp: serverTimestamp()
            });
            input.value = "";
        } finally {
            setTimeout(() => {
                coolDown = false;
                document.getElementById('sendBtn').disabled = false;
            }, 3000);
        }
    }

    const q = query(messagesRef, limitToLast(50));
    onChildAdded(q, (snap) => {
        const data = snap.val();
        const chatBox = document.getElementById('chatBox');
        const isMe = data.sender === myName;
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'msg-me' : 'msg-remote'} ${data.isSecret ? 'msg-secret' : ''}`;
        div.innerHTML = `<div class="sender"><span>${isMe ? 'Ø£Ù†Øª' : data.sender}</span></div><div class="text">${data.text}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById('sendBtn').onclick = send;
    document.getElementById('msgInput').onkeypress = (e) => e.key === 'Enter' && send();

</script>
</body>
</html>
