<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª â€” Ø¥Ø¯Ø§Ø±Ø© Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  <style>
    /* ------------------------------------------- */
    /* ------------ Colors & Base Styles ----------- */
    /* ------------------------------------------- */
    :root{
      --bg:#070707; 
      --card:#1a1a1b; /* Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      --gold:#f5c542; 
      --muted:#b0b7c0; 
      --text:#eef2f7;
      --accent:#00fa9a; /* Ø£Ø®Ø¶Ø± */
      --blue:#3b82f6; 
      --red:#ef4444; 
      --orange:#f97316;
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }
    * {box-sizing:border-box;}
    body{
      font-family:"Cairo",sans-serif;
      background:linear-gradient(180deg,var(--bg),#0b0b0b);
      color:var(--text);
      margin:0;padding:20px;
    }
    .wrap{max-width:1300px;margin:0 auto;}
    
    /* ------------------------------------------- */
    /* ------------- Header & Cards -------------- */
    /* ------------------------------------------- */
    header{
      display:flex;gap:15px;align-items:center;justify-content:space-between;margin-bottom:25px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gold);
    }
    header h1{margin:0;color:var(--gold);font-size:24px; font-weight: 900;}
    .card{
      background:var(--card);
      padding:25px;
      border-radius:15px;
      border:1px solid rgba(245,197,66,0.15);
      box-shadow: var(--shadow);
      margin-bottom:25px
    }

    /* ------------------------------------------- */
    /* ------------- Controls & Buttons ---------- */
    /* ------------------------------------------- */
    .controls{
      display:flex;gap:15px;align-items:center;flex-wrap:wrap;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }
    .controls input,.controls select, .controls button{
      padding:10px 15px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.1);
      background:#262626;
      color:var(--text);
      outline:none;
      transition: all 0.2s;
    }
    .controls input:focus, .controls select:focus {
        border-color: var(--gold);
        box-shadow: 0 0 8px rgba(245, 197, 66, 0.5);
    }
    .btn-primary{background:var(--blue);border-color:var(--blue);font-weight:700; color: #fff;}
    .btn-success{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
    .btn-danger{background:var(--red);border-color:var(--red);color:#fff;font-weight:700}
    .action-btn { background: #333; color: var(--text); }
    .btn-primary:hover, .btn-success:hover, .btn-danger:hover, .action-btn:hover {opacity: 0.9; transform: translateY(-1px);}

    /* ------------------------------------------- */
    /* ---------------- Stats Section ------------ */
    /* ------------------------------------------- */
    .stats{display:flex;gap:15px;flex-wrap:wrap; margin-right: auto;}
    .stat{
        padding:15px 20px;
        border-radius:10px;
        border:1px solid rgba(245,197,66,0.1);
        min-width:180px;
        text-align:center;
        background: rgba(245,197,66,0.05);
    }
    .stat strong{
        display:block;
        color:var(--gold);
        font-size:24px;
        font-family: 'Montserrat', sans-serif;
        font-weight: 900;
        text-shadow: 0 0 3px rgba(245, 197, 66, 0.4);
    }
    .stat .small{font-size:13px;color:var(--muted); margin-top: 5px;}
    
    /* Pending & Completed overrides */
    .stat.pending { border-color: var(--orange); background: rgba(249, 115, 22, 0.1); }
    .stat.pending strong { color: var(--orange); }
    .stat.completed { border-color: var(--accent); background: rgba(0, 250, 154, 0.1); }
    .stat.completed strong { color: var(--accent); }


    /* ------------------------------------------- */
    /* ---------------- Table Styles ------------- */
    /* ------------------------------------------- */
    .table-container{overflow:auto;margin-top:15px}
    table{
      width:100%;
      border-collapse:collapse;
      min-width:1100px;
      direction: rtl; /* â¬…ï¸ Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± */
    } 
    th,td{
      padding:12px 15px;
      text-align:right; 
      border-bottom:1px solid rgba(255,255,255,0.08); 
      white-space: nowrap;
    }
    th{
      background:rgba(245,197,66,0.1);
      color:var(--gold);
      position:sticky;top:0;
      font-weight: 700;
      cursor: pointer;
    }
    tr:hover td{background:rgba(255,255,255,0.03)}
    .status-badge{padding:6px 10px;border-radius:15px;font-weight:700;font-size:12px; min-width: 80px; text-align: center;}
    .status-pending{background:var(--orange);color:#000}
    .status-completed{background:var(--accent);color:#000}
    .status-rejected{background:var(--red);color:#fff}
    .small{font-size:13px;color:var(--muted)}
    
    /* ------------------------------------------- */
    /* ---------------- Modal Styles ------------- */
    /* ------------------------------------------- */
    .modal{display:none; position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter: blur(4px); align-items:center;justify-content:center;padding:12px;z-index:2000}
    .modal-box{
      background:var(--card);
      padding:30px;
      border-radius:15px;
      width:100%;max-width:600px;
      max-height:90vh;
      overflow:auto;
      border:2px solid var(--gold);
      box-shadow: var(--shadow);
      text-align: right;
    }
    .modal-close{position:absolute;right:15px;top:15px;font-size:24px;cursor:pointer;color:var(--muted)}
    .modal-row{
      display:flex;justify-content:space-between;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,0.1);
      font-size: 15px;
    }
    .modal-row strong { color: var(--text); }
    .modal-row span { color: var(--gold); font-weight: 700; }
    textarea{
      width:100%;min-height:100px;padding:10px;border-radius:8px;
      background:#262626;color:var(--text);border:1px solid rgba(255,255,255,0.1);
      resize:vertical; margin-top: 5px;
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px}
    .hidden{display:none !important}

    /* Toggle buttons for return points */
    #rejectArea button {
      padding: 8px 15px;
      border-radius: 8px;
      border: 1px solid transparent;
      width: 48%; 
    }
    #returnYes { background-color: var(--accent); color: #000; }
    #returnNo { background-color: var(--red); color: #fff; opacity: 0.6; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ’° Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <div>
        <button id="refreshBtn" class="btn-primary">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button id="logoutBtn" style="margin-right:8px" class="action-btn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <select id="statusFilter" title="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©">
          <option value="All">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ (Ø§Ù„Ø­Ø§Ù„Ø©)</option>
          <option value="pending">Ù…Ø¹Ù„Ù‘Ù‚</option>
          <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
          <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
        </select>

        <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / UID / Ø§Ù„Ù…Ø­ÙØ¸Ø©..." title="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨" />

        <div class="stats">
          <div class="stat completed"><strong id="totalCompletedCount">0</strong><span class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© âœ…</span></div>
          <div class="stat"><strong id="totalPaid">EGP 0.00</strong><span class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ğŸ’¸</span></div>
          <div class="stat pending"><strong id="pendingCount">0</strong><span class="small">Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© â³</span></div>
          <div class="stat pending"><strong id="pendingAmount">EGP 0.00</strong><span class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ù„Ù‚</span></div>
        </div>
      </div>

    </div>

    <div class="card">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>UID</th> 
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­ÙˆÙ„Ø© â­</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
              <th>ØµØ§ÙÙŠ (EGP) ğŸ’¸</th>
              <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨ ğŸ“…</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th> </tr>
          </thead>
          <tbody id="withdrawalsTbody">
            <tr><td colspan="10" class="small" style="text-align:center;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="modal" class="modal hidden">
    <div class="modal-box">
      <div style="position:relative;">
        <span id="closeModal" class="modal-close">âœ–</span>
        <h3 style="color:var(--gold);margin-top:0; border-bottom: 1px solid rgba(245, 197, 66, 0.5); padding-bottom: 10px;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨ Ø³Ø­Ø¨ â€” <span id="modalId"></span></h3>

        <div id="modalContent">
          </div>

        <div style="margin-top:20px">
          <div id="actionButtons" class="actions">
            <button id="acceptBtn" class="btn-success">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¯ÙØ¹</button>
            <button id="rejectBtn" class="btn-danger">âŒ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>

          <div id="rejectArea" class="hidden" style="margin-top:20px; padding: 15px; border: 1px dashed var(--red); border-radius: 10px;">
            <label class="small">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</label>
            <textarea id="rejectReason" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ Ù‡Ù†Ø§..."></textarea>

            <label class="small" style="display:block; margin-top: 10px;">Ø¥Ø±Ø¬Ø§Ø¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ</label>
            <div style="margin-top:8px; display:flex; gap:10px;">
              <button id="returnYes" class="btn-success" style="opacity: 1;">âœ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
              <button id="returnNo" class="btn-danger" style="opacity: 0.6;">âŒ Ø¹Ø¯Ù… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
            </div>

            <button id="confirmReject" class="btn-danger" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</button>
          </div>

          <div id="confirmAcceptArea" class="hidden" style="margin-top:20px; padding: 15px; border: 1px dashed var(--accent); border-radius: 10px; text-align: center;">
            <p style="color: var(--muted); margin-top: 0;">Ø§Ø¶ØºØ· Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ø¹Ø¯ Ø£Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.</p>
            <button id="confirmAccept" class="btn-success">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, orderBy, doc, writeBatch, increment, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ============== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¯ÙŠÙƒ) ==============
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.firebasestorage.app",
      messagingSenderId: "744783579735",
      appId: "1:744783579735:web:45e00de9998893bbc9b112",
      measurementId: "G-CV3GLT2TTJ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ============== Ø«ÙˆØ§Ø¨Øª DOM ==============
    const withdrawTbody = document.getElementById('withdrawalsTbody');
    const statusFilter = document.getElementById('statusFilter');
    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const totalPaidEl = document.getElementById('totalPaid');
    const pendingCountEl = document.getElementById('pendingCount');
    const pendingAmountEl = document.getElementById('pendingAmount');
    const totalCompletedCountEl = document.getElementById('totalCompletedCount');

    // modal
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const modalContent = document.getElementById('modalContent');
    const modalIdEl = document.getElementById('modalId');

    const acceptBtn = document.getElementById('acceptBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const rejectArea = document.getElementById('rejectArea');
    const rejectReason = document.getElementById('rejectReason');
    const returnYes = document.getElementById('returnYes');
    const returnNo  = document.getElementById('returnNo');
    const confirmReject = document.getElementById('confirmReject');
    const confirmAccept = document.getElementById('confirmAccept');
    const confirmAcceptArea = document.getElementById('confirmAcceptArea');

    // state
    const ADMIN_EMAIL = "amirfg992005@gmail.com";
    let allWithdrawals = []; // raw data
    let usersMap = {}; // ØªØ®Ø²ÙŠÙ† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    let selectedWithdrawal = null;
    let returnPoints = true;

    // helpers
    function toDateSafe(ts) {
      if (!ts) return null;
      if (ts.toDate) return ts.toDate();
      if (ts.seconds) return new Date(ts.seconds * 1000);
      return new Date(ts);
    }
    function fmtCurrency(n) {
      return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits:2}) + ' EGP';
    }
    function fmtNumber(n) { return Number(n||0).toLocaleString('en-US'); }
    function translate(status) {
      if (!status) return status;
      status = status.toString().toLowerCase();
      if (status === 'pending') return 'Ù…Ø¹Ù„Ù‘Ù‚';
      if (status === 'completed') return 'Ù…ÙƒØªÙ…Ù„';
      if (status === 'rejected') return 'Ù…Ø±ÙÙˆØ¶';
      return status;
    }

    // auth guard
    onAuthStateChanged(auth, user => {
      if (!user || user.email !== ADMIN_EMAIL) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ± Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.');
      }
    });

    // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† 
    async function fetchUsers(withdrawalDocs) {
        const userIds = [...new Set(withdrawalDocs.map(d => d.userId).filter(id => id))];
        usersMap = {};
        if (userIds.length === 0) return;

        const usersCollection = collection(db, 'users');
        const userPromises = [];

        // Ù†Ù‚Ø³Ù… Ø§Ù„Ù€ UIDs Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù† 10 (Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… 'in')
        const chunkSize = 10;
        for (let i = 0; i < userIds.length; i += chunkSize) {
            const chunk = userIds.slice(i, i + chunkSize);
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… '__name__' Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©
            const q = query(usersCollection, where('__name__', 'in', chunk)); 
            userPromises.push(getDocs(q));
        }

        const snapshots = await Promise.all(userPromises);
        snapshots.forEach(snap => {
            snap.forEach(doc => {
                usersMap[doc.id] = doc.data().name || doc.data().email || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            });
        });
    }

    // fetch withdrawals and compute stats 
    async function loadWithdrawals() {
      withdrawTbody.innerHTML = '<tr><td colspan="10" class="small" style="text-align:center;">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª...</td></tr>';
      try {
        const q = query(collection(db, 'withdrawals'), orderBy('date', 'desc'));
        const snap = await getDocs(q);
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        allWithdrawals = docs;

        // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
        await fetchUsers(allWithdrawals);

        // stat calculations
        const completed = docs.filter(d => (d.status || '').toString().toLowerCase() === 'completed');
        const pending = docs.filter(d => (d.status || '').toString().toLowerCase() === 'pending');

        const totalPaid = completed.reduce((s, r) => s + (Number(r.net) || 0), 0);
        const pendingAmount = pending.reduce((s, r) => s + (Number(r.net) || 0), 0);

        totalPaidEl.textContent = fmtCurrency(totalPaid);
        pendingCountEl.textContent = fmtNumber(pending.length);
        pendingAmountEl.textContent = fmtCurrency(pendingAmount);
        totalCompletedCountEl.textContent = fmtNumber(completed.length); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒØªÙ…Ù„

        applyFiltersAndRender();
      } catch (err) {
        console.error('Load withdrawals error', err);
        withdrawTbody.innerHTML = `<tr><td colspan="10" class="small" style="color:tomato; text-align:center;">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore (console Ù„Ù„Ù…Ø²ÙŠØ¯)</td></tr>`;
      }
    }

    function applyFiltersAndRender() {
      const status = statusFilter.value; // 'All' or 'pending' etc.
      const q = searchInput.value.trim().toLowerCase();

      let filtered = allWithdrawals.filter(w => {
        const st = (w.status || '').toString().toLowerCase();
        const statusMatch = status === 'All' ? true : (st === status.toLowerCase());
        
        const userName = (usersMap[w.userId] || '').toString().toLowerCase();
        const uid = (w.userId || w.uid || '').toString().toLowerCase();
        const wallet = (w.wallet || '').toString().toLowerCase();
        
        return statusMatch && (!q || userName.includes(q) || uid.includes(q) || wallet.includes(q) || (w.id||'').toLowerCase().includes(q));
      });

      // sort: pending first, then by date desc
      filtered.sort((a,b) => {
        if ((a.status||'').toLowerCase() === 'pending' && (b.status||'').toLowerCase() !== 'pending') return -1;
        if ((a.status||'').toLowerCase() !== 'pending' && (b.status||'').toLowerCase() === 'pending') return 1;
        return (toDateSafe(b.date)?.getTime() || 0) - (toDateSafe(a.date)?.getTime() || 0);
      });

      renderTable(filtered);
    }

    function renderTable(list) {
      if (!list.length) {
        withdrawTbody.innerHTML = '<tr><td colspan="10" class="small" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</td></tr>';
        return;
      }
      withdrawTbody.innerHTML = '';
      list.forEach(w => {
        const tr = document.createElement('tr');

        const uid = w.userId || w.uid || 'N/A';
        const userName = usersMap[w.userId] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'; 
        const pts = Number(w.pts || w.points || 0);
        const amount = Number(w.amount || 0);
        const net = Number(w.net || amount);
        const method = w.method || 'N/A';
        const wallet = w.wallet || 'N/A';
        const date = toDateSafe(w.date);
        const dateStr = date ? date.toLocaleString('ar-EG', {hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'}) : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        const statusRaw = (w.status||'').toString();
        const statusLower = statusRaw.toLowerCase();

        // status badge
        let statusCls = 'status-pending';
        if (statusLower === 'completed') statusCls = 'status-completed';
        if (statusLower === 'rejected') statusCls = 'status-rejected';

        // actions cell creation
        const actionsCell = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'action-btn';
        if (statusLower === 'pending') {
          btn.textContent = 'Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ“';
          btn.classList.add('btn-primary');
          btn.onclick = () => openModal(w.id);
        } else {
          btn.textContent = 'Ø¹Ø±Ø¶ ğŸ‘ï¸';
          btn.style.backgroundColor = 'transparent';
          btn.style.borderColor = 'var(--muted)';
          btn.onclick = () => openModal(w.id);
        }
        actionsCell.appendChild(btn);
        
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ UID ÙˆÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        tr.innerHTML = `
          <td>${uid}</td>
          <td>${userName}</td>
          <td>${fmtNumber(pts)}</td>
          <td>${fmtCurrency(amount)}</td>
          <td>${fmtCurrency(net)}</td>
          <td>${method}</td>
          <td>${wallet}</td>
          <td>${dateStr}</td>
          <td><span class="status-badge ${statusCls}">${translate(statusLower)}</span></td>
          <td></td>
        `;
        // ÙˆØ¶Ø¹ Ø®Ù„ÙŠØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ø´Ø±Ø© (Ø§Ù„Ø£Ø®ÙŠØ±Ø©)
        tr.lastChild.replaceWith(actionsCell); 
        withdrawTbody.appendChild(tr);
      });
    }

    // open modal for a given withdrawal ID
    function openModal(id) {
      selectedWithdrawal = allWithdrawals.find(x => x.id === id);
      if (!selectedWithdrawal) return alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« â€” Ø§Ø¶ØºØ· ØªØ­Ø¯ÙŠØ«.');

      // populate modal content
      modalIdEl.textContent = id;
      modalContent.innerHTML = '';
      
      const userName = usersMap[selectedWithdrawal.userId] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù…
      const rejectionReason = selectedWithdrawal.rejectionReason;
      
      const rows = [
        ['UID', selectedWithdrawal.userId || 'N/A'],
        ['Ø§Ù„Ø§Ø³Ù…', userName],
        ['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨', fmtCurrency(Number(selectedWithdrawal.amount || 0))],
        ['Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­ÙˆÙ„Ø©', fmtNumber(Number(selectedWithdrawal.pts || selectedWithdrawal.points || 0))],
        ['Ø§Ù„Ø±Ø³ÙˆÙ…', fmtNumber(Number(selectedWithdrawal.fee || 0))],
        ['ØµØ§ÙÙŠ', fmtCurrency(Number(selectedWithdrawal.net || selectedWithdrawal.amount || 0))],
        ['Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', selectedWithdrawal.method || 'N/A'],
        ['Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©', selectedWithdrawal.wallet || 'N/A'],
        ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨', toDateSafe(selectedWithdrawal.date) ? toDateSafe(selectedWithdrawal.date).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'],
        ['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', translate((selectedWithdrawal.status||'').toLowerCase())]
      ];

      rows.forEach(([k,v])=>{
        const div = document.createElement('div');
        div.className = 'modal-row';
        div.innerHTML = `<strong>${k}</strong><span>${v}</span>`;
        modalContent.appendChild(div);
      });
      
      // Add rejection reason if status is rejected
      if((selectedWithdrawal.status||'').toLowerCase() === 'rejected' && rejectionReason) {
           const div = document.createElement('div');
           div.className = 'modal-row';
           div.innerHTML = `<strong>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</strong><span style="color:var(--red);">${rejectionReason}</span>`;
           modalContent.appendChild(div);
      }


      // reset controls
      rejectArea.classList.add('hidden');
      confirmAcceptArea.classList.add('hidden');
      rejectReason.value = '';
      returnPoints = true;
      confirmReject.disabled = true;
      returnYes.style.opacity = '1';
      returnNo.style.opacity = '0.6';
      
      // show action buttons only when pending
      const st = (selectedWithdrawal.status||'').toLowerCase();
      if (st === 'pending') {
        document.getElementById('actionButtons').classList.remove('hidden');
        confirmAccept.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
        acceptBtn.style.display = 'inline-block';
      } else {
        document.getElementById('actionButtons').classList.add('hidden');
      }

      modal.style.display = 'flex'; // Ø§Ø³ØªØ®Ø¯Ø§Ù… display: flex Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      modal.setAttribute('aria-hidden', 'false');
    }

    closeModal.addEventListener('click', () => {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      selectedWithdrawal = null;
    });

    // accept (init)
    acceptBtn.addEventListener('click', () => {
      rejectArea.classList.add('hidden');
      confirmAcceptArea.classList.remove('hidden');
    });

    confirmAccept.addEventListener('click', async () => {
      if (!selectedWithdrawal) return;
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¯ÙØ¹ØŸ Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù…ÙƒØªÙ…Ù„" ÙˆØªØ³Ø¬ÙŠÙ„ processedAt Ùˆ processedBy.')) return;
      await performUpdate('completed');
    });

    // reject (init)
    rejectBtn.addEventListener('click', () => {
      rejectArea.classList.remove('hidden');
      confirmAcceptArea.classList.add('hidden');
    });

    // return points toggles
    returnYes.addEventListener('click', ()=> {
      returnPoints = true;
      returnYes.style.opacity = '1';
      returnNo.style.opacity = '0.6';
    });
    returnNo.addEventListener('click', ()=> {
      returnPoints = false;
      returnYes.style.opacity = '0.6';
      returnNo.style.opacity = '1';
    });

    // enable confirmReject when reason long enough
    rejectReason.addEventListener('input', () => {
      confirmReject.disabled = rejectReason.value.trim().length < 3;
    });

    confirmReject.addEventListener('click', async () => {
      if (!selectedWithdrawal) return;
      const reason = rejectReason.value.trim();
      if (reason.length < 3) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ ÙˆØ§Ø¶Ø­ Ù„Ù„Ø±ÙØ¶.');
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±ØŸ')) return;
      await performUpdate('rejected', reason, returnPoints);
    });

    // perform update: status can be 'completed' or 'rejected'
    async function performUpdate(newStatus, reason = null, returnPts = true) {
      if (!selectedWithdrawal) return;
      try {
        const batch = writeBatch(db);
        const wRef = doc(db, 'withdrawals', selectedWithdrawal.id);
        const now = Timestamp.fromDate(new Date());
        
        // update withdrawal doc
        const wUpdate = { status: newStatus, processedAt: now, processedBy: auth.currentUser ? auth.currentUser.uid : 'admin-web' };
        if (reason) wUpdate.rejectionReason = reason;
        batch.update(wRef, wUpdate);

        // if rejected and want to return points -> increment user's points
        if (newStatus === 'rejected' && returnPts) {
          const userId = selectedWithdrawal.userId;
          if (userId) {
            const userRef = doc(db, 'users', userId);
            const pts = Number(selectedWithdrawal.pts || selectedWithdrawal.points || 0);
            batch.update(userRef, { points: increment(pts) });
          } else {
            console.warn('Ù„Ø§ ÙŠÙˆØ¬Ø¯ userId Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·.');
          }
        }
        
        await batch.commit();
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.');
        modal.style.display = 'none';
        await loadWithdrawals(); // Reload data
      } catch (err) {
        console.error('Update error', err);
        alert('âŒ ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø¯ÙŠØ«. ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ (Console Ù„Ù„Ù…Ø²ÙŠØ¯).');
      }
    }

    // events
    statusFilter.addEventListener('change', applyFiltersAndRender);
    searchInput.addEventListener('input', applyFiltersAndRender);
    refreshBtn.addEventListener('click', loadWithdrawals);
    logoutBtn.addEventListener('click', async ()=>{
      try { await signOut(auth); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); } catch(e){ console.error(e); alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }
    });

    // initial load
    document.addEventListener('DOMContentLoaded', loadWithdrawals);
  </script>
</body>
</html>
