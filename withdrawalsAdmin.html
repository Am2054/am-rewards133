<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AM REWARDS | SUPREME ADMIN</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #020617; 
      --card: rgba(15, 23, 42, 0.8);
      --gold: #fbbf24; 
      --border: rgba(251, 191, 36, 0.1);
      --text: #f8fafc;
      --accent: #10b981;
      --red: #ef4444; 
      --orange: #f59e0b;
    }

    body {
      font-family: "Cairo", sans-serif;
      background: var(--bg); color: var(--text); margin: 0; padding: 20px;
      background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 70%);
      min-height: 100vh;
    }

    .wrap { max-width: 1500px; margin: 0 auto; }

    /* --- Header & Stats --- */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 25px; background: var(--card); border-radius: 24px;
      border: 1px solid var(--border); margin-bottom: 30px;
      backdrop-filter: blur(12px);
    }
    header h1 { margin: 0; font-family: 'Orbitron'; font-size: 1.4rem; color: var(--gold); letter-spacing: 2px; }

    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;
    }
    .stat-card {
      background: var(--card); padding: 25px; border-radius: 24px;
      border: 1px solid var(--border); position: relative;
    }
    .stat-card strong { display: block; font-size: 2rem; font-family: 'Orbitron'; margin-bottom: 8px; color: #fff; }
    .stat-card span { color: #94a3b8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
    .stat-card::after { content: ''; position: absolute; bottom: 0; right: 20px; left: 20px; height: 3px; border-radius: 3px; }
    .s-comp::after { background: var(--accent); }
    .s-pend::after { background: var(--orange); }

    /* --- Modern Table System --- */
    .table-container {
      background: var(--card); border-radius: 30px; padding: 25px;
      border: 1px solid var(--border); backdrop-filter: blur(10px);
    }
    .table-header-tools {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 25px; flex-wrap: wrap; gap: 15px;
    }
    .search-bar {
      background: #000; border: 1px solid var(--border); color: #fff;
      padding: 14px 25px; border-radius: 16px; width: 400px; outline: none;
    }
    .filter-select {
      background: #000; border: 1px solid var(--border); color: #fff;
      padding: 14px; border-radius: 16px; outline: none; cursor: pointer;
    }

    .main-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
    .main-table th { padding: 15px 20px; color: #64748b; font-size: 0.8rem; text-align: right; text-transform: uppercase; }
    .main-table tbody tr { 
        background: rgba(255,255,255,0.02); 
        transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .main-table tbody tr:hover { background: rgba(251, 191, 36, 0.05); transform: translateY(-2px); }
    .main-table td { padding: 20px; border: none; }
    .main-table td:first-child { border-radius: 0 20px 20px 0; }
    .main-table td:last-child { border-radius: 20px 0 0 20px; }

    .user-cell { display: flex; align-items: center; gap: 12px; }
    .avatar-icon { 
        width: 45px; height: 45px; background: linear-gradient(135deg, #475569, #1e293b); 
        border-radius: 14px; display: flex; align-items: center; justify-content: center;
        font-family: 'Orbitron'; font-weight: 900; color: var(--gold); border: 1px solid var(--border);
    }

    .badge { padding: 6px 14px; border-radius: 10px; font-size: 0.75rem; font-weight: 800; }
    .b-pending { background: rgba(245, 158, 11, 0.15); color: var(--orange); }
    .b-completed { background: rgba(16, 185, 129, 0.15); color: var(--accent); }
    .b-rejected { background: rgba(239, 68, 68, 0.15); color: var(--red); }

    .btn-exec {
      background: var(--gold); color: #000; border: none; padding: 10px 20px;
      border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s;
    }
    .btn-exec:hover { box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }

    /* --- Auth Gate --- */
    #auth-gate { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .auth-box { width: 400px; padding: 40px; background: var(--card); border-radius: 30px; border: 1px solid var(--gold); text-align: center; }
    .auth-box input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #1e293b; background: #000; color: #fff; text-align: center; }

    /* --- Modal --- */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: 0.3s; }
    .modal.active { visibility: visible; opacity: 1; }
    .modal-box { width: 500px; background: #0f172a; padding: 35px; border-radius: 30px; border: 1px solid var(--gold); }
    textarea { width: 100%; background: #000; border: 1px solid #1e293b; color: #fff; padding: 15px; border-radius: 15px; margin: 15px 0; resize: none; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="auth-gate">
  <div class="auth-box">
    <h2 style="font-family: 'Orbitron'; color: var(--gold);">SECURE ACCESS</h2>
    <input type="email" id="adm-email" placeholder="ADMIN EMAIL" value="amirfg992005@gmail.com">
    <input type="password" id="adm-pass" placeholder="PASSWORD">
    <input type="password" id="adm-token" placeholder="SECRET TOKEN">
    <button id="btn-login" class="btn-exec" style="width: 100%;">AUTHORIZE SYSTEM</button>
  </div>
</div>

<div id="main-ui" class="wrap hidden">
  <header>
    <h1>COMMAND CENTER</h1>
    <button id="btnLogout" class="btn-exec" style="background: var(--red); color: #fff;">LOGOUT</button>
  </header>

  <div class="stats-grid">
    <div class="stat-card s-comp"> <strong id="totalPaid">0.00</strong> <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (EGP)</span> </div>
    <div class="stat-card s-pend"> <strong id="pendingCount">0</strong> <span>Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</span> </div>
    <div class="stat-card"> <strong id="totalCompletedCount">0</strong> <span>Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ø§Ø¬Ø­Ø©</span> </div>
  </div>

  <div class="table-container">
    <div class="table-header-tools">
      <input type="text" id="searchInput" class="search-bar" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…Ø­ÙØ¸Ø©ØŒ Ø£Ùˆ UID...">
      <select id="statusFilter" class="filter-select">
        <option value="All">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
        <option value="completed">ØªÙ… Ø§Ù„Ø¯ÙØ¹</option>
        <option value="rejected">Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</option>
      </select>
    </div>

    <table class="main-table">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</th>
          <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
          <th>Ø§Ù„ØµØ§ÙÙŠ (EGP)</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© / Ø§Ù„ÙˆØ³ÙŠÙ„Ø©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="withdrawalsTbody"></tbody>
    </table>
  </div>
</div>

<div id="modal" class="modal">
    <div class="modal-box">
        <h3 style="color: var(--gold); font-family: 'Orbitron';">DECISION PANEL</h3>
        <div id="modalContent" style="margin: 20px 0; font-size: 0.95rem; line-height: 1.6;"></div>
        
        <div id="main-actions">
            <button id="btnAccept" class="btn-exec" style="background: var(--accent); width: 100%; margin-bottom: 10px;">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø¥Ù†Ù‡Ø§Ø¡</button>
            <button id="btnShowReject" class="btn-exec" style="background: var(--red); color: #fff; width: 100%;">âŒ Ø±ÙØ¶ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
        </div>

        <div id="reject-area" class="hidden">
            <textarea id="rejectReason" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…)..."></textarea>
            <button id="btnConfirmReject" class="btn-exec" style="background: #fff; color: #000; width: 100%;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>

        <button onclick="closeModal()" style="background: transparent; border: none; color: #64748b; width: 100%; margin-top: 20px; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, getDocs, orderBy, doc, writeBatch, increment, Timestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const SECRET_TOKEN = "AM-VIP-2025";

    let allData = [];
    let usersNames = {};

    // --- Auth Logic ---
    document.getElementById('btn-login').onclick = async () => {
        const email = document.getElementById('adm-email').value;
        const pass = document.getElementById('adm-pass').value;
        if(document.getElementById('adm-token').value !== SECRET_TOKEN) return alert("TOKEN ERROR");
        try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { alert(e.message); }
    };

    onAuthStateChanged(auth, user => {
        if(user && user.email === "amirfg992005@gmail.com") {
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            loadAllData();
        }
    });

    // --- Data Logic ---
    async function loadAllData() {
        const snap = await getDocs(query(collection(db, 'withdrawals'), orderBy('date', 'desc')));
        allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        const uids = [...new Set(allData.map(w => w.userId))];
        for (let uid of uids) {
            const uSnap = await getDoc(doc(db, 'users', uid));
            usersNames[uid] = uSnap.exists() ? uSnap.data().name : "User";
        }
        filterAndRender();
    }

    function filterAndRender() {
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();

        const filtered = allData.filter(w => {
            const matchesStatus = status === 'All' || w.status === status;
            const matchesSearch = (usersNames[w.userId] || '').toLowerCase().includes(search) || 
                                 (w.wallet || '').toLowerCase().includes(search) || 
                                 w.userId.toLowerCase().includes(search);
            return matchesStatus && matchesSearch;
        });

        const tbody = document.getElementById('withdrawalsTbody');
        tbody.innerHTML = '';

        filtered.forEach(w => {
            const tr = document.createElement('tr');
            const name = usersNames[w.userId] || '...';
            const statusClass = w.status === 'pending' ? 'b-pending' : (w.status === 'completed' ? 'b-completed' : 'b-rejected');
            
            tr.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="avatar-icon">${name.charAt(0)}</div>
                        <div><div style="font-weight:700;">${name}</div><small style="color:#64748b;">${w.userId}</small></div>
                    </div>
                </td>
                <td style="font-family:'Orbitron'; font-size:0.9rem;">${Number(w.pts).toLocaleString()}</td>
                <td style="color:var(--gold); font-weight:900;">${Number(w.net).toFixed(2)}</td>
                <td><div style="font-weight:700;">${w.wallet}</div><small style="color:#64748b;">${w.method}</small></td>
                <td><small>${new Date(w.date.seconds*1000).toLocaleDateString('ar-EG')}</small></td>
                <td><span class="badge ${statusClass}">${w.status}</span></td>
                <td>${w.status === 'pending' ? `<button class="btn-exec" onclick="openReview('${w.id}')">Ø¥Ø¬Ø±Ø§Ø¡</button>` : '---'}</td>
            `;
            tbody.appendChild(tr);
        });

        // Update Stats
        const comp = allData.filter(x => x.status === 'completed');
        document.getElementById('totalCompletedCount').textContent = comp.length;
        document.getElementById('totalPaid').textContent = comp.reduce((a,b) => a + (Number(b.net)||0), 0).toFixed(2);
        document.getElementById('pendingCount').textContent = allData.filter(x => x.status === 'pending').length;
    }

    // --- Decision Modal Logic ---
    window.openReview = (id) => {
        const w = allData.find(x => x.id === id);
        const modal = document.getElementById('modal');
        const content = document.getElementById('modalContent');
        
        content.innerHTML = `
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px;">
                <p>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯: <b>${usersNames[w.userId]}</b></p>
                <p>ğŸ’° Ø§Ù„ØµØ§ÙÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b style="color: var(--gold);">${w.net} EGP</b></p>
                <p>â­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©: <b>${w.pts}</b></p>
                <p>ğŸ“± Ø§Ù„Ù…Ø­ÙØ¸Ø©: <b>${w.wallet}</b></p>
            </div>
        `;

        modal.classList.add('active');
        document.getElementById('reject-area').classList.add('hidden');
        document.getElementById('main-actions').classList.remove('hidden');

        // Accept Click
        document.getElementById('btnAccept').onclick = async () => {
            if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ " + w.net + " EGPØŸ")) return;
            const batch = writeBatch(db);
            batch.update(doc(db, 'withdrawals', id), { status: 'completed', processedAt: Timestamp.now() });
            await batch.commit();
            closeModal();
            loadAllData();
        };

        // Show Reject Box
        document.getElementById('btnShowReject').onclick = () => {
            document.getElementById('main-actions').classList.add('hidden');
            document.getElementById('reject-area').classList.remove('hidden');
        };

        // Final Reject Confirm
        document.getElementById('btnConfirmReject').onclick = async () => {
            const reason = document.getElementById('rejectReason').value.trim();
            if(!reason) return alert("Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ Ø£ÙˆÙ„Ø§Ù‹!");
            
            const batch = writeBatch(db);
            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨
            batch.update(doc(db, 'withdrawals', id), { 
                status: 'rejected', 
                rejectionReason: reason, 
                processedAt: Timestamp.now() 
            });
            // 2. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            batch.update(doc(db, 'users', w.userId), { 
                points: increment(Number(w.pts)) 
            });

            await batch.commit();
            alert("ØªÙ… Ø§Ù„Ø±ÙØ¶ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·.");
            closeModal();
            loadAllData();
        };
    };

    window.closeModal = () => {
        document.getElementById('modal').classList.remove('active');
        document.getElementById('rejectReason').value = '';
    };

    document.getElementById('statusFilter').onchange = filterAndRender;
    document.getElementById('searchInput').oninput = filterAndRender;
    document.getElementById('btnLogout').onclick = () => signOut(auth);

</script>
</body>
</html>
