<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سجل السحوبات — إدارة Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#070707; --card:#0f0f10; --gold:#f5c542; --muted:#9aa4b2; --text:#eef2f7;
      --accent:#00fa9a; --blue:#3b82f6; --red:#ef4444; --orange:#f97316;
    }
    *{box-sizing:border-box}
    body{font-family:"Cairo",sans-serif;background:linear-gradient(180deg,var(--bg),#0b0b0b);color:var(--text);margin:0;padding:16px}
    .wrap{max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px;}
    header h1{margin:0;color:var(--gold);font-size:20px}
    .card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(245,197,66,0.08);box-shadow:0 6px 22px rgba(0,0,0,0.4);margin-bottom:18px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .controls input,.controls select, .controls button{padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0b1113;color:var(--text);outline:none}
    .btn-primary{background:var(--blue);border-color:var(--blue);color:var(--text);font-weight:700}
    .btn-success{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
    .btn-danger{background:var(--red);border-color:var(--red);color:#fff;font-weight:700}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .stat{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-width:140px;text-align:center}
    .stat strong{display:block;color:var(--gold);font-size:18px}
    .table-container{overflow:auto;margin-top:12px}
    table{width:100%;border-collapse:collapse;min-width:1000px}
    th,td{padding:10px 12px;text-align:right;border-bottom:1px solid rgba(255,255,255,0.03)}
    th{background:rgba(245,197,66,0.05);color:var(--gold);position:sticky;top:0}
    tr:hover td{background:rgba(255,255,255,0.01)}
    .status-badge{padding:6px 8px;border-radius:6px;font-weight:700;font-size:13px}
    .status-pending{background:var(--orange);color:#000}
    .status-completed{background:var(--accent);color:#000}
    .status-rejected{background:var(--red);color:#fff}
    .small{font-size:13px;color:var(--muted)}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;padding:12px;z-index:2000}
    .modal-box{background:var(--card);padding:18px;border-radius:12px;width:100%;max-width:720px;max-height:90vh;overflow:auto;border:1px solid var(--gold)}
    .modal-close{position:absolute;right:18px;top:18px;font-size:20px;cursor:pointer;color:var(--muted)}
    .modal-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    textarea{width:100%;min-height:80px;padding:10px;border-radius:8px;background:#0b1113;color:var(--text);border:1px solid rgba(255,255,255,0.04);resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>💰 سجل السحوبات — لوحة الإدارة</h1>
      <div>
        <button id="refreshBtn" class="btn-primary">🔄 تحديث البيانات</button>
        <button id="logoutBtn" style="margin-right:8px">خروج</button>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <select id="statusFilter">
          <option value="All">عرض الكل</option>
          <option value="pending">معلّق</option>
          <option value="completed">مكتمل</option>
          <option value="rejected">مرفوض</option>
        </select>

        <input id="searchInput" placeholder="ابحث بالإيميل / UID / رقم المحفظة..." />

        <div style="margin-left:auto" class="stats">
          <div class="stat"><strong id="totalPaid">EGP 0.00</strong><span class="small">إجمالي المدفوع</span></div>
          <div class="stat"><strong id="pendingCount">0</strong><span class="small">طلبات معلقة</span></div>
          <div class="stat"><strong id="pendingAmount">EGP 0.00</strong><span class="small">إجمالي المعلق</span></div>
        </div>
      </div>

    </div>

    <div class="card">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>إجراءات</th>
              <th>الحالة</th>
              <th>تاريخ الطلب</th>
              <th>رقم المحفظة</th>
              <th>طريقة الدفع</th>
              <th>صافي (EGP)</th>
              <th>المبلغ المطلوب</th>
              <th>النقاط المحولة</th>
              <th>بريد المستخدم</th>
              <th>UID</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTbody">
            <tr><td colspan="10" class="small">جارِ تحميل البيانات...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal hidden" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <div style="position:relative;">
        <span id="closeModal" class="modal-close">✖</span>
        <h3 style="color:var(--gold);margin-top:0">مراجعة طلب سحب — <span id="modalId"></span></h3>

        <div id="modalContent">
          <!-- dynamic rows -->
        </div>

        <div style="margin-top:12px">
          <div id="actionButtons" class="actions">
            <button id="acceptBtn" class="btn-success">✅ اعتماد الدفع</button>
            <button id="rejectBtn" class="btn-danger">❌ رفض الطلب</button>
          </div>

          <div id="rejectArea" class="hidden" style="margin-top:12px">
            <label class="small">سبب الرفض (إجباري):</label>
            <textarea id="rejectReason" placeholder="اكتب سبب الرفض"></textarea>

            <div style="margin-top:8px; display:flex; gap:8px;">
              <button id="returnYes" class="btn-success">✅ إرجاع النقاط</button>
              <button id="returnNo" class="btn-danger">❌ عدم إرجاع النقاط</button>
            </div>

            <div style="margin-top:10px">
              <button id="confirmReject" class="btn-danger" disabled>تأكيد الرفض وتنفيذ الإجراء</button>
            </div>
          </div>

          <div id="confirmAcceptArea" class="hidden" style="margin-top:12px">
            <button id="confirmAccept" class="btn-success">تأكيد الدفع الآن</button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, orderBy, doc, writeBatch, increment, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ============== إعدادات Firebase (استخدم الإعدادات لديك) ==============
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.firebasestorage.app",
      messagingSenderId: "744783579735",
      appId: "1:744783579735:web:45e00de9998893bbc9b112",
      measurementId: "G-CV3GLT2TTJ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ============== ثوابت DOM ==============
    const withdrawTbody = document.getElementById('withdrawalsTbody');
    const statusFilter = document.getElementById('statusFilter');
    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const totalPaidEl = document.getElementById('totalPaid');
    const pendingCountEl = document.getElementById('pendingCount');
    const pendingAmountEl = document.getElementById('pendingAmount');

    // modal
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const modalContent = document.getElementById('modalContent');
    const modalIdEl = document.getElementById('modalId');

    const acceptBtn = document.getElementById('acceptBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const rejectArea = document.getElementById('rejectArea');
    const rejectReason = document.getElementById('rejectReason');
    const returnYes = document.getElementById('returnYes');
    const returnNo  = document.getElementById('returnNo');
    const confirmReject = document.getElementById('confirmReject');
    const confirmAccept = document.getElementById('confirmAccept');
    const confirmAcceptArea = document.getElementById('confirmAcceptArea');

    // state
    const ADMIN_EMAIL = "amirfg992005@gmail.com";
    let allWithdrawals = []; // raw data
    let selectedWithdrawal = null;
    let returnPoints = true;

    // helpers
    function toDateSafe(ts) {
      if (!ts) return null;
      if (ts.toDate) return ts.toDate();
      if (ts.seconds) return new Date(ts.seconds * 1000);
      return new Date(ts);
    }
    function fmtCurrency(n) {
      return Number(n || 0).toLocaleString('ar-EG', {minimumFractionDigits:2}) + ' EGP';
    }
    function fmtNumber(n) { return Number(n||0).toLocaleString('en-US'); }
    function translate(status) {
      if (!status) return status;
      status = status.toString().toLowerCase();
      if (status === 'pending') return 'معلّق';
      if (status === 'completed') return 'مكتمل';
      if (status === 'rejected') return 'مرفوض';
      return status;
    }

    // auth guard
    onAuthStateChanged(auth, user => {
      if (!user || user.email !== ADMIN_EMAIL) {
        alert('يرجى تسجيل الدخول كمدير للوصول لهذه الصفحة.');
        // لا نعيد التوجيه هنا تلقائياً لأنك قد تفضل تسجيل الدخول يدوياً
      }
    });

    // fetch withdrawals and compute stats
    async function loadWithdrawals() {
      withdrawTbody.innerHTML = '<tr><td colspan="10" class="small">جارِ جلب السحوبات...</td></tr>';
      try {
        const q = query(collection(db, 'withdrawals'), orderBy('date', 'desc'));
        const snap = await getDocs(q);
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        allWithdrawals = docs;

        // stat calculations
        const completed = docs.filter(d => (d.status || '').toString().toLowerCase() === 'completed');
        const pending = docs.filter(d => (d.status || '').toString().toLowerCase() === 'pending');

        const totalPaid = completed.reduce((s, r) => s + (Number(r.net) || 0), 0);
        const pendingAmount = pending.reduce((s, r) => s + (Number(r.net) || 0), 0);

        totalPaidEl.textContent = fmtCurrency(totalPaid);
        pendingCountEl.textContent = fmtNumber(pending.length);
        pendingAmountEl.textContent = fmtCurrency(pendingAmount);

        applyFiltersAndRender();
      } catch (err) {
        console.error('Load withdrawals error', err);
        withdrawTbody.innerHTML = `<tr><td colspan="10" class="small" style="color:tomato">فشل جلب السحوبات — تحقق من قواعد Firestore (console للمزيد)</td></tr>`;
      }
    }

    function applyFiltersAndRender() {
      const status = statusFilter.value; // 'All' or 'pending' etc.
      const q = searchInput.value.trim().toLowerCase();

      let filtered = allWithdrawals.filter(w => {
        const st = (w.status || '').toString().toLowerCase();
        const statusMatch = status === 'All' ? true : (st === status.toLowerCase());
        // search on uid, email, wallet, id
        const email = (w.email || w.userEmail || '').toString().toLowerCase();
        const uid = (w.userId || w.uid || '').toString().toLowerCase();
        const wallet = (w.wallet || '').toString().toLowerCase();
        return statusMatch && (!q || email.includes(q) || uid.includes(q) || wallet.includes(q) || (w.id||'').toLowerCase().includes(q));
      });

      // sort: pending first, then by date desc
      filtered.sort((a,b) => {
        if ((a.status||'').toLowerCase() === 'pending' && (b.status||'').toLowerCase() !== 'pending') return -1;
        if ((a.status||'').toLowerCase() !== 'pending' && (b.status||'').toLowerCase() === 'pending') return 1;
        return (toDateSafe(b.date)?.getTime() || 0) - (toDateSafe(a.date)?.getTime() || 0);
      });

      renderTable(filtered);
    }

    function renderTable(list) {
      if (!list.length) {
        withdrawTbody.innerHTML = '<tr><td colspan="10" class="small">لا توجد طلبات مطابقة.</td></tr>';
        return;
      }
      withdrawTbody.innerHTML = '';
      list.forEach(w => {
        const tr = document.createElement('tr');

        const uid = w.userId || w.uid || 'N/A';
        const email = w.email || w.userEmail || 'غير متوفر';
        const pts = Number(w.pts || w.points || 0);
        const amount = Number(w.amount || 0);
        const net = Number(w.net || amount);
        const method = w.method || 'N/A';
        const wallet = w.wallet || 'N/A';
        const date = toDateSafe(w.date);
        const dateStr = date ? date.toLocaleString('ar-EG', {hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'}) : 'غير متوفر';
        const statusRaw = (w.status||'').toString();
        const statusLower = statusRaw.toLowerCase();

        // status badge
        let statusCls = 'status-pending';
        if (statusLower === 'completed') statusCls = 'status-completed';
        if (statusLower === 'rejected') statusCls = 'status-rejected';

        // actions
        const actionsCell = document.createElement('td');
        if (statusLower === 'pending') {
          const btn = document.createElement('button');
          btn.textContent = 'مراجعة';
          btn.className = 'btn-primary';
          btn.onclick = () => openModal(w.id);
          actionsCell.appendChild(btn);
        } else {
          const btn = document.createElement('button');
          btn.textContent = 'عرض';
          btn.onclick = () => openModal(w.id);
          actionsCell.appendChild(btn);
        }

        tr.innerHTML = `
          <td></td>
          <td><span class="status-badge ${statusCls}">${translate(statusLower)}</span></td>
          <td>${dateStr}</td>
          <td>${wallet}</td>
          <td>${method}</td>
          <td>${fmtCurrency(net)}</td>
          <td>${fmtCurrency(amount)}</td>
          <td>${fmtNumber(pts)}</td>
          <td>${email}</td>
          <td>${uid}</td>
        `;
        tr.firstChild.replaceWith(actionsCell); // put actions in first cell
        withdrawTbody.appendChild(tr);
      });
    }

    // open modal for a given withdrawal ID
    function openModal(id) {
      selectedWithdrawal = allWithdrawals.find(x => x.id === id);
      if (!selectedWithdrawal) return alert('الطلب غير موجود بعد التحديث — اضغط تحديث.');

      // populate modal content
      modalIdEl.textContent = id;
      modalContent.innerHTML = '';

      const rows = [
        ['UID', selectedWithdrawal.userId || 'N/A'],
        ['البريد', selectedWithdrawal.email || selectedWithdrawal.userEmail || 'غير متوفر'],
        ['المبلغ المطلوب', fmtCurrency(Number(selectedWithdrawal.amount || 0))],
        ['النقاط المحولة', fmtNumber(Number(selectedWithdrawal.pts || selectedWithdrawal.points || 0))],
        ['الرسوم', fmtNumber(Number(selectedWithdrawal.fee || 0))],
        ['صافي', fmtCurrency(Number(selectedWithdrawal.net || selectedWithdrawal.amount || 0))],
        ['طريقة الدفع', selectedWithdrawal.method || 'N/A'],
        ['رقم المحفظة', selectedWithdrawal.wallet || 'N/A'],
        ['تاريخ الطلب', toDateSafe(selectedWithdrawal.date) ? toDateSafe(selectedWithdrawal.date).toLocaleString('ar-EG') : 'غير متوفر'],
        ['الحالة الحالية', translate((selectedWithdrawal.status||'').toLowerCase())]
      ];

      rows.forEach(([k,v])=>{
        const div = document.createElement('div');
        div.className = 'modal-row';
        div.innerHTML = `<strong>${k}</strong><span>${v}</span>`;
        modalContent.appendChild(div);
      });

      // reset controls
      rejectArea.classList.add('hidden');
      confirmAcceptArea.classList.add('hidden');
      rejectReason.value = '';
      returnPoints = true;
      confirmReject.disabled = true;

      // show confirm accept area only when pending
      const st = (selectedWithdrawal.status||'').toLowerCase();
      if (st === 'pending') {
        confirmAcceptArea.classList.remove('hidden');
        confirmAccept.style.display = 'inline-block';
      } else {
        confirmAcceptArea.classList.add('hidden');
      }

      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      selectedWithdrawal = null;
    });

    // accept (init)
    acceptBtn.addEventListener('click', () => {
      rejectArea.classList.add('hidden');
      confirmAcceptArea.classList.remove('hidden');
    });

    confirmAccept.addEventListener('click', async () => {
      if (!selectedWithdrawal) return;
      if (!confirm('هل أنت متأكد من اعتماد الدفع؟ سيتم تغيير الحالة إلى "مكتمل" وتسجيل processedAt و processedBy.')) return;
      await performUpdate('completed');
    });

    // reject (init)
    rejectBtn.addEventListener('click', () => {
      rejectArea.classList.remove('hidden');
      confirmAcceptArea.classList.add('hidden');
    });

    // return points toggles
    returnYes.addEventListener('click', ()=> {
      returnPoints = true;
      returnYes.style.opacity = '1';
      returnNo.style.opacity = '0.6';
    });
    returnNo.addEventListener('click', ()=> {
      returnPoints = false;
      returnYes.style.opacity = '0.6';
      returnNo.style.opacity = '1';
    });

    // enable confirmReject when reason long enough
    rejectReason.addEventListener('input', () => {
      confirmReject.disabled = rejectReason.value.trim().length < 3;
    });

    confirmReject.addEventListener('click', async () => {
      if (!selectedWithdrawal) return;
      const reason = rejectReason.value.trim();
      if (reason.length < 3) return alert('الرجاء كتابة سبب واضح للرفض.');
      if (!confirm('تأكيد رفض الطلب وتنفيذ الإجراء المختار؟')) return;
      await performUpdate('rejected', reason, returnPoints);
    });

    // perform update: status can be 'completed' or 'rejected'
    async function performUpdate(newStatus, reason = null, returnPts = true) {
      if (!selectedWithdrawal) return;
      try {
        const batch = writeBatch(db);
        const wRef = doc(db, 'withdrawals', selectedWithdrawal.id);
        const now = Timestamp.fromDate(new Date());
        // update withdrawal doc
        const wUpdate = { status: newStatus, processedAt: now, processedBy: auth.currentUser ? auth.currentUser.uid : 'admin-web' };
        if (reason) wUpdate.rejectionReason = reason;
        batch.update(wRef, wUpdate);

        // if rejected and want to return points -> increment user's points
        if (newStatus === 'rejected' && returnPts) {
          const userId = selectedWithdrawal.userId;
          if (userId) {
            const userRef = doc(db, 'users', userId);
            const pts = Number(selectedWithdrawal.pts || selectedWithdrawal.points || 0);
            batch.update(userRef, { points: increment(pts) });
          } else {
            console.warn('لا يوجد userId لإرجاع النقاط.');
          }
        }
        // if completed -> you might want to mark 'processedBy' and maybe store transactionId (not implemented)
        await batch.commit();
        alert('تم تحديث حالة الطلب بنجاح.');
        modal.classList.add('hidden');
        await loadWithdrawals();
      } catch (err) {
        console.error('Update error', err);
        alert('❌ فشل تنفيذ التحديث. تحقق من قواعد Firestore أو صلاحياتك (Console للمزيد).');
      }
    }

    // events
    statusFilter.addEventListener('change', applyFiltersAndRender);
    searchInput.addEventListener('input', applyFiltersAndRender);
    refreshBtn.addEventListener('click', loadWithdrawals);
    logoutBtn.addEventListener('click', async ()=>{
      try { await signOut(auth); alert('تم تسجيل الخروج'); } catch(e){ console.error(e); alert('فشل تسجيل الخروج'); }
    });

    // initial load
    document.addEventListener('DOMContentLoaded', loadWithdrawals);
  </script>
</body>
  </html>
