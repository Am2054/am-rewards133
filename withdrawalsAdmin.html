<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AM REWARDS | SUPREME COMMAND</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #050810;
      --card-bg: rgba(13, 17, 28, 0.7);
      --gold: #f59e0b;
      --gold-glow: rgba(245, 158, 11, 0.3);
      --accent: #10b981;
      --red: #ef4444;
      --border: rgba(255, 255, 255, 0.05);
      --text: #e2e8f0;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: var(--bg); color: var(--text); margin: 0; padding: 20px;
      background-image: radial-gradient(circle at 20% 20%, #1e1b4b 0%, #050810 50%);
      min-height: 100vh; overflow-x: hidden;
    }

    .container { max-width: 1500px; margin: 0 auto; }

    /* --- Header & Stats --- */
    .top-bar {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--card-bg); padding: 20px 30px; border-radius: 24px;
      backdrop-filter: blur(15px); border: 1px solid var(--border); margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .brand { font-family: 'Orbitron'; font-weight: 900; color: var(--gold); font-size: 1.5rem; letter-spacing: 2px; }

    .stats-shelf {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;
    }
    .stat-pill {
      background: var(--card-bg); padding: 25px; border-radius: 24px;
      border: 1px solid var(--border); text-align: center; transition: 0.3s;
    }
    .stat-pill:hover { border-color: var(--gold); transform: translateY(-5px); }
    .stat-pill span { display: block; color: #94a3b8; font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; }
    .stat-pill strong { font-family: 'Orbitron'; font-size: 1.8rem; color: #fff; }

    /* --- Advanced Command Table --- */
    .table-wrapper {
      background: var(--card-bg); border-radius: 32px; padding: 30px;
      border: 1px solid var(--border); backdrop-filter: blur(20px);
    }
    .controls-grid {
      display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px;
    }
    .input-premium {
      background: rgba(0,0,0,0.4); border: 1px solid var(--border); color: #fff;
      padding: 16px 25px; border-radius: 18px; outline: none; transition: 0.3s;
    }
    .input-premium:focus { border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); }

    .data-row {
      display: grid; grid-template-columns: 2fr 1fr 1fr 1.5fr 1fr 1fr 1fr;
      align-items: center; padding: 18px 25px; background: rgba(255,255,255,0.02);
      border-radius: 20px; margin-bottom: 12px; transition: 0.3s;
      border: 1px solid transparent;
    }
    .data-row:hover { background: rgba(255,255,255,0.05); border-color: rgba(245,158,11,0.2); }
    .data-header { color: #64748b; font-size: 0.75rem; font-weight: 900; padding: 0 25px 15px; }

    .user-box { display: flex; align-items: center; gap: 15px; }
    .user-avatar { 
      width: 48px; height: 48px; border-radius: 16px; 
      background: linear-gradient(135deg, #1e293b, #334155);
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; color: var(--gold); border: 1px solid var(--border);
    }

    .badge-status {
      padding: 6px 12px; border-radius: 10px; font-size: 0.7rem; font-weight: 900;
      text-align: center; display: inline-block; width: fit-content;
    }
    .pending { background: rgba(245, 158, 11, 0.1); color: var(--gold); border: 1px solid rgba(245, 158, 11, 0.2); }
    .completed { background: rgba(16, 185, 129, 0.1); color: var(--accent); border: 1px solid rgba(16, 185, 129, 0.2); }
    .rejected { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid rgba(239, 68, 68, 0.2); }

    .btn-action {
      background: var(--gold); color: #000; border: none; padding: 10px 20px;
      border-radius: 12px; font-weight: 900; cursor: pointer; transition: 0.3s;
    }
    .btn-action:hover { transform: scale(1.05); box-shadow: 0 5px 15px var(--gold-glow); }

    /* --- Decision Modal --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px); z-index: 1000; display: flex;
      align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: 0.4s;
    }
    .overlay.active { visibility: visible; opacity: 1; }
    .decision-modal {
      background: #0f172a; width: 550px; border-radius: 35px; border: 1px solid var(--gold);
      padding: 40px; transform: scale(0.9); transition: 0.4s;
    }
    .overlay.active .decision-modal { transform: scale(1); }

    .reject-box { margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--border); }
    textarea {
      width: 100%; background: #000; border: 1px solid var(--border); color: #fff;
      padding: 15px; border-radius: 15px; margin-top: 10px; resize: none; outline: none;
    }
    textarea:focus { border-color: var(--red); }

    .hidden { display: none !important; }
    #auth-gate { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<div id="auth-gate">
  <div style="width: 400px; text-align: center; background: var(--card-bg); padding: 50px; border-radius: 40px; border: 1px solid var(--gold);">
    <h2 style="font-family: 'Orbitron'; color: var(--gold); margin-bottom: 30px;">AUTHORIZE</h2>
    <input type="email" id="adm-email" class="input-premium" value="amirfg992005@gmail.com" style="width: 100%; margin-bottom: 15px;">
    <input type="password" id="adm-pass" class="input-premium" placeholder="PASSWORD" style="width: 100%; margin-bottom: 15px;">
    <input type="password" id="adm-token" class="input-premium" placeholder="SECURE TOKEN" style="width: 100%; margin-bottom: 25px;">
    <button id="btn-login" class="btn-action" style="width: 100%; padding: 18px;">ENTER COMMAND CENTER</button>
  </div>
</div>

<div id="main-ui" class="container hidden">
  <div class="top-bar">
    <div class="brand">AM REWARDS EXECUTIVE</div>
    <button id="btnLogout" class="btn-action" style="background: var(--red); color: #fff;">LOGOUT SESSION</button>
  </div>

  <div class="stats-shelf">
    <div class="stat-pill"><span>TOTAL PAID</span><strong id="totalPaid">0.00</strong></div>
    <div class="stat-pill"><span>PENDING REQUESTS</span><strong id="pendingCount">0</strong></div>
    <div class="stat-pill"><span>SUCCESSFUL JOBS</span><strong id="totalCompletedCount">0</strong></div>
  </div>

  <div class="table-wrapper">
    <div class="controls-grid">
      <input type="text" id="searchInput" class="input-premium" placeholder="Search by name, wallet or UID...">
      <select id="statusFilter" class="input-premium">
        <option value="All">All Transactions</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
        <option value="rejected">Rejected</option>
      </select>
    </div>

    <div class="data-header data-row" style="background: none; border: none; margin-bottom: 0;">
        <div>BENEFICIARY</div>
        <div>POINTS</div>
        <div>NET AMOUNT</div>
        <div>WALLET INFO</div>
        <div>DATE</div>
        <div>STATUS</div>
        <div>ACTION</div>
    </div>
    
    <div id="withdrawalsList"></div>
  </div>
</div>

<div id="modalOverlay" class="overlay">
    <div class="decision-modal">
        <h2 id="modalTitle" style="color: var(--gold); font-family: 'Orbitron'; margin-top: 0;">TX REVIEW</h2>
        <div id="modalContent" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 20px; line-height: 2;"></div>
        
        <div id="actionGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
            <button id="btnApprove" class="btn-action" style="background: var(--accent);">✅ APPROVE PAYMENT</button>
            <button id="btnTriggerReject" class="btn-action" style="background: #334155; color: #fff;">❌ REJECT & REFUND</button>
        </div>

        <div id="rejectArea" class="reject-box hidden">
            <label style="color: var(--red); font-weight: 700;">REJECTION REASON:</label>
            <textarea id="rejectReason" rows="3" placeholder="Explain to user why..."></textarea>
            <button id="btnFinalReject" class="btn-action" style="background: var(--red); color: #fff; width: 100%;">CONFIRM REJECTION</button>
        </div>

        <button onclick="closeModal()" style="width: 100%; background: none; border: none; color: #64748b; margin-top: 20px; cursor: pointer;">CANCEL & CLOSE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, getDocs, orderBy, doc, writeBatch, increment, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const SECURE_TOKEN = "AM-VIP-2025";

    let rawData = [];
    let nameCache = {};

    // --- Auth Execution ---
    document.getElementById('btn-login').onclick = async () => {
        const token = document.getElementById('adm-token').value;
        if(token !== SECURE_TOKEN) return alert("ACCESS DENIED");
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('adm-email').value, document.getElementById('adm-pass').value);
        } catch(e) { alert(e.message); }
    };

    onAuthStateChanged(auth, user => {
        if(user && user.email === "amirfg992005@gmail.com") {
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            loadSystemData();
        }
    });

    // --- Core Data Engine ---
    async function loadSystemData() {
        const snap = await getDocs(query(collection(db, 'withdrawals'), orderBy('date', 'desc')));
        rawData = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        const uids = [...new Set(rawData.map(w => w.userId))];
        for (let uid of uids) {
            if(!nameCache[uid]) {
                const uSnap = await getDoc(doc(db, 'users', uid));
                nameCache[uid] = uSnap.exists() ? uSnap.data().name : "Unknown User";
            }
        }
        renderDisplay();
    }

    function renderDisplay() {
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        const container = document.getElementById('withdrawalsList');
        container.innerHTML = '';

        const filtered = rawData.filter(w => {
            const mS = status === 'All' || w.status === status;
            const mQ = nameCache[w.userId]?.toLowerCase().includes(search) || w.wallet?.includes(search) || w.userId.includes(search);
            return mS && mQ;
        });

        filtered.forEach(w => {
            const div = document.createElement('div');
            div.className = 'data-row';
            const userName = nameCache[w.userId] || 'Loading...';
            
            div.innerHTML = `
                <div class="user-box">
                    <div class="user-avatar">${userName.charAt(0)}</div>
                    <div><div style="font-weight:700;">${userName}</div><small style="color:#64748b;">${w.userId}</small></div>
                </div>
                <div style="font-family:'Orbitron'; color:#94a3b8;">${Number(w.pts).toLocaleString()}</div>
                <div style="font-family:'Orbitron'; color:var(--gold); font-weight:700;">${Number(w.net).toFixed(2)} EGP</div>
                <div><div style="font-size:0.85rem;">${w.wallet}</div><small style="color:#64748b;">${w.method}</small></div>
                <div style="font-size:0.75rem;">${new Date(w.date.seconds*1000).toLocaleDateString('ar-EG')}</div>
                <div><span class="badge-status ${w.status}">${w.status.toUpperCase()}</span></div>
                <div>${w.status === 'pending' ? `<button class="btn-action" onclick="reviewTx('${w.id}')">REVIEW</button>` : '---'}</div>
            `;
            container.appendChild(div);
        });

        // Update Dashboard Stats
        const comp = rawData.filter(x => x.status === 'completed');
        document.getElementById('totalCompletedCount').textContent = comp.length;
        document.getElementById('totalPaid').textContent = comp.reduce((a,b) => a + (Number(b.net)||0), 0).toFixed(2);
        document.getElementById('pendingCount').textContent = rawData.filter(x => x.status === 'pending').length;
    }

    // --- Decision System (The "Heart" of the UI) ---
    window.reviewTx = (id) => {
        const tx = rawData.find(x => x.id === id);
        const overlay = document.getElementById('modalOverlay');
        const content = document.getElementById('modalContent');
        
        content.innerHTML = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <span style="color:#64748b">USER:</span> <b>${nameCache[tx.userId]}</b>
                <span style="color:#64748b">NET PAYOUT:</span> <b style="color:var(--gold)">${tx.net} EGP</b>
                <span style="color:#64748b">POINTS COST:</span> <b>${tx.pts}</b>
                <span style="color:#64748b">WALLET:</span> <b>${tx.wallet}</b>
            </div>
        `;

        overlay.classList.add('active');
        document.getElementById('rejectArea').classList.add('hidden');
        document.getElementById('actionGrid').classList.remove('hidden');

        // Approve Function
        document.getElementById('btnApprove').onclick = async () => {
            if(!confirm("MARK AS PAID? This cannot be undone.")) return;
            const batch = writeBatch(db);
            batch.update(doc(db, 'withdrawals', id), { status: 'completed', processedAt: Timestamp.now() });
            await batch.commit();
            closeModal();
            loadSystemData();
        };

        // Trigger Reject UI
        document.getElementById('btnTriggerReject').onclick = () => {
            document.getElementById('actionGrid').classList.add('hidden');
            document.getElementById('rejectArea').classList.remove('hidden');
        };

        // Execute Rejection & Refund
        document.getElementById('btnFinalReject').onclick = async () => {
            const reason = document.getElementById('rejectReason').value.trim();
            if(!reason) return alert("PLEASE STATE REASON");

            const batch = writeBatch(db);
            // 1. Update Tx status
            batch.update(doc(db, 'withdrawals', id), { 
                status: 'rejected', 
                rejectionReason: reason, 
                processedAt: Timestamp.now() 
            });
            // 2. REFUND POINTS TO USER (CRITICAL)
            batch.update(doc(db, 'users', tx.userId), { 
                points: increment(Number(tx.pts)) 
            });

            await batch.commit();
            alert("TX REJECTED. POINTS REFUNDED TO USER.");
            closeModal();
            loadSystemData();
        };
    };

    window.closeModal = () => {
        document.getElementById('modalOverlay').classList.remove('active');
        document.getElementById('rejectReason').value = '';
    };

    document.getElementById('statusFilter').onchange = renderDisplay;
    document.getElementById('searchInput').oninput = renderDisplay;
    document.getElementById('btnLogout').onclick = () => signOut(auth);

</script>
</body>
</html>
