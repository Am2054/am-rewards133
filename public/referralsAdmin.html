<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AM REWARDS | REFERRALS CONTROL PRO</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #030712; --card: rgba(17, 24, 39, 0.7); --gold: #f5c542; 
      --border: rgba(245, 197, 66, 0.1); --text: #eef2f7; --accent: #00fa9a;
      --blue: #3b82f6; --red: #ef4444; --cyan: #00f2ff;
    }
    body { font-family: "Cairo", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; }
    .wrap { max-width: 1200px; margin: 0 auto; }
    
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; padding: 20px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); }
    
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-item { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
    .stat-item strong { display: block; font-size: 1.5rem; color: #fff; }
    .stat-item span { color: var(--gold); font-size: 0.7rem; font-weight: 700; }

    .table-card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid var(--border); margin-bottom: 30px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th { padding: 12px; color: var(--gold); font-size: 0.8rem; text-align: right; border-bottom: 1px solid var(--border); }
    td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
    
    .btn-main { background: var(--gold); color: #000; font-weight: 900; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; }
    .status-badge { padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 900; background: rgba(0,250,154,0.1); color: var(--accent); border: 1px solid var(--accent); }
    
    /* Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
    .modal-content { background: #111827; padding: 25px; border-radius: 20px; border: 1px solid var(--gold); width: 95%; max-width: 700px; max-height: 80vh; overflow-y: auto; }
    .friend-row { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .progress-mini { width: 100px; height: 5px; background: #334155; border-radius: 5px; overflow: hidden; margin-top: 5px; }
    .progress-bar-mini { height: 100%; background: var(--accent); }
    
    .hidden { display: none !important; }
    .clickable { color: var(--cyan); cursor: pointer; text-decoration: underline; }

    /* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø¶Ø§Ù Ù„Ù„Ù…Ø³Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
    .modal-content {
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .clickable:hover {
        color: var(--gold);
        letter-spacing: 0.5px;
        transition: 0.3s;
    }

    .progress-bar-mini {
        transition: width 1s ease-in-out;
        box-shadow: 0 0 8px var(--accent);
    }
    
    #liveLogsBody tr {
        border-right: 3px solid transparent;
    }
    #liveLogsBody tr:first-child {
        border-right-color: var(--cyan);
        background: rgba(0, 242, 255, 0.03);
    }
  </style>
</head>
<body>

  <div class="wrap">
    <header>
      <h1>REFERRALS <span style="color:var(--gold);">CONTROL</span></h1>
      <button class="btn-main" onclick="location.reload()">REFRESH DATA</button>
    </header>

    <div class="metrics">
      <div class="stat-item"><strong id="totalReferrals">0</strong> <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</span></div>
      <div class="stat-item"><strong id="totalRewardEGP">0.00</strong> <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ²Ø¹Ø©</span></div>
    </div>

    <div class="table-card">
        <h3 style="color:var(--gold); margin-bottom:15px;">ğŸ† Ù…ØªØµØ¯Ø±ÙŠ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ù„ØªÙØ§ØµÙŠÙ„)</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
                        <th>Ø§Ù„Ø¯Ø§Ø¹ÙŠ (Ø§Ù„Ø§Ø³Ù…)</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…ÙˆÙ„ØªÙ‡</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>
    </div>

    <div class="table-card">
        <h3 style="color:var(--cyan); margin-bottom:15px;">ğŸ“¡ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Live Logs)</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø¶Ù…</th>
                        <th>Ø¯ÙØ¹ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                        <th>Ø³Ø­Ø¨Ø§ØªÙ‡ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                        <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù†Ø§ØªØ¬Ø©</th>
                    </tr>
                </thead>
                <tbody id="liveLogsBody"></tbody>
            </table>
        </div>
    </div>
  </div>
  
  <div id="detailsModal" class="modal hidden">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h3 id="modalTitle" style="color:var(--gold); margin:0;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
        <span style="color:var(--red); cursor:pointer; font-weight:bold;" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ âœ–</span>
      </div>
      <div id="friendsListContainer"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", authDomain: "am--rewards.firebaseapp.com", projectId: "am--rewards" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let allUsers = [];
    let allWithdrawals = [];

    async function startAdmin() {
        const uSnap = await getDocs(collection(db, "users"));
        allUsers = uSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const wSnap = await getDocs(query(collection(db, "withdrawals"), where("status", "==", "completed")));
        allWithdrawals = wSnap.docs.map(d => d.data());

        processAndRender();
    }

    function processAndRender() {
        const referrersMap = {};
        let totalSystemCommission = 0;
        let totalConversions = 0;

        allUsers.forEach(user => {
            if (user.referredBy) {
                totalConversions++;
                const bossId = user.referredBy;
                
                const hisWithdrawals = allWithdrawals.filter(w => w.userId === user.id);
                let commFromHim = 0;
                hisWithdrawals.slice(0, 10).forEach(w => {
                    commFromHim += (Number(w.amount) * 0.10);
                });

                if (!referrersMap[bossId]) {
                    const bossData = allUsers.find(u => u.id === bossId);
                    referrersMap[bossId] = {
                        name: bossData?.name || "Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                        email: bossData?.email || "-",
                        friends: [],
                        totalComm: 0
                    };
                }

                referrersMap[bossId].friends.push({
                    name: user.name,
                    email: user.email,
                    withdrawalsCount: hisWithdrawals.length,
                    commGenerated: commFromHim
                });
                referrersMap[bossId].totalComm += commFromHim;
                totalSystemCommission += commFromHim;
            }
        });

        document.getElementById('totalReferrals').innerText = totalConversions;
        document.getElementById('totalRewardEGP').innerText = totalSystemCommission.toFixed(2);

        const leaderboard = Object.entries(referrersMap).sort((a,b) => b[1].totalComm - a[1].totalComm);
        const lbBody = document.getElementById('leaderboardBody');
        lbBody.innerHTML = leaderboard.map(([id, data], i) => `
            <tr>
                <td>#${i+1}</td>
                <td class="clickable" onclick="showFriends('${id}')">${data.name}</td>
                <td>${data.friends.length}</td>
                <td style="color:var(--accent)">${data.totalComm.toFixed(2)} Ø¬</td>
                <td><button class="status-badge" onclick="showFriends('${id}')">Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button></td>
            </tr>
        `).join('');

        const logsBody = document.getElementById('liveLogsBody');
        const recentJoined = allUsers.filter(u => u.referredBy).slice(-15).reverse();
        logsBody.innerHTML = recentJoined.map(u => {
            const boss = allUsers.find(b => b.id === u.referredBy);
            const hisW = allWithdrawals.filter(w => w.userId === u.id).length;
            return `
                <tr>
                    <td>${u.name} <br><small style="color:var(--muted)">${u.email}</small></td>
                    <td>${boss?.name || '---'}</td>
                    <td>${hisW} Ø³Ø­Ø¨Ø§Øª</td>
                    <td style="color:var(--gold)">+${(hisW > 10 ? 10 : hisW * 0.10).toFixed(2)}</td>
                </tr>
            `;
        }).join('');

        window.cachedReferrers = referrersMap;
    }

    window.showFriends = (bossId) => {
        const data = window.cachedReferrers[bossId];
        document.getElementById('modalTitle').innerText = `Ø£ØµØ¯Ù‚Ø§Ø¡: ${data.name}`;
        const container = document.getElementById('friendsListContainer');
        
        container.innerHTML = data.friends.map(f => {
            const progress = (f.withdrawalsCount / 10) * 100;
            return `
                <div class="friend-row">
                    <div>
                        <div style="font-weight:bold">${f.name}</div>
                        <div style="font-size:10px; color:var(--muted)">${f.email}</div>
                    </div>
                    <div style="text-align:left">
                        <div style="font-size:11px">Ø³Ø­Ø¨Ø§Øª: ${f.withdrawalsCount}/10</div>
                        <div class="progress-mini"><div class="progress-bar-mini" style="width:${progress > 100 ? 100 : progress}%"></div></div>
                        <div style="color:var(--accent); font-size:11px; margin-top:5px">+${f.commGenerated.toFixed(2)} Ø¬</div>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('detailsModal').classList.remove('hidden');
    }

    window.closeModal = () => document.getElementById('detailsModal').classList.add('hidden');

    onAuthStateChanged(auth, user => {
        if(user && user.email === "amirfg992005@gmail.com") {
            startAdmin();
        } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø¯Ø®ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
            window.location.href = "index.html";
        }
    });
  </script>
</body>
</html>
