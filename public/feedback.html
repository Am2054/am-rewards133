<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª | Am Rewards</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Tajawal:wght@500;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --cyan: #00f2ff; --purple: #7000ff; --dark: #020617; --glass: rgba(15, 23, 42, 0.8); --border: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: #fff; margin: 0; padding: 20px; background-image: radial-gradient(circle at top right, rgba(0, 242, 255, 0.1), transparent 400px); }
        .container { max-width: 750px; margin: auto; }
        
        .reward-banner {
            background: linear-gradient(90deg, rgba(112, 0, 255, 0.15), rgba(0, 242, 255, 0.15));
            border: 1px solid var(--border); border-right: 4px solid var(--cyan); border-radius: 12px; padding: 15px;
            margin-bottom: 25px; font-size: 14px; line-height: 1.8;
        }
        .reward-banner b { color: var(--cyan); }

        .support-card { background: var(--glass); border: 1px solid var(--border); padding: 30px; border-radius: 25px; backdrop-filter: blur(10px); }
        h1 { color: var(--cyan); text-align: center; font-weight: 900; margin-top: 0; font-family: 'Tajawal'; }
        
        label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--cyan); font-weight: 700; }
        input, select, textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 12px; color: #fff; font-family: 'Cairo'; outline: none; margin-bottom: 15px; box-sizing: border-box; }
        input:focus, select:focus, textarea:focus { border-color: var(--cyan); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }
        
        .btn-send { width: 100%; padding: 16px; background: linear-gradient(90deg, var(--purple), var(--cyan)); border: none; border-radius: 15px; color: #fff; font-weight: 900; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-send:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 242, 255, 0.3); }
        
        .ticket-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 18px; border-radius: 18px; margin-top: 15px; }
        .status-tag { float: left; font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 900; }
        
        .pending { background: #64748b; color: #fff; }
        .reviewing { background: #f59e0b; color: #000; }
        .approved { background: #10b981; color: #fff; }
        .rejected { background: #ef4444; color: #fff; }

        .points-badge { color: #22c55e; font-weight: 900; font-size: 13px; margin-top: 10px; display: block; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; }
        .admin-reply-box { background:rgba(0,242,255,0.05); padding:10px; border-radius:10px; font-size:13px; border-right:2px solid var(--cyan); margin-top:10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="reward-banner">
        ğŸ¯ <b>Ù†Ø¸Ø§Ù… Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù…Ø³Ø§Ù‡Ù…ÙŠÙ†:</b><br>
        âœ… Ù…Ø´ÙƒÙ„Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ø«Ø¨ØªØ©: <b>50 â€“ 500 Ù†Ù‚Ø·Ø©</b><br>
        âœ… Ø§Ù‚ØªØ±Ø§Ø­ ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡ ÙØ¹Ù„ÙŠØ§Ù‹: <b>1000 â€“ 5000 Ù†Ù‚Ø·Ø©</b><br>
        âœ… Ø«ØºØ±Ø© Ø£Ù…Ù†ÙŠØ© Ø®Ø·ÙŠØ±Ø©: <b>Ù…ÙƒØ§ÙØ£Ø© Ø®Ø§ØµØ© ÙƒØ¨Ø±Ù‰</b> ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.
    </div>

    <div class="support-card">
        <h1>ğŸ“© Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ø§Ø¨ØªÙƒØ§Ø±</h1>
        <p style="text-align: center; font-size: 13px; opacity: 0.8; margin-bottom: 25px;">Ø³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§ÙƒØ³Ø¨ Ù†Ù‚Ø§Ø·Ø§Ù‹ ØªÙØ¶Ø§Ù Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ ÙÙˆØ± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ.</p>
        
        <form id="supportForm">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <select id="requestType" required onchange="toggleFields()">
                <option value="">-- Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ®Ø¨Ø±Ù†Ø§ØŸ --</option>
                <option value="Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·">ğŸ”´ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</option>
                <option value="Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨">ğŸ’¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨</option>
                <option value="Ø¹Ø·Ù„ ÙÙŠ Ø®Ø¯Ù…Ø© Ù…Ø¹ÙŠÙ†Ø©">âš ï¸ Ø¹Ø·Ù„ ÙÙŠ Ø®Ø¯Ù…Ø© Ù…Ø¹ÙŠÙ†Ø©</option>
                <option value="Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©">âš™ï¸ Ø¹Ø·Ù„ ÙÙ†ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>
                <option value="Ø§Ù‚ØªØ±Ø§Ø­ ØªØ·ÙˆÙŠØ±">ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>
                <option value="Ø«ØºØ±Ø© Ø£Ù…Ù†ÙŠØ©">ğŸ›¡ï¸ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø«ØºØ±Ø© Ø£Ù…Ù†ÙŠØ©</option>
            </select>

            <div id="serviceSelectionArea" style="display:none">
                <label>Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©</label>
                <select id="serviceName">
                    <option value="ØºÙŠØ± Ù…Ø­Ø¯Ø¯">-- Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© --</option>
                    <option value="Ù…Ø­Ù„Ù„ Ø¨Ø§Ù‚Ø© Ø§Ù„Ø§Ù†ØªØ±Ù†Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ">ğŸŒ Ù…Ø­Ù„Ù„ Ø¨Ø§Ù‚Ø© Ø§Ù„Ø§Ù†ØªØ±Ù†Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ</option>
                    <option value="Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">âš¡ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                    <option value="Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙŠØ§Ù‡">ğŸ’§ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙŠØ§Ù‡</option>
                    <option value="Ø§ÙƒÙˆØ§Ø¯ Ø§Ù„Ù‡Ø§ØªÙ">ğŸ“± Ø§ÙƒÙˆØ§Ø¯ Ø§Ù„Ù‡Ø§ØªÙ</option>
                    <option value="Ø´Ø§Øª Ø§Ù„Ø§Ø´Ø¨Ø§Ø­">ğŸ‘» Ø´Ø§Øª Ø§Ù„Ø§Ø´Ø¨Ø§Ø­</option>
                </select>
            </div>

            <div id="extraInputArea" style="display:none">
                <label id="extraLabel">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</label>
                <input type="text" id="extraValue">
            </div>

            <label>Ø§Ø´Ø±Ø­ Ù„Ù†Ø§ Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
            <textarea id="message" rows="5" minlength="30" required placeholder="Ø§Ø´Ø±Ø­ Ù…Ø´ÙƒÙ„ØªÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ Ø¨ÙˆØ¶ÙˆØ­ (30 Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„) Ù„Ø¶Ù…Ø§Ù† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨..."></textarea>

            <button type="submit" class="btn-send" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€</button>
        </form>
    </div>

    <div id="myTickets" style="margin-top: 40px;">
        <h3 style="border-right: 4px solid var(--cyan); padding-right: 15px; font-family: 'Tajawal';">ğŸ« Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
        <div id="ticketsList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy, onSnapshot, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
        authDomain: "am--rewards.firebaseapp.com",
        projectId: "am--rewards",
        storageBucket: "am--rewards.appspot.com",
        messagingSenderId: "744783579735",
        appId: "1:744783579735:web:45e00de9998893bbc9b112",
        measurementId: "G-CV3GLT2TTJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let user = null;

    onAuthStateChanged(auth, (u) => {
        if (u) { user = u; listenToTickets(); }
        else { window.location.href = "login.html"; }
    });

    window.toggleFields = () => {
        const type = document.getElementById('requestType').value;
        const area = document.getElementById('extraInputArea');
        const serviceArea = document.getElementById('serviceSelectionArea');
        const label = document.getElementById('extraLabel');
        const input = document.getElementById('extraValue');

        area.style.display='none';
        serviceArea.style.display='none';

        if(type.includes('Ø§Ù„Ù†Ù‚Ø§Ø·')) { area.style.display='block'; label.innerText='Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù‡Ù…Ø© (Ø¥Ù† ÙˆØ¬Ø¯)'; input.placeholder='Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§'; }
        else if(type.includes('Ø§Ù„Ø³Ø­Ø¨')) { area.style.display='block'; label.innerText='Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø³Ø­Ø¨'; input.placeholder='Ù…Ø«Ø§Ù„: 010xxxxxxxx'; }
        else if(type === 'Ø¹Ø·Ù„ ÙÙŠ Ø®Ø¯Ù…Ø© Ù…Ø¹ÙŠÙ†Ø©') { serviceArea.style.display='block'; }
    };

    function escapeHTML(str) {
        if(!str) return "";
        const p = document.createElement('p');
        p.textContent = str;
        return p.innerHTML;
    }

    function listenToTickets() {
        const q = query(collection(db, "support_tickets"), where("uid", "==", user.uid), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('ticketsList');
            list.innerHTML = snap.empty ? '<p style="text-align:center; opacity:0.5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>' : '';
            
            snap.forEach(doc => {
                const d = doc.data();
                const ticketDiv = document.createElement('div');
                ticketDiv.className = 'ticket-item';
                
                const statusMap = { 'pending': 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'reviewing': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'approved': 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„', 'rejected': 'Ù…Ø±ÙÙˆØ¶' };
                const serviceInfo = d.selectedService ? `<br><small style="color:var(--purple)">Ø§Ù„Ø®Ø¯Ù…Ø©: ${escapeHTML(d.selectedService)}</small>` : '';

                ticketDiv.innerHTML = `
                    <span class="status-tag ${d.status}">${statusMap[d.status] || d.status}</span>
                    <strong style="color:var(--cyan)">${escapeHTML(d.type)}</strong>${serviceInfo}
                    <p style="font-size:14px; margin: 10px 0;">${escapeHTML(d.message)}</p>
                `;

                if(d.adminReply) {
                    const replyBox = document.createElement('div');
                    replyBox.className = 'admin-reply-box';
                    replyBox.innerHTML = `<b>Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</b> ${escapeHTML(d.adminReply)}`;
                    if(d.rewardPoints > 0 && d.status === 'approved') {
                        replyBox.innerHTML += `<span class="points-badge">ğŸ’° ØªÙ… Ø¥Ø¶Ø§ÙØ© +${d.rewardPoints} Ù†Ù‚Ø·Ø© Ù„Ø±ØµÙŠØ¯Ùƒ Ø¨Ù†Ø¬Ø§Ø­</span>`;
                    }
                    ticketDiv.appendChild(replyBox);
                }
                list.appendChild(ticketDiv);
            });
        }, (error) => {
            console.error("Snapshot error:", error);
        });
    }

    document.getElementById('supportForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const type = document.getElementById('requestType').value;
        const msg = document.getElementById('message').value;
        
        btn.disabled = true;
        btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";

        try {
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            
            // ØªÙ… Ø¥Ø¶Ø§ÙØ© orderBy Ù‡Ù†Ø§ Ù„ÙŠØªÙˆØ§ÙÙ‚ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø¹ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø±ÙƒØ¨ (uid + timestamp DESC)
            const rateQuery = query(
                collection(db, "support_tickets"), 
                where("uid", "==", user.uid),
                where("timestamp", ">=", Timestamp.fromDate(twentyFourHoursAgo)),
                orderBy("timestamp", "desc")
            );
            
            const rateSnap = await getDocs(rateQuery);
            
            if (rateSnap.size >= 3) {
                Swal.fire("ØªÙˆÙ‚Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹!", "Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (3 Ø·Ù„Ø¨Ø§Øª ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©). Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.", "warning");
                btn.disabled = false;
                btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€";
                return;
            }

            btn.innerText = "ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...";

            await addDoc(collection(db, "support_tickets"), {
                uid: user.uid,
                email: user.email,
                type: type,
                selectedService: type === 'Ø¹Ø·Ù„ ÙÙŠ Ø®Ø¯Ù…Ø© Ù…Ø¹ÙŠÙ†Ø©' ? document.getElementById('serviceName').value : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                extraData: document.getElementById('extraValue').value || "Ù„Ø§ ÙŠÙˆØ¬Ø¯",
                message: msg,
                status: "pending",
                adminReply: "", 
                rewardPoints: 0, 
                timestamp: serverTimestamp()
            });

            Swal.fire("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ", "Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø³Ø§Ù‡Ù…ØªÙƒ! Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØ¥Ø¨Ù„Ø§ØºÙƒ Ø¨Ø§Ù„Ø±Ø¯ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.", "success");
            document.getElementById('supportForm').reset();
            document.getElementById('extraInputArea').style.display = 'none';
            document.getElementById('serviceSelectionArea').style.display = 'none';
        } catch (error) { 
            console.error("Submit Error:", error);
            Swal.fire("Ø¹Ø°Ø±Ø§Ù‹", "Ø­Ø¯Ø« Ø®Ø·Ø£: " + (error.code || error.message), "error"); 
        }
        
        btn.disabled = false;
        btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€";
    };
</script>
</body>
</html>
