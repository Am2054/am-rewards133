<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AM REWARDS | Ù…Ø±ÙƒØ² Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #030712; --card: rgba(17, 24, 39, 0.8);
      --gold: #f5c542; --accent: #00fa9a;
      --text: #eef2f7; --border: rgba(245, 197, 66, 0.1);
    }

    body {
      font-family: 'Cairo', sans-serif; background: var(--bg);
      color: var(--text); margin: 0; padding: 20px;
      background-image: radial-gradient(circle at top, #1e293b, #030712);
      min-height: 100vh; direction: rtl;
    }

    .header-section { text-align: center; margin-bottom: 30px; }
    h2 { color: var(--gold); font-size: 1.8rem; font-weight: 900; margin-bottom: 10px; }
    
    #user-points {
      background: var(--card); border: 1px solid var(--gold);
      padding: 10px 25px; border-radius: 50px; display: inline-flex;
      align-items: center; gap: 10px; font-weight: 900; color: var(--gold);
      box-shadow: 0 0 20px rgba(245, 197, 66, 0.1);
    }

    #status { font-size: 0.9rem; margin: 15px 0; color: var(--accent); opacity: 0.8; }
    #err { color: #ff5252; font-size: 0.85rem; height: 20px; }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· */
    #links-container {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px; max-width: 1100px; margin: 0 auto;
    }

    .link-card {
      background: var(--card); border: 1px solid var(--border);
      padding: 25px; border-radius: 24px; position: relative;
      transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(10px); text-align: center;
    }

    .link-card:hover { transform: translateY(-8px); border-color: var(--gold); }

    .link-card p { margin: 0 0 20px 0; font-weight: 700; font-size: 1.1rem; }
    
    .reward-badge {
      position: absolute; top: -10px; right: 20px; background: var(--gold);
      color: #000; padding: 2px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 900;
    }

    .btn-action {
      width: 100%; padding: 12px; border-radius: 12px; border: none;
      font-weight: 900; cursor: pointer; transition: 0.3s;
      background: var(--accent); color: #030712; font-size: 1rem;
    }

    .btn-action:disabled {
      background: rgba(255,255,255,0.05); color: #64748b; cursor: not-allowed;
    }

    .timer-lock {
      margin-top: 15px; font-size: 0.8rem; color: #94a3b8;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }

    .back-nav {
      margin-top: 50px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;
    }
    .btn-nav {
      background: transparent; border: 1px solid var(--border);
      color: var(--text); padding: 10px 20px; border-radius: 12px;
      cursor: pointer; font-weight: 700; text-decoration: none; font-size: 0.9rem;
    }
    .btn-nav:hover { background: var(--card); border-color: var(--gold); }

  </style>
</head>
<body>

  <div class="header-section">
    <h2>Ù…Ø±ÙƒØ² Ù…Ù‡Ø§Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø©</h2>
    <div id="user-points">ğŸª™ Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="points-val">0</span></div>
    <div id="status">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
    <div id="err"></div>
  </div>

  <div id="links-container">
      </div>

  <div class="back-nav">
    <a href="dashboard.html" class="btn-nav">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="tasks.html" class="btn-nav">ğŸ—‚ï¸ Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</a>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain: "am--rewards.firebaseapp.com",
  projectId: "am--rewards"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const POINTS_PER_LINK = 2; 
const LINK_COOLDOWN = 24 * 60 * 60 * 1000;
const MIN_WAIT_TIME = 15000;

const shortlinks = [
  {title:"Ø®Ø§Ø¯Ù… SwiftLnx", url:"https://swiftlnx.com/RRIj1Sni"},
  {title:"Ù…Ø­Ø±Ùƒ Exe", url:"https://exe.io/ED0ipEN"},
  {title:"Ø¨ÙˆØ§Ø¨Ø© YShorten", url:"https://yshorten.com/OZpCcW9"},
  {title:"Ø´Ø¨ÙƒØ© OII", url:"https://oii.la/LcWIK3BD"},
  {title:"Ø¬Ø§Ù…Ø¨Ùˆ Ø¥Ù†Ùƒ", url:"https://short-jambo.ink/6XeL7"},
  {title:"Ø¨ÙˆØ§Ø¨Ø© TPI", url:"https://tpi.li/e6TZ8SqRPLi"},
  {title:"ShrinkMe ÙƒÙ„ÙŠÙƒ", url:"https://shrinkme.click/k4EXrq"},
  {title:"ShortSlug Ø¨Ø²Ù†Ø³", url:"https://shrtslug.biz/8xx8c"},
  {title:"RevLink Ø¨Ø±Ùˆ", url:"https://revlink.pro/Egc9E"},
  {title:"CutWin Ø³Ø±ÙŠØ¹", url:"https://cutw.in/tFu9b17C"},
  {title:"LinkJust Ù‡Ø¨", url:"https://linkjust.com/ooilAAdJ"},
  {title:"GP Links Ø§Ù„Ù…Ø·ÙˆØ±", url:"https://gplinks.co/XA30n0vz"},
  {title:"Ø´Ø¨ÙƒØ© TMEarn", url:"https://tmearn.net/link/82sq"},
  {title:"UII IO Ø¯Ø±Ø¹", url:"https://uii.io/INzfKhNW"},
  {title:"Link4Earn Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ", url:"https://go.link4earn.in/jtXBvLz"},
  {title:"ShortFly Ø§Ù„Ù…ØªÙ…ÙŠØ²", url:"https://www.short-fly.com/MTGN"},
  {title:"LNBZ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©", url:"https://lnbz.la/eAUo"},
  {title:"Ø³Ø­Ø§Ø¨Ø© DropLink", url:"https://droplink.co/gXE1an"},
  {title:"XP Ø´ÙˆØ±Øª Ù„ÙŠÙ†Ùƒ", url:"https://xpshort.com/oBwyc"},
  {title:"Ø¨ÙˆØ§Ø¨Ø© Easy4Skip", url:"http://easy4skip.com/TJmg"}
];

let currentUserRef = null;
let serverTimeOffset = 0;

onAuthStateChanged(auth, async (user) => {
  if (!user) { location.href = "index.html"; return; }
  currentUserRef = doc(db, "users", user.uid);
  
  // Ù…Ø²Ø§Ù…Ù†Ø© ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø¯Ø§Ù„Ø©
  const nowRef = doc(db, "system", "time");
  await setDoc(nowRef, { time: serverTimestamp() });
  const nowSnap = await getDoc(nowRef);
  serverTimeOffset = (nowSnap.data()?.time?.toMillis() || Date.now()) - Date.now();

  await checkPendingReward();

  onSnapshot(currentUserRef, (snap) => {
    const data = snap.data() || {};
    document.getElementById("points-val").textContent = data.points || 0;
    renderUI(data.lastLinks || {});
    document.getElementById("status").textContent = "ğŸ“¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²";
  });
});

async function checkPendingReward() {
  const linkIdx = localStorage.getItem("p_idx");
  const startTime = localStorage.getItem("p_time");
  if (!linkIdx || !startTime) return;

  const now = Date.now() + serverTimeOffset;
  const elapsed = now - Number(startTime);

  if (elapsed >= MIN_WAIT_TIME) {
    try {
      await updateDoc(currentUserRef, {
        points: increment(POINTS_PER_LINK),
        [`lastLinks.${linkIdx}`]: serverTimestamp()
      });
      alert(`ğŸ‰ Ø£Ø­Ø³Ù†Øª! ØªÙ… Ø¥Ø¶Ø§ÙØ© ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ.`);
    } catch (e) { console.error("Reward Error", e); }
  } else {
    alert("âš ï¸ Ø¹ÙˆØ¯Ø© Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ø§Ù‹! ÙŠØ¬Ø¨ Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ø¯Ø© 15 Ø«Ø§Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
  }
  localStorage.removeItem("p_idx");
  localStorage.removeItem("p_time");
}

function renderUI(lastLinks) {
  const container = document.getElementById("links-container");
  container.innerHTML = "";
  const now = Date.now() + serverTimeOffset;

  shortlinks.forEach((item, i) => {
    const lastTime = lastLinks[i]?.toMillis ? lastLinks[i].toMillis() : (lastLinks[i] || 0);
    const isLocked = lastTime && (now - lastTime < LINK_COOLDOWN);
    
    const card = document.createElement("div");
    card.className = "link-card";
    
    let timerHTML = "";
    if (isLocked) {
      const diff = LINK_COOLDOWN - (now - lastTime);
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      timerHTML = `<div class="timer-lock">â³ Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ ${h} Ø³Ø§Ø¹Ø© Ùˆ ${m} Ø¯Ù‚ÙŠÙ‚Ø©</div>`;
    }

    card.innerHTML = `
      <div class="reward-badge">+${POINTS_PER_LINK} Ù†</div>
      <p>${item.title}</p>
      <button class="btn-action" ${isLocked ? "disabled" : ""} 
        onclick="window.openLink(${i}, '${item.url}')">
        ${isLocked ? "Ù…ØºÙ„Ù‚ Ø§Ù„Ø¢Ù†" : "ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø©"}
      </button>
      ${timerHTML}
    `;
    container.appendChild(card);
  });
}

window.openLink = (i, url) => {
  localStorage.setItem("p_idx", i);
  localStorage.setItem("p_time", Date.now() + serverTimeOffset);
  window.location.href = url;
};
</script>
</body>
</html>
