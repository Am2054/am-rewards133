<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background-color: #111;
      color: white;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background-color: #1e1e1e;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }
    input, select {
      background-color: #2c2c2c;
      color: white;
    }
    button {
      background-color: #4caf50;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    .note {
      font-size: 14px;
      color: #ccc;
      margin-top: 10px;
    }
    .balance-box {
      background-color: #333;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    .success-msg {
      color: #ffeb3b;
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h2><div class="balance-box">
  Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong id="current-balance">0</strong> Ø¬Ù†ÙŠÙ‡
</div>

<label for="method">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
<select id="method">
  <option value="vodafone">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
</select>

<label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©:</label>
<input type="text" id="phone" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´">

<label for="amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø¬Ù†ÙŠÙ‡):</label>
<input type="number" id="amount" placeholder="Ù…Ù† 15 Ø¥Ù„Ù‰ 150">

<button onclick="submitWithdrawal()">Ø³Ø­Ø¨</button>

<div class="note">
  Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: 15 Ø¬Ù†ÙŠÙ‡ | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 150 Ø¬Ù†ÙŠÙ‡<br>
  ÙŠØªÙ… Ø®ØµÙ… 10% Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº 30 Ø¬Ù†ÙŠÙ‡.<br>
  ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ 3 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§.
</div>

<div class="success-msg" id="message"></div>

  </div>  <!-- Firebase SDK -->  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  <script>
    const POINT_VALUE_EGP = 0.07;
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userDocRef;
    let currentEGP = 0;
    let currentPoints = 0;

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      userDocRef = db.collection('users').doc(user.uid);
      const doc = await userDocRef.get();
      const data = doc.data();
      const totalPoints = data.points || 0;
      const withdrawn = data.withdrawn || 0;
      const totalEGP = totalPoints * POINT_VALUE_EGP;
      const withdrawnEGP = withdrawn * POINT_VALUE_EGP;
      currentEGP = totalEGP - withdrawnEGP;
      currentPoints = totalPoints;
      document.getElementById('current-balance').textContent = currentEGP.toFixed(2);
    });

    async function submitWithdrawal() {
      const amount = parseFloat(document.getElementById('amount').value);
      const phone = document.getElementById('phone').value;
      const method = document.getElementById('method').value;
      const msg = document.getElementById('message');
      msg.textContent = '';

      if (!amount || amount < 15 || amount > 150) {
        msg.textContent = 'âŒ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 15 Ùˆ 150 Ø¬Ù†ÙŠÙ‡';
        return;
      }

      if (!phone || phone.length < 10) {
        msg.textContent = 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­';
        return;
      }

      let finalAmount = amount;
      if (amount > 30) finalAmount *= 0.9;

      const requiredPoints = Math.ceil(finalAmount / POINT_VALUE_EGP);
      if (currentPoints < requiredPoints) {
        msg.textContent = 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ© Ù„Ù„Ø³Ø­Ø¨';
        return;
      }

      await userDocRef.update({
        withdrawn: firebase.firestore.FieldValue.increment(requiredPoints),
        points: firebase.firestore.FieldValue.increment(-requiredPoints)
      });

      await db.collection("withdraw_requests").add({
        uid: auth.currentUser.uid,
        phone,
        method,
        amount,
        afterDiscount: finalAmount,
        status: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      msg.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
      document.getElementById('amount').value = '';
      document.getElementById('phone').value = '';
    }
  </script></body>
  </html>
