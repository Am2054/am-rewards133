<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | AM Rewards</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">  
    <style>  
        :root {  
          --neon-cyan: #00f2ff; --neon-purple: #7000ff; --bg-deep: #020617;  
          --glass-bg: rgba(15, 23, 42, 0.7); --glass-border: rgba(255, 255, 255, 0.1);  
          --success: #22c55e; --error: #f87171; --warning: #facc15; --text-main: #f1f5f9;  
        }  
        body { font-family: 'Cairo', sans-serif; background: var(--bg-deep); color: var(--text-main); margin: 0; padding: 20px; }  
        .container { max-width: 480px; margin: 0 auto; background: var(--glass-bg); padding: 25px; border-radius: 24px; backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }  
        h1 { text-align: center; color: var(--neon-cyan); }  
        .balance-card { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; border: 1px solid var(--glass-border); }  
        .points-val { font-size: 32px; font-weight: 900; color: var(--neon-cyan); display: block; }  
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; outline: none; }  
        input:focus { border-color: var(--neon-cyan); }  
        .calc-box { display: flex; justify-content: space-around; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin: 15px 0; border: 1px dashed var(--glass-border); }  
        .calc-box b { display: block; color: var(--neon-purple); }  
        #confirmBtn { width: 100%; padding: 16px; border-radius: 16px; border: none; background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan)); color: #fff; font-weight: 900; cursor: pointer; font-size: 18px; }  
        #confirmBtn:disabled { opacity: 0.3; cursor: not-allowed; }  
        .status-msg { margin-top: 15px; padding: 12px; border-radius: 10px; text-align: center; display: none; font-weight: bold; }  
        table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 12px; }  
        th { color: var(--neon-cyan); padding: 10px; border-bottom: 1px solid var(--glass-border); }  
        td { padding: 10px; text-align: center; border-bottom: 1px solid var(--glass-border); }  
        .row-pending { color: var(--warning); } .row-completed { color: var(--success); } .row-rejected { color: var(--error); }  
        #customModal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }  
        .modal-content { background: var(--bg-deep); padding: 30px; border-radius: 24px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--neon-purple); }  
    </style>  
</head>  
<body>  
    <div class="container">  
        <h1>ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>  
        <div class="balance-card">  
            <span style="font-size: 14px; opacity: 0.8;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>  
            <span class="points-val" id="pointsVal">0</span>  
            <span>â‰ˆ <span id="egpVal">0.00</span> Ø¬.Ù…</span>  
        </div>  

        <label>Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>  
        <input type="text" id="walletVod" placeholder="010xxxxxxxx" maxlength="11">  
        
        <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 20 Ø¬.Ù…)</label>  
        <input type="number" id="amountInp" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">  

        <div class="calc-box">  
            <div>Ø§Ù„ØµØ§ÙÙŠ (90%)<b id="netVal">0.00</b></div>  
            <div>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©<b id="needPts">0</b></div>  
        </div>  

        <button id="confirmBtn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>  
        <div id="msg" class="status-msg"></div>  

        <h3>ğŸ“œ Ø§Ù„Ø³Ø¬Ù„</h3>  
        <table>  
            <thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>  
            <tbody id="withdrawalsTable"></tbody>  
        </table>  
    </div>  

    <div id="customModal">  
        <div class="modal-content">  
            <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>  
            <p>Ø³ÙŠØªÙ… Ø³Ø­Ø¨ <span id="mAm"></span> Ø¬.Ù… Ø¥Ù„Ù‰ <b id="mWa"></b></p>  
            <button id="cancelActionBtn" style="background:#334155; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">ØªØ¹Ø¯ÙŠÙ„</button>  
            <button id="confirmActionBtn" style="background:var(--success); color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">ØªØ£ÙƒÙŠØ¯</button>  
        </div>  
    </div>  

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  

    <script>  
        const firebaseConfig = { apiKey: "AIzaSy...", authDomain: "...", projectId: "..." }; // Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§  
        firebase.initializeApp(firebaseConfig);  
        const auth = firebase.auth(); const db = firebase.firestore();  
        const POINT_VALUE = 0.07;  

        auth.onAuthStateChanged(user => {  
            if (user) {  
                db.collection('users').doc(user.uid).onSnapshot(doc => {  
                    const pts = doc.data()?.points || 0;  
                    document.getElementById('pointsVal').innerText = Math.floor(pts).toLocaleString();  
                    document.getElementById('egpVal').innerText = (pts * POINT_VALUE).toFixed(2);  
                });  
                db.collection("withdrawals").where("userId", "==", user.uid).orderBy("date", "desc").limit(5).onSnapshot(snap => {  
                    let html = ""; snap.forEach(doc => {  
                        const w = doc.data();  
                        html += `<tr class="row-${w.status}"><td>${w.amount}Ø¬</td><td>${w.net?.toFixed(2)}Ø¬</td><td>${w.status}</td></tr>`;  
                    });  
                    document.getElementById('withdrawalsTable').innerHTML = html;  
                });  
            }  
        });  

        function updateCalc() {  
            const amt = parseFloat(document.getElementById('amountInp').value) || 0;  
            const wallet = document.getElementById('walletVod').value;  
            document.getElementById('netVal').innerText = (amt * 0.9).toFixed(2);  
            document.getElementById('needPts').innerText = Math.ceil(amt / POINT_VALUE);  
            document.getElementById('confirmBtn').disabled = !(amt >= 20 && /^010\d{8}$/.test(wallet));  
        }  
        document.getElementById('amountInp').oninput = updateCalc;  
        document.getElementById('walletVod').oninput = updateCalc;  

        document.getElementById('confirmBtn').onclick = () => {  
            document.getElementById('mAm').innerText = document.getElementById('amountInp').value;  
            document.getElementById('mWa').innerText = document.getElementById('walletVod').value;  
            document.getElementById('customModal').style.display = 'flex';  
        };  

        document.getElementById('confirmActionBtn').onclick = async () => {  
            document.getElementById('customModal').style.display = 'none';  
            const btn = document.getElementById('confirmBtn');  
            const msg = document.getElementById('msg');  
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";  

            try {  
                const idToken = await auth.currentUser.getIdToken();  
                const res = await fetch('/api/withdraw', {  
                    method: 'POST',  
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },  
                    body: JSON.stringify({ amount: parseFloat(document.getElementById('amountInp').value), wallet: document.getElementById('walletVod').value })  
                });  
                
                const data = await res.json();  
                msg.innerText = data.message;  
                msg.style.display = "block";  
                msg.style.color = res.ok ? "var(--success)" : "var(--error)";  
                if(res.ok) document.getElementById('amountInp').value = "";  
            } catch (e) {  
                msg.innerText = "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";  
                msg.style.display = "block"; msg.style.color = "var(--error)";  
            } finally { btn.disabled = false; btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨"; }  
        };  
        document.getElementById('cancelActionBtn').onclick = () => document.getElementById('customModal').style.display = 'none';  
    </script>  
</body>  
</html>
