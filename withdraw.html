<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Cairo', sans-serif;
  background:#121212 url('https://i.ibb.co/4YV5fB2/bg-dark.jpg') no-repeat center center fixed;
  background-size:cover;
  color:#eee;
  margin:0; padding:0;
}
.container {
  max-width:600px;
  margin:50px auto;
  background:rgba(30,30,30,0.95);
  padding:30px;
  border-radius:15px;
  box-shadow:0 0 20px #00e5ff66;
}
h1 { text-align:center; margin-bottom:20px; color:#00e5ff; }
label { display:block; margin:10px 0 5px; }
input, select, button {
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border:1px solid #333;
  border-radius:8px;
  background:#1f1f1f;
  color:#eee;
  font-weight:600;
}
input::placeholder { color:#aaa; }
.wallet-box { display:none; margin-bottom:10px; }
.wallet-box.show { display:block; }
.info { display:flex; justify-content:space-between; margin-bottom:10px; }
.info div {
  width:48%;
  background:#222;
  padding:12px;
  border-radius:8px;
  text-align:center;
  box-shadow: inset 0 0 10px #00e5ff33;
}
#confirmModal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.8);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
#confirmModal.show { display:flex; }
.modal-content {
  background:#1e1e1e;
  padding:25px;
  border-radius:15px;
  max-width:400px;
  width:90%;
  text-align:center;
  box-shadow:0 0 20px #00e5ff66;
}
.modal-content h2 { margin-bottom:20px; color:#00e5ff; }
.modal-content div { margin-bottom:12px; font-weight:600; }
.modal-buttons { display:flex; justify-content:space-between; margin-top:15px; }
.modal-buttons button {
  width:48%;
  padding:12px;
  font-weight:700;
  border:none;
  border-radius:10px;
  cursor:pointer;
  transition:0.3s;
}
.modal-buttons button.confirm { background:#10b981; color:#fff; }
.modal-buttons button.confirm:hover { background:#059669; }
.modal-buttons button.cancel { background:#d32f2f; color:#fff; }
.modal-buttons button.cancel:hover { background:#ff5252; }
.msg { color:#ff5252; text-align:center; margin-bottom:10px; }
.ok { color:#10b981; text-align:center; margin-bottom:10px; }
button#confirmBtn { background:#00e5ff; color:#000; font-weight:700; border:none; border-radius:10px; padding:12px; cursor:pointer; transition:0.3s; }
button#confirmBtn:hover { background:#00bcd4; }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>

  <div class="info">
    <div>Ø±ØµÙŠØ¯Ùƒ: <span id="pointsVal">0</span></div>
    <div>Ù…Ø§ ÙŠØ¹Ø§Ø¯Ù„: <span id="egpVal">0.00</span> Ø¬Ù…</div>
  </div>

  <label for="methodSel">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
  <select id="methodSel">
    <option value="vodafone">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
    <option value="etisalat">Ø§ØªØµØ§Ù„Ø§Øª ÙƒØ§Ø´</option>
    <option value="orange">Ø§ÙˆØ±Ù†Ø¬ ÙƒØ§Ø´</option>
  </select>

  <div id="box-vodafone" class="wallet-box show">
    <label>Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ†</label>
    <input type="text" id="walletVod" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©">
  </div>
  <div id="box-etisalat" class="wallet-box">
    <label>Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© Ø§ØªØµØ§Ù„Ø§Øª</label>
    <input type="text" id="walletEts" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©">
  </div>
  <div id="box-orange" class="wallet-box">
    <label>Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© Ø§ÙˆØ±Ù†Ø¬</label>
    <input type="text" id="walletOrg" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©">
  </div>

  <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡ (20 - 200 Ø¬Ù†ÙŠÙ‡)</label>
  <input type="number" id="amountInp" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">

  <div class="info">
    <div>Ø§Ù„Ø®ØµÙ…: <span id="feeVal">0.00</span> Ø¬Ù…</div>
    <div>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: <span id="netVal">0.00</span> Ø¬Ù…</div>
  </div>
  <div>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <span id="needPts">0</span></div>
  <div>Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ: <span id="leftCap">0</span></div>
  <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="leftCount">0</span></div>

  <button id="confirmBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>

  <div class="msg" id="msg"></div>
  <div class="ok" id="ok"></div>
</div>

<div id="confirmModal">
  <div class="modal-content">
    <h2>ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</h2>
    <div>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: <span id="c_method"></span></div>
    <div>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="c_gross"></span></div>
    <div>Ø§Ù„Ø®ØµÙ…: <span id="c_fee"></span></div>
    <div>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: <span id="c_net"></span></div>
    <div>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: <span id="c_pts"></span></div>
    <div class="modal-buttons">
      <button class="confirm" onclick="submitWithdrawal()">ØªØ£ÙƒÙŠØ¯</button>
      <button class="cancel" onclick="closeConfirm()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { 
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", 
  authDomain:"am--rewards.firebaseapp.com", 
  projectId:"am--rewards" 
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const POINT_VALUE_EGP = 0.07;
const LIMITS = { 
  vodafone:{label:'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´',min:20,maxDaily:200,maxCount:3}, 
  etisalat:{label:'Ø§ØªØµØ§Ù„Ø§Øª ÙƒØ§Ø´',min:20,maxDaily:200,maxCount:3}, 
  orange:{label:'Ø§ÙˆØ±Ù†Ø¬ ÙƒØ§Ø´',min:20,maxDaily:200,maxCount:3} 
};

const methodSel=document.getElementById('methodSel');
const amountInp=document.getElementById('amountInp');
const pointsVal=document.getElementById('pointsVal');
const egpVal=document.getElementById('egpVal');

const walletVod=document.getElementById('walletVod');
const walletEts=document.getElementById('walletEts');
const walletOrg=document.getElementById('walletOrg');

const boxVodafone=document.getElementById('box-vodafone');
const boxEtisalat=document.getElementById('box-etisalat');
const boxOrange=document.getElementById('box-orange');

const feeVal=document.getElementById('feeVal');
const netVal=document.getElementById('netVal');
const needPts=document.getElementById('needPts');

const leftCount=document.getElementById('leftCount');
const leftCap=document.getElementById('leftCap');

const msg=document.getElementById('msg');
const ok=document.getElementById('ok');

const confirmModal=document.getElementById('confirmModal');
const c_method=document.getElementById('c_method');
const c_gross=document.getElementById('c_gross');
const c_fee=document.getElementById('c_fee');
const c_net=document.getElementById('c_net');
const c_pts=document.getElementById('c_pts');

let userData=null;
let userId=null;

function isToday(date){ const now=new Date(); return date.getDate()===now.getDate() && date.getMonth()===now.getMonth() && date.getFullYear()===now.getFullYear(); }

auth.onAuthStateChanged(user=>{
  if(user){
    userId=user.uid;
    db.collection('users').doc(userId).get().then(doc=>{
      if(doc.exists){
        userData=doc.data();
        if(!userData.withdrawals) userData.withdrawals=[];
        updateDisplay();
      }
    });
  } else {
    msg.textContent='ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.'; msg.style.display='block';
  }
});

function updateDisplay(){
  if(!userData) return;
  const points=userData.points||0;
  pointsVal.textContent=points;
  const egp=points*POINT_VALUE_EGP;
  egpVal.textContent=egp.toFixed(2);

  const method=methodSel.value;
  const limit=LIMITS[method];

  const withdrawalsToday=userData.withdrawals?.filter(w=>w.method===method && isToday(new Date(w.date)))||[];
  const withdrawnAmountToday=withdrawalsToday.reduce((acc,w)=>acc+w.amount,0);
  const leftAmount=limit.maxDaily-withdrawnAmountToday;
  const leftRequests=limit.maxCount-withdrawalsToday.length;

  leftCount.textContent=leftRequests>0?leftRequests:0;
  leftCap.textContent=leftAmount>0?leftAmount.toFixed(2)+' Ø¬Ù…':'0.00 Ø¬Ù…';

  const amt=parseFloat(amountInp.value);
  if(isNaN(amt)||amt<limit.min||amt>leftAmount||leftRequests<=0){
    feeVal.textContent='0.00'; netVal.textContent='0.00'; needPts.textContent='0'; return;
  }
  const fee=amt*0.10; const net=amt-fee; const neededPoints=Math.ceil(amt/POINT_VALUE_EGP);
  feeVal.textContent=fee.toFixed(2); netVal.textContent=net.toFixed(2); needPts.textContent=neededPoints;
}

methodSel.addEventListener('change',()=>{
  const val=methodSel.value;
  boxVodafone.classList.toggle('show',val==='vodafone');
  boxEtisalat.classList.toggle('show',val==='etisalat');
  boxOrange.classList.toggle('show',val==='orange');
  updateDisplay();
});
amountInp.addEventListener('input',updateDisplay);
document.getElementById('confirmBtn').addEventListener('click',()=>openConfirm());

function openConfirm(){
  msg.style.display='none'; ok.style.display='none';
  if(!userData){ msg.textContent='ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.'; msg.style.display='block'; return; }

  const method=methodSel.value; 
  const limit=LIMITS[method]; 
  const amt=parseFloat(amountInp.value);
  if(isNaN(amt)){ msg.textContent='ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­.'; msg.style.display='block'; return; }
  if(amt<limit.min){ msg.textContent=`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ù‡Ùˆ ${limit.min} Ø¬Ù†ÙŠÙ‡.`; msg.style.display='block'; return; }
  if(userData.points*POINT_VALUE_EGP<amt){ msg.textContent='Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ.'; msg.style.display='block'; return; }

  const withdrawalsToday=userData.withdrawals?.filter(w=>w.method===method && isToday(new Date(w.date)))||[];
  const withdrawnAmountToday=withdrawalsToday.reduce((acc,w)=>acc+w.amount,0);
  const leftAmount=limit.maxDaily-withdrawnAmountToday;
  const leftRequests=limit.maxCount-withdrawalsToday.length;
  if(amt>leftAmount){ msg.textContent=`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù‡Ùˆ ${leftAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡.`; msg.style.display='block'; return; }
  if(leftRequests<=0){ msg.textContent='ÙˆØµÙ„Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ….'; msg.style.display='block'; return; }

  c_method.textContent=LIMITS[method].label;
  c_gross.textContent=amt.toFixed(2);
  const fee=amt*0.10; c_fee.textContent=fee.toFixed(2);
  c_net.textContent=(amt-fee).toFixed(2);
  c_pts.textContent=Math.ceil(amt/POINT_VALUE_EGP);
  confirmModal.classList.add('show');
}

function closeConfirm(){ confirmModal.classList.remove('show'); }

function submitWithdrawal(){
  const method=methodSel.value;
  const amt=parseFloat(amountInp.value);
  const fee=amt*0.10;
  const net=amt-fee;
  const ptsUsed=Math.ceil(amt/POINT_VALUE_EGP);
  const wallet=(method==='vodafone'?walletVod.value:method==='etisalat'?walletEts.value:walletOrg.value);

  if(!wallet){ msg.textContent='ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©.'; msg.style.display='block'; return; }

  const withdrawalData = { method, amount: amt, fee, net, pts: ptsUsed, wallet, userId, status:"pending", date:firebase.firestore.FieldValue.serverTimestamp() };

  const userRef=db.collection('users').doc(userId);
  const userWithdrawalsRef=userRef.collection('withdrawals');
  const mainWithdrawalsRef=db.collection('withdrawals');

  db.runTransaction(async (transaction)=>{
    const userSnap=await transaction.get(userRef);
    if(!userSnap.exists) throw "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";

    const currentPts=userSnap.data().points||0;
    if(currentPts<ptsUsed) throw "Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ";

    transaction.update(userRef,{ points: firebase.firestore.FieldValue.increment(-ptsUsed) });
    transaction.set(userWithdrawalsRef.doc(), withdrawalData);
    transaction.set(mainWithdrawalsRef.doc(), withdrawalData);
  }).then(()=>{
    ok.textContent='ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!'; ok.style.display='block';
    amountInp.value=''; confirmModal.classList.remove('show');
    updateDisplay();
  }).catch(err=>{
    console.error(err);
    msg.textContent="Ø­Ø¯Ø« Ø®Ø·Ø£: "+err; msg.style.display='block';
  });
}

updateDisplay();
</script>
</body>
  </html>
