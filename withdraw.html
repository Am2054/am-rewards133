<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | Am Rewards</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">  
    <style>  
        :root {  
          --bg-color: #0f172a;  
          --primary: #38bdf8;  
          --secondary: #0ea5e9;  
          --text-color: #f1f5f9;  
          --surface-color: #1e293b;  
          --border-color: #334155;  
          --success: #22c55e;  
          --error: #f87171;  
          --warning: #facc15;   
        }  
        body {  
          font-family: 'Cairo', sans-serif;  
          background: var(--bg-color);  
          color: var(--text-color);  
          margin: 0; padding: 0;  
          min-height: 100vh;  
          position: relative;  
        }  
        .container {  
          max-width: 480px;  
          margin: 30px auto;  
          background: rgba(15, 23, 42, 0.96);  
          padding: 25px;  
          border-radius: 15px;  
          box-shadow: 0 0 30px rgba(56,189,248,0.2);  
          position: relative; z-index: 2;  
        }  
        h1 { text-align: center; color: var(--primary); font-size: 24px; }  
        label { display:block; margin:10px 0 5px; font-weight:600; }  
        input {  
          width: 100%; padding: 12px; margin-bottom: 12px;  
          border: 1px solid var(--border-color); border-radius: 8px;  
          background: var(--surface-color); color: var(--text-color);  
        }  
        .info {  
          background: var(--surface-color); padding: 10px; border-radius: 8px;  
          margin-bottom: 12px; text-align: center; font-size: 15px;  
        }  
        #remainingLimitVal { font-weight: 700; color: var(--primary); }  
        button {  
          width: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));  
          color: var(--bg-color); font-weight: 700; padding: 12px; border: none;  
          border-radius: 10px; cursor: pointer; font-size: 17px;  
        }  
        button:disabled { opacity: 0.5; cursor: not-allowed; }  
        
        .history { margin-top: 28px; }  
        table { width: 100%; border-collapse: collapse; background: var(--surface-color); border-radius: 8px; overflow: hidden; }  
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 13px; }  
        th { background: var(--secondary); color: var(--bg-color); }  

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¨Ø© */
        .status-pending { color: var(--warning); }   
        .status-completed { color: var(--success); }  
        .status-rejected { color: var(--error); }  

        /* Ø§Ù„Ù€ Modal */
        #customModal {  
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);  
            display: none; justify-content: center; align-items: center; z-index: 1000;  
        }  
        .modal-content { background: var(--surface-color); padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }  
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; }

        .status-msg { text-align: center; margin-top: 10px; font-weight: 700; display: none; }
        .status-msg.show { display: block; }
    </style>  
</head>  
<body>  
    <div class="container">  
        <h1>ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>  
        <div class="info">  
            Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="pointsVal">0</span> Ù†Ù‚Ø·Ø© â‰ˆ <span id="egpVal">0.00</span> Ø¬Ù…   
            <br>  
            Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ…: <span id="remainingLimitVal">200.00</span> Ø¬Ù… | Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <span id="remainingOpsVal">--</span>  
        </div>  
      
        <label>Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>  
        <input type="text" id="walletVod" placeholder="01xxxxxxxxx" maxlength="11">  
      
        <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 20 Ø¬Ù…)</label>  
        <input type="number" id="amountInp" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">  

        <div class="info">Ø§Ù„ØµØ§ÙÙŠ: <span id="netVal">0.00</span> Ø¬Ù… | Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="needPts">0</span></div>  
      
        <button id="confirmBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>  
        <div id="msg" class="status-msg"></div>  

        <div class="history">  
            <h2 style="font-size: 16px; text-align: center; color: var(--primary);">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</h2>  
            <table>  
                <thead>  
                    <tr>  
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>  
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>  
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>  
                    </tr>  
                </thead>  
                <tbody id="withdrawalsTable"><tr><td colspan="3">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>  
            </table>  
        </div>  
    </div>  

    <div id="customModal">  
        <div class="modal-content">  
            <h3 style="color:var(--warning)">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</h3>  
            <p>Ø³Ø­Ø¨ <span id="modalAmount"></span> Ø¬Ù… Ø¥Ù„Ù‰ <span id="modalWallet"></span>ØŸ</p>  
            <div class="modal-actions">  
                <button id="confirmActionBtn" style="background:var(--success)">ØªØ£ÙƒÙŠØ¯</button>  
                <button id="cancelActionBtn" style="background:var(--border-color); color:white;">Ø¥Ù„ØºØ§Ø¡</button>  
            </div>  
        </div>  
    </div>  

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  
    
    <script>  
        const firebaseConfig = {  
            apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
            authDomain:"am--rewards.firebaseapp.com",  
            projectId:"am--rewards"  
        };  
        firebase.initializeApp(firebaseConfig);  
        const auth = firebase.auth();  
        const db = firebase.firestore();  

        const POINT_VALUE_EGP = 0.07;  
        const LIMITS = { min: 20, maxDaily: 200, maxOpsPerDay: 2 };   

        let userId, currentPoints, todayOpsCount, todayAmountTotal;

        // ØªØ¹Ø±ÙŠØ¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª
        const translateStatus = (status) => {
            const map = { 'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â³', 'completed': 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…', 'rejected': 'Ù…Ø±ÙÙˆØ¶ âŒ' };
            return map[status] || status;
        };

        async function checkDailyLimits() {
            if (!userId) return;
            const start = new Date(); start.setUTCHours(0,0,0,0);
            const snap = await db.collection("withdrawals").where("userId", "==", userId).where("date", ">=", start).get();
            todayOpsCount = 0; todayAmountTotal = 0;
            snap.forEach(doc => { 
                if(doc.data().status !== 'rejected') {
                    todayOpsCount++; todayAmountTotal += (+doc.data().amount);
                }
            });
            document.getElementById('remainingOpsVal').textContent = Math.max(0, LIMITS.maxOpsPerDay - todayOpsCount);
            document.getElementById('remainingLimitVal').textContent = (LIMITS.maxDaily - todayAmountTotal).toFixed(2);
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                checkDailyLimits();
                db.collection('users').doc(userId).onSnapshot(doc => {
                    if (doc.exists) {
                        currentPoints = doc.data().points || 0;
                        document.getElementById('pointsVal').textContent = Math.floor(currentPoints);
                        document.getElementById('egpVal').textContent = (currentPoints * POINT_VALUE_EGP).toFixed(2);
                        updateCalc();
                    }
                });

                db.collection("withdrawals").where("userId", "==", user.uid).orderBy("date", "desc").limit(10).onSnapshot(snap => {
                    const table = document.getElementById('withdrawalsTable');
                    table.innerHTML = "";
                    snap.forEach(doc => {
                        const w = doc.data();
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${w.amount} Ø¬Ù…</td><td class="status-${w.status}">${translateStatus(w.status)}</td><td>${w.date?.toDate().toLocaleDateString('ar-EG')}</td>`;
                        table.appendChild(tr);
                    });
                });
            }
        });

        function updateCalc() {
            const amt = parseFloat(document.getElementById('amountInp').value);
            const wallet = document.getElementById('walletVod').value.trim();
            const ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);
            const remainingAmt = LIMITS.maxDaily - todayAmountTotal;

            if (amt >= LIMITS.min) {
                document.getElementById('netVal').textContent = (amt * 0.9).toFixed(2);
                document.getElementById('needPts').textContent = ptsNeeded;
                document.getElementById('confirmBtn').disabled = !(ptsNeeded <= currentPoints && wallet.length === 11 && amt <= remainingAmt && todayOpsCount < LIMITS.maxOpsPerDay);
            } else { document.getElementById('confirmBtn').disabled = true; }
        }

        document.getElementById('amountInp').oninput = updateCalc;
        document.getElementById('walletVod').oninput = updateCalc;

        document.getElementById('confirmBtn').onclick = () => {
            document.getElementById('modalAmount').textContent = document.getElementById('amountInp').value;
            document.getElementById('modalWallet').textContent = document.getElementById('walletVod').value;
            document.getElementById('customModal').style.display = 'flex';
        };

        document.getElementById('cancelActionBtn').onclick = () => document.getElementById('customModal').style.display = 'none';

        document.getElementById('confirmActionBtn').onclick = async () => {
            document.getElementById('customModal').style.display = 'none';
            const btn = document.getElementById('confirmBtn');
            btn.disabled = true; btn.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
            
            try {
                const idToken = await auth.currentUser.getIdToken();
                const amt = parseFloat(document.getElementById('amountInp').value);
                
                // Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø§ÙØªØ±Ø¶Ù†Ø§ Ø£Ù† Ø§Ù„Ù€ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙŠØ¹Ù…Ù„)
                const response = await fetch('/api/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify({ amount: amt, wallet: document.getElementById('walletVod').value.trim() })
                });

                if (!response.ok) throw new Error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");

                // --- ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ withdrawn Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ ---
                await db.collection('users').doc(userId).update({
                    withdrawn: firebase.firestore.FieldValue.increment(amt)
                });

                document.getElementById('msg').textContent = "âœ… ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­";
                document.getElementById('msg').className = "status-msg show";
                document.getElementById('amountInp').value = "";
                checkDailyLimits();
            } catch (err) {
                document.getElementById('msg').textContent = "âŒ " + err.message;
                document.getElementById('msg').className = "status-msg show";
            } finally {
                btn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨";
                updateCalc();
            }
        };
    </script>
</body>  
</html>
