<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | AM Rewards</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">  
    <style>  
        :root {  
          --neon-cyan: #00f2ff;
          --neon-purple: #7000ff;
          --bg-deep: #020617;
          --glass-bg: rgba(15, 23, 42, 0.7);
          --glass-border: rgba(255, 255, 255, 0.1);
          --success: #22c55e;  
          --error: #f87171;  
          --warning: #facc15;   
          --text-main: #f1f5f9;
        }  

        * { box-sizing: border-box; transition: transform 0.3s ease, box-shadow 0.3s ease; }

        body {  
          font-family: 'Cairo', sans-serif;  
          background: var(--bg-deep);  
          color: var(--text-main);  
          margin: 0; padding: 0;  
          min-height: 100vh;
          background-image: 
            radial-gradient(circle at 0% 0%, rgba(112, 0, 255, 0.15) 0%, transparent 35%),
            radial-gradient(circle at 100% 100%, rgba(0, 242, 255, 0.15) 0%, transparent 35%);
          overflow-x: hidden;  
        }  

        body::after {
          content: ""; position: fixed; inset: 0; z-index: -1;
          background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
          opacity: 0.15; pointer-events: none;
        }

        .container {  
          max-width: 480px;  
          margin: 20px auto;  
          background: var(--glass-bg);  
          padding: 25px;  
          border-radius: 24px;  
          backdrop-filter: blur(20px);
          border: 1px solid var(--glass-border);
          box-shadow: 0 20px 50px rgba(0,0,0,0.5);
          position: relative; z-index: 2;  
        }  

        h1 {  
          text-align: center; margin-bottom: 25px;  
          color: var(--neon-cyan); font-weight: 900;
          text-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
        }  

        .balance-info-card {
            background: linear-gradient(135deg, rgba(112, 0, 255, 0.1), rgba(0, 242, 255, 0.1));
            border-radius: 20px; padding: 20px; border: 1px solid var(--glass-border);
            margin-bottom: 20px; text-align: center;
        }

        .points-large { font-family: 'Montserrat'; font-size: 35px; display: block; color: var(--neon-cyan); }
        .egp-sub { font-size: 18px; color: var(--text-main); opacity: 0.8; }

        .limits-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
        }
        .limit-box {
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; font-size: 12px;
        }
        .limit-box span { display: block; color: var(--neon-cyan); font-weight: 700; font-size: 14px; }

        label { display:block; margin:15px 0 8px; font-weight:700; color: #94a3b8; font-size: 14px; }  
        
        input {  
          width: 100%; padding: 14px; margin-bottom: 5px;  
          border: 1px solid var(--glass-border); border-radius: 12px;  
          background: rgba(0,0,0,0.3); color: #fff;  
          font-size: 16px; outline: none;
        }  
        input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }  
        input.invalid { border-color: var(--error); }  

        .calc-details {
            background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin: 15px 0;
            display: flex; justify-content: space-around; text-align: center; border: 1px dashed var(--glass-border);
        }
        .calc-item b { display: block; font-family: 'Montserrat'; color: var(--neon-purple); }

        .limit-warning {  
            background: rgba(248, 113, 113, 0.1); color: var(--error);  
            padding: 10px; border-radius: 10px; font-weight: 700; font-size: 13px;  
            margin-bottom: 15px; text-align: center; border: 1px solid rgba(248, 113, 113, 0.2);
        }  

        button#confirmBtn {  
          width: 100%; background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan));  
          color: #fff; font-weight: 900; padding: 16px; border: none;  
          border-radius: 16px; cursor: pointer; font-size: 18px;  
          box-shadow: 0 10px 20px rgba(112, 0, 255, 0.3);
        }  
        button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(112, 0, 255, 0.5); }  
        button:disabled { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }  

        .history { margin-top: 35px; }  
        .history h2 { font-size: 18px; color: var(--neon-cyan); text-align: center; margin-bottom: 15px; }  
        
        .table-responsive { border-radius: 15px; overflow: hidden; border: 1px solid var(--glass-border); }  
        table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.2); }  
        th { background: rgba(112, 0, 255, 0.2); color: var(--neon-cyan); padding: 12px; font-size: 13px; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--glass-border); font-size: 13px; }  
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¨Ø© */
        .status-badge { font-weight: bold; }
        .row-pending { color: var(--warning); }
        .row-completed { color: var(--success); }
        .row-rejected { color: var(--error); }

        #customModal {  
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);  
            display: none; justify-content: center; align-items: center; z-index: 1000;  
            backdrop-filter: blur(10px);
        }  
        #customModal.show { display: flex; animation: fadeIn 0.3s ease; }  
        .modal-content {  
            background: var(--bg-deep); padding: 30px; border-radius: 24px;  
            width: 90%; max-width: 380px; text-align: center;  
            border: 1px solid var(--neon-purple); box-shadow: 0 0 50px rgba(112, 0, 255, 0.3);
        }  
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
        #confirmActionBtn { background: var(--success); color: #fff; }
        #cancelActionBtn { background: #334155; color: #fff; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .status-msg { text-align: center; margin-top: 15px; font-weight: 700; padding: 10px; border-radius: 10px; display: none; }
        .status-msg.show { display: block; }
        .status-msg.error { background: rgba(248, 113, 113, 0.1); color: var(--error); }
        .status-msg.success { background: rgba(34, 197, 94, 0.1); color: var(--success); }
    </style>
</head>  
<body>  
    <div class="container">  
        <h1>ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>  
        
        <div class="balance-info-card">  
            <span style="font-size: 14px; opacity: 0.7;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³Ø­Ø¨</span>
            <span class="points-large" id="pointsVal">0</span>
            <span class="egp-sub">â‰ˆ <span id="egpVal">0.00</span> Ø¬.Ù…</span>
            
            <div class="limits-row">
                <div class="limit-box">Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ… <span id="remainingLimitVal">200</span></div>
                <div class="limit-box">Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ¨Ù‚ÙŠØ© <span id="remainingOpsVal">--</span></div>
            </div>
        </div>  
      
        <label>Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>  
        <input type="text" id="walletVod" placeholder="01xxxxxxxxx" maxlength="11" inputmode="numeric">  
          
        <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 20 Ø¬.Ù…)</label>  
        <input type="number" id="amountInp" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù‡Ù†Ø§">  

        <div id="limitWarning" class="limit-warning" style="display:none;"></div>  

        <div class="calc-details">
            <div class="calc-item">Ø§Ù„Ø®ØµÙ… (10%)<b id="feeVal">0.00</b></div>
            <div class="calc-item">ØµØ§ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…<b id="netVal" style="color:var(--neon-cyan)">0.00</b></div>
            <div class="calc-item">Ù†Ù‚Ø§Ø· Ù…Ø·Ù„ÙˆØ¨Ø©<b id="needPts">0</b></div>
        </div>
          
        <button id="confirmBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>  
        <div id="msg" class="status-msg"></div>  
          
        <p style="text-align:center; color:var(--warning); font-size:12px; margin-top: 15px; opacity: 0.8;">  
            âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.  
        </p>  

        <div class="history">  
            <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</h2>  
            <div class="table-responsive">  
                <table>  
                    <thead>  
                        <tr>  
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>  
                            <th>Ø§Ù„ØµØ§ÙÙŠ</th>  
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>  
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>  
                        </tr>  
                    </thead>  
                    <tbody id="withdrawalsTable"><tr><td colspan="4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>  
                </table>  
            </div>  
        </div>  
    </div>  
  
    <div id="customModal">  
        <div class="modal-content">  
            <h3 style="color:var(--neon-cyan)">âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>  
            <div style="text-align: right; font-size: 15px; line-height: 1.8;">  
                <p>Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨: <span id="modalAmount" style="color:var(--neon-purple); font-weight:900;">0.00</span> Ø¬.Ù…</p>  
                <p>Ø§Ù„ØµØ§ÙÙŠ Ù„Ùƒ: <span id="modalNet" style="color:var(--success); font-weight:900;">0.00</span> Ø¬.Ù…</p>  
                <p>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: <span id="modalWallet" style="color:var(--neon-cyan); font-weight:900;"></span></p>  
            </div>  
            <div class="modal-actions">  
                <button id="cancelActionBtn">ØªØ±Ø§Ø¬Ø¹</button>  
                <button id="confirmActionBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¢Ù†</button>  
            </div>  
        </div>  
    </div>  

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  
    
    <script>  
        const firebaseConfig = {  
            apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
            authDomain:"am--rewards.firebaseapp.com",  
            projectId:"am--rewards"  
        };  
        firebase.initializeApp(firebaseConfig);  
        const auth = firebase.auth();  
        const db = firebase.firestore();  

        const POINT_VALUE_EGP = 0.07;  
        const LIMITS = { min: 20, maxDaily: 200, maxOpsPerDay: 2 };   
        const HISTORY_LIMIT = 20;   

        const pointsVal = document.getElementById('pointsVal');  
        const egpVal = document.getElementById('egpVal');  
        const amountInp = document.getElementById('amountInp');  
        const walletVod = document.getElementById('walletVod');  
        const feeVal = document.getElementById('feeVal');  
        const netVal = document.getElementById('netVal');  
        const needPts = document.getElementById('needPts');  
        const msgEl = document.getElementById('msg');  
        const withdrawalsTable = document.getElementById('withdrawalsTable');  
        const confirmBtn = document.getElementById('confirmBtn');  
        const remainingOpsEl = document.getElementById('remainingOpsVal');   
        const remainingLimitEl = document.getElementById('remainingLimitVal');   
        const limitWarningEl = document.getElementById('limitWarning');   
        
        const customModal = document.getElementById('customModal');  
        const modalAmount = document.getElementById('modalAmount');  
        const modalNet = document.getElementById('modalNet');  
        const modalWallet = document.getElementById('modalWallet');  
        const confirmActionBtn = document.getElementById('confirmActionBtn');  
        const cancelActionBtn = document.getElementById('cancelActionBtn');  
        
        let userId = null;  
        let currentPoints = 0;  
        let todayOpsCount = 0;   
        let todayAmountTotal = 0;   

        walletVod.value = localStorage.getItem('lastWallet') || '';  

        function showMsg(text, type = 'success') {  
            msgEl.textContent = text;  
            msgEl.className = `status-msg show ${type}`;  
            setTimeout(() => { msgEl.classList.remove('show'); }, 5000);   
        }  

        // Ø¯Ø§Ù„Ø© ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
        function translateStatus(s) {
            const map = {
                'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â³',
                'completed': 'ØªÙ… Ø§Ù„Ø³Ø­Ø¨ âœ…',
                'rejected': 'Ù…Ø±ÙÙˆØ¶ âŒ'
            };
            return map[s] || s;
        }

        function formatNum(num) {  
            return Number(num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });  
        }  
        
        function formatDate(ts) {  
            if (!ts?.toDate) return "-";   
            const dt = ts.toDate();  
            return `${dt.getDate()}/${dt.getMonth()+1} ${dt.getHours()}:${dt.getMinutes()}`;  
        }  
        
        function validateWallet() {  
            const wallet = walletVod.value.trim();  
            const isValid = wallet.length === 11 && /^\d{11}$/.test(wallet);  
            walletVod.classList.toggle('invalid', !isValid && wallet.length > 0);  
            return isValid;  
        }  

        async function checkDailyLimits() {  
            if (!userId) return;  
            const start = new Date(); start.setUTCHours(0, 0, 0, 0);   
            const todaySnapshot = await db.collection("withdrawals")  
                .where("userId", "==", userId)  
                .where("date", ">=", start)   
                .where("status", "in", ['pending', 'completed'])   
                .get();  
            
            let ops = 0, amt = 0;  
            todaySnapshot.forEach(doc => { ops++; amt += (+doc.data().amount) || 0; });  
            todayOpsCount = ops; todayAmountTotal = amt;   
            
            remainingOpsEl.textContent = Math.max(0, LIMITS.maxOpsPerDay - todayOpsCount);  
            remainingLimitEl.textContent = formatNum(Math.max(0, LIMITS.maxDaily - todayAmountTotal)).replace('.00', '');   
        }  

        auth.onAuthStateChanged(user => {  
            if (user) {  
                userId = user.uid;  
                checkDailyLimits();  
                db.collection('users').doc(userId).onSnapshot(doc => {  
                    if (doc.exists) {  
                        currentPoints = doc.data().points || 0;  
                        pointsVal.textContent = Math.floor(currentPoints).toLocaleString();  
                        egpVal.textContent = formatNum(currentPoints * POINT_VALUE_EGP);  
                        updateCalc();   
                    }  
                });  

                db.collection("withdrawals").where("userId", "==", user.uid)  
                    .orderBy("date", "desc").limit(HISTORY_LIMIT)   
                    .onSnapshot(snapshot => {  
                        withdrawalsTable.innerHTML = "";  
                        if (snapshot.empty) {  
                            withdrawalsTable.innerHTML = `<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨</td></tr>`;  
                            return;  
                        }  
                        snapshot.forEach(doc => {  
                            const w = doc.data();  
                            const tr = document.createElement("tr");  
                            tr.className = `row-${w.status}`;  
                            tr.innerHTML = `
                                <td>${w.amount} Ø¬</td>
                                <td>${w.net} Ø¬</td>
                                <td class="status-badge">${translateStatus(w.status)}</td>
                                <td>${formatDate(w.date)}</td>`;  
                            withdrawalsTable.appendChild(tr);  
                        });  
                    });  
            } else { window.location.href = "index.html"; }  
        });  

        function updateCalc() {  
            const amt = parseFloat(amountInp.value);  
            const isWalletValid = validateWallet();  
            const remainingAmount = LIMITS.maxDaily - todayAmountTotal;   
            const remainingOps = LIMITS.maxOpsPerDay - todayOpsCount;  
            
            limitWarningEl.style.display = 'none';  
            
            if (isNaN(amt) || amt < LIMITS.min) {  
                feeVal.textContent = "0.00"; netVal.textContent = "0.00"; needPts.textContent = "0";  
                confirmBtn.disabled = true;  
            } else {  
                const fee = amt * 0.10; const net = amt - fee;  
                const ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);  
                feeVal.textContent = formatNum(fee);  
                netVal.textContent = formatNum(net);  
                needPts.textContent = ptsNeeded.toLocaleString();  
                
                if (ptsNeeded > currentPoints) {  
                    limitWarningEl.textContent = 'âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ'; limitWarningEl.style.display = 'block';  
                    confirmBtn.disabled = true;  
                } else if (!isWalletValid) {  
                    confirmBtn.disabled = true;  
                } else if (amt > remainingAmount) {  
                    limitWarningEl.textContent = 'âŒ ØªØ¬Ø§ÙˆØ²Øª Ø­Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ'; limitWarningEl.style.display = 'block';  
                    confirmBtn.disabled = true;  
                } else if (remainingOps <= 0) {  
                    limitWarningEl.textContent = 'âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…'; limitWarningEl.style.display = 'block';  
                    confirmBtn.disabled = true;  
                } else { confirmBtn.disabled = false; }  
            }  
        }  

        amountInp.addEventListener('input', updateCalc);  
        walletVod.addEventListener('input', updateCalc);  

        confirmBtn.addEventListener('click', () => {    
            modalAmount.textContent = amountInp.value;  
            modalNet.textContent = netVal.textContent;  
            modalWallet.textContent = walletVod.value;  
            customModal.classList.add('show');  
        });  

        cancelActionBtn.addEventListener('click', () => customModal.classList.remove('show'));  

        confirmActionBtn.addEventListener('click', async () => {  
            customModal.classList.remove('show');  
            confirmBtn.disabled = true;  
            confirmBtn.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";  
            
            try {  
                const amtValue = parseFloat(amountInp.value);
                const idToken = await auth.currentUser.getIdToken();  
                const response = await fetch('/api/withdraw', {  
                    method: 'POST',  
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },  
                    body: JSON.stringify({ amount: amtValue, wallet: walletVod.value.trim() })  
                });  
                const data = await response.json();  
                if (!response.ok) throw new Error(data.message);  

                // --- ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ withdrawn ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
                await db.collection('users').doc(userId).update({
                    withdrawn: firebase.firestore.FieldValue.increment(amtValue)
                });

                localStorage.setItem('lastWallet', walletVod.value);  
                showMsg("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­", "success");  
                amountInp.value = ""; checkDailyLimits();  
            } catch (err) {  
                showMsg(err.message, "error");  
            } finally {  
                confirmBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨";  
                updateCalc();  
            }  
        });  
    </script>
</body>  
</html>
