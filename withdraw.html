<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>طلب سحب الأرباح | Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Cairo', sans-serif;
  background: #0f172a url('https://i.ibb.co/4YV5fB2/bg-dark.jpg') no-repeat center center fixed;
  background-size: cover;
  color: #f1f5f9;
  margin: 0; padding: 0;
}
.container {
  max-width: 480px;
  margin: 30px auto;
  background: rgba(15, 23, 42, 0.9);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 0 20px rgba(0,229,255,0.4);
}
h1 {
  text-align: center;
  margin-bottom: 20px;
  color: #38bdf8;
  font-size: 22px;
}
label { display:block; margin:10px 0 5px; font-weight:600; }
input {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid #334155;
  border-radius: 8px;
  background: #1e293b;
  color: #f1f5f9;
}
input::placeholder { color:#94a3b8; }
.info {
  background: #1e293b;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 12px;
  text-align: center;
  font-size: 15px;
}
button {
  width: 100%;
  background: #38bdf8;
  color: #0f172a;
  font-weight: 700;
  padding: 12px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #0ea5e9; }
.msg { text-align:center; margin-top:10px; font-size:15px; }
.error { color:#f87171; }
.success { color:#22c55e; }

/* جدول السحوبات */
.history {
  margin-top: 25px;
}
.history h2 {
  font-size: 18px;
  margin-bottom: 10px;
  color: #38bdf8;
  text-align: center;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #1e293b;
  border-radius: 8px;
  overflow: hidden;
}
th, td {
  padding: 8px;
  text-align: center;
  border-bottom: 1px solid #334155;
  font-size: 14px;
}
th {
  background: #0ea5e9;
  color: #0f172a;
}

/* الحالات */
.status {
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}
.status-pending { color: orange; }
.status-completed { color: #22c55e; }
.status-rejected { color: #f87171; }
</style>
</head>
<body>

<div class="container">
  <h1>💸 طلب سحب الأرباح</h1>

  <div class="info">رصيدك الحالي: <span id="pointsVal">0</span> نقطة ≈ <span id="egpVal">0.00</span> جم</div>

  <label>رقم محفظة فودافون كاش</label>
  <input type="text" id="walletVod" placeholder="ادخل رقم المحفظة">

  <label>المبلغ المراد سحبه (20 - 200 جنيه)</label>
  <input type="number" id="amountInp" placeholder="ادخل المبلغ">

  <div class="info">الخصم: <span id="feeVal">0.00</span> جم | صافي: <span id="netVal">0.00</span> جم</div>
  <div class="info">النقاط المطلوبة: <span id="needPts">0</span></div>

  <button id="confirmBtn">تأكيد السحب</button>

  <div id="msg" class="msg"></div>

  <!-- سجل السحب -->
  <div class="history">
    <h2>📜 سجل طلبات السحب</h2>
    <table>
      <thead>
        <tr>
          <th>المبلغ</th>
          <th>الصافي</th>
          <th>الحالة</th>
          <th>التاريخ</th>
        </tr>
      </thead>
      <tbody id="withdrawalsTable"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { 
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", 
  authDomain:"am--rewards.firebaseapp.com", 
  projectId:"am--rewards" 
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const POINT_VALUE_EGP = 0.07; // سعر النقطة
const LIMITS = { min:20, maxDaily:200 };

const pointsVal=document.getElementById('pointsVal');
const egpVal=document.getElementById('egpVal');
const amountInp=document.getElementById('amountInp');
const walletVod=document.getElementById('walletVod');
const feeVal=document.getElementById('feeVal');
const netVal=document.getElementById('netVal');
const needPts=document.getElementById('needPts');
const msg=document.getElementById('msg');
const withdrawalsTable=document.getElementById('withdrawalsTable');
const confirmBtn=document.getElementById('confirmBtn');

let userId=null;

auth.onAuthStateChanged(user=>{
  if(user){
    userId=user.uid;
    db.collection('users').doc(userId)
      .onSnapshot(doc=>{
        if(doc.exists){
          const points=doc.data().points||0;
          pointsVal.textContent=points;
          egpVal.textContent=(points*POINT_VALUE_EGP).toFixed(2);
        }
      });

    // متابعة سجل السحب
    db.collection("withdrawals")
      .where("userId","==",user.uid)
      .orderBy("date","desc")
      .onSnapshot(snap=>{
        withdrawalsTable.innerHTML="";
        snap.forEach(d=>{
          const w=d.data();
          const tr=document.createElement("tr");
          const date=w.date?.toDate ? w.date.toDate().toLocaleString("ar-EG") : "-";

          let statusClass="", icon="";
          if(w.status==="pending" || w.status==="معلق") {
            statusClass="status-pending"; icon="⏳";
          } else if(w.status==="completed" || w.status==="مكتمل") {
            statusClass="status-completed"; icon="✅";
          } else if(w.status==="rejected" || w.status==="مرفوض") {
            statusClass="status-rejected"; icon="❌";
          }

          tr.innerHTML=`
            <td>${w.amount} جم</td>
            <td>${w.net.toFixed(2)} جم</td>
            <td class="status ${statusClass}">${icon} ${w.status}</td>
            <td>${date}</td>
          `;
          withdrawalsTable.appendChild(tr);
        });
      });

  } else {
    window.location.href="index.html";
  }
});

function updateCalc(){
  const amt=parseFloat(amountInp.value);
  if(isNaN(amt)||amt<LIMITS.min){
    feeVal.textContent="0.00";
    netVal.textContent="0.00";
    needPts.textContent="0";
    return;
  }
  const fee=amt*0.10;
  const net=amt-fee;
  const ptsNeeded=Math.ceil(amt/POINT_VALUE_EGP);
  feeVal.textContent=fee.toFixed(2);
  netVal.textContent=net.toFixed(2);
  needPts.textContent=ptsNeeded;
}
amountInp.addEventListener('input',updateCalc);

confirmBtn.addEventListener('click',async ()=>{
  msg.textContent=""; msg.className="msg";
  const amt=parseFloat(amountInp.value);
  const wallet=walletVod.value.trim();
  if(isNaN(amt)||amt<LIMITS.min){ msg.textContent="❌ الحد الأدنى للسحب 20 جم"; msg.classList.add("error"); return; }
  if(amt>LIMITS.maxDaily){ msg.textContent="❌ الحد الأقصى 200 جم يومياً"; msg.classList.add("error"); return; }
  if(!wallet){ msg.textContent="❌ أدخل رقم المحفظة"; msg.classList.add("error"); return; }

  // رسالة تأكيد أولى
  const confirmMsg=`هل تريد سحب ${amt} جم إلى المحفظة: ${wallet} ؟`;
  if(!confirm(confirmMsg)) return;

  confirmBtn.disabled=true; // منع التكرار
  const ptsNeeded=Math.ceil(amt/POINT_VALUE_EGP);

  db.runTransaction(async (tr)=>{
    const userRef=db.collection("users").doc(userId);
    const snap=await tr.get(userRef);
    const points=snap.data().points||0;
    if(points<ptsNeeded) throw "رصيد نقاط غير كافٍ";
    tr.update(userRef,{ points: firebase.firestore.FieldValue.increment(-ptsNeeded) });
    tr.set(db.collection("withdrawals").doc(),{
      userId, method:"vodafone", wallet,
      amount:amt, fee:amt*0.10, net:amt-amt*0.10,
      pts:ptsNeeded, status:"معلق",
      date:firebase.firestore.FieldValue.serverTimestamp()
    });
  }).then(()=>{
    msg.textContent="✅ تم إرسال طلب السحب بنجاح. ⏳ المعالجة تستغرق من 30 دقيقة إلى 12 ساعة.";
    msg.classList.add("success");
    amountInp.value=""; walletVod.value="";
    updateCalc();
  }).catch(err=>{
    msg.textContent="❌ "+err;
    msg.classList.add("error");
  }).finally(()=>{
    confirmBtn.disabled=false; // إعادة تفعيل الزر
  });
});
</script>
</body>
    </html>
