<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>سحب الأرباح | AM Rewards</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">  
    <style>  
        :root {  
          --neon-cyan: #00f2ff;
          --neon-purple: #7000ff;
          --bg-deep: #020617;
          --glass: rgba(255, 255, 255, 0.05);
          --glass-border: rgba(255, 255, 255, 0.1);
          --success: #00ff88;  
          --error: #ff4d4d;  
          --warning: #ffcc00;   
        }  

        * { box-sizing: border-box; transition: all 0.3s ease; }
        body {  
          font-family: 'Cairo', sans-serif; background: var(--bg-deep); color: #fff;  
          margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden;
        }

        /* خلفية المجرة المتحركة */
        .space-bg {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0f172a, #020617);
        }
        .space-bg::after {
            content: ""; position: absolute; inset: -50%;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            opacity: 0.15; animation: orbit 120s linear infinite;
        }
        @keyframes orbit { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .container { max-width: 450px; margin: 20px auto; padding: 20px; position: relative; }

        /* بطاقة الرصيد الكبرى */
        .main-card {
            background: linear-gradient(135deg, rgba(112, 0, 255, 0.2), rgba(0, 242, 255, 0.2));
            border-radius: 28px; padding: 30px 20px; border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px); text-align: center; margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4), inset 0 0 20px rgba(255,255,255,0.05);
        }
        .main-card h2 { font-size: 14px; opacity: 0.7; margin-bottom: 10px; letter-spacing: 1px; }
        .balance-glow { 
            font-family: 'Montserrat'; font-size: 42px; font-weight: 900; 
            color: var(--neon-cyan); text-shadow: 0 0 20px rgba(0, 242, 255, 0.5); 
            display: block;
        }

        /* حقول الإدخال */
        .input-group { background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid var(--glass-border); margin-bottom: 20px; }
        label { display: block; font-size: 13px; color: var(--neon-cyan); margin-bottom: 8px; font-weight: 700; }
        input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px; color: #fff; font-size: 16px; outline: none;
        }
        input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0,242,255,0.1); }

        /* شريط العمليات */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; font-size: 12px; text-align: center; border: 1px solid var(--glass-border); }
        .stat-item b { color: var(--neon-purple); display: block; font-size: 14px; }

        /* الأزرار */
        #confirmBtn {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan));
            color: #fff; font-weight: 900; font-size: 18px; cursor: pointer;
            box-shadow: 0 10px 25px rgba(112, 0, 255, 0.3); margin-top: 10px;
        }
        #confirmBtn:disabled { filter: grayscale(1); opacity: 0.3; cursor: not-allowed; transform: scale(0.98); }

        /* السجل */
        .history-section { margin-top: 40px; }
        .history-section h3 { font-size: 16px; color: var(--neon-cyan); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .history-section h3::after { content: ""; flex: 1; height: 1px; background: var(--glass-border); }

        .withdraw-row {
            background: var(--glass); padding: 15px; border-radius: 15px; 
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            border-right: 4px solid transparent;
        }
        .row-pending { border-right-color: var(--warning); }
        .row-completed { border-right-color: var(--success); }
        .row-rejected { border-right-color: var(--error); }

        .amt-info b { display: block; font-size: 16px; font-family: 'Montserrat'; }
        .amt-info span { font-size: 11px; opacity: 0.5; }
        .status-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; background: rgba(255,255,255,0.05); }

        /* Modal */
        #customModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { background: #0f172a; padding: 30px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--neon-purple); }
        .modal-btn { padding: 12px 20px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin: 5px; width: 100%; }

        .status-msg { text-align: center; padding: 10px; font-size: 13px; font-weight: 700; margin-top: 10px; border-radius: 10px; display: none; }
        .status-msg.show { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>  
<body>  
    <div class="space-bg"></div>
    <div class="container">  
        <div class="main-card">
            <h2>الرصيد المتاح للسحب</h2>
            <span class="balance-glow" id="pointsVal">0</span>
            <div class="egp-sub" style="margin-top:5px; opacity:0.8;">≈ <span id="egpVal" style="font-family: 'Montserrat';">0.00</span> ج.م</div>
            
            <div class="stats-grid">
                <div class="stat-item">المتبقي يومياً <b id="remainingLimitVal">200</b></div>
                <div class="stat-item">عمليات متبقية <b id="remainingOpsVal">--</b></div>
            </div>
        </div>

        <div class="input-group">
            <label>رقم محفظة كاش</label>
            <input type="text" id="walletVod" placeholder="01xxxxxxxxx" maxlength="11" inputmode="numeric">
            
            <label style="margin-top:15px;">المبلغ المطلوب (أقل حد 20)</label>
            <input type="number" id="amountInp" placeholder="أدخل المبلغ">
            
            <div id="limitWarning" style="color:var(--error); font-size:12px; margin-top:10px; display:none; font-weight:700;"></div>
        </div>

        <div style="display:flex; justify-content: space-around; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px dashed var(--glass-border);">
            <div style="text-align:center;"><span style="font-size:10px; opacity:0.6;">الصافي</span><b id="netVal" style="display:block; color:var(--success);">0.00</b></div>
            <div style="text-align:center;"><span style="font-size:10px; opacity:0.6;">النقاط</span><b id="needPts" style="display:block; color:var(--neon-cyan);">0</b></div>
        </div>

        <button id="confirmBtn" disabled>تأكيد العملية الآن</button>
        <div id="msg" class="status-msg"></div>

        <div class="history-section">
            <h3>سجل العمليات</h3>
            <div id="withdrawalsList">
                <div style="text-align:center; opacity:0.5; padding:20px;">جارِ جلب البيانات...</div>
            </div>
        </div>
    </div>

    <div id="customModal">  
        <div class="modal-box">  
            <h3 style="color:var(--neon-cyan); margin-top:0;">تأكيد السحب</h3>  
            <p style="font-size:14px; line-height:1.6; color:#cbd5e1;">أنت على وشك سحب مبلغ <b id="modalAmount"></b> ج.م إلى الرقم <b id="modalWallet"></b>. هل البيانات صحيحة؟</p>  
            <button id="confirmActionBtn" class="modal-btn" style="background:var(--success); color:#000;">نعم، متأكد</button>  
            <button id="cancelActionBtn" class="modal-btn" style="background:#1e293b; color:#fff;">تعديل البيانات</button>  
        </div>  
    </div>  

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  
    
    <script>  
        const firebaseConfig = { 
            apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", 
            authDomain:"am--rewards.firebaseapp.com", 
            projectId:"am--rewards" 
        };  
        firebase.initializeApp(firebaseConfig);  
        const auth = firebase.auth();  
        const db = firebase.firestore();  

        const POINT_VALUE_EGP = 0.07;  
        const LIMITS = { min: 20, maxDaily: 200, maxOpsPerDay: 2 };   

        // Elements
        const pointsVal = document.getElementById('pointsVal');
        const amountInp = document.getElementById('amountInp');
        const walletVod = document.getElementById('walletVod');
        const confirmBtn = document.getElementById('confirmBtn');
        const withdrawalsList = document.getElementById('withdrawalsList');
        
        let userId = null;  
        let currentPoints = 0;  
        let todayOpsCount = 0;   
        let todayAmountTotal = 0;

        function showMsg(text, type) {
            const m = document.getElementById('msg');
            m.textContent = text;
            m.className = `status-msg show ${type === 'success' ? 'success' : 'error'}`;
            setTimeout(() => m.classList.remove('show'), 4000);
        }

        // تحويل الحالات للعربية
        const translateStatus = (s) => {
            const map = { 'pending': 'قيد الانتظار', 'completed': 'تم الدفع ✅', 'rejected': 'مرفوض ❌' };
            return map[s] || s;
        };

        async function checkDailyLimits() {
            if (!userId) return;
            const start = new Date(); start.setUTCHours(0,0,0,0);
            const snap = await db.collection("withdrawals").where("userId", "==", userId).where("date", ">=", start).get();
            todayOpsCount = 0; todayAmountTotal = 0;
            snap.forEach(doc => { 
                if(doc.data().status !== 'rejected') {
                    todayOpsCount++; todayAmountTotal += (+doc.data().amount);
                }
            });
            document.getElementById('remainingOpsVal').textContent = Math.max(0, LIMITS.maxOpsPerDay - todayOpsCount);
            document.getElementById('remainingLimitVal').textContent = Math.max(0, LIMITS.maxDaily - todayAmountTotal);
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                checkDailyLimits();
                db.collection('users').doc(userId).onSnapshot(doc => {
                    if (doc.exists) {
                        currentPoints = doc.data().points || 0;
                        pointsVal.textContent = Math.floor(currentPoints).toLocaleString();
                        document.getElementById('egpVal').textContent = (currentPoints * POINT_VALUE_EGP).toFixed(2);
                        updateCalc();
                    }
                });

                db.collection("withdrawals").where("userId", "==", user.uid).orderBy("date", "desc").limit(10).onSnapshot(snap => {
                    withdrawalsList.innerHTML = "";
                    snap.forEach(doc => {
                        const w = doc.data();
                        const div = document.createElement('div');
                        div.className = `withdraw-row row-${w.status}`;
                        div.innerHTML = `
                            <div class="amt-info">
                                <b>${w.amount} ج.م</b>
                                <span>صافي: ${w.net} ج</span>
                            </div>
                            <div class="status-badge">${translateStatus(w.status)}</div>
                        `;
                        withdrawalsList.appendChild(div);
                    });
                });
            } else { window.location.href = "index.html"; }
        });

        function updateCalc() {
            const amt = parseFloat(amountInp.value);
            const wallet = walletVod.value.trim();
            const ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);
            const remainingAmt = LIMITS.maxDaily - todayAmountTotal;

            if (!isNaN(amt) && amt >= LIMITS.min) {
                document.getElementById('netVal').textContent = (amt * 0.9).toFixed(2);
                document.getElementById('needPts').textContent = ptsNeeded.toLocaleString();
                
                const isPossible = ptsNeeded <= currentPoints && wallet.length === 11 && amt <= remainingAmt && todayOpsCount < LIMITS.maxOpsPerDay;
                confirmBtn.disabled = !isPossible;
            } else {
                confirmBtn.disabled = true;
            }
        }

        amountInp.oninput = updateCalc;
        walletVod.oninput = updateCalc;

        confirmBtn.onclick = () => {
            document.getElementById('modalAmount').textContent = amountInp.value;
            document.getElementById('modalWallet').textContent = walletVod.value;
            document.getElementById('customModal').style.display = 'flex';
        };

        document.getElementById('cancelActionBtn').onclick = () => document.getElementById('customModal').style.display = 'none';

        document.getElementById('confirmActionBtn').onclick = async () => {
            document.getElementById('customModal').style.display = 'none';
            confirmBtn.disabled = true;
            confirmBtn.textContent = "جارٍ المعالجة...";
            
            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify({ amount: parseFloat(amountInp.value), wallet: walletVod.value.trim() })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message);

                // --- تحديث حقل withdrawn عند النجاح ---
                const userRef = db.collection('users').doc(userId);
                await userRef.update({
                    totalWithdrawn: firebase.firestore.FieldValue.increment(parseFloat(amountInp.value))
                });

                showMsg("تم إرسال طلبك للمراجعة بنجاح!", "success");
                amountInp.value = ""; checkDailyLimits();
            } catch (err) {
                showMsg(err.message, "error");
            } finally {
                confirmBtn.textContent = "تأكيد العملية الآن";
                updateCalc();
            }
        };
    </script>
</body>  
</html>
