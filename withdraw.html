<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طلب سحب الأرباح</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background-color: #111;
      color: white;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background-color: #1e1e1e;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }
    input, select {
      background-color: #2c2c2c;
      color: white;
    }
    button {
      background-color: #4caf50;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    .note {
      font-size: 14px;
      color: #ccc;
      margin-top: 10px;
    }
    .balance-box {
      background-color: #333;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    .success-msg {
      color: #ffeb3b;
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>💸 طلب سحب الأرباح</h2><div class="balance-box">
  رصيدك الحالي: <strong id="current-balance">0</strong> جنيه
</div>

<label for="method">طريقة الدفع:</label>
<select id="method">
  <option value="vodafone">فودافون كاش</option>
</select>

<label for="phone">رقم المحفظة:</label>
<input type="text" id="phone" placeholder="ادخل رقم فودافون كاش">

<label for="amount">المبلغ المطلوب (جنيه):</label>
<input type="number" id="amount" placeholder="من 15 إلى 150">

<button onclick="submitWithdrawal()">سحب</button>

<div class="note">
  الحد الأدنى: 15 جنيه | الحد الأقصى: 150 جنيه<br>
  يتم خصم 10% إذا تجاوز المبلغ 30 جنيه.<br>
  يمكن السحب 3 مرات يوميًا.
</div>

<div class="success-msg" id="message"></div>

  </div>  <!-- Firebase SDK -->  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  <script>
    const POINT_VALUE_EGP = 0.07;
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userDocRef;
    let currentEGP = 0;
    let currentPoints = 0;

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      userDocRef = db.collection('users').doc(user.uid);
      const doc = await userDocRef.get();
      const data = doc.data();
      const totalPoints = data.points || 0;
      const withdrawn = data.withdrawn || 0;
      const totalEGP = totalPoints * POINT_VALUE_EGP;
      const withdrawnEGP = withdrawn * POINT_VALUE_EGP;
      currentEGP = totalEGP - withdrawnEGP;
      currentPoints = totalPoints;
      document.getElementById('current-balance').textContent = currentEGP.toFixed(2);
    });

    async function submitWithdrawal() {
      const amount = parseFloat(document.getElementById('amount').value);
      const phone = document.getElementById('phone').value;
      const method = document.getElementById('method').value;
      const msg = document.getElementById('message');
      msg.textContent = '';

      if (!amount || amount < 15 || amount > 150) {
        msg.textContent = '❌ المبلغ يجب أن يكون بين 15 و 150 جنيه';
        return;
      }

      if (!phone || phone.length < 10) {
        msg.textContent = '❌ يرجى إدخال رقم صحيح';
        return;
      }

      let finalAmount = amount;
      if (amount > 30) finalAmount *= 0.9;

      const requiredPoints = Math.ceil(finalAmount / POINT_VALUE_EGP);
      if (currentPoints < requiredPoints) {
        msg.textContent = '❌ لا يوجد نقاط كافية للسحب';
        return;
      }

      await userDocRef.update({
        withdrawn: firebase.firestore.FieldValue.increment(requiredPoints),
        points: firebase.firestore.FieldValue.increment(-requiredPoints)
      });

      await db.collection("withdraw_requests").add({
        uid: auth.currentUser.uid,
        phone,
        method,
        amount,
        afterDiscount: finalAmount,
        status: 'جاري المعالجة',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      msg.textContent = '✅ تم إرسال الطلب بنجاح - جاري المعالجة';
      document.getElementById('amount').value = '';
      document.getElementById('phone').value = '';
    }
  </script></body>
  </html>
