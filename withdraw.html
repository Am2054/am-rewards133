<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>طلب سحب الأرباح | Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Cairo', sans-serif;
  background:#121212 url('https://i.ibb.co/4YV5fB2/bg-dark.jpg') no-repeat center center fixed;
  background-size:cover;
  color:#eee;
  margin:0; padding:0;
}
.container {
  max-width:500px;
  margin:50px auto;
  background:rgba(30,30,30,0.95);
  padding:25px;
  border-radius:15px;
  box-shadow:0 0 20px #00e5ff66;
}
h1 { text-align:center; margin-bottom:20px; color:#00e5ff; }
label { display:block; margin:10px 0 5px; }
input, button {
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border:1px solid #333;
  border-radius:8px;
  background:#1f1f1f;
  color:#eee;
  font-weight:600;
}
input::placeholder { color:#aaa; }
.info { display:flex; justify-content:space-between; margin-bottom:10px; }
.info div {
  width:48%;
  background:#222;
  padding:12px;
  border-radius:8px;
  text-align:center;
  box-shadow: inset 0 0 10px #00e5ff33;
}
.msg { color:#ff5252; text-align:center; margin-bottom:10px; }
.ok { color:#10b981; text-align:center; margin-bottom:10px; }
button#confirmBtn { background:#00e5ff; color:#000; font-weight:700; border:none; border-radius:10px; padding:12px; cursor:pointer; transition:0.3s; }
button#confirmBtn:hover { background:#00bcd4; }
</style>
</head>
<body>

<div class="container">
  <h1>💸 طلب سحب الأرباح</h1>

  <div class="info">
    <div>رصيدك: <span id="pointsVal">0</span></div>
    <div>ما يعادل: <span id="egpVal">0.00</span> جم</div>
  </div>

  <label>رقم محفظة فودافون كاش</label>
  <input type="text" id="walletVod" placeholder="ادخل رقم المحفظة">

  <label>المبلغ المراد سحبه (20 - 200 جنيه)</label>
  <input type="number" id="amountInp" placeholder="ادخل المبلغ">

  <div class="info">
    <div>الخصم: <span id="feeVal">0.00</span> جم</div>
    <div>صافي المبلغ: <span id="netVal">0.00</span> جم</div>
  </div>
  <div>النقاط المطلوبة: <span id="needPts">0</span></div>

  <button id="confirmBtn">تأكيد السحب</button>

  <div class="msg" id="msg"></div>
  <div class="ok" id="ok"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { 
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", 
  authDomain:"am--rewards.firebaseapp.com", 
  projectId:"am--rewards" 
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const POINT_VALUE_EGP = 0.07;
const LIMITS = { min:20, maxDaily:200, maxCount:3 };

const pointsVal=document.getElementById('pointsVal');
const egpVal=document.getElementById('egpVal');
const amountInp=document.getElementById('amountInp');
const walletVod=document.getElementById('walletVod');
const feeVal=document.getElementById('feeVal');
const netVal=document.getElementById('netVal');
const needPts=document.getElementById('needPts');
const msg=document.getElementById('msg');
const ok=document.getElementById('ok');

let userId=null;
let userData=null;

auth.onAuthStateChanged(user=>{
  if(user){
    userId=user.uid;
    db.collection('users').doc(userId).get().then(doc=>{
      if(doc.exists){
        userData=doc.data();
        updateDisplay();
      }
    });
  } else {
    msg.textContent='يرجى تسجيل الدخول أولاً.'; msg.style.display='block';
  }
});

function updateDisplay(){
  if(!userData) return;
  const points=userData.points||0;
  pointsVal.textContent=points;
  egpVal.textContent=(points*POINT_VALUE_EGP).toFixed(2);

  const amt=parseFloat(amountInp.value);
  if(isNaN(amt)||amt<LIMITS.min){
    feeVal.textContent='0.00';
    netVal.textContent='0.00';
    needPts.textContent='0';
    return;
  }
  const fee=amt*0.10;
  const net=amt-fee;
  const neededPoints=Math.ceil(amt/POINT_VALUE_EGP);
  feeVal.textContent=fee.toFixed(2);
  netVal.textContent=net.toFixed(2);
  needPts.textContent=neededPoints;
}
amountInp.addEventListener('input',updateDisplay);

document.getElementById('confirmBtn').addEventListener('click',()=>{
  msg.textContent=''; ok.textContent='';
  if(!userData){ msg.textContent='يرجى تسجيل الدخول.'; return; }

  const amt=parseFloat(amountInp.value);
  const wallet=walletVod.value.trim();
  if(isNaN(amt)||amt<LIMITS.min){ msg.textContent='الحد الأدنى للسحب 20 جنيه.'; return; }
  if(amt>LIMITS.maxDaily){ msg.textContent='الحد الأقصى للسحب 200 جنيه يومياً.'; return; }
  if(!wallet){ msg.textContent='من فضلك أدخل رقم المحفظة.'; return; }

  const ptsUsed=Math.ceil(amt/POINT_VALUE_EGP);
  if((userData.points||0)<ptsUsed){ msg.textContent='رصيد نقاطك غير كافٍ.'; return; }

  const withdrawalData={
    method:"vodafone",
    amount:amt,
    fee:amt*0.10,
    net:amt-amt*0.10,
    pts:ptsUsed,
    wallet,
    userId,
    status:"pending",
    date:firebase.firestore.FieldValue.serverTimestamp()
  };

  const userRef=db.collection('users').doc(userId);
  const withdrawalsRef=db.collection('withdrawals');

  db.runTransaction(async (transaction)=>{
    const userSnap=await transaction.get(userRef);
    const currentPts=userSnap.data().points||0;
    if(currentPts<ptsUsed) throw "رصيدك غير كافٍ";

    transaction.update(userRef,{ points: firebase.firestore.FieldValue.increment(-ptsUsed) });
    transaction.set(withdrawalsRef.doc(), withdrawalData);
  }).then(()=>{
    ok.textContent='✅ تم تقديم طلب السحب بنجاح';
    amountInp.value=''; walletVod.value='';
    updateDisplay();
  }).catch(err=>{
    console.error(err);
    msg.textContent="خطأ: "+err;
  });
});
</script>
</body>
  </html>
