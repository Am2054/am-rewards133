<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>طلب سحب الأرباح | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#9aa4b2; --text:#e8eef6;
      --brand:#10b981; --brand-2:#22d3ee; --danger:#ef4444; --accent:#6366f1;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Cairo',sans-serif;
      background:radial-gradient(1000px 500px at 80% -20%, #0f172a33, transparent),
                 linear-gradient(180deg,#0b0f14,#0a121a);
      color:var(--text); min-height:100vh; padding:24px;
    }
    .wrap{max-width:720px; margin:0 auto}
    .card{
      background:linear-gradient(180deg,#0f1621,#0e141d);
      border:1px solid #243140; box-shadow:0 10px 40px rgba(0,0,0,.4);
      border-radius:18px; padding:22px;
    }
    h1{margin:0 0 12px; font-size:26px; font-weight:800}
    .sub{color:var(--muted); margin-bottom:16px}
    .alert{
      background:var(--warning); padding:12px; border-radius:8px; margin-bottom:16px;
      color:#000; font-weight:700; font-size:14px;
    }
    .status{
      margin-top:14px; font-size:15px; padding:10px; border-radius:8px;
      text-align:center;
    }
    .status.pending{background:#2196f3;}
    .status.paid{background:#4caf50;}
    .balance{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px}
    .pill{background:#0c121a; border:1px solid #1f2a36; border-radius:14px; padding:14px}
    .pill .label{color:var(--muted); font-size:14px}
    .pill .val{font-weight:800; font-size:20px; margin-top:4px}
    label{display:block; margin:12px 0 6px; font-weight:700}
    input, select, .chip{width:100%; padding:12px; margin-top:6px; border-radius:8px;
      border:1px solid #233140; background:#0b1219; color:var(--text); font-size:15px;}
    .chip{border-style:dashed; margin-top:14px;}
    .divider{height:1px; background:#1e2a38; margin:18px 0}
    button{
      width:100%; padding:14px; border:none; border-radius:12px;
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      color:#001e1b; font-weight:900; font-size:16px;
      cursor:pointer; box-shadow:0 8px 20px rgba(16,185,129,.25);
      transition:transform .08s ease;
    }
    button:active{transform:translateY(2px)}
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:50}
    .modal.show{display:grid}
    .modal .inner{background:var(--panel); border-radius:12px; padding:18px; width:90%; max-width:480px}
    .modal h3{margin-bottom:10px}
    .modal p{margin:6px 0; color:var(--muted)}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    .error{color:var(--danger); font-size:14px; margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>💸 طلب سحب الأرباح</h1>
      <div class="sub">نخصم 10% رسوم خدمة، وتُعالج الطلبات خلال 0–24 ساعة.</div>
      
      <!-- إنذار زمني -->
      <div class="alert">⏳ ملاحظة: عملية السحب تستغرق من 0 إلى 24 ساعة للمراجعة.</div>
      
      <!-- الحالة الافتراضية -->
      <div id="reqStatus" class="status pending" style="display:none;">جاري المعالجة...</div>

      <!-- الرصيد -->
      <div class="balance">
        <div class="pill">
          <div class="label">رصيدك بالنقاط</div>
          <div class="val" id="pointsVal">0</div>
        </div>
        <div class="pill">
          <div class="label">ما يعادله (جنيه / دولار)</div>
          <div class="val"><span id="egpVal">0</span> جم · <span id="usdVal">0</span> $</div>
          <div class="help">سعر الدولار: <span id="usdRate">—</span> جم</div>
        </div>
      </div>

      <!-- نموذج السحب -->
      <label for="method">طريقة الدفع</label>
      <select id="method">
        <option value="vodafone">فودافون كاش (EGP)</option>
        <option value="paypal">PayPal (USD)</option>
      </select>
      <label for="amount">المبلغ المطلوب</label>
      <input type="number" id="amount" step="0.01" placeholder="EGP أو $">
      <div class="help" id="limitsHelp">الحدود حسب الطريقة.</div>
      
      <div id="box-vodafone" class="method-box show">
        <label for="wallet">رقم محفظة فودافون</label>
        <input type="text" id="wallet" placeholder="01xxxxxxxxx">
      </div>
      <div id="box-paypal" class="method-box">
        <label for="paypalEmail">بريد PayPal</label>
        <input type="email" id="paypalEmail" placeholder="example@email.com">
      </div>

      <div class="chip">رسوم 10%: <span id="feeVal">0</span></div>
      <div class="chip">سيصلك: <span id="netVal">0</span></div>
      <div class="chip">النقاط المطلوبة: <span id="needPts">0</span></div>

      <div class="divider"></div>

      <!-- الطلبات المتبقية -->
      <div class="grid-2">
        <div class="pill">
          <div class="label">طلبات اليوم المتبقية</div>
          <div class="val" id="leftCount">—</div>
        </div>
        <div class="pill">
          <div class="label">المبلغ المتبقي اليوم</div>
          <div class="val" id="leftCap">—</div>
        </div>
      </div>

      <div id="msg" class="error" style="display:none;"></div>
      <button onclick="openConfirm()">إرسال الطلب</button>

      <div class="note">
        • الحد الأدنى: 20 جم (فودافون) – $0.50 (PayPal).<br>
        • الحد الأقصى يوميًا: 150 جم / 3$.
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal" id="confirmModal">
    <div class="inner">
      <h3>تأكيد السحب</h3>
      <p>راجع المعلومات قبل الإرسال:</p>
      <p>الطريقة: <strong id="c_method">—</strong></p>
      <p>المبلغ: <strong id="c_gross">—</strong></p>
      <p>الخصم 10%: <strong id="c_fee">—</strong></p>
      <p>تصل إليك: <strong id="c_net">—</strong></p>
      <p>النقاط المطلوبة: <strong id="c_pts">—</strong></p>
      <div class="grid-2">
        <button class="danger" onclick="closeConfirm()">رجوع</button>
        <button onclick="submitWithdrawal()">تأكيد وارسال</button>
      </div>
    </div>
  </div>

  <!-- سكربت Firebase & JS -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const POINT_VALUE_EGP = 0.07;
    const LIMITS = {
      vodafone: {min:20, maxDaily:150, maxCount:3, currency:'EGP',label:'فودافون'},
      paypal: {min:0.5, maxDaily:3, maxCount:3, currency:'USD',label:'PayPal'}
    };
    const firebaseConfig = {
      apiKey: "...", authDomain: "am--rewards.firebaseapp.com", projectId: "am--rewards"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    // DOM elements...
    const statusDiv = document.getElementById('reqStatus');
    // (plus other elements as in your original script)

    let usdRate = null, userRef, userData=null, todayStats={vodafone:{count:0,total:0},paypal:{count:0,total:0}};

    function fmt(n){return (Math.round((+n||0)*100)/100).toFixed(2);}
    function pointsToEGP(pts){return pts*POINT_VALUE_EGP;}
    function egpToPoints(egp){return Math.ceil((+egp||0)/POINT_VALUE_EGP);}
    function showError(msg){ msgDiv.textContent=msg; msgDiv.style.display='block'; }
    function hideError(){ msgDiv.style.display='none'; }

    async function fetchUsdRate(){ try{
      const resp=await fetch('https://api.exchangerate.host/latest?base=USD&symbols=EGP');
      const data=await resp.json(); usdRate=data.rates.EGP||null;
      document.getElementById('usdRate').textContent=usdRate?fmt(usdRate):'—';
      updateBalances();
    }catch(e){ document.getElementById('usdRate').textContent='تعذر التحديث'; }}

    function updateBalances(){
      if(!userData) return;
      const pts=Number(userData.points||0);
      document.getElementById('pointsVal').textContent=pts+'';
      const egp=pointsToEGP(pts);
      document.getElementById('egpVal').textContent=fmt(egp);
      document.getElementById('usdVal').textContent= usdRate?fmt(egp/usdRate):'—';
    }

    async function loadLatestRequestStatus(uid){
      const snap = await db.collection('withdraw_requests')
        .where('uid','==',uid)
        .orderBy('createdAt','desc')
        .limit(1)
        .get();
      if(snap.empty){
        statusDiv.style.display='none';
        return;
      }
      const st = snap.docs[0].data().status;
      statusDiv.style.display='block';
      statusDiv.textContent = st==='تم الدفع'?'تم الدفع':'جاري المعالجة...';
      statusDiv.className = 'status ' + (st==='تم الدفع'?'paid':'pending');
    }

    // Rest of your JS logic (switchMethodUI, calc, openConfirm, submitWithdrawal, etc.),
    // plus call to loadLatestRequestStatus(user.uid) after auth success.

    auth.onAuthStateChanged(async user=>{
      if(!user) return window.location.href='login.html';
      userRef = db.collection('users').doc(user.uid);
      const snap = await userRef.get(); userData=snap.data();
      updateBalances();
      await fetchUsdRate();
      await loadLatestRequestStatus(user.uid);
      // also loadTodayStats(), switchMethodUI(), calc(), etc.
    });

    // And in submitWithdrawal(), after adding request to Firestore,
    // call loadLatestRequestStatus(user.uid) to refresh status immediately.

  </script>
</body>
  </html> 
