<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | AM Rewards</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">  
    <style>  
        :root {  
          --neon-cyan: #00f2ff; --neon-purple: #7000ff; --bg-deep: #020617;  
          --glass-bg: rgba(15, 23, 42, 0.7); --glass-border: rgba(255, 255, 255, 0.1);  
          --success: #22c55e; --error: #f87171; --warning: #facc15; --text-main: #f1f5f9;  
        }  
        * { box-sizing: border-box; transition: transform 0.3s ease, box-shadow 0.3s ease; }  
        body {  
          font-family: 'Cairo', sans-serif; background: var(--bg-deep); color: var(--text-main);  
          margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden;  
          background-image: radial-gradient(circle at 0% 0%, rgba(112, 0, 255, 0.15) 0%, transparent 35%), radial-gradient(circle at 100% 100%, rgba(0, 242, 255, 0.15) 0%, transparent 35%);  
        }  
        body::after { content: ""; position: fixed; inset: 0; z-index: -1; background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.15; }  
        .container { max-width: 480px; margin: 20px auto; background: var(--glass-bg); padding: 25px; border-radius: 24px; backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; z-index: 2; }  
        h1 { text-align: center; margin-bottom: 25px; color: var(--neon-cyan); font-weight: 900; text-shadow: 0 0 15px rgba(0, 242, 255, 0.4); }  
        .balance-info-card { background: linear-gradient(135deg, rgba(112, 0, 255, 0.1), rgba(0, 242, 255, 0.1)); border-radius: 20px; padding: 20px; border: 1px solid var(--glass-border); margin-bottom: 20px; text-align: center; }  
        .points-large { font-family: 'Montserrat'; font-size: 35px; display: block; color: var(--neon-cyan); }  
        .limits-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }  
        .limit-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; font-size: 11px; }  
        .limit-box span { display: block; color: var(--neon-cyan); font-weight: 700; font-size: 14px; }  
        label { display:block; margin:15px 0 8px; font-weight:700; color: #94a3b8; font-size: 13px; }  
        input { width: 100%; padding: 14px; margin-bottom: 5px; border: 1px solid var(--glass-border); border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; outline: none; }  
        input:focus { border-color: var(--neon-cyan); }  
        .calc-details { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin: 15px 0; display: flex; justify-content: space-around; text-align: center; border: 1px dashed var(--glass-border); }  
        .calc-item b { display: block; font-family: 'Montserrat'; color: var(--neon-purple); }  
        #confirmBtn { width: 100%; background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan)); color: #fff; font-weight: 900; padding: 16px; border: none; border-radius: 16px; cursor: pointer; font-size: 18px; box-shadow: 0 10px 20px rgba(112, 0, 255, 0.3); }  
        #confirmBtn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }  
        .history { margin-top: 35px; }  
        .table-responsive { border-radius: 15px; overflow: hidden; border: 1px solid var(--glass-border); }  
        table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.2); }  
        th { background: rgba(112, 0, 255, 0.2); color: var(--neon-cyan); padding: 12px; font-size: 11px; }  
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--glass-border); font-size: 11px; }  
        .row-pending { color: var(--warning); } .row-completed { color: var(--success); } .row-rejected { color: var(--error); }  
        #customModal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(10px); }  
        .modal-content { background: var(--bg-deep); padding: 30px; border-radius: 24px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--neon-purple); }  
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }  
        .modal-actions button { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }  
        #confirmActionBtn { background: var(--success); color: #fff; }  
        #cancelActionBtn { background: #334155; color: #fff; }  
        .status-msg { text-align: center; margin-top: 15px; font-weight: 700; padding: 10px; border-radius: 10px; display: none; }  
        .status-msg.show { display: block; }  
    </style>  
</head>  
<body>  
    <div class="container">  
        <h1>ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>  
        <div class="balance-info-card">  
            <span style="font-size: 13px; opacity: 0.7;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>  
            <span class="points-large" id="pointsVal">0</span>  
            <span style="font-size:16px;">â‰ˆ <span id="egpVal">0.00</span> Ø¬.Ù…</span>  
            <div class="limits-row">  
                <div class="limit-box">Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ… <span id="remainingLimitVal">200</span></div>  
                <div class="limit-box">Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ¨Ù‚ÙŠØ© <span id="remainingOpsVal">--</span></div>  
            </div>  
        </div>  
        <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´)</label>  
        <input type="text" id="walletVod" placeholder="01xxxxxxxxx" maxlength="11">  
        <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 20 Ø¬.Ù…)</label>  
        <input type="number" id="amountInp" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">  
        <div id="limitWarning" style="color:var(--error); font-size:12px; text-align:center; display:none; margin-top:10px;"></div>  
        <div class="calc-details">  
            <div class="calc-item">Ø§Ù„Ø®ØµÙ… (10%)<b id="feeVal">0.00</b></div>  
            <div class="calc-item">Ø§Ù„ØµØ§ÙÙŠ<b id="netVal" style="color:var(--neon-cyan)">0.00</b></div>  
            <div class="calc-item">Ø§Ù„Ù†Ù‚Ø§Ø·<b id="needPts">0</b></div>  
        </div>  
        <button id="confirmBtn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>  
        <div id="msg" class="status-msg"></div>  
        <div class="history">  
            <h2 style="font-size:16px; text-align:center; color:var(--neon-cyan);">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>  
            <div class="table-responsive">  
                <table>  
                    <thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>  
                    <tbody id="withdrawalsTable"><tr><td colspan="4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>  
                </table>  
            </div>  
        </div>  
    </div>  

    <div id="customModal">  
        <div class="modal-content">  
            <h3 style="color:var(--neon-cyan)">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</h3>  
            <p style="font-size:14px;">Ø³ÙŠØªÙ… Ø³Ø­Ø¨ <span id="modalAmount"></span> Ø¬.Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… <br><b id="modalWallet" style="color:var(--neon-purple)"></b></p>  
            <div class="modal-actions">  
                <button id="cancelActionBtn">ØªØ¹Ø¯ÙŠÙ„</button>  
                <button id="confirmActionBtn">ØªØ£ÙƒÙŠØ¯</button>  
            </div>  
        </div>  
    </div>  

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  
    
    <script>  
        const firebaseConfig = { apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", authDomain: "am--rewards.firebaseapp.com", projectId: "am--rewards" };  
        firebase.initializeApp(firebaseConfig);  
        const auth = firebase.auth(); const db = firebase.firestore();  
        const POINT_VALUE = 0.07; const LIMITS = { min: 20, maxDaily: 200, maxOps: 2 };  

        let userId, currentPoints, todayOps = 0, todayAmt = 0;  
        const translateStatus = (s) => ({ 'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â³', 'completed': 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…', 'rejected': 'Ù…Ø±ÙÙˆØ¶ âŒ' }[s] || s);  

        async function checkLimits() {  
            if (!userId) return;  
            const start = new Date(); start.setUTCHours(0,0,0,0);  
            const snap = await db.collection("withdrawals").where("userId", "==", userId).where("date", ">=", start).get();  
            todayOps = 0; todayAmt = 0;  
            snap.forEach(doc => { if(doc.data().status !== 'rejected') { todayOps++; todayAmt += doc.data().amount; } });  
            document.getElementById('remainingOpsVal').textContent = Math.max(0, LIMITS.maxOps - todayOps);  
            document.getElementById('remainingLimitVal').textContent = Math.max(0, LIMITS.maxDaily - todayAmt).toFixed(2);  
        }  

        auth.onAuthStateChanged(user => {  
            if (user) {  
                userId = user.uid; checkLimits();  
                db.collection('users').doc(userId).onSnapshot(doc => {  
                    if (doc.exists) {  
                        currentPoints = doc.data().points || 0;  
                        document.getElementById('pointsVal').textContent = Math.floor(currentPoints).toLocaleString();  
                        document.getElementById('egpVal').textContent = (currentPoints * POINT_VALUE).toFixed(2);  
                        updateCalc();  
                    }  
                });  
                db.collection("withdrawals").where("userId", "==", userId).orderBy("date", "desc").limit(10).onSnapshot(snap => {  
                    const table = document.getElementById('withdrawalsTable'); table.innerHTML = "";  
                    snap.forEach(doc => {  
                        const w = doc.data(); const tr = document.createElement('tr'); tr.className = `row-${w.status}`;  
                        tr.innerHTML = `
                            <td>${w.amount} Ø¬</td>
                            <td style="color:var(--neon-cyan)">${w.net ? w.net.toFixed(2) : '--'} Ø¬</td>
                            <td>${translateStatus(w.status)}</td>
                            <td>${w.date?.toDate().toLocaleDateString('ar-EG')}</td>
                        `;  
                        table.appendChild(tr);  
                    });  
                });  
            } else { window.location.href = "login.html"; }  
        });  

        function updateCalc() {  
            const amtInp = document.getElementById('amountInp').value;
            const amt = parseFloat(amtInp);  
            const wallet = document.getElementById('walletVod').value.trim();  
            const warning = document.getElementById('limitWarning');  
            warning.style.display = 'none';  

            if (amtInp && amt >= LIMITS.min) {  
                const ptsNeeded = Math.ceil(amt / POINT_VALUE);  
                document.getElementById('feeVal').textContent = (amt * 0.1).toFixed(2);  
                document.getElementById('netVal').textContent = (amt * 0.9).toFixed(2);  
                document.getElementById('needPts').textContent = ptsNeeded.toLocaleString();  
                
                const canSubmit = ptsNeeded <= currentPoints && wallet.length === 11 && (todayAmt + amt) <= LIMITS.maxDaily && todayOps < LIMITS.maxOps;  
                document.getElementById('confirmBtn').disabled = !canSubmit;  
                if (ptsNeeded > currentPoints) { warning.textContent = "âš ï¸ Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø§ ØªÙƒÙÙŠ"; warning.style.display = "block"; }  
            } else {   
                document.getElementById('feeVal').textContent = "0.00";
                document.getElementById('netVal').textContent = "0.00";
                document.getElementById('needPts').textContent = "0";
                document.getElementById('confirmBtn').disabled = true; 
            }  
        }  

        document.getElementById('amountInp').oninput = updateCalc;  
        document.getElementById('walletVod').oninput = updateCalc;  

        document.getElementById('confirmBtn').onclick = () => {  
            document.getElementById('modalAmount').textContent = document.getElementById('amountInp').value;  
            document.getElementById('modalWallet').textContent = document.getElementById('walletVod').value;  
            document.getElementById('customModal').style.display = 'flex';  
        };  

        document.getElementById('cancelActionBtn').onclick = () => document.getElementById('customModal').style.display = 'none';  

        document.getElementById('confirmActionBtn').onclick = async () => {  
            document.getElementById('customModal').style.display = 'none';  
            const btn = document.getElementById('confirmBtn'); btn.disabled = true; btn.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";  
            try {  
                const idToken = await auth.currentUser.getIdToken();  
                const response = await fetch('/api/withdraw', { 
                    method: 'POST',  
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },  
                    body: JSON.stringify({ amount: parseFloat(document.getElementById('amountInp').value), wallet: document.getElementById('walletVod').value.trim() })  
                });  
                const data = await response.json();  
                if (!response.ok) throw new Error(data.message);  
                
                document.getElementById('msg').textContent = "âœ… " + data.message;  
                document.getElementById('msg').className = "status-msg show success";  
                document.getElementById('amountInp').value = ""; checkLimits();  
            } catch (err) {  
                document.getElementById('msg').textContent = "âŒ " + err.message;  
                document.getElementById('msg').className = "status-msg show error";  
            } finally { btn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨"; updateCalc(); }  
        };  
    </script>  
</body>  
</html>
