<!DOCTYPE html>  <html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | Am Rewards</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">  
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ */
        :root { --bg-color: #0f172a; --primary: #38bdf8; --secondary: #0ea5e9; --text-color: #f1f5f9; --surface-color: #1e293b; --border-color: #334155; --success: #22c55e; --error: #f87171; --warning: #facc15; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; min-height: 100vh; position: relative; overflow-x: hidden; }
        .container { max-width: 480px; margin: 30px auto; background: rgba(15, 23, 42, 0.96); padding: 25px; border-radius: 15px; box-shadow: 0 0 30px rgba(56,189,248,0.35); position: relative; z-index: 2; }
        input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--surface-color); color: var(--text-color); }
        .info { background: var(--surface-color); padding: 10px; border-radius: 8px; margin-bottom: 12px; text-align: center; font-size: 15px; }
        .status-msg { text-align: center; margin-top: 10px; font-size: 15px; font-weight: 700; opacity: 0; transition: 0.3s; }
        .status-msg.show { opacity: 1; }
        button { width: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); color: var(--bg-color); font-weight: 700; padding: 12px; border: none; border-radius: 10px; cursor: pointer; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; background: var(--surface-color); }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        /* Modal Style */
        #customModal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #customModal.show { display: flex; }
        .modal-content { background: var(--surface-color); padding: 30px; border-radius: 15px; max-width: 350px; text-align: center; }
    </style>
</head>  
<body>  
    <div class="container">  
        <h1>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>  
        <div class="info">
            Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="pointsVal">0</span> Ù†Ù‚Ø·Ø© â‰ˆ <span id="egpVal">0.00</span> Ø¬Ù…   
            <br>  
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ…: <span id="remainingLimitVal">200.00</span> Ø¬Ù… | Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="remainingOpsVal">--</span>
        </div>  
      
        <label>Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>  
        <input type="text" id="walletVod" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (11 Ø±Ù‚Ù…)" maxlength="11">  
      
        <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡</label>  
        <input type="number" id="amountInp" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 20 Ø¬Ù…">  

        <div id="limitWarning" class="status-msg error" style="display:none; opacity:1; margin-bottom:10px;"></div>

        <div class="info">Ø§Ù„Ø®ØµÙ… (10%): <span id="feeVal">0.00</span> Ø¬Ù… | Ø§Ù„ØµØ§ÙÙŠ: <span id="netVal">0.00</span> Ø¬Ù…</div>  
        
        <button id="confirmBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>  
        <div id="msg" class="status-msg"></div>  

        <div class="history">  
            <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</h2>  
            <table>  
                <thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>  
                <tbody id="withdrawalsTable"></tbody>  
            </table>  
        </div>  
    </div>  

    <div id="customModal">  
        <div class="modal-content">  
            <h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</h3>  
            <p>Ø§Ù„Ù…Ø¨Ù„Øº: <span id="modalAmount"></span> Ø¬Ù…</p>  
            <p>Ø§Ù„ØµØ§ÙÙŠ: <span id="modalNet"></span> Ø¬Ù…</p>  
            <p>Ø§Ù„Ù…Ø­ÙØ¸Ø©: <span id="modalWallet"></span></p>  
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="cancelActionBtn" style="background:#475569">Ø¥Ù„ØºØ§Ø¡</button>  
                <button id="confirmActionBtn" style="background:var(--success)">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>  
    </div>  

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  
  
    <script>  
        const firebaseConfig = { apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", authDomain:"am--rewards.firebaseapp.com", projectId:"am--rewards" };  
        firebase.initializeApp(firebaseConfig);  
        const auth = firebase.auth();  
        const db = firebase.firestore();  

        const POINT_VALUE_EGP = 0.07;  
        const LIMITS = { min: 20, maxDaily: 200, maxOpsPerDay: 2 };   

        const pointsVal = document.getElementById('pointsVal'), egpVal = document.getElementById('egpVal'), amountInp = document.getElementById('amountInp'), walletVod = document.getElementById('walletVod'), feeVal = document.getElementById('feeVal'), netVal = document.getElementById('netVal'), msgEl = document.getElementById('msg'), withdrawalsTable = document.getElementById('withdrawalsTable'), confirmBtn = document.getElementById('confirmBtn'), remainingOpsEl = document.getElementById('remainingOpsVal'), remainingLimitEl = document.getElementById('remainingLimitVal'), limitWarningEl = document.getElementById('limitWarning');
        const customModal = document.getElementById('customModal'), modalAmount = document.getElementById('modalAmount'), modalNet = document.getElementById('modalNet'), modalWallet = document.getElementById('modalWallet'), confirmActionBtn = document.getElementById('confirmActionBtn'), cancelActionBtn = document.getElementById('cancelActionBtn');

        let userId = null, currentPoints = 0, todayOpsCount = 0, todayAmountTotal = 0;

        function showMsg(text, type = 'success') {  
            msgEl.textContent = text;  
            msgEl.className = `status-msg show ${type === 'success' ? 'success' : 'error'}`;  
            setTimeout(() => msgEl.classList.remove('show'), 5000);   
        }  

        async function checkDailyLimits() {  
            if (!userId) return;  
            const start = new Date(); start.setUTCHours(0, 0, 0, 0);   
            const snap = await db.collection("withdrawals").where("userId", "==", userId).where("date", ">=", start).where("status", "in", ['pending', 'completed']).get();  
            let ops = 0, amt = 0; snap.forEach(doc => { ops++; amt += (+doc.data().amount) || 0; });  
            todayOpsCount = ops; todayAmountTotal = amt;   
            remainingOpsEl.textContent = Math.max(0, LIMITS.maxOpsPerDay - ops);  
            remainingLimitEl.textContent = (LIMITS.maxDaily - amt).toFixed(2);  
        }  

        auth.onAuthStateChanged(user => {  
            if (user) {  
                userId = user.uid; checkDailyLimits();  
                db.collection('users').doc(userId).onSnapshot(d => { if(d.exists){ currentPoints = d.data().points || 0; pointsVal.textContent = currentPoints; egpVal.textContent = (currentPoints * POINT_VALUE_EGP).toFixed(2); updateCalc(); } });  
                db.collection("withdrawals").where("userId", "==", user.uid).orderBy("date", "desc").limit(20).onSnapshot(s => {  
                    withdrawalsTable.innerHTML = s.empty ? "<tr><td colspan='4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>" : "";  
                    s.forEach(doc => {  
                        const w = doc.data();  
                        withdrawalsTable.innerHTML += `<tr><td>${w.amount} Ø¬Ù…</td><td>${w.net.toFixed(2)} Ø¬Ù…</td><td>${w.status}</td><td>${w.date ? w.date.toDate().toLocaleDateString('ar-EG') : '-'}</td></tr>`;  
                    });  
                });  
            } else { window.location.href = "login.html"; }  
        });  

        function updateCalc() {  
            const amt = parseFloat(amountInp.value) || 0;  
            const wallet = walletVod.value.trim();  
            const ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);  
            const remainingAmt = LIMITS.maxDaily - todayAmountTotal;  
            
            feeVal.textContent = (amt * 0.10).toFixed(2);  
            netVal.textContent = (amt * 0.90).toFixed(2);  

            let err = "";  
            if (amt > 0 && amt < LIMITS.min) err = `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${LIMITS.min} Ø¬Ù…`;  
            else if (ptsNeeded > currentPoints) err = "Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø§ ØªÙƒÙÙŠ";  
            else if (wallet.length > 0 && wallet.length !== 11) err = "Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø®Ø·Ø£";  
            else if (amt > remainingAmt) err = "ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ";  
            else if (todayOpsCount >= LIMITS.maxOpsPerDay) err = "ÙˆØµÙ„Øª Ù„Ø­Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ";  

            limitWarningEl.textContent = err;  
            limitWarningEl.style.display = err ? "block" : "none";  
            confirmBtn.disabled = !!err || amt <= 0 || wallet.length !== 11;  
        }  

        amountInp.addEventListener('input', updateCalc);  
        walletVod.addEventListener('input', updateCalc);  

        confirmBtn.onclick = () => {  
            modalAmount.textContent = amountInp.value;  
            modalNet.textContent = netVal.textContent;  
            modalWallet.textContent = walletVod.value;  
            customModal.classList.add('show');  
        };  

        cancelActionBtn.onclick = () => customModal.classList.remove('show');  

        confirmActionBtn.onclick = async () => {  
            customModal.classList.remove('show');  
            confirmBtn.disabled = true; confirmBtn.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";  
            try {  
                const token = await auth.currentUser.getIdToken();  
                const res = await fetch('/api/withdraw', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ amount: amountInp.value, wallet: walletVod.value }) });  
                const data = await res.json();  
                if (!res.ok) throw new Error(data.message);  
                showMsg(data.message, 'success');  
                amountInp.value = ""; checkDailyLimits();  
            } catch (e) {  
                let msg = e.message; if(msg.includes(':')) msg = msg.split(':').pop();  
                showMsg(msg, 'error');  
            } finally {  
                confirmBtn.disabled = false; confirmBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨"; updateCalc();  
            }  
        };  
    </script>  
</body></html>
