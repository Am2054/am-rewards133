<!DOCTYPE html>  <html lang="ar" dir="rtl">    <head>        <meta charset="UTF-8" />      
  <meta name="viewport" content="width=device-width, initial-scale=1" />      
  <title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | Am Rewards</title>      
  <link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet" />      
  <style>      
    body {      
      font-family: 'Tajawal', sans-serif;      
      background: linear-gradient(135deg, #e6f9ff, #fff);      
      margin: 0;      
      padding: 20px;      
      display: flex;      
      justify-content: center;      
    }      
    .container {      
      background: #fff;      
      border-radius: 16px;      
      padding: 25px;      
      max-width: 450px;      
      width: 100%;      
      box-shadow: 0 0 15px rgba(0,0,0,0.1);      
      border: 2px solid #17a2b8;      
    }      
    h2 {      
      color: #17a2b8;      
      text-align: center;      
      margin-bottom: 20px;      
    }      
    label {      
      font-weight: bold;      
      margin-top: 12px;      
      display: block;      
      text-align: right;      
    }      
    input, button {      
      width: 100%;      
      padding: 12px;      
      margin: 10px 0;      
      border-radius: 10px;      
      font-size: 16px;      
      box-sizing: border-box;      
    }      
    input {      
      border: 1px solid #ccc;      
    }      
    button {      
      background: #17a2b8;      
      color: white;      
      font-weight: bold;      
      border: none;      
      cursor: pointer;      
    }      
    button:hover {      
      background: #138496;      
    }      
    .note {      
      font-size: 14px;      
      color: #dc3545;      
      margin-top: 10px;      
      text-align: center;      
    }      
    .success {      
      color: green;      
      text-align: center;      
    }      
    .balance {      
      text-align: center;      
      margin-top: 15px;      
      font-weight: bold;      
      color: #007bff;      
    }      
  </style>      
</head>      
<body>      
  <div class="container">      
    <h2>Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø¹Ø¨Ø± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</h2>      
    <label for="points">Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·:</label>      
    <input type="number" id="points" placeholder="Ù…Ø«Ø§Ù„: 1000" min="0" oninput="calculateEGP()" />  <label for="phone">Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´:</label>      
<input type="text" id="phone" placeholder="Ù…Ø«Ø§Ù„: 010xxxxxxxx" />    <div class="balance" id="convertedAmount">= 0 Ø¬Ù†ÙŠÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</div>    <button onclick="requestWithdrawal()">Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>  <p class="note">âœ… Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ 15 Ø¬Ù†ÙŠÙ‡.        
ğŸš« Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ 130 Ø¬Ù†ÙŠÙ‡ (3 Ù…Ø±Ø§Øª).        
âš ï¸ ÙŠØªÙ… Ø®ØµÙ… 10% Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² 20 Ø¬Ù†ÙŠÙ‡.</p>    <p id="message" class="note"></p>    </div>    <script type="module">      
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";      
    import {      
      getFirestore, doc, getDoc, updateDoc, addDoc, collection, serverTimestamp, query, where, getDocs      
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";      
    import {      
      getAuth, onAuthStateChanged      
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";    const firebaseConfig = {      
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",      
  authDomain: "am--rewards.firebaseapp.com",      
  projectId: "am--rewards"      
};      const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const pointValue = 0.07;
let currentUser, currentPoints = 0;

onAuthStateChanged(auth, async user => {
if (!user) return window.location.href = "login.html";
currentUser = user;
const snap = await getDoc(doc(db, "users", user.uid));
if (snap.exists()) currentPoints = snap.data().points || 0;
});

window.calculateEGP = () => {
const pts = parseInt(document.getElementById("points").value) || 0;
let egp = pts * pointValue;
if (egp > 20) egp *= 0.90;
document.getElementById("convertedAmount").textContent = = ${egp.toFixed(2)} Ø¬Ù†ÙŠÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…;
};

async function checkWithdrawLimit() {
const today = new Date();
today.setHours(0, 0, 0, 0);
const q = query(collection(db, "withdrawRequests"),
where("uid", "==", currentUser.uid),
where("createdAt", ">=", serverTimestamp())
);
const snap = await getDocs(q);
let total = 0, count = 0;
snap.forEach(doc => {
const d = doc.data();
total += parseFloat(d.amountEGP || 0);
count += 1;
});
return { total, count };
}

window.requestWithdrawal = async () => {
const pts = parseInt(document.getElementById("points").value);
const phone = document.getElementById("phone").value.trim();
const msg = document.getElementById("message");

if (!pts || pts <= 0) return msg.textContent = "âŒ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­.";
if (!phone || !/^01[0-9]{9}$/.test(phone)) return msg.textContent = "âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ ØµØ­ÙŠØ­.";
const egpRaw = pts * pointValue;
const egp = egpRaw > 20 ? egpRaw * 0.9 : egpRaw;

if (egp < 15) return msg.textContent = "âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ù‡Ùˆ 15 Ø¬Ù†ÙŠÙ‡.";
if (egp > 130) return msg.textContent = "âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø­Ø¨ Ù‡Ùˆ 130 Ø¬Ù†ÙŠÙ‡.";

const { total, count } = await checkWithdrawLimit();
if (count >= 3) return msg.textContent = "âŒ ÙˆØµÙ„Øª Ù„Ø­Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ (3 Ù…Ø±Ø§Øª).";
if ((total + egp) > 130) return msg.textContent = "âŒ Ù…Ø¬Ù…ÙˆØ¹ Ø³Ø­ÙˆØ¨Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ… ØªØ¬Ø§ÙˆØ² 130 Ø¬Ù†ÙŠÙ‡.";

if (pts > currentPoints) return msg.textContent = "âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ©.";

try {
await addDoc(collection(db, "withdrawRequests"), {
uid: currentUser.uid,
userEmail: currentUser.email,
phone,
points: pts,
amountEGP: egp.toFixed(2),
status: "pending",
createdAt: serverTimestamp()
});

await updateDoc(doc(db, "users", currentUser.uid), {      
  points: currentPoints - pts      
});      

msg.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.";      
msg.classList.add("success");

} catch (err) {
console.error(err);
msg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
}
};

</script>  </body>

</html>
