<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ğŸ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    :root {
      --bg-color: #0f172a;
      --primary: #38bdf8;
      --secondary: #0ea5e9;
      --text-color: #f1f5f9;
      --surface-color: #1e293b;
      --border-color: #334155;
      --success: #22c55e;
      --error: #f87171;
      --warning: orange;
    }
    body {
      font-family: 'Cairo', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0; padding: 0;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      top:0; left:0; width:100vw; height:100vh; z-index:0;
      background: var(--bg-color) linear-gradient(135deg, var(--bg-color) 0%, var(--primary) 100%);
      opacity: 0.22;
      filter: blur(5px);
      animation: bgmove 20s infinite alternate;
    }
    @keyframes bgmove {
      0% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .container {
      max-width: 480px;
      margin: 30px auto;
      background: rgba(15, 23, 42, 0.96);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(56,189,248,0.35), 0 0 80px 0 rgba(56,189,248,0.1);
      position: relative;
      z-index: 2;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary);
      font-size: 24px;
      letter-spacing: 1px;
    }
    label { display:block; margin:10px 0 5px; font-weight:600; }
    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--surface-color);
      color: var(--text-color);
      font-size: 15px;
      transition: border-color 0.2s;
    }
    input:focus { border-color: var(--primary); outline: none; }
    input.invalid { border-color: var(--error); }
    input::placeholder { color:#94a3b8; }

    .info {
      background: var(--surface-color);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      text-align: center;
      font-size: 15px;
      box-shadow: 0 0 8px var(--secondary);
    }
    /* ğŸ’¡ Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚ Ù„Ù€ remainingLimit */
    #remainingLimitVal {
      font-weight: 700; 
      color: var(--primary);
    }

    .status-msg {
        text-align: center; 
        margin-top: 10px; 
        font-size: 15px; 
        font-weight: 700;
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
    }
    .status-msg.show { opacity: 1; }
    .status-msg.error { color: var(--error); }
    .status-msg.success { color: var(--success); }
    .status-msg.warning { color: var(--warning); }


    button {
      width: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--bg-color);
      font-weight: 700;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s, opacity 0.3s;
      font-size: 17px;
      box-shadow: 0 2px 10px #38bdf863;
    }
    button:hover:not(:disabled) { background: var(--secondary); color: var(--text-color); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    
    /* ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨ */
    .history {
      margin-top: 28px;
      position: relative;
      z-index: 1;
    }
    .history h2 {
      font-size: 18px;
      margin-bottom: 10px;
      color: var(--primary);
      text-align: center;
      letter-spacing: 1px;
    }
    .table-responsive {
        overflow-x: auto;
        border-radius: 8px;
    }
    table {
      min-width: 400px;
      width: 100%;
      border-collapse: collapse;
      background: var(--surface-color);
      box-shadow: 0 0 10px #38bdf838;
    }
    th, td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }
    th {
      background: var(--secondary);
      color: var(--bg-color);
    }
    .status {
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .status-pending { color: var(--warning); }
    .status-completed { color: var(--success); }
    .status-rejected { color: var(--error); }

    /* 1. ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ */
    @media (max-width: 360px) {
      .container { padding: 15px; }
      table { font-size: 12px; }
      th, td { padding: 8px 5px; }
      .info { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>
    
    <div class="info">
        Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="pointsVal">0</span> Ù†Ù‚Ø·Ø© â‰ˆ <span id="egpVal">0.00</span> Ø¬Ù… 
        <br>
        Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ…: <span id="remainingLimitVal">200.00</span> Ø¬Ù… | Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <span id="remainingOpsVal">--</span>
    </div>
    
    <label for="walletVod">Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>
    <input type="text" id="walletVod" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (11 Ø±Ù‚Ù…)" maxlength="11" inputmode="numeric">
    
    <label for="amountInp">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 20 Ø¬Ù…)</label>
    <input type="number" id="amountInp" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ…)" min="20">

    <div class="info">Ø§Ù„Ø®ØµÙ… (10%): <span id="feeVal">0.00</span> Ø¬Ù… | ØµØ§ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: <span id="netVal">0.00</span> Ø¬Ù…</div>
    <div class="info">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <span id="needPts">0</span></div>
    
    <button id="confirmBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>
    <div id="msg" class="status-msg" aria-live="polite"></div>

    <div class="history">
      <h2>ğŸ“œ Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (Ø¢Ø®Ø± 20 Ø·Ù„Ø¨)</h2>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„ØµØ§ÙÙŠ</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTable"><tr><td colspan="4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
        </table>
      </div>
       <p style="text-align:center; color:#94a3b8; font-size:13px; margin-top: 15px;">
        â° ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„
      </p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain:"am--rewards.firebaseapp.com",
      projectId:"am--rewards"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const POINT_VALUE_EGP = 0.07;
    const LIMITS = { min: 20, maxDaily: 200, maxOpsPerDay: 2 }; 
    // ğŸ’¡ 3. Ø§Ù‚ØªØ±Ø§Ø­ ØµØºÙŠØ± Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„: ØªØ§Ø±ÙŠØ® Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨
    const HISTORY_LIMIT = 20; 

    // ** Ø¹Ù†Ø§ØµØ± DOM **
    const pointsVal = document.getElementById('pointsVal');
    const egpVal = document.getElementById('egpVal');
    const amountInp = document.getElementById('amountInp');
    const walletVod = document.getElementById('walletVod');
    const feeVal = document.getElementById('feeVal');
    const netVal = document.getElementById('netVal');
    const needPts = document.getElementById('needPts');
    const msgEl = document.getElementById('msg');
    const withdrawalsTable = document.getElementById('withdrawalsTable');
    const confirmBtn = document.getElementById('confirmBtn');
    const remainingOpsEl = document.getElementById('remainingOpsVal'); 
    const remainingLimitEl = document.getElementById('remainingLimitVal'); 
    
    let userId = null;
    let currentPoints = 0;
    let referredByUID = null;
    let todayOpsCount = 0; 
    let todayAmountTotal = 0; 

    // ** Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© **
    
    function showMsg(text, type = 'success') {
        msgEl.textContent = text;
        msgEl.className = `status-msg show ${type}`;
        setTimeout(() => {
            msgEl.classList.remove('show');
        }, 5000);
    }

    function formatNum(num) {
      return Number(num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // 1. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª: Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ø§Ù„Ø³Ù†Ø©
    function formatDate(ts) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒØ§Ø¦Ù† ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØµØ­Ø© Ø§Ù„Ø³Ù†Ø©
        if (!ts?.toDate || ts.toDate().getFullYear() < 2024) return "-"; 

        const months = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        const dt = ts.toDate();
        if (isNaN(dt)) return "-";

        const hour = dt.getHours().toString().padStart(2, '0');
        const minute = dt.getMinutes().toString().padStart(2, '0');

        return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear()} - ${hour}:${minute}`;
    }
    
    function validateWallet() {
      const wallet = walletVod.value.trim();
      const isValid = wallet.length === 11 && /^\d{11}$/.test(wallet);
      walletVod.classList.toggle('invalid', !isValid && wallet.length > 0);
      return isValid;
    }
    walletVod.addEventListener('input', validateWallet);

    async function checkDailyLimits() {
      if (!userId) return { todayOps: 0, todayAmt: 0 };
      
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
      
      const todaySnapshot = await db.collection("withdrawals")
          .where("userId", "==", userId)
          .where("date", ">=", start) 
          .get();
      
      let ops = 0, amt = 0;
      todaySnapshot.forEach(doc => {
          const d = doc.data();
          if (d.status === 'pending' || d.status === 'completed') {
              ops++;
              amt += (+d.amount) || 0;
          }
      });
      
      todayOpsCount = ops;
      todayAmountTotal = amt; 
      
      const remainingOps = Math.max(0, LIMITS.maxOpsPerDay - todayOpsCount);
      const remainingAmount = Math.max(0, LIMITS.maxDaily - todayAmountTotal); 
      
      remainingOpsEl.textContent = remainingOps; 
      remainingLimitEl.textContent = formatNum(remainingAmount).replace('.00', ''); 
      
      return { todayOps: ops, todayAmt: amt, remainingAmount };
    }


    // ** 1. Ù…Ø³ØªÙ…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© **
    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        checkDailyLimits();

        db.collection('users').doc(userId).onSnapshot(doc => {
          if (doc.exists) {
            const data = doc.data();
            currentPoints = data.points || 0;
            referredByUID = data.referredByUID || null; 

            pointsVal.textContent = formatNum(currentPoints).replace('.00', '');
            egpVal.textContent = formatNum(currentPoints * POINT_VALUE_EGP);
            updateCalc();
          }
        });

        db.collection("withdrawals").where("userId", "==", user.uid)
          .orderBy("date", "desc")
          // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± HISTORY_LIMIT
          .limit(HISTORY_LIMIT) 
          .onSnapshot(snapshot => {
            checkDailyLimits().then(() => updateCalc()); 
            
            withdrawalsTable.innerHTML = "";
            if (snapshot.empty) {
              withdrawalsTable.innerHTML = `<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø¨Ø¹Ø¯</td></tr>`;
              return;
            }
            
            snapshot.forEach(doc => {
              const w = doc.data();
              let statusClass = "", icon = "", statusText = "";
              switch (w.status) {
                case "pending": statusClass = "status-pending"; icon = "â³"; statusText = "Ù…Ø¹Ù„Ù‚"; break;
                case "completed": statusClass = "status-completed"; icon = "âœ…"; statusText = "Ù…ÙƒØªÙ…Ù„"; break;
                case "rejected": statusClass = "status-rejected"; icon = "âŒ"; statusText = "Ù…Ø±ÙÙˆØ¶"; break;
                default: statusText = w.status || "-";
              }
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${formatNum(w.amount)} Ø¬Ù…</td>
                <td>${formatNum(w.net)} Ø¬Ù…</td>
                <td class="status ${statusClass}">${icon} ${statusText}</td>
                <td>${formatDate(w.date)}</td>`;
              withdrawalsTable.appendChild(tr);
            });
          }, (error) => {
              console.error("FIREBASE ERROR: Failed to fetch withdrawals.", error);
              withdrawalsTable.innerHTML = `<tr><td colspan="4" class="error">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„.</td></tr>`;
          });

      } else {
        window.location.href = "index.html";
      }
    });

    // ** 2. Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± **
    function updateCalc() {
      const rawAmt = amountInp.value; 
      const amt = parseFloat(rawAmt);
      const isWalletValid = validateWallet();
      
      let isDisabled = true;
      let ptsNeeded = 0;
      const remainingAmount = LIMITS.maxDaily - todayAmountTotal; 
      const remainingOps = LIMITS.maxOpsPerDay - todayOpsCount;
      
      remainingLimitEl.textContent = formatNum(remainingAmount).replace('.00', '');

      if (isNaN(amt) || amt < LIMITS.min) {
        feeVal.textContent = "0.00"; netVal.textContent = "0.00"; needPts.textContent = "0";
      } else {
        const fee = amt * 0.10;
        const net = amt - fee;
        ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);
        
        feeVal.textContent = formatNum(fee);
        netVal.textContent = formatNum(net);
        needPts.textContent = formatNum(ptsNeeded).replace('.00', '');
        
        needPts.style.color = ptsNeeded > currentPoints ? 'var(--error)' : 'var(--success)';
        
        if (
             ptsNeeded > currentPoints || 
             !isWalletValid ||            
             amt < LIMITS.min ||          
             amt > remainingAmount ||     
             remainingOps <= 0            
            ) 
        {
            isDisabled = true;
        } else {
            isDisabled = false;
        }
      }
      confirmBtn.disabled = isDisabled;
      
      if(remainingAmount <= 0) {
        amountInp.placeholder = `Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ (${LIMITS.maxDaily} Ø¬Ù…)`;
        amountInp.disabled = true;
      } else {
        amountInp.placeholder = `Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ ${formatNum(remainingAmount).replace('.00', '')} Ø¬Ù…)`;
        amountInp.disabled = false;
        amountInp.setAttribute('max', remainingAmount); 
      }
    }

    // ğŸ’¡ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: Debounce
    let calcTimeout;
    function debounceCalc() {
      clearTimeout(calcTimeout);
      calcTimeout = setTimeout(updateCalc, 250);
    }
    
    amountInp.addEventListener('input', debounceCalc);
    walletVod.addEventListener('input', debounceCalc);

    // ** 3. Ø¯Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ (Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬) **
    confirmBtn.addEventListener('click', async () => {
      // 2. Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬: ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙÙˆØ±Ø§Ù‹
      confirmBtn.disabled = true;

      msgEl.textContent = ""; msgEl.className = "status-msg";
      
      const amt = parseFloat(amountInp.value);
      const wallet = walletVod.value.trim();

      if (!validateWallet()) { showMsg("âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ ØµØ­ÙŠØ­ (11 Ø±Ù‚Ù…)", "error"); setTimeout(() => confirmBtn.disabled = false, 3000); return; }
      if (isNaN(amt) || amt < LIMITS.min) {
        showMsg(`âŒ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ${LIMITS.min} Ø¬Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.`, "error"); setTimeout(() => confirmBtn.disabled = false, 3000); return; 
      }

      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ø­Ø¨ ${formatNum(amt)} Ø¬Ù… Ø¥Ù„Ù‰ ${wallet}ØŸ`)) { 
        // 2. Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        confirmBtn.disabled = false; 
        return; 
      }

      confirmBtn.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."; 
      
      try {
        const ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);
        
        const limitsStatus = await checkDailyLimits();
        const todayOps = limitsStatus.todayOps;
        const remainingAmount = limitsStatus.remainingAmount; 
        
        if (todayOps >= LIMITS.maxOpsPerDay) { 
            throw `Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${LIMITS.maxOpsPerDay} Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨ ÙŠÙˆÙ…ÙŠÙ‹Ø§)`; 
        }
        if (amt > remainingAmount) { 
            throw `Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ ${formatNum(remainingAmount)} Ø¬Ù….`; 
        }
        
        // ** ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø¢Ù…Ù†Ø© **
        await db.runTransaction(async tr => {
          const userRef = db.collection("users").doc(userId);
          const withdrawalRef = db.collection("withdrawals").doc(); 
          
          const snap = await tr.get(userRef);
          const points = snap.data().points || 0;
          
          if (points < ptsNeeded) throw "Ø±ØµÙŠØ¯ Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙ";
          
          tr.update(userRef, { 
            points: firebase.firestore.FieldValue.increment(-ptsNeeded),
            lastWithdrawDate: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          tr.set(withdrawalRef, {
            userId, method: "vodafone", wallet,
            amount: amt, fee: amt * 0.10, net: amt - amt * 0.10,
            pts: ptsNeeded, status: "pending",
            date: firebase.firestore.FieldValue.serverTimestamp(),
            referredByUID: referredByUID || null,
            isReferralPaid: false 
          });
        });

        const newRemainingOps = LIMITS.maxOpsPerDay - (todayOps + 1); 
        showMsg(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ù…ØªØ¨Ù‚ÙŠ Ù„Ùƒ ${newRemainingOps} Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙŠÙˆÙ…. â³ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.`, "success");
        amountInp.value = ""; walletVod.value = "";
        
        checkDailyLimits(); 
        updateCalc();
        
      } catch (err) {
        console.error(err);
        let errorMsg;

        if (typeof err === 'string') {
          errorMsg = err; 
        } else if (err.code === 'ABORTED') {
            errorMsg = "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø¢Ù…Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
        } else if (err.code) {
            errorMsg = `Ø®Ø·Ø£ ÙÙŠ Firebase: ${err.code}`;
        } else {
          errorMsg = "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
        }
        
        showMsg("âŒ " + errorMsg, "error");
      } finally {
        confirmBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨"; 
        // 2. Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬)
        setTimeout(() => {
          // ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‚Ø¯ ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© updateCalc ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
          updateCalc(); 
        }, 3000); 
      }
    });
  </script>
</body>
</html>
