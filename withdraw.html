<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طلب سحب الأرباح | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      margin: 0; padding: 0;
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      top:0; left:0; width:100vw; height:100vh; z-index:0;
      background: #0f172a linear-gradient(135deg, #0f172a 0%, #38bdf8 100%);
      opacity: 0.22;
      filter: blur(5px);
      animation: bgmove 20s infinite alternate;
    }
    @keyframes bgmove {
      0% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .container {
      max-width: 480px;
      margin: 30px auto;
      background: rgba(15, 23, 42, 0.96);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(56,189,248,0.35), 0 0 80px 0 rgba(56,189,248,0.1);
      position: relative;
      z-index: 2;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #38bdf8;
      font-size: 24px;
      letter-spacing: 1px;
    }
    label { display:block; margin:10px 0 5px; font-weight:600; }
    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #1e293b;
      color: #f1f5f9;
      font-size: 15px;
    }
    input::placeholder { color:#94a3b8; }
    .info {
      background: #1e293b;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      text-align: center;
      font-size: 15px;
      box-shadow: 0 0 8px #0ea5e9a1;
    }
    button {
      width: 100%;
      background: linear-gradient(90deg, #38bdf8 0%, #0ea5e9 100%);
      color: #0f172a;
      font-weight: 700;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 17px;
      box-shadow: 0 2px 10px #38bdf863;
    }
    button:hover:not(:disabled) { background: #0ea5e9; color: #fff; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .msg { text-align:center; margin-top:10px; font-size:15px; }
    .error { color:#f87171; }
    .success { color:#22c55e; }
    .history {
      margin-top: 28px;
      position: relative;
      z-index: 1;
    }
    .history h2 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #38bdf8;
      text-align: center;
      letter-spacing: 1px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px #38bdf838;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #334155;
      font-size: 14px;
    }
    th {
      background: #0ea5e9;
      color: #0f172a;
    }
    .status {
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .status-pending { color: orange; }
    .status-completed { color: #22c55e; }
    .status-rejected { color: #f87171; }
  </style>
</head>
<body>
  <div class="container">
    <h1>💸 طلب سحب الأرباح</h1>
    <div class="info">رصيدك الحالي: <span id="pointsVal">0</span> نقطة ≈ <span id="egpVal">0.00</span> جم</div>
    <label>رقم محفظة فودافون كاش</label>
    <input type="text" id="walletVod" placeholder="ادخل رقم المحفظة">
    <label>المبلغ المراد سحبه (20 - 200 جنيه)</label>
    <input type="number" id="amountInp" placeholder="ادخل المبلغ" min="20">

    <div class="info">الخصم (10%): <span id="feeVal">0.00</span> جم | صافي الاستلام: <span id="netVal">0.00</span> جم</div>
    <div class="info">النقاط المطلوبة: <span id="needPts">0</span></div>
    <button id="confirmBtn">تأكيد السحب</button>
    <div id="msg" class="msg"></div>
    <div class="history">
      <h2>📜 سجل طلبات السحب (آخر 20 طلب)</h2>
      <table>
        <thead>
          <tr>
            <th>المبلغ</th>
            <th>الصافي</th>
            <th>الحالة</th>
            <th>التاريخ</th>
          </tr>
        </thead>
        <tbody id="withdrawalsTable"><tr><td colspan="4">جارِ التحميل...</td></tr></tbody>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain:"am--rewards.firebaseapp.com",
      projectId:"am--rewards"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const POINT_VALUE_EGP = 0.07;
    const LIMITS = { min: 20, maxDaily: 200, maxOpsPerDay: 2 };

    // ** عناصر DOM **
    const pointsVal = document.getElementById('pointsVal');
    const egpVal = document.getElementById('egpVal');
    const amountInp = document.getElementById('amountInp');
    const walletVod = document.getElementById('walletVod');
    const feeVal = document.getElementById('feeVal');
    const netVal = document.getElementById('netVal');
    const needPts = document.getElementById('needPts');
    const msg = document.getElementById('msg');
    const withdrawalsTable = document.getElementById('withdrawalsTable');
    const confirmBtn = document.getElementById('confirmBtn');

    let userId = null;
    let currentPoints = 0;
    let referredByUID = null;
    
    // دالة تنسيق الأرقام
    function formatNum(num) {
      return Number(num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // دالة تنسيق التاريخ
    function formatDate(ts) {
        if (!ts || !ts.toDate) return "-";
        const dt = ts.toDate();
        if (isNaN(dt)) return "-";
        return dt.toLocaleDateString("ar-EG", { year: 'numeric', month: 'short', day: 'numeric' }) + " " + dt.toLocaleTimeString("ar-EG", { hour: '2-digit', minute: '2-digit' });
    }

    // ** 1. مستمع حالة المصادقة **
    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        
        // جلب رصيد النقاط وreferredByUID (Realtime)
        db.collection('users').doc(userId).onSnapshot(doc => {
          if (doc.exists) {
            const data = doc.data();
            currentPoints = data.points || 0;
            // نترك referredByUID هنا لأننا سنستخدمه في صفحة المراجعة
            referredByUID = data.referredByUID || null; 

            pointsVal.textContent = formatNum(currentPoints).replace('.00', '');
            egpVal.textContent = formatNum(currentPoints * POINT_VALUE_EGP);
            updateCalc();
          }
        });

        // جلب سجل السحب (Realtime) - (تم حل مشكلته بإنشاء الفهرس)
        db.collection("withdrawals").where("userId", "==", user.uid)
          .orderBy("date", "desc")
          .limit(20)
          .onSnapshot(snapshot => {
            withdrawalsTable.innerHTML = "";
            if (snapshot.empty) {
              withdrawalsTable.innerHTML = `<tr><td colspan="4">لا يوجد طلبات سحب بعد</td></tr>`;
              return;
            }
            
            snapshot.forEach(doc => {
              const w = doc.data();
              let statusClass = "", icon = "", statusText = "";
              switch (w.status) {
                case "pending": statusClass = "status-pending"; icon = "⏳"; statusText = "معلق"; break;
                case "completed": statusClass = "status-completed"; icon = "✅"; statusText = "مكتمل"; break;
                case "rejected": statusClass = "status-rejected"; icon = "❌"; statusText = "مرفوض"; break;
                default: statusText = w.status || "-";
              }
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${formatNum(w.amount)} جم</td>
                <td>${formatNum(w.net)} جم</td>
                <td class="status ${statusClass}">${icon} ${statusText}</td>
                <td>${formatDate(w.date)}</td>`;
              withdrawalsTable.appendChild(tr);
            });
          }, (error) => {
              // هذا الجزء سيساعد في اكتشاف مشكلة قواعد الأمان إذا عادت المشكلة
              console.error("FIREBASE ERROR: Failed to fetch withdrawals.", error);
              withdrawalsTable.innerHTML = `<tr><td colspan="4" class="error">❌ فشل تحميل السجل. انظر الـ Console لمزيد من التفاصيل.</td></tr>`;
          });

      } else {
        window.location.href = "index.html";
      }
    });

    // ** 2. دالة حساب الرسوم والنقاط المطلوبة **
    function updateCalc() {
      const amt = parseFloat(amountInp.value);
      
      if (isNaN(amt) || amt < LIMITS.min) {
        feeVal.textContent = "0.00"; netVal.textContent = "0.00"; needPts.textContent = "0";
        confirmBtn.disabled = true;
        return;
      }
      
      const fee = amt * 0.10;
      const net = amt - fee;
      const ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);
      
      feeVal.textContent = formatNum(fee);
      netVal.textContent = formatNum(net);
      needPts.textContent = formatNum(ptsNeeded).replace('.00', '');
      
      if (amt > LIMITS.maxDaily || ptsNeeded > currentPoints) {
        confirmBtn.disabled = true;
      } else {
        confirmBtn.disabled = false;
      }
    }
    amountInp.addEventListener('input', updateCalc);

    // ** 3. دالة تأكيد السحب (مع المعاملة الآمنة) **
    confirmBtn.addEventListener('click', async () => {
      msg.textContent = ""; msg.className = "msg";
      const amt = parseFloat(amountInp.value);
      const wallet = walletVod.value.trim();

      // التحقق الأولي من المدخلات
      if (isNaN(amt) || amt < LIMITS.min || amt > LIMITS.maxDaily) {
        msg.textContent = `❌ المبلغ يجب أن يكون بين ${LIMITS.min} و ${LIMITS.maxDaily} جم.`; 
        msg.classList.add("error"); return; 
      }
      if (!wallet || wallet.length < 11 || !/^\d+$/.test(wallet)) { 
        msg.textContent = "❌ أدخل رقم محفظة فودافون كاش صحيح"; 
        msg.classList.add("error"); return; 
      }

      confirmBtn.disabled = true;
      
      try {
        const ptsNeeded = Math.ceil(amt / POINT_VALUE_EGP);
        
        // التحقق من قيود اليوم 
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        
        // ** ملاحظة: هذا الاستعلام قد يحتاج فهرس مركب آخر في Firestore إذا كان يتسبب في خطأ **
        // (userId, date, Ascending) - لكن دعه كما هو حالياً
        const todaySnapshot = await db.collection("withdrawals")
            .where("userId", "==", userId)
            .where("date", ">=", start) 
            .get();
        
        let todayOps = 0, todayAmt = 0;
        todaySnapshot.forEach(doc => {
            const d = doc.data();
            todayOps++; 
            todayAmt += (+d.amount) || 0;
        });
        
        if (todayOps >= LIMITS.maxOpsPerDay) { 
            throw "لقد وصلت للحد الأقصى (2 عملية سحب يوميًا)"; 
        }
        if ((todayAmt + amt) > LIMITS.maxDaily) { 
            throw `لا يمكنك تجاوز ${LIMITS.maxDaily} جم يوميًا`; 
        }
        
        if (!confirm(`هل أنت متأكد من سحب ${formatNum(amt)} جم إلى ${wallet}؟`)) { 
            confirmBtn.disabled = false; return; 
        }
        
        // ** تنفيذ المعاملة الآمنة لخصم النقاط وإنشاء طلب السحب **
        let newWithdrawalDocId = null; 

        await db.runTransaction(async tr => {
          const userRef = db.collection("users").doc(userId);
          const withdrawalRef = db.collection("withdrawals").doc(); 
          
          const snap = await tr.get(userRef);
          const points = snap.data().points || 0;
          
          if (points < ptsNeeded) throw "رصيد نقاط غير كافٍ";
          
          // الخصم آمن لأنه يتم في Transaction و Rules تسمح لمالك المستند بالتعديل
          tr.update(userRef, { points: firebase.firestore.FieldValue.increment(-ptsNeeded) });
          
          tr.set(withdrawalRef, {
            userId, method: "vodafone", wallet,
            amount: amt, fee: amt * 0.10, net: amt - amt * 0.10,
            pts: ptsNeeded, status: "pending",
            date: firebase.firestore.FieldValue.serverTimestamp(),
            referredByUID: referredByUID || null,
            isReferralPaid: false // يتم ترك هذه العلامة ليعرف المشرف لاحقاً أن الإحالة لم تتم
          });

          newWithdrawalDocId = withdrawalRef.id; 
        });

        // 🚨🚨🚨 منطق الإحالة المؤقت وغير الآمن 🚨🚨🚨
        // 🛑🛑 تم تعطيل هذا الجزء بالكامل لحل مشكلة 'failed-precondition' 🛑🛑
        /*
        if (referredByUID && newWithdrawalDocId) {
            const inviterRef = db.collection("users").doc(referredByUID);
            const withdrawalRef = db.collection("withdrawals").doc(newWithdrawalDocId);
            const bonusPoints = Math.floor(amt * 0.10 * (1 / POINT_VALUE_EGP));
            
            if (bonusPoints > 0) {
                await Promise.all([
                    inviterRef.update({
                        points: firebase.firestore.FieldValue.increment(bonusPoints),
                        referralPoints: firebase.firestore.FieldValue.increment(bonusPoints),
                        lastReferralUpdateDate: firebase.firestore.FieldValue.serverTimestamp()
                    }),
                    
                    withdrawalRef.update({
                        isReferralPaid: true,
                        referralBonusAmount: bonusPoints
                    })
                ]);
            }
        }
        */
        // 🚨🚨🚨 نهاية منطق الإحالة المؤقت وغير الآمن 🚨🚨🚨
        
        msg.textContent = "✅ تم إرسال طلب السحب بنجاح. ⏳ جارٍ المراجعة.";
        msg.classList.add("success");
        amountInp.value = ""; walletVod.value = "";
        updateCalc();

      } catch (err) {
        // ❌❌ معالجة الأخطاء المحسّنة لعرض الأخطاء بدقة في الـ Console ❌❌
        console.error("FATAL WITHDRAWAL ERROR:", err); 
        let errorMsg;

        if (typeof err === 'string') {
          errorMsg = err; 
        } else if (err.code) {
             // أخطاء Firebase (مثل 'permission-denied' أو 'failed-precondition')
            errorMsg = `خطأ في Firebase: ${err.code}`;
        } else {
          errorMsg = "حدث خطأ غير متوقع. حاول مجدداً.";
        }
        
        msg.textContent = "❌ " + errorMsg; 
        msg.classList.add("error");
      } finally {
        confirmBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
