<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Cairo', sans-serif;
  background: #0f172a linear-gradient(135deg, #0f172a 0%, #38bdf8 100%);
  color: #f1f5f9;
  margin: 0; padding: 0;
  min-height: 100vh;
  position: relative;
  overflow: hidden;
}
body::before {
  content: "";
  position: fixed;
  top:0; left:0; width:100vw; height:100vh; z-index:0;
  background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80') no-repeat center center;
  background-size: cover;
  opacity: 0.22;
  filter: blur(5px) brightness(1.2);
  animation: bgmove 20s infinite alternate;
}
@keyframes bgmove {
  0% { background-position: center top; }
  100% { background-position: center bottom; }
}
.container {
  max-width: 480px;
  margin: 30px auto;
  background: rgba(15, 23, 42, 0.94);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 0 30px rgba(56,189,248,0.35), 0 0 80px 0 rgba(56,189,248,0.1);
  position: relative;
  z-index: 2;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
  color: #38bdf8;
  font-size: 24px;
  letter-spacing: 1px;
}
label { display:block; margin:10px 0 5px; font-weight:600; }
input {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid #334155;
  border-radius: 8px;
  background: #1e293b;
  color: #f1f5f9;
  font-size: 15px;
}
input::placeholder { color:#94a3b8; }
.info {
  background: #1e293b;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 12px;
  text-align: center;
  font-size: 15px;
  box-shadow: 0 0 8px #0ea5e9a1;
}
button {
  width: 100%;
  background: linear-gradient(90deg, #38bdf8 0%, #0ea5e9 100%);
  color: #0f172a;
  font-weight: 700;
  padding: 12px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.3s;
  font-size: 17px;
  box-shadow: 0 2px 10px #38bdf863;
}
button:hover { background: #0ea5e9; color: #fff; }
.msg { text-align:center; margin-top:10px; font-size:15px; }
.error { color:#f87171; }
.success { color:#22c55e; }

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª */
.history {
  margin-top: 28px;
  position: relative;
  z-index: 1;
}
.history h2 {
  font-size: 18px;
  margin-bottom: 10px;
  color: #38bdf8;
  text-align: center;
  letter-spacing: 1px;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #1e293b;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 0 10px #38bdf838;
}
th, td {
  padding: 8px;
  text-align: center;
  border-bottom: 1px solid #334155;
  font-size: 14px;
}
th {
  background: #0ea5e9;
  color: #0f172a;
}

/* Ø§Ù„Ø­Ø§Ù„Ø§Øª */
.status {
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}
.status-pending { color: orange; }
.status-completed { color: #22c55e; }
.status-rejected { color: #f87171; }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>

  <div class="info">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="pointsVal">0</span> Ù†Ù‚Ø·Ø© â‰ˆ <span id="egpVal">0.00</span> Ø¬Ù…</div>

  <label>Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>
  <input type="text" id="walletVod" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©">

  <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡ (20 - 200 Ø¬Ù†ÙŠÙ‡)</label>
  <input type="number" id="amountInp" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">

  <div class="info">Ø§Ù„Ø®ØµÙ…: <span id="feeVal">0.00</span> Ø¬Ù… | ØµØ§ÙÙŠ: <span id="netVal">0.00</span> Ø¬Ù…</div>
  <div class="info">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <span id="needPts">0</span></div>

  <button id="confirmBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>

  <div id="msg" class="msg"></div>

  <!-- Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨ -->
  <div class="history">
    <h2>ğŸ“œ Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h2>
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ø§Ù„ØµØ§ÙÙŠ</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        </tr>
      </thead>
      <tbody id="withdrawalsTable"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { 
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", 
  authDomain:"am--rewards.firebaseapp.com", 
  projectId:"am--rewards" 
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const POINT_VALUE_EGP = 0.07; // Ø³Ø¹Ø± Ø§Ù„Ù†Ù‚Ø·Ø©
const LIMITS = { min:20, maxDaily:200, maxOpsPerDay:2 };

const pointsVal=document.getElementById('pointsVal');
const egpVal=document.getElementById('egpVal');
const amountInp=document.getElementById('amountInp');
const walletVod=document.getElementById('walletVod');
const feeVal=document.getElementById('feeVal');
const netVal=document.getElementById('netVal');
const needPts=document.getElementById('needPts');
const msg=document.getElementById('msg');
const withdrawalsTable=document.getElementById('withdrawalsTable');
const confirmBtn=document.getElementById('confirmBtn');

let userId=null;

auth.onAuthStateChanged(user=>{
  if(user){
    userId=user.uid;
    db.collection('users').doc(userId)
      .onSnapshot(doc=>{
        if(doc.exists){
          const points=doc.data().points||0;
          pointsVal.textContent=points;
          egpVal.textContent=(points*POINT_VALUE_EGP).toFixed(2);
        }
      });

    // Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Øµ ÙˆØªØ§ÙŠÙ… Ø³ØªØ§Ù…Ø¨
    db.collection("withdrawals")
      .where("userId", "==", user.uid)
      .onSnapshot(snapshot => {
        withdrawalsTable.innerHTML = "";
        if (snapshot.empty) {
          withdrawalsTable.innerHTML = `<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø¨Ø¹Ø¯</td></tr>`;
          return;
        }
        let arr = [];
        snapshot.forEach(doc => {
          const w = doc.data();
          let dateVal = 0;
          if (w.date) {
            if (typeof w.date === "string") {
              dateVal = Date.parse(w.date) || 0;
            } else if (w.date.toDate) {
              dateVal = w.date.toDate().getTime();
            }
          }
          arr.push({ ...w, dateVal });
        });
        arr.sort((a, b) => b.dateVal - a.dateVal);
        arr.forEach(w => {
          let dateStr = "-";
          if (w.date) {
            if (typeof w.date === "string") {
              dateStr = w.date;
            } else if (w.date.toDate) {
              const dt = w.date.toDate();
              dateStr = dt.toLocaleDateString("ar-EG") + " - " + dt.toLocaleTimeString("ar-EG");
            }
          }
          let statusClass="", icon="", statusText="";
          switch (w.status) {
            case "pending":
            case "Ù…Ø¹Ù„Ù‚":
              statusClass = "status-pending"; icon = "â³"; statusText = "Ù…Ø¹Ù„Ù‚"; break;
            case "completed":
            case "Ù…ÙƒØªÙ…Ù„":
              statusClass = "status-completed"; icon = "âœ…"; statusText = "Ù…ÙƒØªÙ…Ù„"; break;
            case "rejected":
            case "Ù…Ø±ÙÙˆØ¶":
              statusClass = "status-rejected"; icon = "âŒ"; statusText = "Ù…Ø±ÙÙˆØ¶"; break;
            default:
              statusText = w.status || "-";
          }
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${w.amount || "-"} Ø¬Ù…</td>
            <td>${w.net ? w.net.toFixed(2) : "-"} Ø¬Ù…</td>
            <td class="status ${statusClass}">${icon} ${statusText}</td>
            <td>${dateStr}</td>
          `;
          withdrawalsTable.appendChild(tr);
        });
      });

  } else {
    window.location.href="index.html";
  }
});

function updateCalc(){
  const amt=parseFloat(amountInp.value);
  if(isNaN(amt)||amt<LIMITS.min){
    feeVal.textContent="0.00";
    netVal.textContent="0.00";
    needPts.textContent="0";
    return;
  }
  const fee=amt*0.10;
  const net=amt-fee;
  const ptsNeeded=Math.ceil(amt/POINT_VALUE_EGP);
  feeVal.textContent=fee.toFixed(2);
  netVal.textContent=net.toFixed(2);
  needPts.textContent=ptsNeeded;
}
amountInp.addEventListener('input',updateCalc);

confirmBtn.addEventListener('click',async ()=>{
  msg.textContent=""; msg.className="msg";
  const amt=parseFloat(amountInp.value);
  const wallet=walletVod.value.trim();
  if(isNaN(amt)||amt<LIMITS.min){ msg.textContent="âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ 20 Ø¬Ù…"; msg.classList.add("error"); return; }
  if(!wallet){ msg.textContent="âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©"; msg.classList.add("error"); return; }

  confirmBtn.disabled=true;
  try {
    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
    const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);

    // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø£Ø¨Ø³Ø· Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ index
    const query = db.collection("withdrawals")
      .where("userId", "==", userId);

    const snapshot = await query.get();

    // ÙÙ„ØªØ±Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
    let todayOpsCount = 0;
    let todayTotalAmount = 0;
    snapshot.forEach(doc => {
      const data = doc.data();
      let wDate = data.date;
      if(wDate && wDate.toDate){
        wDate = wDate.toDate();
        if(wDate >= startOfDay && wDate <= endOfDay){
          todayOpsCount += 1;
          todayTotalAmount += Number(data.amount) || 0;
        }
      }
    });

    if (todayOpsCount >= LIMITS.maxOpsPerDay) {
      msg.textContent = "âŒ Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (2 Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨ ÙŠÙˆÙ…ÙŠÙ‹Ø§). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ø­Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ØºØ¯Ù‹Ø§.";
      msg.classList.add("error");
      confirmBtn.disabled=false;
      return;
    }
    if((todayTotalAmount + amt) > LIMITS.maxDaily){
      msg.textContent = `âŒ Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ù„ÙŠØªÙŠ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ®Ø·Ù‰ ${LIMITS.maxDaily} Ø¬Ù…. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…: ${(LIMITS.maxDaily-todayTotalAmount).toFixed(2)} Ø¬Ù…`;
      msg.classList.add("error");
      confirmBtn.disabled=false;
      return;
    }
    if(amt > (LIMITS.maxDaily-todayTotalAmount)){
      msg.textContent = `âŒ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ… (${(LIMITS.maxDaily-todayTotalAmount).toFixed(2)} Ø¬Ù…).`;
      msg.classList.add("error");
      confirmBtn.disabled=false;
      return;
    }

    const confirmMsg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø³Ø­Ø¨ ${amt} Ø¬Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ÙØ¸Ø©: ${wallet} ØŸ`;
    if(!confirm(confirmMsg)) { confirmBtn.disabled=false; return; }

    const ptsNeeded=Math.ceil(amt/POINT_VALUE_EGP);

    await db.runTransaction(async (tr)=>{
      const userRef=db.collection("users").doc(userId);
      const snap=await tr.get(userRef);
      const points=snap.data().points||0;
      if(points<ptsNeeded) throw "Ø±ØµÙŠØ¯ Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙ";
      tr.update(userRef,{ points: firebase.firestore.FieldValue.increment(-ptsNeeded) });
      tr.set(db.collection("withdrawals").doc(),{
        userId, method:"vodafone", wallet,
        amount:amt, fee:amt*0.10, net:amt-amt*0.10,
        pts:ptsNeeded, status:"Ù…Ø¹Ù„Ù‚",
        date:firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    msg.textContent="âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­. â³ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³ØªØºØ±Ù‚ Ù…Ù† 30 Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ù„Ù‰ 12 Ø³Ø§Ø¹Ø©.";
    msg.classList.add("success");
    amountInp.value=""; walletVod.value="";
    updateCalc();
  } catch(err){
    msg.textContent="âŒ "+err;
    msg.classList.add("error");
  } finally{
    confirmBtn.disabled=false;
  }
});
</script>
</body>
                              </html>
