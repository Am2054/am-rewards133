<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#9aa4b2; --text:#e8eef6; --brand:#10b981; --brand-2:#22d3ee; --danger:#ef4444; --accent:#6366f1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Cairo',sans-serif; background:radial-gradient(1000px 500px at 80% -20%, #0f172a33, transparent), linear-gradient(180deg,#0b0f14 0%, #0a121a 100%);
      color:var(--text); min-height:100vh; padding:24px;
    }
    .wrap{max-width:720px; margin:0 auto}
    .card{
      background:linear-gradient(180deg,#0f1621 0%, #0e141d 100%); border:1px solid #243140; box-shadow:0 10px 40px rgba(0,0,0,.4);
      border-radius:18px; padding:22px;
    }
    h1{margin:0 0 12px; font-size:26px; font-weight:800}
    .sub{color:var(--muted); margin-bottom:18px}
    .balance{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0 18px;
    }
    .pill{
      background:#0c121a; border:1px solid #1f2a36; border-radius:14px; padding:14px;
    }
    .pill .label{color:var(--muted); font-size:14px}
    .pill .val{font-weight:800; font-size:20px; margin-top:4px}
    .mt{margin-top:14px}
    label{display:block; margin:12px 0 6px; color:#cdd6e1; font-weight:700}
    input, select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #233140; background:#0b1219; color:var(--text); font-size:16px; outline:none;
    }
    input::placeholder{color:#6b7280}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .help{color:var(--muted); font-size:13px; margin-top:6px}
    .calc{
      display:flex; gap:12px; flex-wrap:wrap; margin-top:14px;
    }
    .chip{
      background:#0b1219; border:1px dashed #2a3a4d; border-radius:12px; padding:10px 12px; font-size:14px;
    }
    .note{margin-top:14px; color:#aab4c2; font-size:14px; line-height:1.8}
    .hint{margin-top:8px; color:#93c5fd; font-size:13px}
    .divider{height:1px; background:#1e2a38; margin:18px 0}
    button{
      width:100%; padding:14px; border:none; border-radius:12px; background:linear-gradient(90deg,var(--brand) 0%, var(--brand-2) 100%);
      color:#002d2a; font-weight:900; font-size:16px; cursor:pointer; box-shadow:0 10px 30px rgba(16,185,129,.25);
      transition:transform .08s ease;
    }
    button:active{transform:translateY(1px)}
    .danger{background:linear-gradient(90deg,#ef4444,#f59e0b); color:#111}
    .warn{color:#f59e0b}
    .center{text-align:center}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .method-box{display:none}
    .show{display:block}
    .footer{
      margin-top:14px; display:grid; grid-template-columns:1fr 1fr; gap:10px; color:var(--muted); font-size:13px;
    }
    /* Confirm Modal */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:50;
    }
    .modal.show{display:grid}
    .modal .inner{
      width:min(520px,92vw); background:var(--panel); border:1px solid #233140; border-radius:16px; padding:18px;
    }
    .modal h3{margin:0 0 10px; font-size:20px}
    .modal p{margin:6px 0; color:#c7d2fe}
    .modal .grid-2{margin-top:12px}
    .muted{color:var(--muted)}
    .success{color:#34d399; margin-top:10px}
    .error{color:#fca5a5; margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>
      <div class="sub">ØªØ­ÙˆÙŠÙ„ Ù†Ù‚Ø§Ø·Ùƒ Ø¥Ù„Ù‰ Ø£Ø±Ø¨Ø§Ø­Ùƒ Ø¨Ù„Ù…Ø³Ø© ÙˆØ§Ø­Ø¯Ø© â€” Ù…Ø¹ Ø®ØµÙ… 10% Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø©.</div>

      <!-- Ø£Ø±ØµØ¯Ø© -->
      <div class="balance">
        <div class="pill">
          <div class="label">Ø±ØµÙŠØ¯Ùƒ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·</div>
          <div class="val" id="pointsVal">0 Ù†Ù‚Ø·Ø©</div>
        </div>
        <div class="pill">
          <div class="label">ÙŠØ¹Ø§Ø¯Ù„ (Ø¬Ù†ÙŠÙ‡ / Ø¯ÙˆÙ„Ø§Ø±)</div>
          <div class="val"><span id="egpVal">0</span> Ø¬Ù… Â· <span id="usdVal">0</span> $</div>
          <div class="help">Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ù‰: <span id="usdRate">â€”</span> Ø¬Ù…</div>
        </div>
      </div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© -->
      <div class="row mt">
        <div>
          <label for="method">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
          <select id="method">
            <option value="vodafone">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ (EGP)</option>
            <option value="paypal">PayPal (USD)</option>
          </select>
        </div>
        <div>
          <label for="amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
          <input type="number" id="amount" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (EGP Ø£Ùˆ $)">
          <div class="help" id="limitsHelp">Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.</div>
        </div>
      </div>

      <!-- Ù…Ø¯Ø®Ù„Ø§Øª Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© -->
      <div id="box-vodafone" class="method-box show">
        <label for="wallet">Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>
        <input type="text" id="wallet" placeholder="01xxxxxxxxx">
      </div>

      <div id="box-paypal" class="method-box">
        <label for="paypalEmail">Ø¨Ø±ÙŠØ¯ PayPal</label>
        <input type="email" id="paypalEmail" placeholder="example@email.com">
        <div class="hint">ØªØ£ÙƒØ¯ Ø£Ù† Ø­Ø³Ø§Ø¨Ùƒ ÙŠØ³ØªÙ‚Ø¨Ù„ Ø£Ù…ÙˆØ§Ù„Ù‹Ø§.</div>
      </div>

      <!-- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… -->
      <div class="calc">
        <div class="chip">Ø®ØµÙ… Ø§Ù„Ø®Ø¯Ù…Ø© 10%: <span id="feeVal">0</span></div>
        <div class="chip">Ø³ÙŠØµÙ„Ùƒ: <strong id="netVal">0</strong></div>
        <div class="chip">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <span id="needPts">0</span></div>
      </div>

      <div class="divider"></div>

      <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
      <div class="grid-2">
        <div class="pill">
          <div class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)</div>
          <div class="val" id="leftCount">â€”</div>
          <div class="help">Ø­Ø¯ Ø£Ù‚ØµÙ‰ 3 Ø·Ù„Ø¨Ø§Øª Ù„ÙƒÙ„ Ø·Ø±ÙŠÙ‚Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§</div>
        </div>
        <div class="pill">
          <div class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
          <div class="val" id="leftCap">â€”</div>
          <div class="help" id="capHelp">â€”</div>
        </div>
      </div>

      <div id="msg" class="error" style="display:none;"></div>
      <div id="ok" class="success" style="display:none;"></div>

      <div class="mt">
        <button id="submitBtn" onclick="openConfirm()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>

      <div class="note">
        â€¢ Ø­Ø¯ Ø£Ø¯Ù†Ù‰: <strong>20 Ø¬Ù†ÙŠÙ‡</strong> Ù„ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ØŒ <strong>$0.50</strong> Ù„Ø¨Ø§ÙŠØ¨Ø§Ù„.<br>
        â€¢ Ø­Ø¯ Ø£Ù‚ØµÙ‰ ÙŠÙˆÙ…ÙŠ: <strong>150 Ø¬Ù†ÙŠÙ‡</strong> Ù„ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ØŒ <strong>$3</strong> Ù„Ø¨Ø§ÙŠØ¨Ø§Ù„ â€” Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø·Ù„Ø¨Ø§ØªÙƒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯.<br>
        â€¢ ØªÙØ®ØµÙ… Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø© <strong>10%</strong> Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨. Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªØªÙ… Ø¢Ù„ÙŠÙ‹Ø§.
      </div>

      <div class="footer">
        <div>ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</div>
        <div class="center">ğŸ¤ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Am Rewards</div>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ -->
  <div class="modal" id="confirmModal" role="dialog" aria-modal="true">
    <div class="inner">
      <h3>ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</h3>
      <p class="muted">ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:</p>
      <p>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: <strong id="c_method">â€”</strong></p>
      <p>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <strong id="c_gross">â€”</strong></p>
      <p>Ø§Ù„Ø®ØµÙ… (10%): <strong id="c_fee">â€”</strong></p>
      <p>Ø³ÙŠØµÙ„Ùƒ: <strong id="c_net">â€”</strong></p>
      <p>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø®ØµÙˆÙ…Ø©: <strong id="c_pts">â€”</strong></p>
      <div class="grid-2">
        <button class="danger" onclick="closeConfirm()">Ø±Ø¬ÙˆØ¹</button>
        <button onclick="submitWithdrawal()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    const POINT_VALUE_EGP = 0.07; // Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø·Ø© Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡
    const LIMITS = {
      vodafone: {min: 20, maxDaily: 150, maxCount: 3, currency: 'EGP', label: 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'},
      paypal:   {min: 0.5, maxDaily: 3,  maxCount: 3, currency: 'USD', label: 'PayPal'}
    };

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Ø¹Ù†Ø§ØµØ± DOM
    const pointsVal = document.getElementById('pointsVal');
    const egpVal    = document.getElementById('egpVal');
    const usdVal    = document.getElementById('usdVal');
    const usdRateEl = document.getElementById('usdRate');

    const methodSel = document.getElementById('method');
    const amountInp = document.getElementById('amount');
    const walletInp = document.getElementById('wallet');
    const ppEmail   = document.getElementById('paypalEmail');

    const boxVod = document.getElementById('box-vodafone');
    const boxPP  = document.getElementById('box-paypal');

    const feeVal  = document.getElementById('feeVal');
    const netVal  = document.getElementById('netVal');
    const needPts = document.getElementById('needPts');

    const leftCount = document.getElementById('leftCount');
    const leftCap   = document.getElementById('leftCap');
    const capHelp   = document.getElementById('capHelp');

    const msg = document.getElementById('msg');
    const ok  = document.getElementById('ok');
    const limitsHelp = document.getElementById('limitsHelp');

    // ØªØ£ÙƒÙŠØ¯
    const modal = document.getElementById('confirmModal');
    const c_method = document.getElementById('c_method');
    const c_gross  = document.getElementById('c_gross');
    const c_fee    = document.getElementById('c_fee');
    const c_net    = document.getElementById('c_net');
    const c_pts    = document.getElementById('c_pts');

    // Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø©
    let usdRate = null;       // Ø³Ø¹Ø± $ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (EGP per USD)
    let userRef = null;
    let userData = null;
    let todayStats = { // Ù„ÙƒÙ„ Ø·Ø±ÙŠÙ‚Ø©
      vodafone: {count:0, total:0},
      paypal:   {count:0, total:0}
    };

    // Ø¬Ù„Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (Ø¨Ø¯ÙˆÙ† Ù…ÙØ§ØªÙŠØ­)
    async function fetchUsdRate(){
      try{
        // Ù†Ø¬Ù„Ø¨ Ø³Ø¹Ø± USD Ù…Ù‚Ø§Ø¨Ù„ EGP
        const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=EGP');
        const data = await res.json();
        usdRate = data && data.rates && data.rates.EGP ? Number(data.rates.EGP) : null;
        usdRateEl.textContent = usdRate ? usdRate.toFixed(2) + ' Ø¬Ù…' : 'â€”';
        updateView(); // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
      }catch(e){
        usdRateEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«';
      }
    }

    function fmt(n){
      return (Math.round(n * 100) / 100).toFixed(2);
    }

    function updateLimitsHelp(){
      const m = methodSel.value;
      const L = LIMITS[m];
      limitsHelp.textContent =
        (m==='vodafone'
          ? `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${L.min} Ø¬Ù… â€” Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ ${L.maxDaily} Ø¬Ù… â€” Ø¨Ø­Ø¯ ${L.maxCount} Ø·Ù„Ø¨Ø§Øª`
          : `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ $${L.min} â€” Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ $${L.maxDaily} â€” Ø¨Ø­Ø¯ ${L.maxCount} Ø·Ù„Ø¨Ø§Øª`);
      capHelp.textContent =
        (m==='vodafone'
          ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ: 150 Ø¬Ù†ÙŠÙ‡'
          : 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ: 3 Ø¯ÙˆÙ„Ø§Ø±');
    }

    function switchMethodUI(){
      const m = methodSel.value;
      boxVod.classList.toggle('show', m==='vodafone');
      boxPP.classList.toggle('show',  m==='paypal');
      amountInp.value = '';
      calc();
      updateDailyLeftUI();
      updateLimitsHelp();
    }

    function pointsToEGP(pts){
      return pts * POINT_VALUE_EGP;
    }
    function egpToPoints(egp){
      return Math.ceil(egp / POINT_VALUE_EGP);
    }

    function updateView(){
      if(!userData) return;
      const pts = Number(userData.points||0);
      pointsVal.textContent = `${pts} Ù†Ù‚Ø·Ø©`;
      const egp = pointsToEGP(pts);
      egpVal.textContent = fmt(egp);
      if(usdRate){
        const usd = egp / usdRate;
        usdVal.textContent = fmt(usd);
      } else {
        usdVal.textContent = 'â€”';
      }
    }

    function calc(){
      hideAlerts();
      const m = methodSel.value;
      const L = LIMITS[m];
      const gross = Number(amountInp.value || 0);
      if(!gross || gross <= 0){
        feeVal.textContent = '0';
        netVal.textContent = '0';
        needPts.textContent = '0';
        return;
      }
      // Ø®ØµÙ… 10%
      const fee = gross * 0.10;
      const net = gross - fee;

      // Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ù†Ø­ÙˆÙ„ "Ø§Ù„ØµØ§ÙÙŠ" Ø¥Ù„Ù‰ Ø¬Ù†ÙŠÙ‡ Ø£ÙˆÙ„Ù‹Ø§
      let neededPoints;
      if(m==='vodafone'){
        // Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡
        neededPoints = egpToPoints(net);
      }else{
        // Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± -> Ù†Ø­ÙˆÙ„Ù‡ Ù„Ø¬Ù†ÙŠÙ‡ Ø¨Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…
        if(!usdRate){ neededPoints = NaN; }
        else{
          const egp = net * usdRate;
          neededPoints = egpToPoints(egp);
        }
      }

      feeVal.textContent = (m==='vodafone' ? fmt(fee) + ' Ø¬Ù…' : '$' + fmt(fee));
      netVal.textContent = (m==='vodafone' ? fmt(net) + ' Ø¬Ù…' : '$' + fmt(net));
      needPts.textContent = isNaN(neededPoints) ? 'â€”' : neededPoints;
    }

    function hideAlerts(){ msg.style.display='none'; ok.style.display='none'; }
    function showErr(t){ msg.textContent=t; msg.style.display='block'; }
    function showOk(t){ ok.textContent=t; ok.style.display='block'; }

    function openConfirm(){
      hideAlerts();
      // ØªØ­Ù‚Ù‚ Ù…Ø¨Ø¯Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
      const m = methodSel.value;
      const L = LIMITS[m];
      const gross = Number(amountInp.value || 0);
      if(m==='vodafone'){
        if(!walletInp.value || walletInp.value.trim().length < 10) return showErr('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© ØµØ­ÙŠØ­');
      }else{
        if(!ppEmail.value || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(ppEmail.value)) return showErr('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ PayPal ØµØ­ÙŠØ­');
      }
      if(!gross || gross < L.min) return showErr(`âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù‡Ùˆ ${m==='vodafone' ? (L.min+' Ø¬Ù†ÙŠÙ‡') : ('$'+L.min)}`);

      // Ø®ØµÙ… ÙˆNet
      const fee = gross * 0.10;
      const net = gross - fee;

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ù„Ø¨Ø§ÙŠØ¨Ø§Ù„
      if(m==='paypal' && !usdRate) return showErr('âŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø¢Ù†. Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ù„Ø­Ø¸Ø§Øª.');

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©
      let neededPts;
      if(m==='vodafone'){
        neededPts = egpToPoints(net);
      }else{
        const egp = net * usdRate;
        neededPts = egpToPoints(egp);
      }
      const userPts = Number(userData?.points || 0);
      if(neededPts > userPts) return showErr('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø­Ø¨.');

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: Ø§Ù„Ø¹Ø¯Ø¯ + Ø§Ù„Ø³Ù‚Ù Ø§Ù„Ù…Ø§Ù„ÙŠ
      const usedCount = todayStats[m].count;
      const usedTotal = todayStats[m].total; // Ù†Ø¬Ù…Ø¹ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø­Ø³Ø¨ Ø¹Ù…Ù„Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
      if(usedCount >= L.maxCount) return showErr('âŒ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© (3).');
      if(usedTotal + gross > L.maxDaily){
        const left = Math.max(L.maxDaily - usedTotal, 0);
        return showErr(`âŒ Ø§Ù„Ù…ØªØ§Ø­ Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ… Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² ${m==='vodafone' ? (fmt(left)+' Ø¬Ù†ÙŠÙ‡') : ('$'+fmt(left))}.`);
      }

      // Ø§Ù…Ù„Ø£ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
      c_method.textContent = L.label + (m==='vodafone' ? ' (EGP)' : ' (USD)');
      c_gross.textContent  = m==='vodafone' ? (fmt(gross)+' Ø¬Ù†ÙŠÙ‡') : ('$'+fmt(gross));
      c_fee.textContent    = m==='vodafone' ? (fmt(fee)+' Ø¬Ù†ÙŠÙ‡')  : ('$'+fmt(fee));
      c_net.textContent    = m==='vodafone' ? (fmt(net)+' Ø¬Ù†ÙŠÙ‡')   : ('$'+fmt(net));
      c_pts.textContent    = neededPts;

      modal.classList.add('show');
    }
    function closeConfirm(){ modal.classList.remove('show'); }

    async function submitWithdrawal(){
      // Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯
      const m = methodSel.value;
      const L = LIMITS[m];
      const gross = Number(amountInp.value || 0);
      const fee = gross * 0.10;
      const net = gross - fee;

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
      let neededPts;
      let netInEGP;
      if(m==='vodafone'){
        neededPts = egpToPoints(net);
        netInEGP = net;
      }else{
        const egp = net * usdRate;
        netInEGP = egp;
        neededPts = egpToPoints(egp);
      }

      const uid = auth.currentUser.uid;

      // ØªÙ†ÙÙŠØ°: Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
      try{
        // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await userRef.update({
          points: firebase.firestore.FieldValue.increment(-neededPts),
          withdrawn: firebase.firestore.FieldValue.increment(neededPts)
        });

        // Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        await db.collection('withdraw_requests').add({
          uid,
          method: m,
          currency: L.currency,                    // 'EGP' Ø£Ùˆ 'USD'
          amountRequested: gross,                  // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…)
          fee: Number(fmt(fee)),
          amountAfterFee: Number(fmt(net)),
          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ Ø¥Ù„Ù‰ Ø¬Ù†ÙŠÙ‡ Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:
          netInEGP: Number(fmt(netInEGP)),
          // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„
          wallet: m==='vodafone' ? walletInp.value.trim() : null,
          paypalEmail: m==='paypal' ? ppEmail.value.trim() : null,
          status: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        todayStats[m].count += 1;
        todayStats[m].total += gross;

        showOk('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ â€” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.');
        closeConfirm();
        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
        amountInp.value = '';
        if(m==='vodafone') walletInp.value = '';
        if(m==='paypal')  ppEmail.value = '';
        calc();
        updateDailyLeftUI();
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
        await reloadUser();
      }catch(e){
        console.error(e);
        showErr('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      }
    }

    function updateDailyLeftUI(){
      const m = methodSel.value;
      const L = LIMITS[m];
      const usedC = todayStats[m].count;
      const usedT = todayStats[m].total;
      leftCount.textContent = `${Math.max(L.maxCount - usedC, 0)} / ${L.maxCount}`;
      const leftAmount = Math.max(L.maxDaily - usedT, 0);
      leftCap.textContent = m==='vodafone' ? `${fmt(leftAmount)} Ø¬Ù…` : `$${fmt(leftAmount)}`;
    }

    function startOfToday(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d;
    }
    function endOfToday(){
      const d = new Date();
      d.setHours(23,59,59,999);
      return d;
    }

    async function loadTodayStats(uid){
      // Ù†Ø¬Ù„Ø¨ Ù„ÙƒÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Ø­Ø¯Ø©
      for(const m of ['vodafone','paypal']){
        const L = LIMITS[m];
        const qs = await db.collection('withdraw_requests')
          .where('uid','==', uid)
          .where('method','==', m)
          .where('createdAt','>=', startOfToday())
          .where('createdAt','<=', endOfToday())
          .get();

        let count=0, total=0;
        qs.forEach(doc => {
          const x = doc.data();
          // Ù†Ø¬Ù…Ø¹ Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ "amountRequested" Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
          total += Number(x.amountRequested || 0);
          count += 1;
        });
        todayStats[m] = {count, total};
      }
      updateDailyLeftUI();
    }

    async function reloadUser(){
      const snap = await userRef.get();
      userData = snap.data() || {};
      updateView();
    }

    // Ø£Ø­Ø¯Ø§Ø«
    methodSel.addEventListener('change', switchMethodUI);
    amountInp.addEventListener('input', calc);
    walletInp.addEventListener('input', hideAlerts);
    ppEmail.addEventListener('input', hideAlerts);

    // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ window.location.href='index.html'; return; }
      userRef = db.collection('users').doc(user.uid);
      await reloadUser();
      await fetchUsdRate();
      await loadTodayStats(user.uid);
      switchMethodUI();
      calc();
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeConfirm(); });
    function closeOnEsc(e){ if(e.key==='Escape') closeConfirm(); }
    window.addEventListener('keydown', closeOnEsc);
  </script>
</body>
          </html>
