<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | AM Rewards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
          --neon-cyan: #00f2ff; --neon-purple: #7000ff; --bg-deep: #020617;
          --glass-bg: rgba(15, 23, 42, 0.7); --glass-border: rgba(255, 255, 255, 0.1);
          --success: #22c55e; --error: #f87171; --warning: #facc15; --text-main: #f1f5f9;
        }
        * { box-sizing: border-box; transition: all 0.3s ease; }
        body {
          font-family: 'Cairo', sans-serif; background: var(--bg-deep); color: var(--text-main);
          margin: 0; padding: 0; min-height: 100vh;
          background-image: radial-gradient(circle at 0% 0%, rgba(112, 0, 255, 0.15) 0%, transparent 35%), radial-gradient(circle at 100% 100%, rgba(0, 242, 255, 0.15) 0%, transparent 35%);
        }
        .container { max-width: 480px; margin: 20px auto; background: var(--glass-bg); padding: 25px; border-radius: 24px; backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: var(--neon-cyan); font-weight: 900; text-shadow: 0 0 15px rgba(0, 242, 255, 0.4); }
        
        .balance-info-card { background: linear-gradient(135deg, rgba(112, 0, 255, 0.1), rgba(0, 242, 255, 0.1)); border-radius: 20px; padding: 20px; border: 1px solid var(--glass-border); margin-bottom: 20px; text-align: center; }
        .points-large { font-family: 'Montserrat'; font-size: 35px; display: block; color: var(--neon-cyan); }
        
        .limits-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .limit-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; font-size: 11px; }
        .limit-box span { display: block; color: var(--neon-cyan); font-weight: 700; font-size: 14px; }

        label { display:block; margin:15px 0 8px; font-weight:700; color: #94a3b8; font-size: 13px; }
        input { width: 100%; padding: 14px; border: 1px solid var(--glass-border); border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; outline: none; }
        input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }

        .calc-details { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin: 15px 0; display: flex; justify-content: space-around; text-align: center; border: 1px dashed var(--glass-border); }
        .calc-item b { display: block; font-family: 'Montserrat'; color: var(--neon-purple); }

        #confirmBtn { width: 100%; background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan)); color: #fff; font-weight: 900; padding: 16px; border: none; border-radius: 16px; cursor: pointer; font-size: 18px; margin-top: 10px; }
        #confirmBtn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }

        .status-msg { text-align: center; margin-top: 15px; font-weight: 700; padding: 12px; border-radius: 12px; display: none; }
        .success-msg { background: rgba(34, 197, 94, 0.2); color: var(--success); border: 1px solid var(--success); }
        .error-msg { background: rgba(248, 113, 113, 0.2); color: var(--error); border: 1px solid var(--error); }

        .history { margin-top: 35px; }
        table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.2); border-radius: 15px; overflow: hidden; }
        th { background: rgba(112, 0, 255, 0.2); color: var(--neon-cyan); padding: 12px; font-size: 11px; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--glass-border); font-size: 11px; }
        .row-pending { color: var(--warning); } .row-completed { color: var(--success); } .row-rejected { color: var(--error); }

        /* Modal */
        #customModal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(10px); }
        .modal-content { background: var(--bg-deep); padding: 30px; border-radius: 24px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--neon-purple); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h1>
    
    <div class="balance-info-card">
        <span style="font-size: 13px; opacity: 0.7;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØªØ§Ø­</span>
        <span class="points-large" id="pointsVal">0</span>
        <span style="font-size:16px;">â‰ˆ <span id="egpVal">0.00</span> Ø¬.Ù…</span>
        <div class="limits-row">
            <div class="limit-box">Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ… <span id="remainingLimitVal">200</span></div>
            <div class="limit-box">Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ¨Ù‚ÙŠØ© <span id="remainingOpsVal">--</span></div>
        </div>
    </div>

    <label>Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>
    <input type="text" id="walletVod" placeholder="010xxxxxxxx" maxlength="11">

    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø£Ù‚Ù„ Ø´ÙŠØ¡ 20 Ø¬.Ù…)</label>
    <input type="number" id="amountInp" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¬Ù†ÙŠØ©">

    <div class="calc-details">
        <div class="calc-item">Ø§Ù„Ø®ØµÙ… (10%)<b id="feeVal">0.00</b></div>
        <div class="calc-item">Ø§Ù„ØµØ§ÙÙŠ<b id="netVal" style="color:var(--neon-cyan)">0.00</b></div>
        <div class="calc-item">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©<b id="needPts">0</b></div>
    </div>

    <button id="confirmBtn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>
    <div id="msg" class="status-msg"></div>

    <div class="history">
        <h2 style="font-size:16px; text-align:center; color:var(--neon-cyan);">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±</h2>
        <table>
            <thead>
                <tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr>
            </thead>
            <tbody id="withdrawalsTable">
                <tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="customModal">
    <div class="modal-content">
        <h3 style="color:var(--neon-cyan)">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>
        <p style="font-size:14px;">Ø³ÙŠØªÙ… Ø³Ø­Ø¨ <span id="modalAmount"></span> Ø¬.Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… <br><b id="modalWallet" style="color:var(--neon-purple)"></b></p>
        <div class="modal-actions">
            <button onclick="closeModal()" style="background: #334155; color: #fff;">ØªØ¹Ø¯ÙŠÙ„</button>
            <button id="confirmActionBtn" style="background: var(--success); color: #fff;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = { 
        apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0", 
        authDomain: "am--rewards.firebaseapp.com", 
        projectId: "am--rewards" 
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const POINT_VALUE = 0.07;
    const LIMITS = { min: 20, maxDaily: 200, maxOps: 2 };

    let currentUserId, currentPoints, todayOps = 0, todayAmt = 0;

    const translateStatus = (s) => ({ 'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â³', 'completed': 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…', 'rejected': 'Ù…Ø±ÙÙˆØ¶ âŒ' }[s] || s);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserId = user.uid;
            loadUserData();
            loadWithdrawals();
            checkDailyLimits();
        } else {
            window.location.href = "login.html"; // ØªÙˆØ¬ÙŠÙ‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹
        }
    });

    function loadUserData() {
        db.collection('users').doc(currentUserId).onSnapshot(doc => {
            if (doc.exists) {
                currentPoints = doc.data().points || 0;
                document.getElementById('pointsVal').textContent = Math.floor(currentPoints).toLocaleString();
                document.getElementById('egpVal').textContent = (currentPoints * POINT_VALUE).toFixed(2);
                updateCalc();
            }
        });
    }

    async function checkDailyLimits() {
        const start = new Date(); start.setUTCHours(0,0,0,0);
        const snap = await db.collection("withdrawals")
            .where("userId", "==", currentUserId)
            .where("date", ">=", start).get();
        
        todayOps = 0; todayAmt = 0;
        snap.forEach(doc => { 
            if(doc.data().status !== 'rejected') { 
                todayOps++; todayAmt += doc.data().amount; 
            } 
        });
        
        document.getElementById('remainingOpsVal').textContent = Math.max(0, LIMITS.maxOps - todayOps);
        document.getElementById('remainingLimitVal').textContent = Math.max(0, LIMITS.maxDaily - todayAmt).toFixed(2);
    }

    function loadWithdrawals() {
        db.collection("withdrawals")
            .where("userId", "==", currentUserId)
            .orderBy("date", "desc").limit(8)
            .onSnapshot(snap => {
                const table = document.getElementById('withdrawalsTable');
                table.innerHTML = "";
                if (snap.empty) {
                    table.innerHTML = "<tr><td colspan='4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø­ÙˆØ¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</td></tr>";
                    return;
                }
                snap.forEach(doc => {
                    const w = doc.data();
                    const tr = document.createElement('tr');
                    tr.className = `row-${w.status}`;
                    tr.innerHTML = `
                        <td>${w.amount} Ø¬</td>
                        <td style="color:var(--neon-cyan)">${w.net ? w.net.toFixed(2) : '--'}</td>
                        <td>${translateStatus(w.status)}</td>
                        <td>${w.date ? w.date.toDate().toLocaleDateString('ar-EG') : '--'}</td>
                    `;
                    table.appendChild(tr);
                });
            });
    }

    function updateCalc() {
        const amtVal = document.getElementById('amountInp').value;
        const amt = parseFloat(amtVal);
        const wallet = document.getElementById('walletVod').value.trim();
        
        if (amtVal && amt >= LIMITS.min) {
            const ptsNeeded = Math.ceil(amt / POINT_VALUE);
            document.getElementById('feeVal').textContent = (amt * 0.1).toFixed(2);
            document.getElementById('netVal').textContent = (amt * 0.9).toFixed(2);
            document.getElementById('needPts').textContent = ptsNeeded.toLocaleString();
            
            const isWalletOk = /^010\d{8}$/.test(wallet);
            const isPointsOk = ptsNeeded <= currentPoints;
            const isLimitsOk = (todayAmt + amt) <= LIMITS.maxDaily && todayOps < LIMITS.maxOps;
            
            document.getElementById('confirmBtn').disabled = !(isWalletOk && isPointsOk && isLimitsOk);
        } else {
            document.getElementById('confirmBtn').disabled = true;
        }
    }

    document.getElementById('amountInp').oninput = updateCalc;
    document.getElementById('walletVod').oninput = updateCalc;

    document.getElementById('confirmBtn').onclick = () => {
        document.getElementById('modalAmount').textContent = document.getElementById('amountInp').value;
        document.getElementById('modalWallet').textContent = document.getElementById('walletVod').value;
        document.getElementById('customModal').style.display = 'flex';
    };

    function closeModal() { document.getElementById('customModal').style.display = 'none'; }

    document.getElementById('confirmActionBtn').onclick = async () => {
        closeModal();
        const btn = document.getElementById('confirmBtn');
        const msgBox = document.getElementById('msg');
        
        btn.disabled = true;
        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ...";
        msgBox.style.display = "none";

        try {
            const response = await fetch('/api/withdraw', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUserId,
                    amount: parseFloat(document.getElementById('amountInp').value),
                    wallet: document.getElementById('walletVod').value.trim()
                })
            });

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ JSON
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                const data = await response.json();
                msgBox.textContent = (response.ok ? "âœ… " : "âŒ ") + data.message;
                msgBox.className = `status-msg show ${response.ok ? 'success-msg' : 'error-msg'}`;
                if (response.ok) document.getElementById('amountInp').value = "";
            } else {
                throw new Error("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
            }
        } catch (err) {
            msgBox.textContent = "âŒ " + err.message;
            msgBox.className = "status-msg show error-msg";
        } finally {
            btn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨";
            updateCalc();
            checkDailyLimits();
        }
    };
</script>

</body>
</html>
