<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طلب سحب الأرباح | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background:#f5f5f5; margin:0; padding:0; }
    .container { max-width:600px; margin:50px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; margin-bottom:20px; }
    label { display:block; margin:10px 0 5px; }
    input, select, button { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px; }
    .wallet-box { display:none; margin-bottom:10px; }
    .wallet-box.show { display:block; }
    .info { display:flex; justify-content:space-between; margin-bottom:10px; }
    .info div { width:48%; background:#f0f0f0; padding:10px; border-radius:5px; text-align:center; }
    #confirmModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
    #confirmModal.show { display:flex; }
    .modal-content { background:#fff; padding:20px; border-radius:10px; max-width:400px; width:90%; }
    .modal-content h2 { text-align:center; margin-bottom:20px; }
    .modal-content div { margin-bottom:10px; }
    .modal-buttons { display:flex; justify-content:space-between; }
    .modal-buttons button { width:48%; }
    .msg { color:red; text-align:center; margin-bottom:10px; }
    .ok { color:green; text-align:center; margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>طلب سحب الأرباح</h1>
    <div class="info">
      <div>رصيدك: <span id="pointsVal">0</span></div>
      <div>ما يعادل: <span id="egpVal">0.00</span> جم</div>
    </div>

    <label for="methodSel">اختر طريقة الدفع</label>
    <select id="methodSel">
      <option value="vodafone">فودافون كاش</option>
      <option value="etisalat">اتصالات كاش</option>
      <option value="orange">اورنج كاش</option>
    </select>

    <div id="box-vodafone" class="wallet-box show">
      <label>رقم محفظة فودافون</label>
      <input type="text" id="walletVod" placeholder="ادخل رقم المحفظة">
    </div>
    <div id="box-etisalat" class="wallet-box">
      <label>رقم محفظة اتصالات</label>
      <input type="text" id="walletEts" placeholder="ادخل رقم المحفظة">
    </div>
    <div id="box-orange" class="wallet-box">
      <label>رقم محفظة اورنج</label>
      <input type="text" id="walletOrg" placeholder="ادخل رقم المحفظة">
    </div>

    <label>المبلغ المراد سحبه</label>
    <input type="number" id="amountInp" placeholder="ادخل المبلغ">

    <div class="info">
      <div>الخصم: <span id="feeVal">0.00</span> جم</div>
      <div>صافي المبلغ: <span id="netVal">0.00</span> جم</div>
    </div>
    <div>النقاط المطلوبة: <span id="needPts">0</span></div>
    <div>الحد المتبقي اليومي: <span id="leftCap">0</span></div>
    <div>عدد الطلبات المتبقية: <span id="leftCount">0</span></div>

    <button id="confirmBtn">تأكيد السحب</button>

    <div class="msg" id="msg"></div>
    <div class="ok" id="ok"></div>
  </div>

  <div id="confirmModal">
    <div class="modal-content">
      <h2>تأكيد طلب السحب</h2>
      <div>طريقة الدفع: <span id="c_method"></span></div>
      <div>المبلغ الإجمالي: <span id="c_gross"></span></div>
      <div>الخصم: <span id="c_fee"></span></div>
      <div>صافي المبلغ: <span id="c_net"></span></div>
      <div>النقاط المستخدمة: <span id="c_pts"></span></div>
      <div class="modal-buttons">
        <button onclick="submitWithdrawal()">تأكيد</button>
        <button onclick="closeConfirm()">إلغاء</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.firebasestorage.app",
      messagingSenderId: "744783579735",
      appId: "1:744783579735:web:45e00de9998893bbc9b112",
      measurementId: "G-CV3GLT2TTJ"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const POINT_VALUE_EGP = 0.07; // قيمة النقطة بالجيبه
    const LIMITS = {
      vodafone: { label:'فودافون كاش', min:25, maxDaily:100, maxCount:3 },
      etisalat: { label:'اتصالات كاش', min:25, maxDaily:100, maxCount:3 },
      orange: { label:'اورنج كاش', min:25, maxDaily:100, maxCount:3 }
    };

    const methodSel = document.getElementById('methodSel');
    const amountInp = document.getElementById('amountInp');
    const pointsVal = document.getElementById('pointsVal');
    const egpVal = document.getElementById('egpVal');

    const walletVod = document.getElementById('walletVod');
    const walletEts = document.getElementById('walletEts');
    const walletOrg = document.getElementById('walletOrg');

    const boxVodafone = document.getElementById('box-vodafone');
    const boxEtisalat = document.getElementById('box-etisalat');
    const boxOrange = document.getElementById('box-orange');

    const feeVal = document.getElementById('feeVal');
    const netVal = document.getElementById('netVal');
    const needPts = document.getElementById('needPts');

    const leftCount = document.getElementById('leftCount');
    const leftCap = document.getElementById('leftCap');

    const msg = document.getElementById('msg');
    const ok = document.getElementById('ok');

    const confirmModal = document.getElementById('confirmModal');
    const c_method = document.getElementById('c_method');
    const c_gross = document.getElementById('c_gross');
    const c_fee = document.getElementById('c_fee');
    const c_net = document.getElementById('c_net');
    const c_pts = document.getElementById('c_pts');

    let userData = null;

    function updateDisplay() {
      if (!userData) return;
      const points = userData.points || 0;
      pointsVal.textContent = points + ' نقطة';
      const egp = points * POINT_VALUE_EGP;
      egpVal.textContent = egp.toFixed(2);

      const method = methodSel.value;
      const limit = LIMITS[method];

      const withdrawalsToday = userData.withdrawals?.filter(w => w.method === method && isToday(new Date(w.date))) || [];
      const withdrawnAmountToday = withdrawalsToday.reduce((acc,w)=>acc+w.amount,0);
      const leftAmount = limit.maxDaily - withdrawnAmountToday;
      const leftRequests = limit.maxCount - withdrawalsToday.length;

      leftCount.textContent = leftRequests>0?leftRequests:0;
      leftCap.textContent = leftAmount>0?leftAmount.toFixed(2)+' جم':'0.00 جم';

      const amt = parseFloat(amountInp.value);
      if(isNaN(amt)||amt<limit.min||amt>leftAmount||leftRequests<=0){
        feeVal.textContent='0.00'; netVal.textContent='0.00'; needPts.textContent='0'; return;
      }
      const fee = amt*0.10;
      const net = amt - fee;
      const neededPoints = Math.ceil(amt/POINT_VALUE_EGP);
      feeVal.textContent=fee.toFixed(2); netVal.textContent=net.toFixed(2); needPts.textContent=neededPoints;
    }

    function isToday(date){ const now=new Date(); return date.getDate()===now.getDate() && date.getMonth()===now.getMonth() && date.getFullYear()===now.getFullYear(); }

    methodSel.addEventListener('change',()=>{
      const val=methodSel.value;
      boxVodafone.classList.toggle('show',val==='vodafone');
      boxEtisalat.classList.toggle('show',val==='etisalat');
      boxOrange.classList.toggle('show',val==='orange');
      updateDisplay();
    });

    amountInp.addEventListener('input',updateDisplay);
    methodSel.addEventListener('change',updateDisplay);

    document.getElementById('confirmBtn').addEventListener('click',()=>openConfirm());

    function openConfirm(){
      msg.style.display='none'; ok.style.display='none';
      if(!userData){ msg.textContent='يرجى تسجيل الدخول أولاً.'; msg.style.display='block'; return; }

      const method = methodSel.value;
      const limit = LIMITS[method];
      const amt = parseFloat(amountInp.value);
      if(isNaN(amt)){ msg.textContent='يرجى إدخال مبلغ صالح.'; msg.style.display='block'; return; }
      if(amt<limit.min){ msg.textContent=`الحد الأدنى للسحب هو ${limit.min} جنيه.`; msg.style.display='block'; return; }
      if(userData.points*POINT_VALUE_EGP<amt){ msg.textContent='رصيدك غير كافٍ.'; msg.style.display='block'; return; }

      const withdrawalsToday = userData.withdrawals?.filter(w=>w.method===method && isToday(new Date(w.date)))||[];
      const withdrawnAmountToday = withdrawalsToday.reduce((acc,w)=>acc+w.amount,0);
      const leftAmount = limit.maxDaily-withdrawnAmountToday;
      const leftRequests = limit.maxCount-withdrawalsToday.length;
      if(amt>leftAmount){ msg.textContent=`الحد الأقصى المتبقي للسحب اليومي هو ${leftAmount.toFixed(2)} جنيه.`; msg.style.display='block'; return; }
      if(leftRequests<=0){ msg.textContent='وصلت الحد الأقصى لعدد الطلبات اليوم.'; msg.style.display='block'; return; }

      let walletNumber=''; if(method==='vodafone') walletNumber=walletVod.value.trim();
      else if(method==='etisalat') walletNumber=walletEts.value.trim();
      else if(method==='orange') walletNumber=walletOrg.value.trim();
      if(!walletNumber.match(/^01[0-9]{9}$/)){ msg.textContent='يرجى إدخال رقم محفظة صالح (11 رقم يبدأ بـ01).'; msg.style.display='block'; return; }

      const fee = amt*0.10; const net = amt-fee; const neededPoints = Math.ceil(amt/POINT_VALUE_EGP);
      c_method.textContent=limit.label; c_gross.textContent=amt.toFixed(2)+' جم';
      c_fee.textContent=fee.toFixed(2)+' جم'; c_net.textContent=net.toFixed(2)+' جم'; c_pts.textContent=neededPoints+' نقطة';
      confirmModal.classList.add('show');
    }

    function closeConfirm(){ confirmModal.classList.remove('show'); }

    async function submitWithdrawal(){
      const method = methodSel.value; const limit=LIMITS[method]; const amt=parseFloat(amountInp.value);
      const fee=amt*0.10; const net=amt-fee; const neededPoints=Math.ceil(amt/POINT_VALUE_EGP);
      let walletNumber=''; if(method==='vodafone') walletNumber=walletVod.value.trim();
      else if(method==='etisalat') walletNumber=walletEts.value.trim();
      else if(method==='orange') walletNumber=walletOrg.value.trim();
      if(!userData){ msg.textContent='يرجى تسجيل الدخول أولاً.'; msg.style.display='block'; confirmModal.classList.remove('show'); return; }

      try{
        const userRef=db.collection('users').doc(userData.uid); const userDoc=await userRef.get();
        if(!userDoc.exists){ msg.textContent='حصل خطأ، بيانات المستخدم غير موجودة.'; msg.style.display='block'; confirmModal.classList.remove('show'); return; }
        const currentPoints=userDoc.data().points||0; if(currentPoints<neededPoints){ msg.textContent='رصيدك غير كافٍ.'; msg.style.display='block'; confirmModal.classList.remove('show'); return; }

        const withdrawalData={ uid:userData.uid, method:method, wallet:walletNumber, amount:amt, fee:fee, net:net, pointsUsed:neededPoints, date:new Date().toISOString(), status:'pending' };

        await db.runTransaction(async t=>{ const doc=await t.get(userRef); const pts=doc.data().points||0; if(pts<neededPoints) throw 'رصيد النقاط غير كافٍ'; t.update(userRef,{points:pts-neededPoints}); const withdrawalsRef=userRef.collection('withdrawals'); t.set(withdrawalsRef.doc(),withdrawalData); });

        ok.textContent='تم إرسال طلب السحب بنجاح. سيتم المعالجة خلال 24 ساعة.'; ok.style.display='block'; msg.style.display='none';
        userData.points-=neededPoints; userData.withdrawals.push(withdrawalData); updateDisplay();
        confirmModal.classList.remove('show'); amountInp.value=''; walletVod.value=''; walletEts.value=''; walletOrg.value='';
      } catch(error){ msg.textContent='حدث خطأ أثناء إرسال الطلب: '+error; msg.style.display='block'; confirmModal.classList.remove('show'); }
    }

    auth.onAuthStateChanged(async user=>{
      if(user){
        const userRef=db.collection('users').doc(user.uid); const doc=await userRef.get();
        if(!doc.exists){ await userRef.set({points:1500,withdrawals:[]}); userData={uid:user.uid,points:1500,withdrawals:[]}; }
        else userData={uid:user.uid,...doc.data()};
        updateDisplay();
      } else auth.signInAnonymously().catch(console.error);
    });

    window.onload=()=>{ updateDisplay(); };
  </script>
</body>
  </html>
