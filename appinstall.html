<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تثبيت التطبيقات | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: #f3f9ff;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #007bff;
      text-align: center;
    }
    .app-task {
      background: white;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 15px;
      margin: 15px auto;
      max-width: 450px;
    }
    .app-task h4 {
      margin: 0 0 10px;
    }
    .btn-install, .btn-confirm {
      display: inline-block;
      background-color: #007bff;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      margin: 5px;
    }
    .btn-confirm {
      background-color: #28a745;
    }
    .points {
      color: green;
      font-weight: bold;
    }
    .done-label {
      color: #28a745;
      font-weight: bold;
      margin-top: 10px;
      display: inline-block;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 10px 15px;
      border-radius: 10px;
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }
    .back-btn {
      display: block;
      width: fit-content;
      margin: 30px auto 0;
      background-color: #28a745;
      color: white;
      padding: 12px 25px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
</head>
<body>
  <h2>📲 تثبيت التطبيقات - احصل على النقاط</h2>
  <div id="appsContainer">جاري تحميل التطبيقات...</div>
  <a href="dashboard.html" class="back-btn">🔙 العودة إلى لوحة التحكم</a>

  <script>
    let userId = null;
    const today = new Date().toISOString().slice(0, 10);
    let progressKey = "";

    const apps = [
      {
        title: "ClipClaps",
        description: "اربح المال من مشاهدة الفيديوهات والمكافآت اليومية.",
        link: "https://play.google.com/store/apps/details?id=com.sanhe.clipclaps",
        points: 30
      },
      {
        title: "CashZine",
        description: "تطبيق لربح المال من قراءة الأخبار والدعوات.",
        link: "https://play.google.com/store/apps/details?id=com.jifen.qukan",
        points: 30
      },
      {
        title: "Lucky Money",
        description: "اربح المال من الألعاب اليومية وبطاقات الحظ.",
        link: "https://play.google.com/store/apps/details?id=com.luckymoney.cash.earn.make.money",
        points: 25
      },
      {
        title: "Current Rewards",
        description: "استمع للموسيقى واربح المال.",
        link: "https://play.google.com/store/apps/details?id=io.current.music",
        points: 25
      },
      {
        title: "Make Money",
        description: "أكمل الاستبيانات والمهام واربح النقود.",
        link: "https://play.google.com/store/apps/details?id=com.makemoney.android",
        points: 30
      }
    ];

    function saveProgress(completed) {
      localStorage.setItem(progressKey, JSON.stringify(completed));
    }

    function confirmInstall(index, points, buttonDiv, completed) {
      if (completed.includes(index)) return;

      completed.push(index);
      saveProgress(completed);

      db.collection("users").doc(userId).set({
        points: firebase.firestore.FieldValue.increment(points)
      }, { merge: true }).then(() => {
        const todayKey = new Date().toISOString().slice(0, 10);
        db.collection("users").doc(userId).collection("progress").doc(todayKey).set({
          installedApps: firebase.firestore.FieldValue.arrayUnion(apps[index].title)
        }, { merge: true });

        buttonDiv.innerHTML = `
          <span class="done-label">✅ تمت المهمة</span>
          <div class="success-message">🎉 تم تثبيت التطبيق وتمت إضافة النقاط بنجاح!</div>
        `;
      });
    }

    function startTimer(index, points, completed) {
      const confirmBtn = document.getElementById(`confirm-btn-${index}`);
      const timer = document.getElementById(`timer-${index}`);
      let seconds = 30;

      const countdown = setInterval(() => {
        seconds--;
        timer.textContent = `⏳ انتظر ${seconds} ثانية...`;
        if (seconds <= 0) {
          clearInterval(countdown);
          timer.remove();
          confirmBtn.style.display = "inline-block";
        }
      }, 1000);
    }

    function renderApps(completed) {
      const container = document.getElementById("appsContainer");
      container.innerHTML = "";

      apps.forEach((app, index) => {
        const div = document.createElement("div");
        div.className = "app-task";

        const buttonDiv = document.createElement("div");
        const confirmId = `confirm-btn-${index}`;
        const timerId = `timer-${index}`;

        if (completed.includes(index)) {
          buttonDiv.innerHTML = `<span class="done-label">✅ تمت المهمة</span>`;
        } else {
          buttonDiv.innerHTML = `
            <a href="${app.link}" target="_blank" class="btn-install" onclick="startTimer(${index}, ${app.points}, completed)">تثبيت الآن</a>
            <div id="${timerId}" style="margin-top:10px;color:#555;">⏳ انتظر 30 ثانية...</div>
            <button id="${confirmId}" class="btn-confirm" style="display:none;" onclick="confirmInstall(${index}, ${app.points}, this.parentElement, completed)">تم التثبيت</button>
          `;
        }

        div.innerHTML = `
          <h4>📱 ${app.title}</h4>
          <p>${app.description}</p>
          <p class="points">💰 ${app.points} نقاط</p>
        `;
        div.appendChild(buttonDiv);
        container.appendChild(div);
      });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        localStorage.setItem("userId", userId);
        progressKey = `installed_apps_${userId}_${today}`;
        const completed = JSON.parse(localStorage.getItem(progressKey)) || [];
        renderApps(completed);
      } else {
        alert("⚠️ يجب تسجيل الدخول أولاً.");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
