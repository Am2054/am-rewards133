<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>طلب سحب الأرباح | Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
/* نفس الـ CSS اللي عندك (محفوظ كما هو) */
body {
  font-family: 'Cairo', sans-serif;
  background: #0f172a linear-gradient(135deg, #0f172a 0%, #38bdf8 100%);
  color: #f1f5f9;
  margin: 0; padding: 0;
  min-height: 100vh;
  position: relative;
  overflow: hidden;
}
body::before {
  content: "";
  position: fixed;
  top:0; left:0; width:100vw; height:100vh; z-index:0;
  background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80') no-repeat center center;
  background-size: cover;
  opacity: 0.22;
  filter: blur(5px) brightness(1.2);
  animation: bgmove 20s infinite alternate;
}
@keyframes bgmove {
  0% { background-position: center top; }
  100% { background-position: center bottom; }
}
.container {
  max-width: 480px;
  margin: 30px auto;
  background: rgba(15, 23, 42, 0.94);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 0 30px rgba(56,189,248,0.35), 0 0 80px 0 rgba(56,189,248,0.1);
  position: relative;
  z-index: 2;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
  color: #38bdf8;
  font-size: 24px;
  letter-spacing: 1px;
}
label { display:block; margin:10px 0 5px; font-weight:600; }
input {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid #334155;
  border-radius: 8px;
  background: #1e293b;
  color: #f1f5f9;
  font-size: 15px;
}
input::placeholder { color:#94a3b8; }
.info {
  background: #1e293b;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 12px;
  text-align: center;
  font-size: 15px;
  box-shadow: 0 0 8px #0ea5e9a1;
}
button {
  width: 100%;
  background: linear-gradient(90deg, #38bdf8 0%, #0ea5e9 100%);
  color: #0f172a;
  font-weight: 700;
  padding: 12px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.3s;
  font-size: 17px;
  box-shadow: 0 2px 10px #38bdf863;
}
button:hover { background: #0ea5e9; color: #fff; }
.msg { text-align:center; margin-top:10px; font-size:15px; }
.error { color:#f87171; }
.success { color:#22c55e; }

/* جدول السحوبات */
.history {
margin-top: 28px;
position: relative;
z-index: 1;
}
.history h2 {
font-size: 18px;
margin-bottom: 10px;
color: #38bdf8;
text-align: center;
letter-spacing: 1px;
}
table {
width: 100%;
border-collapse: collapse;
background: #1e293b;
border-radius: 8px;
overflow: hidden;
box-shadow: 0 0 10px #38bdf838;
}
th, td {
padding: 8px;
text-align: center;
border-bottom: 1px solid #334155;
font-size: 14px;
}
th {
background: #0ea5e9;
color: #0f172a;
}
.status {
font-weight: bold;
display: flex;
align-items: center;
justify-content: center;
gap: 5px;
}
.status-pending { color: orange; }
.status-completed { color: #22c55e; }
.status-rejected { color: #f87171; }
</style>
</head>
<body>
<div class="container">
  <h1>💸 طلب سحب الأرباح</h1>
  <div class="info">رصيدك الحالي: <span id="pointsVal">0</span> نقطة ≈ <span id="egpVal">0.00</span> جم</div>

  <label>رقم محفظة فودافون كاش</label>
  <input type="text" id="walletVod" placeholder="ادخل رقم المحفظة">

  <label>المبلغ المراد سحبه (20 - 200 جنيه)</label>
  <input type="number" id="amountInp" placeholder="ادخل المبلغ">

  <div class="info">الخصم: <span id="feeVal">0.00</span> جم | صافي: <span id="netVal">0.00</span> جم</div>
  <div class="info">النقاط المطلوبة: <span id="needPts">0</span></div>
  <button id="confirmBtn">تأكيد السحب</button>

  <div id="msg" class="msg"></div>

  <div class="history">
    <h2>📜 سجل طلبات السحب</h2>
    <table>
      <thead>
        <tr>
          <th>المبلغ</th>
          <th>الصافي</th>
          <th>الحالة</th>
          <th>التاريخ</th>
        </tr>
      </thead>
      <tbody id="withdrawalsTable"></tbody>
    </table>
  </div>

  <p style="margin-top:20px; color:#94a3b8; text-align:center; font-size:14px;">
    💡 تُحسب مكافأة الإحالة تلقائيًا عند كل عملية سحب يقوم بها المدعو.
  </p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain:"am--rewards.firebaseapp.com",
  projectId:"am--rewards"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const POINT_VALUE_EGP = 0.07;
const LIMITS = { min:20, maxDaily:200, maxOpsPerDay:2 };

const pointsVal=document.getElementById('pointsVal');
const egpVal=document.getElementById('egpVal');
const amountInp=document.getElementById('amountInp');
const walletVod=document.getElementById('walletVod');
const feeVal=document.getElementById('feeVal');
const netVal=document.getElementById('netVal');
const needPts=document.getElementById('needPts');
const msg=document.getElementById('msg');
const withdrawalsTable=document.getElementById('withdrawalsTable');
const confirmBtn=document.getElementById('confirmBtn');

let userId=null;
let unsubUserDoc = null;        // to unsubscribe user doc listener
let unsubWithdrawals = null;    // to unsubscribe withdrawals listener

// ensure calc initial state
function updateCalc(){
  const amt=parseFloat(amountInp.value);
  if(isNaN(amt)||amt<LIMITS.min){
    feeVal.textContent="0.00"; netVal.textContent="0.00"; needPts.textContent="0"; return;
  }
  const fee=amt*0.10;
  const net=amt-fee;
  const ptsNeeded=Math.ceil(amt/POINT_VALUE_EGP);
  feeVal.textContent=fee.toFixed(2);
  netVal.textContent=net.toFixed(2);
  needPts.textContent=ptsNeeded;
}
amountInp.addEventListener('input',updateCalc);
// call once on load
updateCalc();

auth.onAuthStateChanged(user=>{
  // unsubscribe previous listeners (if any) to avoid duplicates
  if(unsubUserDoc){ try{ unsubUserDoc(); }catch(e){/*ignore*/} unsubUserDoc = null; }
  if(unsubWithdrawals){ try{ unsubWithdrawals(); }catch(e){/*ignore*/} unsubWithdrawals = null; }

  if(user){
    userId = user.uid;

    // user doc realtime (points update)
    const userRef = db.collection('users').doc(userId);
    unsubUserDoc = userRef.onSnapshot(docSnap=>{
      if(!docSnap.exists){
        pointsVal.textContent = 0;
        egpVal.textContent = (0).toFixed(2);
        return;
      }
      const data = docSnap.data() || {};
      const points = Number(data.points || 0);
      pointsVal.textContent = points;
      egpVal.textContent = (points * POINT_VALUE_EGP).toFixed(2);
      // in case amount input depends on points we can re-run calc
      updateCalc();
    }, err=>{
      console.error("user doc snapshot error:", err);
    });

    // withdrawals realtime (use userId variable)
    const q = db.collection("withdrawals").where("userId","==", userId);
    unsubWithdrawals = q.onSnapshot(snapshot=>{
      withdrawalsTable.innerHTML="";
      if(snapshot.empty){
        withdrawalsTable.innerHTML=`<tr><td colspan="4">لا يوجد طلبات سحب بعد</td></tr>`;
        return;
      }
      let arr=[];
      snapshot.forEach(s=>{
        const w = s.data();
        let dateVal = 0;
        if (w.date) {
          if (typeof w.date === "string") dateVal = Date.parse(w.date) || 0;
          else if (w.date.toDate) dateVal = w.date.toDate().getTime();
        }
        arr.push({...w, dateVal});
      });
      arr.sort((a,b)=>b.dateVal-a.dateVal);
      arr.forEach(w=>{
        let dateStr="-";
        if(w.date && w.date.toDate){
          const dt=w.date.toDate();
          if(!isNaN(dt)) dateStr=dt.toLocaleDateString("ar-EG")+" - "+dt.toLocaleTimeString("ar-EG");
        }
        let statusClass="", icon="", statusText="";
        switch(w.status){
          case "pending": statusClass="status-pending"; icon="⏳"; statusText="معلق"; break;
          case "completed": statusClass="status-completed"; icon="✅"; statusText="مكتمل"; break;
          case "rejected": statusClass="status-rejected"; icon="❌"; statusText="مرفوض"; break;
          default: statusText=w.status||"-";
        }
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${w.amount||"-"} جم</td>
          <td>${w.net?Number(w.net).toFixed(2):"-"} جم</td>
          <td class="status ${statusClass}">${icon} ${statusText}</td>
          <td>${dateStr}</td>`;
        withdrawalsTable.appendChild(tr);
      });
    }, err=>{
      console.error("withdrawals snapshot error:", err);
    });

  } else {
    userId = null;
    // ensure UI cleaned
    pointsVal.textContent = 0;
    egpVal.textContent = (0).toFixed(2);
    withdrawalsTable.innerHTML = `<tr><td colspan="4">مرحبًا — الرجاء تسجيل الدخول</td></tr>`;
    window.location.href = "index.html";
  }
});

confirmBtn.addEventListener('click',async ()=>{
  msg.textContent=""; msg.className="msg";
  const amt=parseFloat(amountInp.value);
  const wallet=walletVod.value.trim();
  if(isNaN(amt)||amt<LIMITS.min){ msg.textContent="❌ الحد الأدنى للسحب 20 جم"; msg.classList.add("error"); return; }
  if(!wallet){ msg.textContent="❌ أدخل رقم المحفظة"; msg.classList.add("error"); return; }
  if(!userId){ msg.textContent="❌ خطأ: المستخدم غير مسجّل"; msg.classList.add("error"); return; }

  confirmBtn.disabled=true;
  try {
    const now=new Date();
    const start=new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0);
    const end=new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59);

    const snapshot=await db.collection("withdrawals").where("userId","==",userId).get();
    let todayOps=0,todayAmt=0;
    snapshot.forEach(doc=>{
      const d=doc.data();
      if(d.date?.toDate){
        const dd=d.date.toDate();
        if(dd>=start&&dd<=end){ todayOps++; todayAmt+=(+d.amount)||0; }
      }
    });

    if(todayOps>=LIMITS.maxOpsPerDay){ msg.textContent="❌ لقد وصلت للحد الأقصى (2 عملية سحب يوميًا)"; msg.classList.add("error"); confirmBtn.disabled=false; return; }
    if((todayAmt+amt)>LIMITS.maxDaily){ msg.textContent=`❌ لا يمكنك تجاوز ${LIMITS.maxDaily} جم يوميًا`; msg.classList.add("error"); confirmBtn.disabled=false; return; }

    if(!confirm(`هل تريد سحب ${amt} جم إلى ${wallet}؟`)){ confirmBtn.disabled=false; return; }

    const ptsNeeded=Math.ceil(amt/POINT_VALUE_EGP);
    await db.runTransaction(async tr=>{
      const userRef=db.collection("users").doc(userId);
      const userSnap=await tr.get(userRef);
      const userData=userSnap.data()||{};
      const points=Number(userData.points||0);
      if(points<ptsNeeded) throw "رصيد نقاط غير كافٍ";

      // نقص النقاط
      tr.update(userRef,{ points: firebase.firestore.FieldValue.increment(-ptsNeeded) });

      // سجّل طلب السحب
      const newWithdrawRef = db.collection("withdrawals").doc();
      tr.set(newWithdrawRef,{
        userId, method:"vodafone", wallet,
        amount:amt, fee:amt*0.10, net:amt-amt*0.10,
        pts:ptsNeeded, status:"pending",
        date:firebase.firestore.FieldValue.serverTimestamp()
      });

      // نظام الإحالة الجديد: مكافأة عند كل عملية سحب
      if(userData.referrerId){
        const referrerRef=db.collection("users").doc(userData.referrerId);
        // نحسب المكافأة: 10% من الصافي محوّلة إلى نقاط
        const netEgp = amt - amt*0.10;
        const bonusPoints = Math.floor((netEgp / POINT_VALUE_EGP) * 0.10);
        if(bonusPoints > 0){
          tr.update(referrerRef,{
            points: firebase.firestore.FieldValue.increment(bonusPoints),
            lastReferralBonusAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }
    });

    msg.textContent="✅ تم إرسال طلب السحب بنجاح. تمت إضافة مكافأة الإحالة (إن وُجدت).";
    msg.classList.add("success");
    amountInp.value=""; walletVod.value="";
    updateCalc();
  }catch(err){
    console.error("withdraw error:", err);
    msg.textContent="❌ "+(err?.toString?.() || err);
    msg.classList.add("error");
  }finally{
    confirmBtn.disabled=false;
  }
});
</script>
</body>
                                                                  </html>
