<!DOCTYPE html>  <html lang="ar" dir="rtl">  
<head>  
  <meta charset="utf-8" />  
  <title>نظام الإحالات | Am Rewards</title>  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">  
  <style>  
    :root{  
      --bg-1:#051424; --bg-2:#031226;  
      --glass: rgba(255,255,255,0.04);  
      --accent:#1fb6ff; --accent-2:#34d399;  
      --gold:#ffd369; --muted:#98a6b3;  
    }  
    *{box-sizing:border-box}  
    body{  
      margin:0; padding:0;  
      font-family:"Cairo",sans-serif;  
      background: radial-gradient(1200px 600px at 10% 10%, rgba(31,182,255,0.04), transparent),  
                  linear-gradient(160deg,var(--bg-1),var(--bg-2));  
      color:#e9f1f7; min-height:100vh;  
    }  
    .wrap{max-width:1100px;margin:28px auto;padding:18px}  
    .brand h1{margin:0;color:var(--accent);font-size:22px}  
    .brand p{margin:0;color:var(--muted);font-size:13px}  
    .summary{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}  
    .stat-card{  
      background:rgba(255,255,255,0.02);border:1px solid var(--glass);  
      border-radius:12px;padding:12px 16px;min-width:140px;text-align:right;  
    }  
    .stat-card .label{font-size:13px;color:var(--muted)}  
    .stat-card .value{font-size:20px;font-weight:800}  
    .btn{  
      border:0;padding:10px 14px;border-radius:10px;cursor:pointer;  
      font-weight:800;  
    }  
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#07101a}  
    .btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--muted)}  
    .card{  
      background:rgba(255,255,255,0.02);border:1px solid var(--glass);  
      border-radius:14px;padding:18px;margin-top:20px;  
      backdrop-filter:blur(8px);  
    }  
    .ref-row{display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px}  
    .ref-code{font-size:18px;font-weight:900;color:#fff}  
    .ref-link-box{  
      background:rgba(0,0,0,0.25);padding:10px;border-radius:10px;  
      border:1px solid rgba(255,255,255,0.05);color:var(--muted);  
      direction:ltr;word-break:break-all;cursor:pointer;transition:0.2s;  
    }  
    table{width:100%;border-collapse:collapse;margin-top:16px}  
    thead th{font-size:13px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.05);padding:10px}  
    tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}  
    .tag{padding:4px 8px;border-radius:8px;font-weight:800;font-size:13px}  
    .tag.diff{background:rgba(255,211,105,0.07);color:var(--gold)}  
    .tag.bonus{background:rgba(31,182,255,0.08);color:var(--accent)}  
    .small-muted{font-size:13px;color:var(--muted)}  
    #toast {  
      position: fixed; left: 50%; transform: translateX(-50%);  
      bottom: 20px; background: linear-gradient(90deg,#16a34a,#34d399);  
      color: #062; padding: 10px 16px; border-radius: 10px;  
      box-shadow: 0 10px 30px rgba(2,6,23,0.5);  
      opacity: 0; transition: opacity .25s ease; font-weight:800;  
    }  
    #toast.show { opacity: 1; }  
  </style>  
</head>  
<body>  
  <div class="wrap">  
    <div class="brand">  
      <h1>Am Rewards — نظام الإحالات</h1>  
      <p id="relativeLast">آخر تحديث: -</p>  
    </div>  <div class="summary">  
  <div class="stat-card"><div class="label">عدد الإحالات</div><div class="value" id="referralCount">0</div></div>  
  <div class="stat-card"><div class="label">نقاط الإحالات</div><div class="value" id="referralPoints">0</div></div>  
  <button id="refreshBtn" class="btn ghost">🔄 تحديث</button>  
  <button id="copyBtn" class="btn primary">نسخ رابط الإحالة</button>  
</div>  

<div class="card">  
  <div class="ref-row">  
    <div>  
      <div class="small-muted">كود الإحالة</div>  
      <div class="ref-code" id="referralCode">—</div>  
    </div>  
    <div>  
      <div class="small-muted" style="text-align:left">رابط التسجيل</div>  
      <div class="ref-link-box" id="referralLink">-</div>  
    </div>  
  </div>  

  <div class="table-wrap">  
    <table>  
      <thead>  
        <tr>  
          <th>#</th><th>المدعو</th><th>نقاطه الحالية</th><th>النقاط السابقة</th><th>الفرق</th><th>ربحك</th>  
        </tr>  
      </thead>  
      <tbody id="tableBody"><tr><td colspan="6" class="small-muted">جارِ التحميل...</td></tr></tbody>  
    </table>  
  </div>  
  <div id="updateSummary" class="small-muted" style="margin-top:10px">—</div>  
</div>

  </div>    <div id="toast">تم</div>    <script type="module">  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";  
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";  
    import {   
      getFirestore, doc, getDoc, collection, query, where, getDocs,  
      onSnapshot, runTransaction, increment, serverTimestamp  
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";  
  
    const firebaseConfig = {  
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
      authDomain: "am--rewards.firebaseapp.com",  
      projectId: "am--rewards",  
      storageBucket: "am--rewards.appspot.com",  
      messagingSenderId: "428582312150",  
      appId: "1:428582312150:web:44e35a70e457e7db4c45df"  
    };  
    const app = initializeApp(firebaseConfig);  
    const auth = getAuth(app);  
    const db = getFirestore(app);  
  
    const referralCountEl = document.getElementById('referralCount');  
    const referralPointsEl = document.getElementById('referralPoints');  
    const referralCodeEl = document.getElementById('referralCode');  
    const referralLinkEl = document.getElementById('referralLink');  
    const tableBody = document.getElementById('tableBody');  
    const refreshBtn = document.getElementById('refreshBtn');  
    const copyBtn = document.getElementById('copyBtn');  
    const relativeLast = document.getElementById('relativeLast');  
    const updateSummary = document.getElementById('updateSummary');  
    const toast = document.getElementById('toast');  
  
    let currentUser = null;  
  
    function showToast(msg){  
      toast.textContent = msg;  
      toast.classList.add('show');  
      setTimeout(()=>toast.classList.remove('show'),3500);  
    }  
  
    function relativeTime(ts){  
      if(!ts) return "-";  
      const d = ts.toDate ? ts.toDate() : new Date(ts);  
      const diff = Math.floor((Date.now() - d.getTime())/60000);  
      if(diff < 1) return "الآن";  
      if(diff < 60) return `منذ ${diff} دقيقة`;  
      const h = Math.floor(diff/60);  
      return h < 24 ? `منذ ${h} ساعة` : `منذ ${Math.floor(h/24)} يوم`;  
    }  
  
    async function loadReferrals(user){  
      const userRef = doc(db,"users",user.uid);  
      const snap = await getDoc(userRef);  
      if(!snap.exists()) return;  
      const data = snap.data();  
  
      referralCodeEl.textContent = data.referralCode || "—";  
      referralLinkEl.textContent = `${location.origin}/signup.html?ref=${data.referralCode||''}`;  
      referralCountEl.textContent = data.referralCount || 0;  
      referralPointsEl.textContent = data.referralPoints || 0;  
      relativeLast.textContent = data.lastReferralUpdateDate ? "آخر تحديث: "+relativeTime(data.lastReferralUpdateDate) : "آخر تحديث: -";  
  
      const q = query(collection(db,"users"), where("referralBy","==",data.referralCode||"__NO__"));  
      const subs = onSnapshot(q, async (snapQ)=>{  
        tableBody.innerHTML = "";  
        if(snapQ.empty){ tableBody.innerHTML=`<tr><td colspan="6" class="small-muted">لا يوجد مدعوون</td></tr>`; return;}  
        let idx=0, totalBonus=0;  
        for(const docSnap of snapQ.docs){  
          idx++;  
          const invited=docSnap.data();  
          const invitedId=docSnap.id;  
          const now=Number(invited.points||0);  
          const prev=Number(invited.totalReferralGiven||0);  
          const diff=Math.max(now-prev,0);  
          const bonus=Math.floor(diff*0.1);  
          if(diff>0){  
            await runTransaction(db,async(t)=>{  
              const invRef=doc(db,"users",invitedId);  
              const invDoc=await t.get(invRef);  
              if(!invDoc.exists()) return;  
              t.update(invRef,{totalReferralGiven:now});  
              t.update(userRef,{  
                referralPoints:increment(bonus),  
                points:increment(bonus),  
                lastReferralUpdateDate:serverTimestamp()  
              });  
            });  
            totalBonus+=bonus;  
          }  
          const row=document.createElement("tr");  
          row.innerHTML=`<td>${idx}</td>  
            <td>${invited.name||'مستخدم'}</td>  
            <td>${now}</td><td>${prev}</td>  
            <td>${diff>0?`<span class='tag diff'>${diff}</span>`:"0"}</td>  
            <td>${bonus>0?`<span class='tag bonus'>+${bonus}</span>`:"0"}</td>`;  
          tableBody.appendChild(row);  
        }  
        if(totalBonus>0){ showToast(`🎉 تمت إضافة ${totalBonus} نقطة!`); updateSummary.textContent=`تمت إضافة ${totalBonus} نقطة جديدة`; }  
        else updateSummary.textContent="لا توجد نقاط جديدة";  
      });  
    }  
  
    onAuthStateChanged(auth,(user)=>{  
      if(!user) return location.href="login.html";  
      currentUser=user;  
      loadReferrals(user);  
    });  
  
    refreshBtn.onclick=()=>{ if(currentUser) loadReferrals(currentUser); };  
    copyBtn.onclick=async()=>{  
      try{  
        await navigator.clipboard.writeText(referralLinkEl.textContent);  
        showToast("تم نسخ الرابط ✅");  
      }catch{ showToast("فشل النسخ ❌"); }  
    };  
  </script>  </body>  
  </html>
