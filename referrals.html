<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { 
      font-family: 'Cairo', sans-serif; 
      background:#f8f9fa; 
      color:#333; 
      text-align:center; 
      padding:20px; 
    }
    .card { 
      background:#fff; 
      padding:20px; 
      border-radius:12px; 
      margin:15px auto; 
      width:90%; 
      max-width:760px; 
      box-shadow:0 2px 12px rgba(0,0,0,0.08); 
      text-align: right;
    }
    h2 { text-align:center; margin-bottom:10px; color:#0f172a; }
    .row { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .input-wrap { width:100%; display:flex; gap:10px; align-items:center; justify-content:center; }
    input[type="text"] { 
      width:78%; 
      padding:10px; 
      border-radius:8px; 
      border:1px solid #ddd; 
      background:#fafafa; 
      color:#111; 
      text-align:center; 
    }
    button { 
      background:#0ea5e9; 
      color:#fff; 
      border:none; 
      padding:10px 14px; 
      border-radius:8px; 
      cursor:pointer; 
      font-weight:700;
    }
    button:hover { background:#0891b2; }
    .stats { display:flex; gap:12px; justify-content:space-between; flex-wrap:wrap; }
    .stat-box { background:#f1f5f9; padding:12px 14px; border-radius:10px; min-width:180px; box-shadow:0 2px 6px rgba(2,6,23,0.03); }
    ul { list-style:none; padding:0; margin:0; }
    li { 
      background:#fff; 
      margin:8px 0; 
      padding:12px; 
      border-radius:8px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      border:1px solid #eef2f7;
    }
    .name { font-weight:700; color:#0f172a; }
    .points { color:#0ea5e9; font-weight:800; }
    .bonus { color:#059669; font-weight:800; }
    .empty { color:#6b7280; padding:12px 0; }
    @media (max-width:640px){
      .stat-box{ min-width: 48%; }
      input[type="text"]{ width:70%; }
    }
  </style>
</head>
<body>
  <h2>ðŸŒŸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª â€” Am Rewards</h2>

  <div class="card">
    <h3>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h3>
    <div class="input-wrap">
      <input type="text" id="referralLink" readonly aria-label="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©">
      <button id="copyBtn">ðŸ“‹ Ù†Ø³Ø®</button>
    </div>
  </div>

  <div class="card">
    <div class="stats">
      <div class="stat-box">
        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div>
        <div style="font-size:20px;font-weight:900" id="referralCount">0</div>
      </div>
      <div class="stat-box">
        <div>Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (Ù…Ø¬Ù…Ù‘Ø¹Ø©)</div>
        <div style="font-size:20px;font-weight:900" id="referralPoints">0</div>
      </div>
      <div class="stat-box">
        <div>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©</div>
        <div style="font-size:14px;color:#374151">Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ùˆ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 10% Ù…Ù† Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ðŸ‘¥ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ‘ÙˆÙ†</h3>
    <ul id="invitedList"></ul>
    <div id="invitedEmpty" class="empty" style="display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø¹ÙˆÙ‘ÙˆÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, doc, updateDoc, onSnapshot, collection, query, where, onSnapshot as onQSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ====== Ù‡Ù†Ø§ firebaseConfig Ø¨ØªØ§Ø¹ Ù…Ø´Ø±ÙˆØ¹Ùƒ (Ù…ÙˆØ¬ÙˆØ¯ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.appspot.com",
      messagingSenderId: "428582312150",
      appId: "1:428582312150:web:44e35a70e457e7db4c45df"
    };
    // ============================================================

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const copyBtn = document.getElementById('copyBtn');
    copyBtn.addEventListener('click', async () => {
      const link = document.getElementById('referralLink').value || '';
      if (!link) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø¢Ù†.');
      try {
        await navigator.clipboard.writeText(link);
        alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© âœ…');
      } catch (e) {
        // fallback
        const el = document.getElementById('referralLink');
        el.select();
        document.execCommand('copy');
        alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© âœ…');
      }
    });

    onAuthStateChanged(auth, user => {
      if (!user) {
        // Ù„Ùˆ Ù…Ø´ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - Ø±Ø¬Ø¹Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.location.href = "index.html";
        return;
      }

      const userRef = doc(db, "users", user.uid);

      // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (real-time)
      onSnapshot(userRef, async (snap) => {
        if (!snap.exists()) {
          // Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø³Ø§Ø¨Ù‡ - Ø±Ø¬Ø¹Ù‡
          console.warn("user doc not found");
          return;
        }
        const data = snap.data();

        // Ù„Ùˆ Ù…ÙÙŠØ´ referralCode - Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯ (6 Ø£Ø­Ø±Ù Ù…Ù† uid)
        if (!data.referralCode || data.referralCode === "") {
          const newCode = user.uid.slice(0,6).toUpperCase();
          try { await updateDoc(userRef, { referralCode: newCode }); }
          catch(e){ console.warn("failed to set referralCode:", e); }
          data.referralCode = newCode;
        }

        // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
        const link = `${window.location.origin}/signup.html?ref=${data.referralCode}`;
        document.getElementById('referralLink').value = link;

        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        document.getElementById('referralCount').innerText = data.referralCount || 0;
        document.getElementById('referralPoints').innerText = data.referralPoints || 0;
      });

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† Ø¨Ø´ÙƒÙ„ Ø­ÙŠ (real-time)
      const q = query(collection(db, "users"), where("referralBy", "==", user.uid));
      onQSnapshot(q, (snapshot) => {
        const invitedList = document.getElementById('invitedList');
        invitedList.innerHTML = "";
        if (snapshot.empty) {
          document.getElementById('invitedEmpty').style.display = 'block';
          return;
        } else {
          document.getElementById('invitedEmpty').style.display = 'none';
        }

        snapshot.forEach(docSnap => {
          const invited = docSnap.data();
          const name = invited.name || invited.email || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
          const pts = Number(invited.points || 0);
          const bonus = Math.floor(pts * 0.10); // 10% ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù…Ù† Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯Ø¹Ùˆ Ø§Ù„Ø¢Ù†
          const li = document.createElement('li');
          li.innerHTML = `
            <span style="display:flex; gap:10px; align-items:center">
              <span class="name">${name}</span>
              <small style="color:#6b7280">(${docSnap.id.slice(0,6)})</small>
            </span>
            <span style="display:flex; gap:14px; align-items:center">
              <span class="points">${pts} Ù†Ù‚Ø·Ø©</span>
              <span class="bonus">+ ${bonus} (10%)</span>
            </span>
          `;
          invitedList.appendChild(li);
        });
      }, (err) => {
        console.error("invited onSnapshot error:", err);
      });
    });
  </script>
</body>
  </html>
