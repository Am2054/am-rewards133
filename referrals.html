<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª | Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #020617; --bg-2: #0f172a;
      --glass: rgba(255, 255, 255, 0.03);
      --accent: #00f2ff; --accent-2: #7000ff;
      --success: #22c55e; --danger: #f87171;
      --text: #f1f5f9; --muted: #94a3b8;
    }
    * { box-sizing: border-box; transition: 0.3s; }
    body {
      margin: 0; padding: 0; font-family: "Cairo", sans-serif;
      background: var(--bg-1); color: var(--text); min-height: 100vh;
      background-image: radial-gradient(circle at 0% 0%, rgba(112, 0, 255, 0.1), transparent 40%);
    }
    .wrap { max-width: 900px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .brand { text-align: center; margin-bottom: 30px; }
    .brand h1 { margin: 0; color: var(--accent); font-weight: 900; font-size: 28px; }
    .brand p { color: var(--muted); margin-top: 5px; }

    /* Stats */
    .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .stat-card {
      background: var(--glass); border: 1px solid rgba(255,255,255,0.05);
      border-radius: 20px; padding: 20px; text-align: center; backdrop-filter: blur(10px);
    }
    .stat-card .label { font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    .stat-card .value { font-size: 26px; font-weight: 900; color: #fff; }

    /* Ref Card */
    .card {
      background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 24px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    }
    .ref-title { font-weight: 700; font-size: 14px; color: var(--muted); margin-bottom: 10px; }
    .ref-code { font-size: 30px; font-weight: 900; color: var(--accent); letter-spacing: 4px; margin-bottom: 15px; }
    
    .ref-link-group { display: flex; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); }
    .ref-link-box { flex: 1; padding: 12px; font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; direction: ltr; }
    
    .btn-copy { background: linear-gradient(45deg, var(--accent-2), var(--accent)); border: none; padding: 10px 20px; border-radius: 12px; color: #fff; font-weight: 900; cursor: pointer; }
    .btn-copy:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); }

    /* Table */
    .table-section { margin-top: 40px; }
    .table-section h3 { font-size: 18px; color: var(--accent); margin-bottom: 15px; }
    .table-container { overflow-x: auto; border-radius: 15px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th { padding: 15px; text-align: right; font-size: 12px; color: var(--muted); background: rgba(255,255,255,0.02); }
    td { padding: 15px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.02); }
    
    .tag { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; }
    .tag-bonus { background: rgba(0, 242, 255, 0.1); color: var(--accent); }

    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: var(--success); color: #fff; padding: 12px 25px;
      border-radius: 50px; font-weight: 700; visibility: hidden; opacity: 0; z-index: 1000;
    }
    #toast.show { visibility: visible; opacity: 1; top: 40px; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="brand">
    <h1>ğŸš€ ØµØ§Ø±ÙˆØ® Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h1>
    <p>Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ø±Ø¨Ø­ 10% ÙƒØ§Ø´ Ù…Ù† ÙƒÙ„ Ø³Ø­Ø¨ Ù„ØµØ¯ÙŠÙ‚Ùƒ</p>
  </div>

  <div class="summary">
    <div class="stat-card">
      <div class="label">Ø£ØµØ¯Ù‚Ø§Ø¡ Ø³Ø¬Ù„ÙˆØ§</div>
      <div class="value" id="refCount">0</div>
    </div>
    <div class="stat-card">
      <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø±Ø¨Ø§Ø­Ùƒ</div>
      <div class="value" id="refEarnings">0.00 Ø¬</div>
    </div>
  </div>

  <div class="card">
    <div class="ref-title">ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</div>
    <div class="ref-code" id="userCode">------</div>
    
    <div class="ref-title">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø³Ø±ÙŠØ¹</div>
    <div class="ref-link-group">
      <div class="ref-link-box" id="refLink">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <button class="btn-copy" onclick="copyRef()">Ù†Ø³Ø®</button>
    </div>
  </div>

  <div class="table-section">
    <h3>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (Ø¢Ø®Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†)</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ØµØ¯ÙŠÙ‚</th>
            <th>Ø±ØµÙŠØ¯ Ù†Ù‚Ø§Ø·Ù‡</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³Ø­ÙˆØ¨Ø§ØªÙ‡</th>
            <th>Ø¹Ù…ÙˆÙ„ØªÙƒ Ù…Ù†Ù‡</th>
          </tr>
        </thead>
        <tbody id="refTable">
          <tr><td colspan="4" style="text-align:center; padding:30px; color:var(--muted);">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast">ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­! ğŸ“‹</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, onSnapshot, collection, query, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      onSnapshot(doc(db, "users", user.uid), (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        
        document.getElementById('userCode').textContent = data.referralCode || "------";
        // Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙˆØ¬Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯
        const fullLink = `${window.location.origin}/signup.html?ref=${data.referralCode}`;
        document.getElementById('refLink').textContent = fullLink;
        
        // Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ù…Ù† Ø­Ù‚Ù„ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø£Ùˆ Ø§Ù„Ø³ÙŠØ³ØªÙ…
        document.getElementById('refEarnings').textContent = `${(data.totalReferralEarnings || 0).toFixed(2)} Ø¬`;
        document.getElementById('refCount').textContent = data.referralCount || 0;
      });

      // 2. Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†
      const q = query(
        collection(db, "users"), 
        where("referredBy", "==", user.uid),
        limit(20)
      );

      onSnapshot(q, (snap) => {
        const tbody = document.getElementById('refTable');
        tbody.innerHTML = "";
        
        if (snap.empty) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--muted);">Ù„Ù… ÙŠØ³Ø¬Ù„ Ø£Ø­Ø¯ Ø¨Ø¹Ø¯ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¢Ù†! ğŸ“¢</td></tr>`;
          return;
        }

        snap.forEach(docSnap => {
          const u = docSnap.data();
          // Ø§Ù„Ø­Ø³Ø¨Ø©: Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù‡ÙŠ 10% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ø³Ø­Ø¨Ù‡ Ø§Ù„ØµØ¯ÙŠÙ‚
          const totalWithdrawn = u.withdrawn || 0;
          const commission = totalWithdrawn * 0.10;

          tbody.innerHTML += `
            <tr>
              <td style="font-weight:700;">${u.name || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯'}</td>
              <td style="color:var(--accent);">${(u.points || 0).toLocaleString()}</td>
              <td>${totalWithdrawn.toFixed(2)} Ø¬</td>
              <td><span class="tag tag-bonus">+ ${commission.toFixed(2)} Ø¬</span></td>
            </tr>`;
        });
      });
    } else {
      window.location.href = "login.html";
    }
  });

  window.copyRef = () => {
    const link = document.getElementById('refLink').textContent;
    navigator.clipboard.writeText(link).then(() => {
      const t = document.getElementById('toast');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    });
  };
</script>

</body>
</html>
