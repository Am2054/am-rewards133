<!DOCTYPE html>  <html lang="ar" dir="rtl">  
<head>  
  <meta charset="utf-8" />  
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª | Am Rewards</title>  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">  
  <style>  
    :root{  
      --bg-1:#051424; --bg-2:#031226;  
      --glass: rgba(255,255,255,0.04);  
      --accent:#1fb6ff; --accent-2:#34d399;  
      --gold:#ffd369; --muted:#98a6b3;  
      --text:#e9f1f7;  
    }  
    *{box-sizing:border-box}  
    body{  
      margin:0; padding:0;  
      font-family:"Cairo",sans-serif;  
      background: radial-gradient(1200px 600px at 10% 10%, rgba(31,182,255,0.04), transparent),  
                  linear-gradient(160deg,var(--bg-1),var(--bg-2));  
      color:var(--text); min-height:100vh;  
    }  
    .wrap{max-width:1100px;margin:28px auto;padding:18px}  
    .brand h1{margin:0;color:var(--accent);font-size:22px}  
    .brand p{margin:0;color:var(--muted);font-size:13px}  
    .summary{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center;}  
    .stat-card{  
      background:rgba(255,255,255,0.02);border:1px solid var(--glass);  
      border-radius:12px;padding:12px 16px;min-width:140px;text-align:right;  
    }  
    .stat-card .label{font-size:13px;color:var(--muted)}  
    .stat-card .value{font-size:20px;font-weight:800}  
    .btn{  
      border:0;padding:10px 14px;border-radius:10px;cursor:pointer;  
      font-weight:800;transition: opacity 0.2s, background 0.2s;  
      display: inline-flex; align-items: center; gap: 8px;  
    }  
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#07101a}  
    .btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--muted)}  
    .btn.ghost:hover{opacity:0.8;}  
    .card{  
      background:rgba(255,255,255,0.02);border:1px solid var(--glass);  
      border-radius:14px;padding:18px;margin-top:20px;  
      backdrop-filter:blur(8px);  
    }  
    .ref-row{display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px}  
    .ref-code{font-size:18px;font-weight:900;color:#fff}  
    .ref-link-box{  
      background:rgba(0,0,0,0.25);padding:10px;border-radius:10px;  
      border:1px solid rgba(255,255,255,0.05);color:var(--muted);  
      direction:ltr;word-break:break-all;cursor:pointer;transition:0.2s;  
    }  
    .ref-link-box:hover{border-color:var(--accent);}  
    table{width:100%;border-collapse:collapse;margin-top:16px}  
    thead th{font-size:13px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.05);padding:10px;text-align:right;}  
    thead th:first-child{text-align:center}  
    tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px;text-align:right;}  
    tbody td:first-child{text-align:center}  
    .tag{padding:4px 8px;border-radius:8px;font-weight:800;font-size:13px}  
    .tag.bonus{background:rgba(31,182,255,0.08);color:var(--accent)}  
    .small-muted{font-size:13px;color:var(--muted)}  
    #toast {  
      position: fixed; left: 50%; transform: translateX(-50%);  
      bottom: 20px; background: linear-gradient(90deg,#16a34a,#34d399);  
      color: #07101a; padding: 10px 16px; border-radius: 10px;  
      box-shadow: 0 10px 30px rgba(2,6,23,0.5);  
      opacity: 0; transition: opacity .25s ease; font-weight:800;  
      z-index: 1000;  
    }  
    #toast.error {  
      background: linear-gradient(90deg,#ff5f5f,#ff9e5f);  
    }  
    #toast.show { opacity: 1; }  
  </style>  
</head>  
<body>  
  <div class="wrap">  
    <div class="brand">  
      <h1>Am Rewards â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h1>  
      <p id="relativeLast">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: -</p>  
    </div>  <div class="summary">  
  <div class="stat-card"><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div><div class="value" id="referralCount">0</div></div>  
  <div class="stat-card"><div class="label">Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div><div class="value" id="referralPoints">0</div></div>  
  <button id="refreshBtn" class="btn ghost">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>  
  <button id="copyBtn" class="btn primary">  
    Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©   
    <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;stroke-width:2.5; stroke:currentColor;">  
      <path d="M7 11C7 8.17157 7 6.75736 7.87868 5.87868C8.75736 5 10.1716 5 13 5H14C16.8284 5 18.2426 5 19.1213 5.87868C20 6.75736 20 8.17157 20 11V16C20 18.8284 20 20.2426 19.1213 21.1213C18.2426 22 16.8284 22 14 22H13C10.1716 22 8.75736 22 7.87868 21.1213C7 20.2426 7 18.8284 7 16" stroke-linecap="round"/>  
      <path d="M10 5C10 3.89543 9.10457 3 8 3H6C4.89543 3 4 3.89543 4 5V16C4 17.1046 4.89543 18 6 18H7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>  
    </svg>  
  </button>  
</div>  

<div class="card">  
  <div class="ref-row">  
    <div>  
      <div class="small-muted">ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</div>  
      <div class="ref-code" id="referralCode">â€”</div>  
    </div>  
    <div>  
      <div class="small-muted" style="text-align:left">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>  
      <div class="ref-link-box" id="referralLink">-</div>  
    </div>  
  </div>  

  <p class="small-muted" style="margin-top:12px;color:var(--gold)">  
    ğŸ’¡ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨ ÙŠÙ‚ÙˆÙ… Ø¨Ù‡Ø§ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† (10Ùª Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø­Ø¨).  
  </p>  

  <div class="table-wrap">  
    <table>  
      <thead>  
        <tr>  
          <th>#</th>  
          <th>Ø§Ù„Ù…Ø¯Ø¹Ùˆ</th>  
          <th>Ù†Ù‚Ø§Ø·Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>  
          <th>Ø¢Ø®Ø± Ø³Ø­Ø¨ (Ø¬)</th>  
          <th>Ø±Ø¨Ø­Ùƒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¬)</th> </tr>  
      </thead>  
      <tbody id="tableBody"><tr><td colspan="5" class="small-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>  
    </table>  
  </div>  
  <div id="updateSummary" class="small-muted" style="margin-top:10px">â€”</div>  
</div>

  </div>    <div id="toast">ØªÙ…</div>    <script type="module">  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";  
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";  
    import {   
      getFirestore, doc, collection, query, where, onSnapshot,  
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";  
  
    const firebaseConfig = {  
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
      authDomain: "am--rewards.firebaseapp.com",  
      projectId: "am--rewards",  
    };  
  
    const app = initializeApp(firebaseConfig);  
    const auth = getAuth(app);  
    const db = getFirestore(app);  
  
    const referralCountEl = document.getElementById('referralCount');  
    const referralPointsEl = document.getElementById('referralPoints');  
    const referralCodeEl = document.getElementById('referralCode');  
    const referralLinkEl = document.getElementById('referralLink');  
    const tableBody = document.getElementById('tableBody');  
    const refreshBtn = document.getElementById('refreshBtn');  
    const copyBtn = document.getElementById('copyBtn');  
    const relativeLast = document.getElementById('relativeLast');  
    const updateSummary = document.getElementById('updateSummary');  
    const toast = document.getElementById('toast');  
  
    // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª  
    function showToast(msg, isSuccess=true){  
      toast.textContent = msg;  
      toast.className = ''; // Reset classes  
      if (!isSuccess) {  
        toast.classList.add('error');  
      }  
      toast.classList.add('show');  
      setTimeout(()=>toast.classList.remove('show'),3500);  
    }  
  
    // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù†Ø³Ø¨ÙŠ  
    function relativeTime(ts){  
      if(!ts) return "-";  
      const d = ts.toDate ? ts.toDate() : new Date(ts);  
      const diff = Math.floor((Date.now() - d.getTime())/60000);  
      if(diff < 1) return "Ø§Ù„Ø¢Ù†";  
      if(diff < 60) return `Ù…Ù†Ø° ${diff} Ø¯Ù‚ÙŠÙ‚Ø©`;  
      const h = Math.floor(diff/60);  
      return h < 24 ? `Ù…Ù†Ø° ${h} Ø³Ø§Ø¹Ø©` : `Ù…Ù†Ø° ${Math.floor(h/24)} ÙŠÙˆÙ…`;  
    }  
  
    // ğŸ’¡ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…  
    function formatNumber(num) {  
      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙƒÙ†Ù‚Ø§Ø· Ø£Ùˆ Ù…Ø¨Ø§Ù„Øº Ù…Ø§Ù„ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© Ø¬)  
      return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 2 });  
    }  
  
    // ğŸš¨ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©  
    function loadInvitedUsers(userCode){  
        const tableBody = document.getElementById('tableBody');  
        const updateSummary = document.getElementById('updateSummary');  
          
        // âœ… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù‚Ù„ "referralBy"  
        const q = query(collection(db,"users"), where("referralBy","==",userCode));   
  
        onSnapshot(q, (snapQ)=>{  
            tableBody.innerHTML = ""; // ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„  
              
            if(snapQ.empty){   
              tableBody.innerHTML=`<tr><td colspan="5" class="small-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø¹ÙˆÙˆÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td></tr>`;   
              updateSummary.textContent="â€”";  
              return;  
            }  
  
            let idx=0;  
            let tableRowsHTML = '';  
              
            snapQ.docs.forEach(docSnap => {  
              idx++;  
              const invited = docSnap.data();  
              const invitedName = invited.name || 'Ù…Ø³ØªØ®Ø¯Ù…';  
              const nowPoints = formatNumber(invited.points);  
              // ğŸŸ¢ ÙŠÙÙØªØ±Ø¶ Ø£Ù† referralEarnings Ù…Ø³Ø¬Ù„Ø© Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ (Ø¬)  
              const totalEarnedFromInvited = Number(invited.totalReferralEarnings || 0);   
              const lastWithdrawAmount = Number(invited.lastWithdrawAmount || 0);  
  
              const rowHTML = `  
                <tr>  
                  <td>${idx}</td>  
                  <td>${invitedName}</td>  
                  <td>${nowPoints}</td>  
                  <td>${formatNumber(lastWithdrawAmount)} Ø¬</td>  
                  <td><span class='tag bonus'>${formatNumber(totalEarnedFromInvited)} Ø¬</span></td> </tr>`;  
              tableRowsHTML += rowHTML;  
            });  
  
            tableBody.innerHTML = tableRowsHTML;  
            updateSummary.textContent=`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${idx} Ù…Ø¯Ø¹Ùˆ.`;  
  
        }, (error) => {  
            console.error("Error loading referrals:", error);  
            tableBody.innerHTML=`<tr><td colspan="5" class="small-muted">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†.</td></tr>`;  
        });  
    }  
  
  
    async function loadReferrals(user){  
      const userRef = doc(db,"users",user.uid);  
  
      // Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£ÙˆÙ„: Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù†Ù‚Ø§Ø·)  
      onSnapshot(userRef, (snap) => {  
          if (!snap.exists()) return;  
          const data = snap.data();  
            
          const userCode = data.referralCode; // âœ… Ø¬Ù„Ø¨ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©  
          const code = userCode || "â€”";  
            
          referralCodeEl.textContent = code;  
          // ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ù‡Ù†Ø§  
          referralLinkEl.textContent = `${location.origin}/signup.html?ref=${code}`;   
  
          referralCountEl.textContent = formatNumber(data.referralCount);  
          referralPointsEl.textContent = formatNumber(data.referralPoints);  
          relativeLast.textContent = data.lastReferralUpdateDate ? "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: "+relativeTime(data.lastReferralUpdateDate) : "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: -";  
            
          // ğŸ’¡ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯  
          if(userCode) {  
              loadInvitedUsers(userCode);   
          } else {  
              document.getElementById('tableBody').innerHTML=`<tr><td colspan="5" class="small-muted">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† ÙŠØªØ·Ù„Ø¨ ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© ÙØ¹Ø§Ù„.</td></tr>`;  
          }  
  
      }, (error) => {  
          console.error("Error loading user data:", error);  
      });  
    }  
  
    // ** 4. Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« **  
  
    onAuthStateChanged(auth,(user)=>{  
      if(!user) return location.href="login.html";  
      loadReferrals(user);  
    });  
  
    refreshBtn.onclick=()=>{   
      showToast("Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", true); // ğŸŸ¢ Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·  
      setTimeout(() => location.reload(), 500);  
    };  
  
    copyBtn.onclick=async()=>{  
      try{  
        const link = referralLinkEl.textContent;  
        if(link === '-' || link.includes(location.origin+'/signup.html?ref=-')) throw new Error('Link not ready');  
        await navigator.clipboard.writeText(link);  
        showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…");  
      }catch(e){   
        console.error(e);  
        showToast("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® âŒ", false);   
      }  
    };  
  </script>  </body>  
        </html>  
