<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª | Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #051424; --bg-2: #031226;
      --glass: rgba(255, 255, 255, 0.04);
      --accent: #1fb6ff; --accent-2: #34d399;
      --gold: #ffd369; --muted: #98a6b3;
      --text: #e9f1f7;
      --success: #34d399;
      --danger: #f87171;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: "Cairo", sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(31, 182, 255, 0.04), transparent),
                  linear-gradient(160deg, var(--bg-1), var(--bg-2));
      color: var(--text); min-height: 100vh;
      overflow-x: hidden;
    }
    .wrap { max-width: 1000px; margin: 25px auto; padding: 15px; }
    .brand h1 { margin: 0; color: var(--accent); font-size: 24px; letter-spacing: -0.5px; }
    .brand p { margin: 0; color: var(--muted); font-size: 14px; }

    .summary { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }
    .stat-card {
      background: var(--glass); border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px; padding: 15px 20px; flex: 1; min-width: 160px;
      backdrop-filter: blur(10px);
    }
    .stat-card .label { font-size: 12px; color: var(--muted); margin-bottom: 5px; }
    .stat-card .value { font-size: 22px; font-weight: 800; color: #fff; }

    .card {
      background: rgba(255, 255, 255, 0.02); border: 1px solid var(--glass);
      border-radius: 20px; padding: 25px; margin-top: 25px;
      backdrop-filter: blur(12px); box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    .ref-row { display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 20px; }
    .ref-code-box { flex: 1; min-width: 200px; }
    .ref-code { font-size: 24px; font-weight: 900; color: var(--accent-2); margin-top: 5px; letter-spacing: 2px; }
    .ref-link-box {
      background: rgba(0, 0, 0, 0.3); padding: 12px 15px; border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1); color: var(--muted);
      font-size: 13px; direction: ltr; word-break: break-all; cursor: pointer;
      transition: 0.3s; margin-top: 8px; flex: 2; min-width: 250px;
    }
    .ref-link-box:hover { border-color: var(--accent); color: #fff; }

    .btn {
      border: 0; padding: 12px 20px; border-radius: 12px; cursor: pointer;
      font-weight: 700; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-copy { background: var(--accent); color: var(--bg-1); }
    .btn-copy:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(31,182,255,0.3); }

    .table-container { margin-top: 30px; overflow-x: auto; border-radius: 12px; background: rgba(0,0,0,0.2); }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { background: rgba(255,255,255,0.03); color: var(--muted); font-size: 13px; padding: 15px; text-align: right; }
    td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 14px; }
    
    .tag { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; }
    .tag-bonus { background: rgba(31, 182, 255, 0.1); color: var(--accent); }
    .tag-active { background: rgba(52, 211, 153, 0.1); color: var(--success); }
    .tag-expired { background: rgba(248, 113, 113, 0.1); color: var(--danger); }

    #toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--success); color: var(--bg-1); padding: 12px 25px;
      border-radius: 50px; font-weight: 800; visibility: hidden; opacity: 0; transition: 0.4s;
    }
    #toast.show { visibility: visible; opacity: 1; bottom: 40px; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="brand">
    <h1>ğŸ’¸ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h1>
    <p>Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ 10% Ù…Ù† ÙƒÙ„ Ø³Ø­Ø¨ ÙŠÙ‚ÙˆÙ…ÙˆÙ† Ø¨Ù‡</p>
  </div>

  <div class="summary">
    <div class="stat-card">
      <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</div>
      <div class="value" id="refCount">0</div>
    </div>
    <div class="stat-card">
      <div class="label">Ø£Ø±Ø¨Ø§Ø­Ùƒ Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div>
      <div class="value" id="refEarnings">0.00 Ø¬</div>
    </div>
  </div>

  <div class="card">
    <div class="ref-row">
      <div class="ref-code-box">
        <div class="label">ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</div>
        <div class="ref-code" id="userCode">------</div>
      </div>
      <div style="flex: 2;">
        <div class="label">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
        <div class="ref-link-box" id="refLink" onclick="copyRef()">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
      <button class="btn btn-copy" onclick="copyRef()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø¯Ø¹Ùˆ</th>
            <th>Ø±ØµÙŠØ¯Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
            <th>Ø¢Ø®Ø± Ø³Ø­Ø¨</th>
            <th>Ø¹Ù…ÙˆÙ„ØªÙƒ Ø§Ù„Ø£Ø®ÙŠØ±Ø©</th>
            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</th>
          </tr>
        </thead>
        <tbody id="refTable">
          <tr><td colspan="5" style="text-align:center; color:var(--muted); padding:30px;">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast">ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­! âœ…</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const formatEGP = (val) => Number(val || 0).toFixed(2);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      onSnapshot(doc(db, "users", user.uid), (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        document.getElementById('userCode').textContent = data.referralCode || "------";
        document.getElementById('refLink').textContent = `${window.location.origin}/signup.html?ref=${data.referralCode}`;
        document.getElementById('refEarnings').textContent = `${formatEGP(data.totalReferralEarnings)} Ø¬`;
        document.getElementById('refCount').textContent = data.referralCount || 0;
      });

      // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† (Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ù„Ø±Ø¨Ø· Ø¨Ù€ UID Ø§Ù„Ø¯Ø§Ø¹ÙŠ)
      const q = query(collection(db, "users"), where("referredBy", "==", user.uid));
      onSnapshot(q, (snap) => {
        const tbody = document.getElementById('refTable');
        tbody.innerHTML = "";
        
        if (snap.empty) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">Ù„Ù… ÙŠØ³Ø¬Ù„ Ø£Ø­Ø¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚Ùƒ Ø¨Ø¹Ø¯.</td></tr>`;
          return;
        }

        snap.forEach(docSnap => {
          const u = docSnap.data();
          const bonusesUsed = u.referralBonusesCount || 0;
          const remaining = 10 - bonusesUsed;
          const lastComm = (u.lastWithdrawAmount || 0) * 0.10;

          tbody.innerHTML += `
            <tr>
              <td>${u.name || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯'}</td>
              <td>${u.points || 0} Ù†Ù‚Ø·Ø©</td>
              <td>${formatEGP(u.lastWithdrawAmount)} Ø¬</td>
              <td><span class="tag tag-bonus">+${formatEGP(lastComm)} Ø¬</span></td>
              <td>
                <span class="tag ${remaining > 0 ? 'tag-active' : 'tag-expired'}">
                  ${remaining > 0 ? `Ù…ØªØ¨Ù‚ÙŠ ${remaining} Ù…Ø±Ø§Øª` : 'Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©'}
                </span>
              </td>
            </tr>`;
        });
      });
    } else {
      window.location.href = "login.html";
    }
  });

  window.copyRef = () => {
    const link = document.getElementById('refLink').textContent;
    navigator.clipboard.writeText(link).then(() => {
      const t = document.getElementById('toast');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    });
  };
</script>

</body>
</html>
