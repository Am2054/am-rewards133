<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Redirect | Am Rewards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
      body {
        font-family: "Tajawal", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f4f4f4;
        flex-direction: column;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h2>جاري تحديث النقاط والرجوع...</h2>
    <p id="dollarRate">سعر الدولار الآن: جاري التحميل...</p>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
        authDomain: "am--rewards.firebaseapp.com",
        databaseURL: "https://am--rewards-default-rtdb.firebaseio.com",
        projectId: "am--rewards",
        storageBucket: "am--rewards.appspot.com",
        messagingSenderId: "744783579735",
        appId: "1:744783579735:web:45e00de9998893bbc9b112",
        measurementId: "G-CV3GLT2TTJ"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const database = firebase.database();

      auth.onAuthStateChanged((user) => {
        if (user) {
          const userId = user.uid;
          const userEmail = user.email;

          // حفظ الإيميل في قاعدة البيانات
          database.ref("users/" + userId + "/email").set(userEmail);

          // تحديث النقاط تلقائيًا
          const pointsToAdd = 1.5;
          const userPointsRef = database.ref("users/" + userId + "/points");

          userPointsRef.once("value").then((snapshot) => {
            const currentPoints = snapshot.val() || 0;
            const newPoints = currentPoints + pointsToAdd;

            userPointsRef.set(newPoints).then(() => {
              // بعد التحديث الرجوع للمهام
              setTimeout(() => {
                window.location.href = "tasks.html";
              }, 1000);
            });
          });
        } else {
          // لو المستخدم مش مسجل
          window.location.href = "login.html";
        }
      });

      // جلب سعر الدولار اللحظي
      fetch("https://api.exchangerate-api.com/v4/latest/USD")
        .then((res) => res.json())
        .then((data) => {
          const egpRate = data.rates.EGP;
          document.getElementById("dollarRate").textContent =
            "سعر الدولار الآن: " + egpRate.toFixed(2) + " جنيه مصري";
        })
        .catch((err) => {
          document.getElementById("dollarRate").textContent =
            "تعذر جلب سعر الدولار.";
        });
    </script>
  </body>
</html>
