<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#17e7b3;
      --primary-dark:#12886b;
      --bg-1:#082032;
      --bg-2:#001b2e;
      --glass:rgba(255,255,255,0.06);
      --text:#e6eef6;
      --muted:#9aa4b2;
      --gold:#f6b93b;
      --danger:#ff5f5f;
      --secondary:#1fb6ff;
      --surface:#091826;
      --shadow:0 10px 40px rgba(7,22,34,0.6), 0 2px 8px rgba(31,182,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;padding:0;
      font-family:"Cairo",sans-serif;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
      overflow-y:auto;
    }

    /* animated gradient overlay */
    .bg-animated{
      position:fixed;inset:0;z-index:-2;
      background:linear-gradient(120deg,#062f3f, #0c1b3a 40%, #05202b 70%);
      animation: moveBg 12s linear infinite;
      opacity:0.95;
    }
    @keyframes moveBg {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    .wrap{max-width:520px;margin:28px auto;padding:18px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow);
      border:1px solid var(--glass);
      backdrop-filter: blur(6px);
    }

    /* header */
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:58px;height:58px;border-radius:14px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      display:flex;align-items:center;justify-content:center;
      color:#08121a;font-weight:900;font-size:22px;box-shadow:0 6px 22px rgba(23,231,179,0.12);
    }
    .headline h1{margin:0;font-size:20px;color:var(--primary)}
    .headline .sub{margin-top:4px;font-size:13px;color:var(--muted)}

    /* profile */
    .profile {
      display:flex;gap:12px;align-items:center;margin-top:12px;
      animation: fadeUp .65s ease both;
    }
    .avatar{
      width:72px;height:72px;border-radius:16px;
      background:linear-gradient(135deg,#fff2,#fff0);
      display:flex;align-items:center;justify-content:center;color:#09121a;font-weight:900;font-size:26px;
      box-shadow:0 8px 30px rgba(0,0,0,0.4);
      flex-shrink:0;
    }
    .profile-info{flex:1;text-align:right}
    .profile-info h3{margin:0;font-size:19px}
    .profile-info p{margin:4px 0 0 0;color:var(--muted);font-size:13px;word-break:break-all}

    .profile-actions{display:flex;gap:8px;margin-top:10px}
    .btn{
      padding:9px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800;font-size:13px;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
    }
    .btn.ghost{background:transparent;border:1.5px solid var(--glass);color:var(--muted)}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#07101a;box-shadow:0 8px 20px rgba(31,182,255,0.08)}

    /* main balance */
    .balance-wrap{display:flex;gap:12px;align-items:center;margin-top:14px;animation: fadeUp .75s .08s both}
    .balance-card{
      flex:1;padding:16px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--glass);
    }
    .bal-title{font-size:13px;color:var(--muted);margin-bottom:6px;text-align:right}
    .bal-value{font-size:34px;font-weight:900;line-height:1;margin:0}
    .bal-egp{color:var(--gold);font-weight:700;margin-top:6px;font-size:14px}

    /* circular progress */
    .progress-card{
      width:120px;height:120px;border-radius:16px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(90deg, rgba(31,182,255,0.04), rgba(23,231,179,0.02));
      border:1px solid var(--glass);
      flex-shrink:0;
      animation: fadeUp .75s .12s both;
    }
    .circle{
      width:94px;height:94px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02));
      box-shadow:inset 0 2px 6px rgba(0,0,0,0.4);
      text-align:center;
    }
    .circle .num{font-weight:900;font-size:18px;color:var(--primary)}
    .circle .lbl{display:block;font-size:11px;color:var(--muted);margin-top:4px}

    /* quick actions big */
    .actions{display:flex;flex-direction:column;gap:10px;margin-top:14px;animation: fadeUp .9s .16s both}
    .action-btn{
      display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;
      background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--glass);cursor:pointer;text-decoration:none;color:var(--text);font-weight:800;
      box-shadow:0 6px 24px rgba(2,6,23,0.25);
    }
    .action-left{display:flex;align-items:center;gap:12px}
    .action-ico{width:44px;height:44;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--primary),var(--secondary));color:#08121a;font-weight:900}
    .action-title{font-size:15px}
    .action-sub{font-size:12px;color:var(--muted);margin-top:3px;font-weight:600}

    /* stats row */
    .stats-row{display:flex;gap:10px;margin-top:12px}
    .stat-card{flex:1;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid var(--glass);text-align:center}
    .stat-number{font-weight:900;font-size:18px}
    .stat-label{font-size:12px;color:var(--muted);margin-top:6px}

    footer{margin:22px 0 18px 0;text-align:center;color:rgba(255,255,255,0.14);font-size:13px}

    /* entry animations */
    @keyframes fadeUp {
      from {opacity:0; transform: translateY(12px)}
      to {opacity:1; transform: translateY(0)}
    }

    /* small screens */
    @media(max-width:480px){
      .wrap{padding:12px}
      .profile{flex-direction:row-reverse;gap:10px}
      .balance-wrap{flex-direction:column-reverse;align-items:flex-end}
      .progress-card{width:100%;height:84px;border-radius:12px;padding:10px}
      .circle{width:64px;height:64px}
      .bal-value{font-size:26px}
      .action-ico{width:40px;height:40}
      .logo{width:50px;height:50;font-size:18px}
    }
  </style>
</head>
<body>
  <div class="bg-animated" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AM</div>
        <div class="headline">
          <h1>Am Rewards</h1>
          <div class="sub">Ø³Ø§Ø±Ø¹ Ø¨Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· â€” Ø§Ù„Ø«Ù‚Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ø£ÙˆÙ„Ù‹Ø§</div>
        </div>
      </div>
      <div style="text-align:left">
        <button id="refreshBtnTop" class="btn ghost" title="ØªØ­Ø¯ÙŠØ«">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </header>

    <div class="card profile">
      <div style="display:flex;flex-direction:column;align-items:flex-end;flex:1">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="profile-info" style="text-align:right">
            <h3 id="userName">Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <p id="userEmail">â€”</p>
            <div class="profile-actions">
              <button id="logoutBtn" class="btn ghost">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
          </div>
          <div class="avatar" id="avatar">A</div>
        </div>
      </div>
    </div>

    <div class="card balance-wrap" style="align-items:center">
      <div class="balance-card" style="min-width:0">
        <div class="bal-title">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†Ù‚Ø§Ø·)</div>
        <div class="bal-value" id="userPoints">0</div>
        <div class="bal-egp" id="pointsEgp">0.00 Ø¬</div>
      </div>

      <div class="progress-card" aria-hidden="true">
        <!-- circular progress (we'll draw with SVG via JS) -->
        <div class="circle" id="circleWrap">
          <div>
            <div class="num" id="progressPercent">0%</div>
            <div class="lbl" id="progressLbl">0 / 1000</div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <a class="action-btn" href="tasks.html">
        <div class="action-left">
          <div class="action-ico">ğŸ“</div>
          <div>
            <div class="action-title">Ø§Ù„Ù…Ù‡Ø§Ù…</div>
            <div class="action-sub">Ø£ÙƒÙ…Ù„ Ù…Ù‡Ø§Ù…Ùƒ Ù„Ø±Ø¨Ø­ Ù†Ù‚Ø§Ø·</div>
          </div>
        </div>
        <div style="color:var(--muted);font-weight:800">Ø§Ø°Ù‡Ø¨</div>
      </a>

      <a class="action-btn" href="referrals.html">
        <div class="action-left">
          <div class="action-ico" style="background:linear-gradient(90deg,var(--gold),#ffd27f)">ğŸ‘¥</div>
          <div>
            <div class="action-title">Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div>
            <div class="action-sub">Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§ÙƒØ³Ø¨ Ù†Ø³Ø¨Ø©</div>
          </div>
        </div>
        <div style="color:var(--muted);font-weight:800">Ø¹Ø±Ø¶</div>
      </a>

      <a class="action-btn" href="withdraw.html">
        <div class="action-left">
          <div class="action-ico" style="background:linear-gradient(90deg,#1fb6ff,#5fffb6)">ğŸ’¸</div>
          <div>
            <div class="action-title">Ø§Ù„Ø³Ø­Ø¨</div>
            <div class="action-sub">Ø§Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø£Ø±Ø¨Ø§Ø­Ùƒ</div>
          </div>
        </div>
        <div style="color:var(--muted);font-weight:800">Ø³Ø­Ø¨</div>
      </a>
    </div>

    <div class="stats-row" style="margin-top:14px">
      <div class="stat-card">
        <div class="stat-number" id="pointsToday">0</div>
        <div class="stat-label">Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalWithdrawn">0 Ø¬</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="referralPoints">0</div>
        <div class="stat-label">Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div>
      </div>
    </div>

    <footer>Â© Am Rewards</footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase v8 (keep same as your code for compatibility) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // ===== Firebase Config (as in Ù…Ù„ÙÙƒ) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
      storageBucket: "am--rewards.appspot.com",
      messagingSenderId: "744783579735",
      appId: "1:744783579735:web:45e00de9998893bbc9b112"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const POINT_VALUE_EGP = 0.07;
    const DAILY_TARGET = 1000;

    // elements
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const avatarEl = document.getElementById('avatar');
    const userPointsEl = document.getElementById('userPoints');
    const pointsTodayEl = document.getElementById('pointsToday');
    const totalWithdrawnEl = document.getElementById('totalWithdrawn');
    const progressPercentEl = document.getElementById('progressPercent');
    const progressLblEl = document.getElementById('progressLbl');
    const pointsEgpEl = document.getElementById('pointsEgp');
    const referralPointsEl = document.getElementById('referralPoints');
    const refreshBtn = document.getElementById('refreshBtnTop');
    const logoutBtn = document.getElementById('logoutBtn');
    const toast = document.getElementById('toast');

    function showToast(text, success=true) {
      toast.textContent = text;
      toast.style.background = success ? 'linear-gradient(90deg,#16a34a,#34d399)' : 'linear-gradient(90deg,#f97316,#fb7185)';
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 3200);
    }

    function renderUser(d, user) {
      userNameEl.textContent = d.name || user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
      userEmailEl.textContent = d.email || user.email || 'â€”';
      avatarEl.textContent = (d.name ? d.name.slice(0,1).toUpperCase() : (user.email? user.email[0].toUpperCase() : 'A'));
      const pts = Number(d.points ?? 0);
      userPointsEl.textContent = pts;
      pointsEgpEl.textContent = (pts * POINT_VALUE_EGP).toFixed(2) + ' Ø¬';
      pointsTodayEl.textContent = Math.max((Number(d.points ?? 0) - Number(d.previousPoints ?? 0)), 0);
      totalWithdrawnEl.textContent = (d.totalWithdrawn ?? 0) + ' Ø¬';
      referralPointsEl.textContent = (d.referralPoints ?? 0);

      // progress relative to DAILY_TARGET (use remainder to show today's progress)
      const todayProgress = Math.min(DAILY_TARGET, (pts % DAILY_TARGET));
      const pct = Math.round((todayProgress / DAILY_TARGET) * 100);
      progressPercentEl.textContent = pct + '%';
      progressLblEl.textContent = `${todayProgress} / ${DAILY_TARGET}`;
      // animate circular stroke via CSS-like effect: we'll create a radial effect by changing background conic-gradient
      const circle = document.getElementById('circleWrap');
      // create conic gradient to simulate circular progress
      circle.style.background = `conic-gradient(var(--primary) ${pct}%, rgba(255,255,255,0.02) ${pct}%)`;
    }

    // referral daily bonus logic (kept intact, per requirement: not changing Firebase logic)
    async function handleReferralDailyBonus(userId, userPoints) {
      const userRef = db.collection('users').doc(userId);
      const userSnap = await userRef.get();
      if (!userSnap.exists) return;
      const userData = userSnap.data();
      const referrerId = userData.referralBy;
      if (!referrerId) return;
      const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
      if (userData.lastReferralBonusDate === today) return;
      const bonusAmount = Math.floor(userPoints * 0.10);
      if (bonusAmount > 0) {
        const referrerRef = db.collection('users').doc(referrerId);
        await referrerRef.update({
          bonusPoint: firebase.firestore.FieldValue.increment(bonusAmount)
        });
        await userRef.update({ lastReferralBonusDate: today });
      }
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.href = 'index.html';
      try {
        const uid = user.uid;
        const userRef = db.collection('users').doc(uid);
        const snap = await userRef.get();
        if (!snap.exists) return;
        const data = snap.data();

        // ensure previousPoints exists to compute "points today"
        if (data.previousPoints === undefined) {
          await userRef.update({ previousPoints: Number(data.points ?? 0) }).catch(()=>{});
          data.previousPoints = Number(data.points ?? 0);
        }

        renderUser(data, user);

        // keep referral daily bonus backend logic (no UI mention of "daily reward")
        await handleReferralDailyBonus(uid, Number(data.points ?? 0));

} catch (err) {
    console.error(err);
    showToast('false);
  }
});
    // buttons
    refreshBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return location.href = 'index.html';
      showToast('Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
      try {
        const snap = await db.collection('users').doc(user.uid).get();
        if (snap.exists) renderUser(snap.data(), user);
        showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
      } catch (e) {
        console.error(e);
        showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', false);
      }
    });

    logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=> location.href='index.html'));

    // small UX: update view when user's doc changes in realtime (optional)
    auth.onAuthStateChanged((user)=>{
      if (!user) return;
      db.collection('users').doc(user.uid).onSnapshot((s)=>{
        if (!s.exists) return;
        renderUser(s.data(), user);
      });
    });
  </script>
</body>
  </html>
