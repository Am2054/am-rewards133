<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Am Rewards (v2)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1724;
      --muted:#9aa4b2;
      --accent:#1fb6ff;
      --gold:#f6b93b;
      --glass: rgba(255,255,255,0.03);
      --success:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Cairo",sans-serif; background:
      radial-gradient(1200px 600px at 10% 10%, rgba(31,182,255,0.06), transparent 8%),
      linear-gradient(180deg,#071024 0%, #0b1f2a 100%);
      color:#e6eef6; -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      padding:20px;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo {
      width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7ef7ff);
      display:flex;align-items:center;justify-content:center;color:#012; font-weight:900; font-size:18px;
      box-shadow:0 6px 30px rgba(31,182,255,0.06), inset 0 -6px 18px rgba(0,0,0,0.25);
    }
    h1{margin:0;font-size:18px;color:var(--gold);letter-spacing:0.6px}
    .sub{color:var(--muted);font-size:13px}

    /* layout */
    .grid {
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
    }
    .left {
      display:grid;
      gap:14px;
    }
    .card {
      background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.01));
      border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 8px 30px rgba(3,10,18,0.45);
    }
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px}
    .stat {
      padding:14px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);
      transition:transform .18s ease, box-shadow .18s;
    }
    .stat:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(2,6,23,0.5)}
    .k{font-size:12px;color:var(--muted);margin-bottom:8px}
    .v{font-weight:800;font-size:20px;color:#fff}

    /* progress */
    .progress-wrap{margin-top:10px}
    .progress {height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7ef7ff);width:0%;transition:width 600ms cubic-bezier(.23,.9,.32,1)}

    /* actions */
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:800;display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:0}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#6ae7ff);color:#012;}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn.gold{background:linear-gradient(90deg,var(--gold),#ffd27f);color:#112}

    /* right column */
    .right .mini{display:flex;gap:10px;flex-direction:column}
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,#fff2,#fff0);display:flex;align-items:center;justify-content:center;color:#012;font-weight:900}
    .profile h3{margin:0;font-size:16px}
    .profile p{margin:0;color:var(--muted);font-size:13px}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(20px);bottom:26px;padding:12px 18px;border-radius:12px;background:linear-gradient(90deg,#16a34a,#34d399);color:#052;box-shadow:0 10px 30px rgba(2,6,23,0.45);opacity:0;pointer-events:none;transition:all .36s cubic-bezier(.2,.9,.3,1);z-index:9999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}

    /* small */
    .muted{color:var(--muted);font-size:13px}
    footer{margin-top:22px;text-align:center;color:rgba(255,255,255,0.12);font-size:13px}

    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      .right{order:-1}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AM</div>
        <div>
          <h1>Am Rewards</h1>
          <div class="sub">Ø³Ø§Ø±Ø¹ Ø¨Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ø±Ø¨Ø­ 10% ÙŠÙˆÙ…ÙŠÙ‹Ø§</div>
        </div>
      </div>
      <div id="headerRight" class="muted">ØªØ­Ù…ÙŠÙ„...</div>
    </header>

    <main class="grid">
      <!-- LEFT -->
      <section class="left">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="k">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†Ù‚Ø§Ø·)</div>
              <div class="v" id="userPoints">0</div>
              <div class="muted" id="pointsEgp">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·: 0.00 Ø¬</div>
            </div>
            <div style="min-width:160px;text-align:left">
              <div class="k">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</div>
              <div class="actions">
                <a class="btn primary" href="tasks.html">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</a>
                <a class="btn gold" href="referrals.html">ğŸ‘¥ Ø¥Ø­Ø§Ù„Ø§Øª</a>
                <a class="btn ghost" href="withdraw.html">ğŸ’¸ Ø³Ø­Ø¨</a>
              </div>
            </div>
          </div>

          <div class="stats-grid" style="margin-top:14px">
            <div class="stat">
              <div class="k">Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…</div>
              <div class="v" id="pointsToday">0</div>
              <div class="muted">Ù…Ù‚Ø§Ø³Ø© Ù…Ù† Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„/ÙØ­Øµ</div>
            </div>

            <div class="stat">
              <div class="k">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (Ù…Ø¬Ù…Ø¹Ø©)</div>
              <div class="v" id="referralPoints">0</div>
              <div class="muted">Ù†Ù‚Ø§Ø· Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø¯Ø¹ÙˆØ§ØªÙƒ</div>
            </div>

            <div class="stat">
              <div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</div>
              <div class="v" id="totalWithdrawn">0 Ø¬</div>
              <div class="muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
            </div>

            <div class="stat">
              <div class="k">Ù†Ù‚Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ©</div>
              <div class="v" id="bonusPoint">0</div>
              <div class="muted">Ø¨ÙˆÙ†Øµ/Ù…ÙƒØ§ÙØ¢Øª Ø£Ø®Ø±Ù‰</div>
            </div>
          </div>

          <div style="margin-top:12px" class="card">
            <div class="k">ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
            <div class="progress-wrap">
              <div class="progress"><i id="progressBar"></i></div>
            </div>
            <div class="muted" id="progressLabel">0 / 1000 Ù†Ù‚Ø·Ø©</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px 0">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h3>
          <div id="quickSummary" class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="right">
        <div class="card mini">
          <div class="profile">
            <div class="avatar" id="avatar">A</div>
            <div>
              <h3 id="userName">Ù…Ø³ØªØ®Ø¯Ù…</h3>
              <p id="userEmail" class="muted">â€”</p>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="k">ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</div>
            <div style="display:flex;gap:8px;align-items:center">
              <div style="background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px" id="refCode">â€”</div>
              <button class="btn ghost" id="copyRef">Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            </div>
            <div class="muted" style="margin-top:8px">Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ 10% ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ù…Ù† Ø£Ø±Ø¨Ø§Ø­Ù‡Ù…</div>
          </div>

          <div style="margin-top:12px">
            <button class="btn primary" id="refreshBtn">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn ghost" id="logoutBtn" style="margin-left:8px">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
      </aside>
    </main>

    <footer>Â© Am Rewards</footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  // ====== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙƒÙ…Ø§ Ù„Ø¯ÙŠÙƒ) ======
  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
    storageBucket: "am--rewards.appspot.com",
    messagingSenderId: "744783579735",
    appId: "1:744783579735:web:45e00de9998893bbc9b112"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
  const POINT_VALUE_EGP = 0.07;
  const DAILY_TARGET = 1000; // Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù€ progress bar (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const loadingMsg = document.getElementById('headerRight');
  const mainLoading = document.getElementById('loadingMsg');
  const mainContent = document.getElementById('mainContent');
  const toast = document.getElementById('toast');
  const userNameEl = document.getElementById('userName');
  const userEmailEl = document.getElementById('userEmail');
  const avatarEl = document.getElementById('avatar');
  const userPointsEl = document.getElementById('userPoints');
  const pointsEgpEl = document.getElementById('pointsEgp');
  const referralPointsEl = document.getElementById('referralPoints');
  const bonusPointEl = document.getElementById('bonusPoint');
  const pointsTodayEl = document.getElementById('pointsToday');
  const totalWithdrawnEl = document.getElementById('totalWithdrawn');
  const quickSummaryEl = document.getElementById('quickSummary');
  const progressBarEl = document.getElementById('progressBar');
  const progressLabelEl = document.getElementById('progressLabel');
  const refCodeEl = document.getElementById('refCode');
  const copyRefBtn = document.getElementById('copyRef');
  const refreshBtn = document.getElementById('refreshBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  function showToast(text, success=true) {
    toast.textContent = text;
    toast.style.background = success ? 'linear-gradient(90deg,#16a34a,#34d399)' : 'linear-gradient(90deg,#f97316,#fb7185)';
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 3600);
  }

  // Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø±Ø¬Ø¹ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† UID Ø£Ùˆ referralCode
  async function getReferrerDocRef(referralBy) {
    if (!referralBy) return null;
    if (typeof referralBy === 'string' && referralBy.length > 20) {
      // Ù†ÙØªØ±Ø¶ UID
      return db.collection('users').doc(referralBy);
    } else {
      // Ø§Ø­ØªÙ…Ø§Ù„ Ø£Ù†Ù‡ referralCode
      const snap = await db.collection('users').where('referralCode', '==', referralBy).limit(1).get();
      if (!snap.empty) return snap.docs[0].ref;
      return null;
    }
  }

  // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (10%)
  async function handleReferralReward(uid, userData) {
    try {
      if (!userData) return;
      const today = new Date().toISOString().split('T')[0];
      const prevPoints = Number(userData.previousPoints ?? 0);
      const currentPoints = Number(userData.points ?? 0);
      const lastDate = userData.lastReferralRewardDate ?? '';
      const referralBy = userData.referralBy ?? null;

      // Ù„Ùˆ previousPoints ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù â€” Ù†Ø¹Ù‘Ø±ÙÙ‡ ÙˆÙ†Ù†Ù‡ÙŠ (Ù„Ø§ Ù†Ø­Ø³Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ø£ÙˆÙ„ Ù…Ø±Ø©)
      if (userData.previousPoints === undefined) {
        await db.collection('users').doc(uid).update({ previousPoints: currentPoints }).catch(()=>{});
        return;
      }

      const gainedToday = Math.max(currentPoints - prevPoints, 0);

      // Ø´Ø±Ø· Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ù„Ø¯ÙŠÙ‡ Ø¯Ø§Ø¹ÙŠØŒ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ù„Ù„ÙŠÙˆÙ… Ù„Ù… ØªÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ØŒ ÙˆÙ†Ù‚Ø·Ø© Ù…ÙˆØ¬Ø¨Ø© Ø§ÙƒØªØ³Ø¨Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ…
      if (!referralBy || lastDate === today || gainedToday <= 0) {
        // Ù†Ø¶Ù…Ù† ØªØ­Ø¯ÙŠØ« previousPoints Ùˆ lastReferralRewardDate Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙÙ…Ù†ÙØ­ Ù…ÙƒØ§ÙØ£Ø©
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{});
        return;
      }

      // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¯Ø§Ø¹ÙŠ
      const referrerDocRef = await getReferrerDocRef(referralBy);
      if (!referrerDocRef) {
        // Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù…Ø·Ø§Ø¨Ù‚ â€” Ø­Ø¯Ø« Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{});
        return;
      }

      const reward = Math.floor(gainedToday * 0.10); // 10%
      if (reward <= 0) {
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{});
        return;
      }

      // transaction: Ø£Ø¶Ù referralPoints Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø§Ø¹ÙŠ ÙˆØ³Ø¬Ù„ Ø§Ù„Ù„ÙˆØ¬ØŒ Ø«Ù… Ø­Ø¯Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      await db.runTransaction(async (tx) => {
        const refSnap = await tx.get(referrerDocRef);
        if (!refSnap.exists) {
          tx.update(db.collection('users').doc(uid), {
            previousPoints: currentPoints,
            lastReferralRewardDate: today
          });
          return;
        }

        const curReferralPoints = Number(refSnap.data().referralPoints ?? 0);
        tx.update(referrerDocRef, {
          referralPoints: curReferralPoints + reward
        });

        // Ø³Ø¬Ù„ Ù„ÙˆØ¬ Ù„Ù„Ø¥Ø­Ø§Ù„Ø©
        const logRef = db.collection('referralLogs').doc();
        tx.set(logRef, {
          type: 'daily_bonus',
          referrer: referrerDocRef.id,
          referred: uid,
          rewardPoints: reward,
          gainedPoints: gainedToday,
          date: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Ø­Ø¯Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        tx.update(db.collection('users').doc(uid), {
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        });
      });

      // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù€ transactionØŒ Ø­Ø¯Ø« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ù†Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø­Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ù…ÙÙŠØ¯)
      const freshRefSnap = await referrerDocRef.get();
      if (freshRefSnap.exists) {
        const newRefPoints = Number(freshRefSnap.data().referralPoints ?? 0);
        // Ù„Ùˆ Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ù‡Ùˆ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†Ø§Ø¯Ø±) Ù†Ø¹Ø±Ø¶Ù‡ Ø£ÙŠØ¶Ø§Ù‹
        if (referrerDocRef.id === uid) {
          referralPointsEl.textContent = newRefPoints;
        }
      }

      showToast(`ğŸ‰ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${reward} Ù†Ù‚Ø·Ø© Ø¥Ù„Ù‰ Ø¯Ø§Ø¹ÙŠÙƒ!`);
      console.log(`Referral: added ${reward} pts to ${referrerDocRef.id}`);

    } catch (err) {
      console.error('handleReferralReward error:', err);
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  function renderUser(userDoc, user) {
    const d = userDoc;
    userNameEl.textContent = d.name || user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
    userEmailEl.textContent = d.email || user.email || 'â€”';
    avatarEl.textContent = (d.name ? d.name.slice(0,1).toUpperCase() : (user.email? user.email[0].toUpperCase() : 'A'));
    userPointsEl.textContent = Number(d.points ?? 0);
    referralPointsEl.textContent = Number(d.referralPoints ?? 0);
    bonusPointEl.textContent = Number(d.bonusPoint ?? 0);
    pointsTodayEl.textContent = Math.max((Number(d.points ?? 0) - Number(d.previousPoints ?? 0)), 0);
    totalWithdrawnEl.textContent = (d.totalWithdrawn ?? 0) + ' Ø¬';
    refCodeEl.textContent = d.referralCode || 'â€”';
    // points to EGP
    pointsEgpEl.textContent = (Number(d.points ?? 0) * POINT_VALUE_EGP).toFixed(2) + ' Ø¬';
    // progress
    const progress = Math.min(100, Math.round(((Number(d.points ?? 0) % DAILY_TARGET) / DAILY_TARGET) * 100));
    progressBarEl.style.width = progress + '%';
    progressLabelEl.textContent = `${Number(d.points ?? 0)} / ${DAILY_TARGET} Ù†Ù‚Ø·Ø©`;
    // quick summary
    quickSummaryEl.textContent = `Ø¥Ø­Ø§Ù„Ø§Øª: ${d.referralCount ?? 0} Â· Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª: ${d.referralPoints ?? 0} Â· Ø¨ÙˆÙ†Øµ: ${d.bonusPoint ?? 0}`;
    loadingMsg.textContent = 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¬Ø§Ù‡Ø²Ø©';
    mainContent.style.display = 'block';
  }

  // Ø¬Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = 'index.html';
    try {
      mainContent.style.display = 'none';
      loadingMsg.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...';
      const uid = user.uid;
      const userRef = db.collection('users').doc(uid);
      const snap = await userRef.get();

      if (!snap.exists) {
        loadingMsg.textContent = 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ';
        return;
      }

      const data = snap.data();

      // Ø¥Ø°Ø§ previousPoints ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â€” Ø®Ø²Ù†Ù‡ Ø£ÙˆÙ„ Ù…Ø±Ø© Ø«Ù… Ø§Ø¹Ø±Ø¶ (Ù„Ø§ Ù†Ø­Ø³Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„)
      if (data.previousPoints === undefined) {
        await userRef.update({ previousPoints: Number(data.points ?? 0) }).catch(()=>{});
        data.previousPoints = Number(data.points ?? 0);
      }

      renderUser(data, user);

      // Ø§Ø³ØªØ¯Ø¹ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ù…Ø±Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§)
      await handleReferralReward(uid, data);

      // Ø¨Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©ØŒ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø®ØµÙˆØµÙ‹Ø§ referralPoints)
      const updatedSnap = await userRef.get();
      if (updatedSnap.exists) {
        renderUser(updatedSnap.data(), user);
      }

    } catch (err) {
      console.error(err);
      loadingMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
      mainContent.style.display = 'none';
    }
  });

  // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
  copyRefBtn.addEventListener('click', async () => {
    const code = refCodeEl.textContent;
    if (!code || code === 'â€”') return showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯', false);
    const url = `${location.origin}/signup.html?ref=${code}`;
    try {
      await navigator.clipboard.writeText(url);
      showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©');
    } catch (e) {
      // fallback
      const ta = document.createElement('textarea');
      ta.value = url; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); ta.remove();
      showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©');
    }
  });

  // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ
  refreshBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return location.href = 'index.html';
    loadingMsg.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
    try {
      const snap = await db.collection('users').doc(user.uid).get();
      if (snap.exists) renderUser(snap.data(), user);
      loadingMsg.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«';
      setTimeout(()=> loadingMsg.textContent = 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¬Ø§Ù‡Ø²Ø©', 1200);
    } catch (e) {
      console.error(e);
      loadingMsg.textContent = 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«';
    }
  });

  // logout
  logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=> location.href='index.html'));

  </script>
</body>
  </html>
