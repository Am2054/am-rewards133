<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>لوحة التحكم — Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;
      --card:#10192d;
      --muted:#9aa4b2;
      --accent:#1fb6ff;
      --gold:#f6b93b;
      --glass: rgba(255,255,255,0.03);
      --success:#16a34a;
      --shadow: 0 8px 32px rgba(31,182,255,0.09), 0 1px 0 rgba(0,0,0,0.09);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Cairo",sans-serif; background:
      radial-gradient(1200px 600px at 10% 10%, rgba(31,182,255,0.06), transparent 8%),
      linear-gradient(180deg,#071024 0%, #0b1f2a 100%);
      color:#e6eef6; -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      padding:8px;
    }
    .wrap{max-width:600px;margin:0 auto;padding:0;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo {
      width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7ef7ff);
      display:flex;align-items:center;justify-content:center;color:#012; font-weight:900; font-size:18px;
      box-shadow:var(--shadow);
    }
    h1{margin:0;font-size:19px;color:var(--gold);letter-spacing:0.8px}
    .sub{color:var(--muted);font-size:13px}
    .profile-bar{
      display:flex;align-items:center;gap:10px;background:var(--card);border-radius:14px;padding:10px 14px;margin-bottom:16px;box-shadow:var(--shadow);
      justify-content:space-between;
    }
    .profile-info{display:flex;align-items:center;gap:10px;}
    .avatar{
      width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#fff2,#fff0);display:flex;align-items:center;justify-content:center;color:#012;font-weight:900;font-size:16px
    }
    .profile-details{display:flex;flex-direction:column;align-items:flex-end;}
    .profile-details h3{margin:0;font-size:15px}
    .profile-details p{margin:0;color:var(--muted);font-size:12px}
    .profile-actions{display:flex;gap:8px;}
    .btn{padding:9px 13px;border-radius:10px;text-decoration:none;font-weight:800;display:inline-flex;align-items:center;gap:6px;cursor:pointer;border:0;font-size:14px;}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#6ae7ff);color:#012;}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .main-card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.01));border-radius:14px;padding:16px;box-shadow:var(--shadow);margin-bottom:16px;border:1px solid #1fb6ff22}
    .main-card .section-title{color:var(--muted);font-size:13px;margin-bottom:9px}
    .balance-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
    .balance{font-weight:900;font-size:28px;color:#fff}
    .points-egp{color:var(--gold);font-size:13px}
    .quick-links{display:flex;gap:12px;margin-bottom:18px;}
    .quick-btn{flex:1;padding:13px 0;border-radius:10px;font-weight:800;font-size:16px;cursor:pointer;border:0;display:flex;align-items:center;justify-content:center;transition:background .2s}
    .quick-btn.tasks{background:linear-gradient(90deg,var(--accent),#7ef7ff);color:#012;}
    .quick-btn.ref{background:linear-gradient(90deg,var(--gold),#ffd27f);color:#112;}
    .quick-btn.withdraw{background:linear-gradient(90deg,#1fb6ff,#5fffb6);color:#012;}
    .stats-row{display:flex;gap:10px;margin-bottom:8px;}
    .stat-box{
      flex:1;
      background:#0b1f2a;
      border-radius:10px;
      padding:10px 7px;
      text-align:center;
      box-shadow:0 2px 8px #1fb6ff08;
      border:1px solid #1fb6ff19;
    }
    .stat-label{font-size:12px;color:var(--muted);margin-bottom:7px}
    .stat-value{font-weight:900;font-size:19px;color:#fff}
    .stat-note{color:var(--muted);font-size:11px;margin-top:2px}
    .progress-wrap{margin:14px 0 2px 0;}
    .progress-label{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .progress-bar{height:9px;background:rgba(255,255,255,0.07);border-radius:999px;overflow:hidden;position:relative;}
    .progress-bar i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7ef7ff);width:0%;transition:width 700ms cubic-bezier(.23,.9,.32,1)}
    .progress-count{font-size:13px;color:var(--gold);margin-top:5px;text-align:left;}
    footer{margin-top:16px;text-align:center;color:rgba(255,255,255,0.12);font-size:13px}
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(20px);bottom:26px;padding:12px 18px;border-radius:12px;background:linear-gradient(90deg,#16a34a,#34d399);color:#052;box-shadow:0 10px 30px rgba(2,6,23,0.45);opacity:0;pointer-events:none;transition:all .36s cubic-bezier(.2,.9,.3,1);z-index:9999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
    @media(max-width:700px){
      .wrap{max-width:99vw;}
      header{flex-direction:column;gap:8px}
      .profile-bar{flex-direction:column;align-items:flex-end;}
      .main-card{padding:11px}
      .quick-links{gap:7px;}
      .stat-box{padding:7px 3px;}
      .balance{font-size:20px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AM</div>
        <div>
          <h1>Am Rewards</h1>
          <div class="sub">سارع بجمع النقاط وادعُ أصدقائك لربح 10% يوميًا</div>
        </div>
      </div>
      <div id="headerRight" class="muted">تحميل...</div>
    </header>

    <div class="profile-bar">
      <div class="profile-info">
        <div class="avatar" id="avatar">A</div>
        <div class="profile-details">
          <h3 id="userName">مستخدم</h3>
          <p id="userEmail" class="muted">—</p>
        </div>
      </div>
      <div class="profile-actions">
        <button class="btn primary" id="refreshBtn">تحديث 🔄</button>
        <button class="btn ghost" id="logoutBtn">تسجيل خروج 📤</button>
      </div>
    </div>

    <div class="main-card">
      <div class="section-title">الرصيد الحالي (نقاط)</div>
      <div class="balance-row">
        <div class="balance" id="userPoints">0</div>
        <div class="points-egp" id="pointsEgp">قيمة النقاط: 0.00 ج</div>
      </div>
      <div class="quick-links">
        <a class="quick-btn tasks" href="tasks.html">📝 المهام</a>
        <a class="quick-btn ref" href="referrals.html">👥 إحالات</a>
        <a class="quick-btn withdraw" href="withdraw.html">💸 سحب</a>
      </div>
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-label">نقاط اليوم</div>
          <div class="stat-value" id="pointsToday">0</div>
          <div class="stat-note">مقاسة من آخر دخول/فحص</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">إجمالي السحوبات</div>
          <div class="stat-value" id="totalWithdrawn">0 ج</div>
          <div class="stat-note">المبلغ المسحوب منذ البداية</div>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-label">تقدمك اليومي</div>
        <div class="progress-bar"><i id="progressBar"></i></div>
        <div class="progress-count" id="progressLabel">0 / 1000 نقطة</div>
      </div>
    </div>
    <footer>© Am Rewards</footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
    storageBucket: "am--rewards.appspot.com",
    messagingSenderId: "744783579735",
    appId: "1:744783579735:web:45e00de9998893bbc9b112"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const POINT_VALUE_EGP = 0.07;
  const DAILY_TARGET = 1000;

  const loadingMsg = document.getElementById('headerRight');
  const userNameEl = document.getElementById('userName');
  const userEmailEl = document.getElementById('userEmail');
  const avatarEl = document.getElementById('avatar');
  const userPointsEl = document.getElementById('userPoints');
  const pointsTodayEl = document.getElementById('pointsToday');
  const totalWithdrawnEl = document.getElementById('totalWithdrawn');
  const progressBarEl = document.getElementById('progressBar');
  const progressLabelEl = document.getElementById('progressLabel');
  const pointsEgpEl = document.getElementById('pointsEgp');
  const refreshBtn = document.getElementById('refreshBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const toast = document.getElementById('toast');

  function showToast(text, success=true) {
    toast.textContent = text;
    toast.style.background = success ? 'linear-gradient(90deg,#16a34a,#34d399)' : 'linear-gradient(90deg,#f97316,#fb7185)';
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 3600);
  }

  function renderUser(d, user) {
    userNameEl.textContent = d.name || user.displayName || 'مستخدم';
    userEmailEl.textContent = d.email || user.email || '—';
    avatarEl.textContent = (d.name ? d.name.slice(0,1).toUpperCase() : (user.email? user.email[0].toUpperCase() : 'A'));
    userPointsEl.textContent = Number(d.points ?? 0);
    pointsTodayEl.textContent = Math.max((Number(d.points ?? 0) - Number(d.previousPoints ?? 0)), 0);
    totalWithdrawnEl.textContent = (d.totalWithdrawn ?? 0) + ' ج';
    pointsEgpEl.textContent = (Number(d.points ?? 0) * POINT_VALUE_EGP).toFixed(2) + ' ج';
    const progress = Math.min(100, Math.round(((Number(d.points ?? 0) % DAILY_TARGET) / DAILY_TARGET) * 100));
    progressBarEl.style.width = progress + '%';
    progressLabelEl.textContent = `${Number(d.points ?? 0)} / ${DAILY_TARGET} نقطة`;
    loadingMsg.textContent = 'أهلاً بك، لوحة التحكم جاهزة';
  }

  // ====== منطق منح نقاط الإحالة يومياً ======
  async function handleReferralDailyBonus(userId, userPoints) {
    const userRef = db.collection('users').doc(userId);
    const userSnap = await userRef.get();
    if (!userSnap.exists) return;
    const userData = userSnap.data();
    const referrerId = userData.referralBy;
    if (!referrerId) return;
    const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
    if (userData.lastReferralBonusDate === today) return;
    const bonusAmount = Math.floor(userPoints * 0.10);
    if (bonusAmount > 0) {
      const referrerRef = db.collection('users').doc(referrerId);
      await referrerRef.update({
        bonusPoint: firebase.firestore.FieldValue.increment(bonusAmount)
      });
      await userRef.update({ lastReferralBonusDate: today });
    }
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = 'index.html';
    try {
      loadingMsg.textContent = 'جارٍ تحميل بياناتك...';
      const uid = user.uid;
      const userRef = db.collection('users').doc(uid);
      const snap = await userRef.get();

      if (!snap.exists) {
        loadingMsg.textContent = 'لم نتمكن من العثور على حسابك';
        return;
      }

      const data = snap.data();
      if (data.previousPoints === undefined) {
        await userRef.update({ previousPoints: Number(data.points ?? 0) }).catch(()=>{});
        data.previousPoints = Number(data.points ?? 0);
      }

      renderUser(data, user);

      // منطق منح الإحالة يومياً
      await handleReferralDailyBonus(uid, Number(data.points ?? 0));

    } catch (err) {
      console.error(err);
      loadingMsg.textContent = 'حدث خطأ أثناء التحميل';
    }
  });

  refreshBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return location.href = 'index.html';
    loadingMsg.textContent = 'جارٍ التحديث...';
    try {
      const snap = await db.collection('users').doc(user.uid).get();
      if (snap.exists) renderUser(snap.data(), user);
      loadingMsg.textContent = 'تم التحديث';
      setTimeout(()=> loadingMsg.textContent = 'لوحة التحكم جاهزة', 1200);
    } catch (e) {
      console.error(e);
      loadingMsg.textContent = 'خطأ أثناء التحديث';
    }
  });

  logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=> location.href='index.html'));
</script>
</body>
  </html>
