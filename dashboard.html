<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
  <meta charset="utf-8" />  
  <title>لوحة التحكم — Am Rewards</title>  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">  
  <style>  
    :root{  
      --primary:#17e7b3;  
      --primary-dark:#12886b;  
      --bg-1:#082032;  
      --bg-2:#001b2e;  
      --glass:rgba(255,255,255,0.06);  
      --text:#e6eef6;  
      --muted:#9aa4b2;  
      --gold:#f6b93b;  
      --danger:#ff5f5f;  
      --secondary:#1fb6ff;  
      --surface:#091826;  
      --shadow:0 10px 40px rgba(7,22,34,0.6), 0 2px 8px rgba(31,182,255,0.06);  
    }  
    *{box-sizing:border-box}  
    html,body{height:100%}  
    body{  
      margin:0;padding:0;  
      font-family:"Cairo",sans-serif;  
      color:var(--text);  
      -webkit-font-smoothing:antialiased;  
      -moz-osx-font-smoothing:grayscale;  
      background:linear-gradient(135deg,var(--bg-1),var(--bg-2));  
      overflow-y:auto;  
    }  
    .bg-animated{  
      position:fixed;inset:0;z-index:-2;  
      background:linear-gradient(120deg,#062f3f, #0c1b3a 40%, #05202b 70%);  
      animation: moveBg 12s linear infinite;  
      opacity:0.95;  
    }  
    @keyframes moveBg {  
      0%{background-position:0% 50%}  
      50%{background-position:100% 50%}  
      100%{background-position:0% 50%}  
    }  
    .wrap{max-width:520px;margin:28px auto;padding:18px;}  
    .card{  
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));  
      border-radius:16px;  
      padding:16px;  
      box-shadow:var(--shadow);  
      border:1px solid var(--glass);  
      backdrop-filter: blur(6px);  
    }  
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}  
    .brand{display:flex;gap:12px;align-items:center}  
    .logo{  
      width:58px;height:58px;border-radius:14px;  
      background:linear-gradient(135deg,var(--primary),var(--secondary));  
      display:flex;align-items:center;justify-content:center;  
      color:#08121a;font-weight:900;font-size:22px;box-shadow:0 6px 22px rgba(23,231,179,0.12);  
    }  
    .headline h1{margin:0;font-size:20px;color:var(--primary)}  
    .headline .sub{margin-top:4px;font-size:13px;color:var(--muted)}  
    .profile {
      display:flex;gap:12px;align-items:center;margin-top:12px;  
      animation: fadeUp .65s ease both;  
    }  
    .avatar{  
      width:72px;height:72px;border-radius:16px;  
      background:linear-gradient(135deg,#fff2,#fff0);  
      display:flex;align-items:center;justify-content:center;color:#09121a;font-weight:900;font-size:26px;  
      box-shadow:0 8px 30px rgba(0,0,0,0.4);  
      flex-shrink:0;  
    }  
    .profile-info{flex:1;text-align:right}
    .profile-info h3{margin:0;font-size:19px}  
    .profile-info p{margin:4px 0 0 0;color:var(--muted);font-size:13px;word-break:break-all}  
    .profile-actions{display:flex;gap:8px;margin-top:10px}  
    .btn{  
      padding:9px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800;font-size:13px;  
      display:inline-flex;gap:8px;align-items:center;justify-content:center;  
      transition: background 0.2s, box-shadow 0.2s;
    }  
    .btn.ghost{background:transparent;border:1.5px solid var(--glass);color:var(--muted)}  
    .btn.ghost:hover{background:var(--glass)}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#07101a;box-shadow:0 8px 20px rgba(31,182,255,0.08)}  
    .balance-wrap{display:flex;gap:10px;align-items:stretch;margin-top:14px;animation: fadeUp .75s .08s both}  
    .balance-card{  
      flex:1;padding:16px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));  
      border:1px solid var(--glass);  
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-end;
    }  
    .bal-title{font-size:13px;color:var(--muted);margin-bottom:6px;text-align:right}  
    .bal-value{font-size:34px;font-weight:900;line-height:1;margin:0}  
    .bal-egp{color:var(--gold);font-weight:700;margin-top:6px;font-size:14px}  
    .progress-card{  
      width:120px;height:120px;border-radius:16px;display:flex;align-items:center;justify-content:center;  
      background:linear-gradient(90deg, rgba(31,182,255,0.04), rgba(23,231,179,0.02));  
      border:1px solid var(--glass);  
      flex-shrink:0;  
      animation: fadeUp .75s .12s both;  
    }  
    .circle{  
      width:94px;height:94px;border-radius:50%;display:flex;align-items:center;justify-content:center;  
      background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02));  
      box-shadow:inset 0 2px 6px rgba(0,0,0,0.4);  
      text-align:center;  
    }  
    .circle .num{font-weight:900;font-size:18px;color:var(--primary)}  
    .circle .lbl{display:block;font-size:11px;color:var(--muted);margin-top:4px}  
    .actions{display:flex;flex-direction:column;gap:10px;margin-top:14px;animation: fadeUp .9s .16s both}  
    .action-btn{  
      display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;  
      background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));  
      border:1px solid var(--glass);cursor:pointer;text-decoration:none;color:var(--text);font-weight:800;  
      box-shadow:0 6px 24px rgba(2,6,23,0.25);  
      transition: transform 0.15s, box-shadow 0.15s;
    }  
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(2,6,23,0.35);}
    .action-left{display:flex;align-items:center;gap:12px}  
    .action-ico{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--primary),var(--secondary));color:#08121a;font-weight:900}  
    .action-title{font-size:15px}  
    .action-sub{font-size:12px;color:var(--muted);margin-top:3px;font-weight:600}  
    .stats-row{display:flex;gap:10px;margin-top:12px}  
    .stat-card{flex:1;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid var(--glass);text-align:center}  
    .stat-number{font-weight:900;font-size:18px}  
    .stat-label{font-size:12px;color:var(--muted);margin-top:6px}  
    footer{margin:22px 0 18px 0;text-align:center;color:rgba(255,255,255,0.14);font-size:13px}  
    @keyframes fadeUp {  
      from {opacity:0; transform: translateY(12px)}  
      to {opacity:1; transform: translateY(0)}  
    }  
    @media(max-width:480px){  
      .wrap{padding:12px}  
      .profile{gap:10px; flex-direction: column-reverse !important; align-items: flex-end !important;}
      .profile-info{text-align: right !important;}
      .profile-actions{justify-content: flex-end;}
      .balance-wrap{flex-direction:column-reverse;align-items:flex-end; gap: 12px;}
      .progress-card{width:100%;height:84px;border-radius:12px;padding:10px}  
      .circle{width:64px;height:64px}  
      .bal-value{font-size:26px}  
      .action-ico{width:40px;height:40}  
      .logo{width:50px;height:50;font-size:18px}  
    }  
    /* Toast Styles */  
    .toast {  
      min-width: 140px;  
      max-width: 320px;  
      padding: 13px 22px;  
      border-radius: 13px;  
      color: #fff;  
      font-weight: 800;  
      text-align: center;  
      position: fixed;  
      right: 22px;  
      bottom: 38px;  
      opacity: 0;  
      pointer-events: none;  
      transition: opacity 0.2s, transform 0.3s;  
      z-index: 999;  
      box-shadow: 0 8px 30px #0004, 0 2px 8px #0002;  
      font-size: 16px;  
      transform: translateY(30px);  
      background: linear-gradient(90deg,#16a34a,#34d399); 
    }  
    .toast.error {
      background: linear-gradient(90deg,#f97316,#fb7185) !important;
    }
    .toast.show {  
      opacity: 1;  
      pointer-events: auto;  
      transform: translateY(0);  
    }  
    @media (max-width: 600px) {  
      .toast {  
        right: 50%;  
        transform: translateX(50%) translateY(30px);  
        left: auto;  
        bottom: 18px;  
        font-size: 13px;  
        padding: 9px 12px;  
        min-width: 90px;  
        max-width: 96vw;  
      }  
      .toast.show {  
        transform: translateX(50%) translateY(0);  
      }  
    }  
  </style>  
</head>  
<body>  
  <div class="bg-animated" aria-hidden="true"></div>  
  <div class="wrap">  
    <header>  
      <div class="brand">  
        <div class="logo">AM</div>  
        <div class="headline">  
          <h1>Am Rewards</h1>  
          <div class="sub">سارع بجمع النقاط — الثقة والأمان أولًا</div>  
        </div>  
      </div>  
      <div style="text-align:left">  
        <button id="refreshBtnTop" class="btn ghost" title="تحديث">
          <svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;stroke-width:2.5"><path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C14.1599 3 16.2162 3.73719 17.8856 5.03509" stroke="currentColor" stroke-linecap="round"/><path d="M17 3V7H21" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>  
      </div>  
    </header>  
    
    <div class="card profile" style="flex-direction: row-reverse; gap: 15px;">
        <div class="avatar" id="avatar">A</div>
        <div class="profile-info" style="text-align: right; flex: 1;">
            <h3 id="userName">مستخدم</h3>
            <p id="userEmail">—</p>
            <p id="userRefCode" style="font-size:12px; color:var(--primary); margin: 0 0 4px 0; font-weight: 700;">كود الإحالة: —</p>
            <div class="profile-actions">
                <button id="logoutBtn" class="btn ghost">تسجيل خروج</button>
            </div>
        </div>
    </div>
    
    <div class="card balance-wrap">  
      <div class="balance-card">  
        <div class="bal-title">الرصيد الحالي (نقاط)</div>  
        <div class="bal-value" id="userPoints">0</div>  
        <div class="bal-egp" style="color: var(--primary); font-size: 14px; margin-top: 6px;" id="pointsEgp">0.00 ج</div>  
      </div>  

      <div class="balance-card" style="background: linear-gradient(180deg, rgba(246, 185, 59, 0.1), rgba(246, 185, 59, 0.05));">
          <div class="bal-title" style="color: var(--gold);">رصيدي بالجنيه المصري</div>
          <div class="bal-value" style="color: var(--gold);" id="userBalanceEgp">0.00</div>
          <div class="bal-egp" style="color: var(--muted); font-weight: 600; margin-top: 6px;">$1$ نقطة = $0.07$ ج</div>
      </div>
    </div>  
    
    <div class="actions">  
      <a class="action-btn" href="tasks.html">  
        <div class="action-left">  
          <div class="action-ico">📝</div>  
          <div>  
            <div class="action-title">المهام</div>  
            <div class="action-sub">أكمل مهامك لربح نقاط</div>  
          </div>  
        </div>  
        <div style="color:var(--muted);font-weight:800">اذهب</div>  
      </a>  
      <a class="action-btn" href="referrals.html">  
        <div class="action-left">  
          <div class="action-ico" style="background:linear-gradient(90deg,var(--gold),#ffd27f)">👥</div>  
          <div>  
            <div class="action-title">الإحالات</div>  
            <div class="action-sub">ادعُ أصدقائك واكسب نسبة</div>  
          </div>  
        </div>  
        <div style="color:var(--muted);font-weight:800">عرض</div>  
      </a>  

      <a class="action-btn" href="mailto:support@am-rewards.com" target="_blank" style="border-color: rgba(255, 95, 95, 0.3);">  
        <div class="action-left">  
          <div class="action-ico" style="background:linear-gradient(90deg,var(--danger),#ff8a8a)">💬</div>  
          <div>  
            <div class="action-title">تواصل معنا</div>  
            <div class="action-sub">دعم فني على مدار الساعة</div>  
          </div>  
        </div>  
        <div style="color:var(--muted);font-weight:800">دعم</div>  
      </a>

      <a class="action-btn" href="withdraw.html">  
        <div class="action-left">  
          <div class="action-ico" style="background:linear-gradient(90deg,#1fb6ff,#5fffb6)">💸</div>  
          <div>  
            <div class="action-title">السحب</div>  
            <div class="action-sub">اطلب سحب أرباحك</div>  
          </div>  
        </div>  
        <div style="color:var(--muted);font-weight:800">سحب</div>  
      </a>  
    </div>  
    <div class="stats-row" style="margin-top:14px">  
      <div class="stat-card">  
        <div class="stat-number" id="pointsToday">0</div>  
        <div class="stat-label">نقاط اليوم</div>  
      </div>  
      <div class="stat-card">  
        <div class="stat-number" id="totalWithdrawn">0 ج</div>  
        <div class="stat-label">إجمالي السحوبات</div>  
      </div>  
      <div class="stat-card">  
        <div class="stat-number" id="referralPoints">0</div>  
        <div class="stat-label">نقاط الإحالات</div>  
      </div>  
    </div>  
    <footer>© Am Rewards</footer>  
  </div>  
  <div id="toast" class="toast" role="status" aria-live="polite"></div>  
  
  <script type="module">  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";  
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";  
    import { 
      getFirestore, 
      doc, 
      updateDoc, 
      onSnapshot, 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";  
    
    // **1. الإعدادات**
    const firebaseConfig = {  
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
      authDomain: "am--rewards.firebaseapp.com",  
      projectId: "am--rewards",  
    };  
    const app = initializeApp(firebaseConfig);  
    const auth = getAuth(app);  
    const db = getFirestore(app);  
    
    // **2. الثوابت**
    const POINT_VALUE_EGP = 0.07;  
    const DAILY_TARGET = 1000;  

    // **3. عناصر DOM**
    const userNameEl = document.getElementById('userName');  
    const userEmailEl = document.getElementById('userEmail');  
    const userRefCodeEl = document.getElementById('userRefCode');
    const avatarEl = document.getElementById('avatar');  
    const userPointsEl = document.getElementById('userPoints');  
    const pointsTodayEl = document.getElementById('pointsToday');  
    const totalWithdrawnEl = document.getElementById('totalWithdrawn');  
    const progressPercentEl = document.getElementById('progressPercent');  
    const progressLblEl = document.getElementById('progressLbl');  
    const pointsEgpEl = document.getElementById('pointsEgp');  
    const referralPointsEl = document.getElementById('referralPoints');  
    const userBalanceEgpEl = document.getElementById('userBalanceEgp'); // 🟢 العنصر الجديد
    const refreshBtn = document.getElementById('refreshBtnTop');  
    const logoutBtn = document.getElementById('logoutBtn');  
    const toast = document.getElementById('toast');  
    const circle = document.getElementById('circleWrap');  

    // **4. الدوال المساعدة**
    function showToast(text, success=true) {  
      toast.textContent = text;  
      toast.className = 'toast'; 
      if (!success) {
        toast.classList.add('error');
      }
      toast.classList.add('show');  
      setTimeout(()=> toast.classList.remove('show'), 3200);  
    }  

    function getAvatarChar(name, email) {
        if (name && name.length > 0) return name.trim()[0].toUpperCase();
        if (email && email.length > 0) return email.trim()[0].toUpperCase();
        return 'A';
    }

    // **5. دالة عرض بيانات المستخدم**
    function renderUser(d, user) {  
      userNameEl.textContent = d.name || user.displayName || 'مستخدم';  
      userEmailEl.textContent = d.email || user.email || '—';  
      userRefCodeEl.textContent = `كود الإحالة: ${d.referralCode || '—'}`;
      avatarEl.textContent = getAvatarChar(d.name, user.email);
      
      const pts = Number(d.points ?? 0);  
      // 🟢 حساب قيمة النقاط بالجنيه المصري
      const egpBalance = (pts * POINT_VALUE_EGP).toFixed(2);
      
      userPointsEl.textContent = pts.toLocaleString(); 
      pointsEgpEl.textContent = egpBalance + ' ج'; 
      
      // 🟢 عرض الرصيد الجديد
      userBalanceEgpEl.textContent = egpBalance; 
      
      const prevPts = Number(d.previousPoints ?? 0);
      const pointsToday = Math.max((pts - prevPts), 0); 
      pointsTodayEl.textContent = pointsToday.toLocaleString();  
      
      totalWithdrawnEl.textContent = (Number(d.totalWithdrawn ?? 0)).toLocaleString() + ' ج';  
      referralPointsEl.textContent = (Number(d.referralPoints ?? 0)).toLocaleString();  

      // حساب التقدم الدائري
      const todayProgress = Math.min(DAILY_TARGET, (pts % DAILY_TARGET));  
      const pct = Math.round((todayProgress / DAILY_TARGET) * 100);  
      
      progressPercentEl.textContent = pct + '%';  
      progressLblEl.textContent = `${todayProgress.toLocaleString()} / ${DAILY_TARGET.toLocaleString()}`;  
      
      // تحديث الدائرة
      circle.style.background = `conic-gradient(var(--primary) ${pct}%, rgba(255,255,255,0.02) ${pct}%)`;  
    }  

    // **6. منطق حالة المصادقة (Auth State Listener)**
    onAuthStateChanged(auth, async (user) => {  
      if (!user) return location.href = 'index.html';  
      
      const uid = user.uid;  
      const userRef = doc(db, 'users', uid);  
      
      // ربط مستمع Realtime (onSnapshot)
      onSnapshot(userRef, async (snap) => {
        if (!snap.exists()) {
          showToast('بيانات الحساب غير موجودة، يتم تسجيل الخروج.', false);  
          await signOut(auth);
          return;
        }
        
        const data = snap.data();  

        // 🛑 تهيئة حقل نقاط الأمس لمرة واحدة
        if (data.previousPoints === undefined) {  
          await updateDoc(userRef, { previousPoints: Number(data.points ?? 0) }).catch(()=>{});  
          data.previousPoints = Number(data.points ?? 0);  
        }  

        renderUser(data, user);  
        
      }, (error) => {
        // التعامل مع أخطاء قواعد الأمان
        showToast('خطأ في قراءة البيانات. تحقق من صلاحياتك.', false);
        console.error("Firestore error:", error);
      });

    });  

    // **7. الأزرار**
    
    // دالة التحديث اليدوي
    refreshBtn.addEventListener('click', () => {  
      showToast('تم التحديث'); 
    });  

    // دالة تسجيل الخروج
    logoutBtn.addEventListener('click', () => { 
        signOut(auth).then(() => {
            location.href = 'index.html';
        }).catch((e) => {
            showToast('حدث خطأ أثناء تسجيل الخروج', false);
            console.error(e);
        });
    });  

  </script>  
</body>  
  </html>
