<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Am Rewards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#17e7b3;
      --primary-dark:#12886b;
      --bg:#121826;
      --glass:rgba(255,255,255,0.07);
      --text:#e6eef6;
      --muted:#9aa4b2;
      --gold:#f6b93b;
      --danger:#ff5f5f;
      --secondary:#1fb6ff;
      --surface:#19223a;
      --shadow:0 4px 32px rgba(23,231,179,0.10),0 1px 0 rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box}
    body{
      background:linear-gradient(135deg,#121826 60%,#181d2f 100%);
      color:var(--text);font-family:"Cairo",sans-serif;margin:0;padding:0;min-height:100vh;
    }
    .wrap{max-width:480px;margin:32px auto 0 auto;padding:0 8px;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:#131c24;font-size:20px;font-weight:900;box-shadow:0 4px 16px #17e7b328;}
    .headline h1{color:var(--primary);margin:0;font-size:21px}
    .headline .sub{color:var(--muted);font-size:13px;}
    .profile-card{
      background:var(--surface);
      box-shadow:var(--shadow);
      border-radius:16px;
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      border:1px solid var(--glass);
    }
    .profile-info{display:flex;align-items:center;gap:10px;}
    .avatar{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#fff2,#fff0);display:flex;align-items:center;justify-content:center;font-weight:900;color:#222;font-size:17px;}
    .profile-details h3{margin:0 0 2px 0;font-size:16px;}
    .profile-details p{margin:0;color:var(--muted);font-size:13px;}
    .profile-actions{display:flex;gap:7px;}
    .btn{
      padding:8px 14px;
      border-radius:10px;
      text-decoration:none;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      border:0;
      transition:background .2s, color .2s;
      display:flex; align-items:center; gap:6px;
      box-shadow:0 2px 12px #17e7b315;
    }
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#191f2c;}
    .btn.ghost{background:transparent;border:1.5px solid var(--glass);color:var(--muted);}
    .card{
      background:var(--surface);
      border-radius:18px;
      margin-bottom:16px;
      box-shadow:var(--shadow);
      padding:16px 14px 18px 14px;
      border:1px solid var(--glass);
    }
    .bal-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
    .bal-title{color:var(--muted);font-size:14px;}
    .bal-main{font-size:30px;font-weight:900;margin-bottom:0;}
    .bal-egp{color:var(--gold);font-size:13px;}
    .quick-actions{display:flex;gap:9px;margin:15px 0 10px 0;}
    .quick-actions a{
      flex:1;
      padding:11px 0;
      border-radius:10px;
      font-weight:800;
      font-size:16px;
      text-decoration:none;
      background:linear-gradient(90deg,var(--primary),var(--secondary));
      color:#181d2f;
      box-shadow:0 2px 8px #1fb6ff1a;
      transition:background .2s;
      display:flex;align-items:center;justify-content:center;
    }
    .quick-actions a.ref{background:linear-gradient(90deg,var(--gold),#ffd27f);color:#112;}
    .quick-actions a.withdraw{background:linear-gradient(90deg,#1fb6ff,#5fffb6);color:#012;}
    .stats{
      display:flex;
      gap:10px;
      margin-bottom:8px;
    }
    .stat{
      flex:1;
      background:var(--bg);
      border-radius:10px;
      padding:11px 5px 8px 5px;
      text-align:center;
      box-shadow:0 2px 8px #1fb6ff0a;
      border:1px solid var(--glass);
      min-width:0;
    }
    .stat-label{font-size:12px;color:var(--muted);}
    .stat-value{font-weight:900;font-size:19px;}
    .stat-note{color:var(--muted);font-size:11px;}
    .progress-wrap{margin:13px 0 2px 0;}
    .progress-label{font-size:12px;color:var(--muted);margin-bottom:5px;}
    .progress-bar{
      height:10px;
      background:rgba(255,255,255,0.07);
      border-radius:999px;
      overflow:hidden;
      position:relative;
    }
    .progress-bar i{
      display:block;
      height:100%;
      background:linear-gradient(90deg,var(--primary),var(--secondary));
      width:0%;
      transition:width .7s cubic-bezier(.23,.9,.32,1);
    }
    .progress-count{font-size:13px;color:var(--primary);margin-top:5px;text-align:left;}
    footer{margin:30px 0 10px 0;text-align:center;color:rgba(255,255,255,0.12);font-size:13px}
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(20px);bottom:26px;padding:12px 18px;border-radius:12px;background:linear-gradient(90deg,#16a34a,#34d399);color:#052;box-shadow:0 10px 30px rgba(2,6,23,0.45);opacity:0;pointer-events:none;transition:all .36s cubic-bezier(.2,.9,.3,1);z-index:9999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
    @media(max-width:650px){
      .wrap{max-width:98vw;}
      .profile-card{flex-direction:column;align-items:flex-end;padding:9px;}
      .profile-info{margin-bottom:7px;}
      .stats{gap:7px;}
      .bal-main{font-size:21px;}
      .btn{font-size:12px;}
      .card{padding:11px 7px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AM</div>
        <div class="headline">
          <h1>Am Rewards</h1>
          <div class="sub">Ø³Ø§Ø±Ø¹ Ø¨Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ø±Ø¨Ø­ <b>10%</b> ÙŠÙˆÙ…ÙŠÙ‹Ø§</div>
        </div>
      </div>
    </header>

    <div class="profile-card">
      <div class="profile-info">
        <div class="avatar" id="avatar">A</div>
        <div class="profile-details">
          <h3 id="userName">Ù…Ø³ØªØ®Ø¯Ù…</h3>
          <p id="userEmail" class="muted">â€”</p>
        </div>
      </div>
      <div class="profile-actions">
        <button class="btn primary" id="refreshBtn">ØªØ­Ø¯ÙŠØ« ğŸ”„</button>
        <button class="btn ghost" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸ“¤</button>
      </div>
    </div>

    <div class="card">
      <div class="bal-row">
        <div>
          <div class="bal-title">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†Ù‚Ø§Ø·)</div>
          <div class="bal-main" id="userPoints">0</div>
        </div>
        <div class="bal-egp" id="pointsEgp">0.00 Ø¬</div>
      </div>
      <div class="quick-actions">
        <a href="tasks.html">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</a>
        <a class="ref" href="referrals.html">ğŸ‘¥ Ø¥Ø­Ø§Ù„Ø§Øª</a>
        <a class="withdraw" href="withdraw.html">ğŸ’¸ Ø³Ø­Ø¨</a>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="stat-value" id="pointsToday">0</div>
          <div class="stat-note">Ù…Ù† Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„/ÙØ­Øµ</div>
        </div>
        <div class="stat">
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</div>
          <div class="stat-value" id="totalWithdrawn">0 Ø¬</div>
          <div class="stat-note">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨</div>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-label">ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
        <div class="progress-bar"><i id="progressBar"></i></div>
        <div class="progress-count" id="progressLabel">0 / 1000 Ù†Ù‚Ø·Ø©</div>
      </div>
    </div>
    <footer>Â© Am Rewards</footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
    storageBucket: "am--rewards.appspot.com",
    messagingSenderId: "744783579735",
    appId: "1:744783579735:web:45e00de9998893bbc9b112"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const POINT_VALUE_EGP = 0.07;
  const DAILY_TARGET = 1000;

  const userNameEl = document.getElementById('userName');
  const userEmailEl = document.getElementById('userEmail');
  const avatarEl = document.getElementById('avatar');
  const userPointsEl = document.getElementById('userPoints');
  const pointsTodayEl = document.getElementById('pointsToday');
  const totalWithdrawnEl = document.getElementById('totalWithdrawn');
  const progressBarEl = document.getElementById('progressBar');
  const progressLabelEl = document.getElementById('progressLabel');
  const pointsEgpEl = document.getElementById('pointsEgp');
  const refreshBtn = document.getElementById('refreshBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const toast = document.getElementById('toast');

  function showToast(text, success=true) {
    toast.textContent = text;
    toast.style.background = success ? 'linear-gradient(90deg,#16a34a,#34d399)' : 'linear-gradient(90deg,#f97316,#fb7185)';
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 3600);
  }

  function renderUser(d, user) {
    userNameEl.textContent = d.name || user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
    userEmailEl.textContent = d.email || user.email || 'â€”';
    avatarEl.textContent = (d.name ? d.name.slice(0,1).toUpperCase() : (user.email? user.email[0].toUpperCase() : 'A'));
    userPointsEl.textContent = Number(d.points ?? 0);
    pointsTodayEl.textContent = Math.max((Number(d.points ?? 0) - Number(d.previousPoints ?? 0)), 0);
    totalWithdrawnEl.textContent = (d.totalWithdrawn ?? 0) + ' Ø¬';
    pointsEgpEl.textContent = (Number(d.points ?? 0) * POINT_VALUE_EGP).toFixed(2) + ' Ø¬';
    const progress = Math.min(100, Math.round(((Number(d.points ?? 0) % DAILY_TARGET) / DAILY_TARGET) * 100));
    progressBarEl.style.width = progress + '%';
    progressLabelEl.textContent = `${Number(d.points ?? 0)} / ${DAILY_TARGET} Ù†Ù‚Ø·Ø©`;
  }

  // ====== Ù…Ù†Ø·Ù‚ Ù…Ù†Ø­ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ ======
  async function handleReferralDailyBonus(userId, userPoints) {
    const userRef = db.collection('users').doc(userId);
    const userSnap = await userRef.get();
    if (!userSnap.exists) return;
    const userData = userSnap.data();
    const referrerId = userData.referralBy;
    if (!referrerId) return;
    const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
    if (userData.lastReferralBonusDate === today) return;
    const bonusAmount = Math.floor(userPoints * 0.10);
    if (bonusAmount > 0) {
      const referrerRef = db.collection('users').doc(referrerId);
      await referrerRef.update({
        bonusPoint: firebase.firestore.FieldValue.increment(bonusAmount)
      });
      await userRef.update({ lastReferralBonusDate: today });
    }
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = 'index.html';
    try {
      const uid = user.uid;
      const userRef = db.collection('users').doc(uid);
      const snap = await userRef.get();

      if (!snap.exists) return;

      const data = snap.data();
      if (data.previousPoints === undefined) {
        await userRef.update({ previousPoints: Number(data.points ?? 0) }).catch(()=>{});
        data.previousPoints = Number(data.points ?? 0);
      }

      renderUser(data, user);

      // Ù…Ù†Ø·Ù‚ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹
      await handleReferralDailyBonus(uid, Number(data.points ?? 0));

    } catch (err) {
      showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„', false);
    }
  });

  refreshBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return location.href = 'index.html';
    showToast('Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
    try {
      const snap = await db.collection('users').doc(user.uid).get();
      if (snap.exists) renderUser(snap.data(), user);
      showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
    } catch (e) {
      showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', false);
    }
  });

  logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=> location.href='index.html'));
</script>
</body>
  </html>
