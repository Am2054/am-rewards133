<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>لوحة التحكم | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1: #0d1117;
      --bg2: #203a43;
      --accent: #f39c12;
      --card: rgba(30,34,44,0.96);
      --muted: #9ca3af;
    }
    html,body{height:100%;margin:0;padding:0;font-family:'Cairo',sans-serif;background:linear-gradient(120deg,var(--bg1) 0%,var(--bg2) 60%, #2c5364 100%);color:#fff}
    .container{max-width:900px;margin:20px auto;padding:18px;box-sizing:border-box;}
    .top { display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:18px; }
    h1{margin:0;font-size:1.7rem;color:var(--accent);text-shadow:0 0 10px #0008}
    .card { background:var(--card); border-radius:14px; padding:18px; box-shadow:0 6px 30px rgba(2,6,23,0.5); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:14px; margin-top:14px; }
    .stat { padding:16px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); }
    .stat h3{margin:0;font-size:0.95rem;color:var(--muted)}
    .stat p{margin:8px 0 0;font-size:1.3rem;font-weight:800;color:#fff}
    .actions { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .btn { display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;color:#111;font-weight:800; text-align:center; }
    .btn.primary{background:linear-gradient(90deg,#3498db,#38bdf8); box-shadow:0 6px 24px rgba(56,189,248,0.12);}
    .btn.green{background:linear-gradient(90deg,#2ecc71,#22c55e);}
    .btn.gold{background:linear-gradient(90deg,#f1c40f,#fde047); color:#111;}
    .links { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .small { font-size:0.85rem; color:var(--muted); margin-top:6px; }
    footer { text-align:center; margin-top:20px; color: #bfcfe0; font-size:0.9rem; }

    /* loading / error */
    .loading { color:#22c55e; font-weight:700; }
    .error { color:#ff7b7b; font-weight:700; }

    /* toast */
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      bottom: 26px;
      padding: 12px 18px;
      border-radius: 12px;
      background: linear-gradient(90deg,#16a34a,#34d399);
      color: #042;
      font-weight:800;
      box-shadow: 0 10px 30px rgba(2,6,23,0.45);
      opacity: 0;
      pointer-events: none;
      transition: all 360ms cubic-bezier(.2,.9,.3,1);
      z-index: 9999;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events:auto; }

    /* responsive tweaks */
    @media (max-width:640px){
      h1{font-size:1.3rem}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>لوحة التحكم — Am Rewards</h1>
      <div class="small">مرحبا بك — سارع بجمع النقاط وادعُ أصدقائك لربح 10% يوميًا</div>
    </div>

    <div class="card">
      <div id="loadingMsg" class="loading">جاري تحميل بياناتك...</div>
      <div id="errorMsg" class="error" style="display:none"></div>

      <div id="mainContent" style="display:none">
        <div class="grid">
          <div class="stat">
            <h3>الاسم</h3>
            <p id="userName">—</p>
            <div class="small">الإيميل: <span id="userEmail">—</span></div>
          </div>

          <div class="stat">
            <h3>النقاط</h3>
            <p id="userPoints">0</p>
            <div class="small">قيمة النقاط: <span id="pointsEgp">0.00</span> جم</div>
          </div>

          <div class="stat">
            <h3>نقاط الإحالات</h3>
            <p id="referralPoints">0</p>
            <div class="small">هذه نقاط الداعي التي حصل عليها من إحالاته</div>
          </div>

          <div class="stat">
            <h3>نقاط إضافية</h3>
            <p id="bonusPoint">0</p>
            <div class="small">مكافآت إضافية/بونص</div>
          </div>
        </div>

        <div style="display:flex; gap:14px; margin-top:14px; flex-wrap:wrap;">
          <div style="flex:1; min-width:180px">
            <div class="card" style="padding:12px;">
              <h3 style="margin:0 0 6px 0">روابط سريعة</h3>
              <div class="links">
                <a class="btn primary" href="tasks.html">📝 الذهاب للمهام</a>
                <a class="btn green" href="withdraw.html">💸 طلب السحب</a>
                <a class="btn gold" href="referrals.html">👥 صفحة الإحالات</a>
              </div>
            </div>
          </div>

          <div style="flex:1; min-width:180px">
            <div class="card" style="padding:12px;">
              <h3 style="margin:0 0 6px 0">ملخص سريع</h3>
              <div class="small">عرض سريع لمعلومات الحساب</div>
              <div style="margin-top:8px" id="quickStats"></div>
            </div>
          </div>
        </div>

      </div> <!-- mainContent -->

    </div> <!-- card -->

    <footer>© Am Rewards</footer>
  </div>

  <!-- toast -->
  <div id="toast" class="toast">🎉 تمت إضافة مكافأة الداعي!</div>

  <!-- Firebase v8 (متوافق مع كودك السابق) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  // ========== إعداد Firebase (استخدم نفس الإعدادات عندك) ==========
  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
    storageBucket: "am--rewards.appspot.com",
    messagingSenderId: "744783579735",
    appId: "1:744783579735:web:45e00de9998893bbc9b112"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // إعدادات صفحة
  const POINT_VALUE_EGP = 0.07;

  const loadingMsg = document.getElementById('loadingMsg');
  const errorMsg = document.getElementById('errorMsg');
  const mainContent = document.getElementById('mainContent');
  const toastEl = document.getElementById('toast');

  function showToast(text) {
    toastEl.textContent = text;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 3500);
  }

  // دالة مساعدة: نحدد مرجع الداعي مهما كان مخزن كـ uid أو referralCode
  async function getReferrerDocRef(referralBy) {
    if (!referralBy) return null;
    // احتمالات: referralBy قد يكون UID طويل أو كود قصير (مثلاً 6 أحرف)
    if (typeof referralBy === 'string' && referralBy.length > 20) {
      // نفترض UID
      return db.collection('users').doc(referralBy);
    } else {
      // نفترض كود إحالة: نبحث عن المستخدم صاحب الكود
      const q = db.collection('users').where('referralCode', '==', referralBy).limit(1);
      const snap = await q.get();
      if (!snap.empty) return snap.docs[0].ref;
      return null;
    }
  }

  // الدالة الأساسية: حساب ومكافأة الداعي (10%) مرة واحدة يوميًا عند فتح الداشبورد
  async function handleReferralReward(uid, userData) {
    try {
      if (!userData) return;
      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      const prevPoints = Number(userData.previousPoints ?? 0);
      const currentPoints = Number(userData.points ?? 0);
      const lastDate = userData.lastReferralRewardDate ?? '';
      const referralBy = userData.referralBy ?? null;

      // إذا لم يكن لدينا previousPoints نفعلها (حالة أول تسجيل)
      if (userData.previousPoints === undefined) {
        await db.collection('users').doc(uid).update({ previousPoints: currentPoints });
        // لا نكمل حساب اليوم أول مرة لأننا لم نحتفظ بقاعدة للمقارنة
        return;
      }

      // شرط منح المكافأة: يوجد رافع (referralBy) + لم تُمنَح اليوم + ربح اليوم > 0
      const gainedToday = Math.max(currentPoints - prevPoints, 0);
      if (!referralBy || lastDate === today || gainedToday <= 0) {
        // فقط نحدث previousPoints و lastReferralRewardDate إذا لم تكن محدثة
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{/* ignore */});
        return;
      }

      // حصلنا على مرجع الداعي (مستند)
      const referrerDocRef = await getReferrerDocRef(referralBy);
      if (!referrerDocRef) {
        // لا يوجد داعٍ مطابق - نحدّث سابق النقاط فقط
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{/* ignore */});
        return;
      }

      const reward = Math.floor(gainedToday * 0.10); // 10%

      if (reward <= 0) {
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{/* ignore */});
        return;
      }

      // نفّذ كتلة مضمونة Transaction لتحديث الداعي وتسجيل اللوج
      await db.runTransaction(async (tx) => {
        // اجلب بيانات الداعي
        const refSnap = await tx.get(referrerDocRef);
        if (!refSnap.exists) {
          // حدثت حالة غير متوقعة
          tx.update(db.collection('users').doc(uid), {
            previousPoints: currentPoints,
            lastReferralRewardDate: today
          });
          return;
        }

        // زيادة referralPoints للداعي (مكافأة)
        const curReferralPoints = Number(refSnap.data().referralPoints ?? 0);
        tx.update(referrerDocRef, {
          referralPoints: curReferralPoints + reward
        });

        // سجّل اللوج (مفيد للتتبع)
        const logRef = db.collection('referralLogs').doc();
        tx.set(logRef, {
          type: 'daily_bonus',
          referrer: referrerDocRef.id,
          referred: uid,
          rewardPoints: reward,
          gainedPoints: gainedToday,
          date: firebase.firestore.FieldValue.serverTimestamp()
        });

        // وأخيراً: حدّث بيانات المستخدم الذي تم احتسابه له
        tx.update(db.collection('users').doc(uid), {
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        });
      });

      // show toast وConsole
      showToast(`🎉 تم إضافة ${reward} نقطة إلى داعيك!`);
      console.log(`Referral reward: added ${reward} points to ${referrerDocRef.id}`);

    } catch (err) {
      console.error('خطأ أثناء حساب مكافأة الإحالة:', err);
    }
  }

  // دالة لتحديث واجهة المستخدم
  function renderData(data, user) {
    document.getElementById('userName').textContent = data.name || user.displayName || 'مستخدم';
    document.getElementById('userEmail').textContent = data.email || user.email || '—';
    document.getElementById('userPoints').textContent = Number(data.points ?? 0);
    document.getElementById('referralPoints').textContent = Number(data.referralPoints ?? 0);
    document.getElementById('bonusPoint').textContent = Number(data.bonusPoint ?? 0);
    // عرض القيمة بالجنيه
    const egp = (Number(data.points ?? 0) * POINT_VALUE_EGP).toFixed(2);
    document.getElementById('pointsEgp').textContent = egp;
    // quick stats
    document.getElementById('quickStats').innerHTML = `
      <div class="small">إحالات: <strong>${data.referralCount ?? 0}</strong></div>
      <div class="small">مسحوبات إجمالية: <strong>${data.totalWithdrawn ?? 0} ج</strong></div>
    `;
  }

  // استمع لحالة الدخول
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }

    try {
      const userRef = db.collection('users').doc(user.uid);
      const docSnap = await userRef.get();
      loadingMsg.style.display = 'none';

      if (!docSnap.exists) {
        errorMsg.style.display = 'block';
        errorMsg.textContent = 'لم يتم العثور على حسابك في النظام.';
        return;
      }

      const data = docSnap.data();

      // تأكد أن previousPoints موجود (لو مش موجود، خزنه دون حساب مكافأة)
      if (data.previousPoints === undefined) {
        await userRef.update({ previousPoints: Number(data.points ?? 0) }).catch(()=>{/* ignore */});
        data.previousPoints = Number(data.points ?? 0);
      }

      // عرض البيانات
      renderData(data, user);
      mainContent.style.display = 'block';

      // حساب مكافأة الإحالة (مرة يوميًا)
      await handleReferralReward(user.uid, data);

    } catch (err) {
      console.error(err);
      loadingMsg.style.display = 'none';
      errorMsg.style.display = 'block';
      errorMsg.textContent = 'حدث خطأ في تحميل بياناتك. حاول مرة أخرى.';
    }
  });

  // تسجيل خروج
  function logout() {
    auth.signOut().then(()=> location.href = 'index.html');
  }
  </script>
</body>
  </html>
