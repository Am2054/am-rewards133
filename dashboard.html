<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1: #0d1117;
      --bg2: #203a43;
      --accent: #f39c12;
      --card: rgba(30,34,44,0.96);
      --muted: #9ca3af;
    }
    html,body{height:100%;margin:0;padding:0;font-family:'Cairo',sans-serif;background:linear-gradient(120deg,var(--bg1) 0%,var(--bg2) 60%, #2c5364 100%);color:#fff}
    .container{max-width:900px;margin:20px auto;padding:18px;box-sizing:border-box;}
    .top { display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:18px; }
    h1{margin:0;font-size:1.7rem;color:var(--accent);text-shadow:0 0 10px #0008}
    .card { background:var(--card); border-radius:14px; padding:18px; box-shadow:0 6px 30px rgba(2,6,23,0.5); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:14px; margin-top:14px; }
    .stat { padding:16px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); }
    .stat h3{margin:0;font-size:0.95rem;color:var(--muted)}
    .stat p{margin:8px 0 0;font-size:1.3rem;font-weight:800;color:#fff}
    .actions { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .btn { display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;color:#111;font-weight:800; text-align:center; }
    .btn.primary{background:linear-gradient(90deg,#3498db,#38bdf8); box-shadow:0 6px 24px rgba(56,189,248,0.12);}
    .btn.green{background:linear-gradient(90deg,#2ecc71,#22c55e);}
    .btn.gold{background:linear-gradient(90deg,#f1c40f,#fde047); color:#111;}
    .links { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .small { font-size:0.85rem; color:var(--muted); margin-top:6px; }
    footer { text-align:center; margin-top:20px; color: #bfcfe0; font-size:0.9rem; }

    /* loading / error */
    .loading { color:#22c55e; font-weight:700; }
    .error { color:#ff7b7b; font-weight:700; }

    /* toast */
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      bottom: 26px;
      padding: 12px 18px;
      border-radius: 12px;
      background: linear-gradient(90deg,#16a34a,#34d399);
      color: #042;
      font-weight:800;
      box-shadow: 0 10px 30px rgba(2,6,23,0.45);
      opacity: 0;
      pointer-events: none;
      transition: all 360ms cubic-bezier(.2,.9,.3,1);
      z-index: 9999;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events:auto; }

    /* responsive tweaks */
    @media (max-width:640px){
      h1{font-size:1.3rem}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Am Rewards</h1>
      <div class="small">Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ â€” Ø³Ø§Ø±Ø¹ Ø¨Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ø±Ø¨Ø­ 10% ÙŠÙˆÙ…ÙŠÙ‹Ø§</div>
    </div>

    <div class="card">
      <div id="loadingMsg" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...</div>
      <div id="errorMsg" class="error" style="display:none"></div>

      <div id="mainContent" style="display:none">
        <div class="grid">
          <div class="stat">
            <h3>Ø§Ù„Ø§Ø³Ù…</h3>
            <p id="userName">â€”</p>
            <div class="small">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: <span id="userEmail">â€”</span></div>
          </div>

          <div class="stat">
            <h3>Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
            <p id="userPoints">0</p>
            <div class="small">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="pointsEgp">0.00</span> Ø¬Ù…</div>
          </div>

          <div class="stat">
            <h3>Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h3>
            <p id="referralPoints">0</p>
            <div class="small">Ù‡Ø°Ù‡ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø§Ù„ØªÙŠ Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø¥Ø­Ø§Ù„Ø§ØªÙ‡</div>
          </div>

          <div class="stat">
            <h3>Ù†Ù‚Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ©</h3>
            <p id="bonusPoint">0</p>
            <div class="small">Ù…ÙƒØ§ÙØ¢Øª Ø¥Ø¶Ø§ÙÙŠØ©/Ø¨ÙˆÙ†Øµ</div>
          </div>
        </div>

        <div style="display:flex; gap:14px; margin-top:14px; flex-wrap:wrap;">
          <div style="flex:1; min-width:180px">
            <div class="card" style="padding:12px;">
              <h3 style="margin:0 0 6px 0">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
              <div class="links">
                <a class="btn primary" href="tasks.html">ğŸ“ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ù…Ù‡Ø§Ù…</a>
                <a class="btn green" href="withdraw.html">ğŸ’¸ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</a>
                <a class="btn gold" href="referrals.html">ğŸ‘¥ ØµÙØ­Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</a>
              </div>
            </div>
          </div>

          <div style="flex:1; min-width:180px">
            <div class="card" style="padding:12px;">
              <h3 style="margin:0 0 6px 0">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h3>
              <div class="small">Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</div>
              <div style="margin-top:8px" id="quickStats"></div>
            </div>
          </div>
        </div>

      </div> <!-- mainContent -->

    </div> <!-- card -->

    <footer>Â© Am Rewards</footer>
  </div>

  <!-- toast -->
  <div id="toast" class="toast">ğŸ‰ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ!</div>

  <!-- Firebase v8 (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯Ùƒ) ==========
  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards",
    storageBucket: "am--rewards.appspot.com",
    messagingSenderId: "744783579735",
    appId: "1:744783579735:web:45e00de9998893bbc9b112"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙØ­Ø©
  const POINT_VALUE_EGP = 0.07;

  const loadingMsg = document.getElementById('loadingMsg');
  const errorMsg = document.getElementById('errorMsg');
  const mainContent = document.getElementById('mainContent');
  const toastEl = document.getElementById('toast');

  function showToast(text) {
    toastEl.textContent = text;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 3500);
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù†Ø­Ø¯Ø¯ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ù…Ø®Ø²Ù† ÙƒÙ€ uid Ø£Ùˆ referralCode
  async function getReferrerDocRef(referralBy) {
    if (!referralBy) return null;
    // Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª: referralBy Ù‚Ø¯ ÙŠÙƒÙˆÙ† UID Ø·ÙˆÙŠÙ„ Ø£Ùˆ ÙƒÙˆØ¯ Ù‚ØµÙŠØ± (Ù…Ø«Ù„Ø§Ù‹ 6 Ø£Ø­Ø±Ù)
    if (typeof referralBy === 'string' && referralBy.length > 20) {
      // Ù†ÙØªØ±Ø¶ UID
      return db.collection('users').doc(referralBy);
    } else {
      // Ù†ÙØªØ±Ø¶ ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø©: Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      const q = db.collection('users').where('referralCode', '==', referralBy).limit(1);
      const snap = await q.get();
      if (!snap.empty) return snap.docs[0].ref;
      return null;
    }
  }

  // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø­Ø³Ø§Ø¨ ÙˆÙ…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠ (10%) Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
  async function handleReferralReward(uid, userData) {
    try {
      if (!userData) return;
      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      const prevPoints = Number(userData.previousPoints ?? 0);
      const currentPoints = Number(userData.points ?? 0);
      const lastDate = userData.lastReferralRewardDate ?? '';
      const referralBy = userData.referralBy ?? null;

      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ†Ø§ previousPoints Ù†ÙØ¹Ù„Ù‡Ø§ (Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„)
      if (userData.previousPoints === undefined) {
        await db.collection('users').doc(uid).update({ previousPoints: currentPoints });
        // Ù„Ø§ Ù†ÙƒÙ…Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„ Ù…Ø±Ø© Ù„Ø£Ù†Ù†Ø§ Ù„Ù… Ù†Ø­ØªÙØ¸ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        return;
      }

      // Ø´Ø±Ø· Ù…Ù†Ø­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ÙŠÙˆØ¬Ø¯ Ø±Ø§ÙØ¹ (referralBy) + Ù„Ù… ØªÙÙ…Ù†ÙØ­ Ø§Ù„ÙŠÙˆÙ… + Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ… > 0
      const gainedToday = Math.max(currentPoints - prevPoints, 0);
      if (!referralBy || lastDate === today || gainedToday <= 0) {
        // ÙÙ‚Ø· Ù†Ø­Ø¯Ø« previousPoints Ùˆ lastReferralRewardDate Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ø¯Ø«Ø©
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{/* ignore */});
        return;
      }

      // Ø­ØµÙ„Ù†Ø§ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¯Ø§Ø¹ÙŠ (Ù…Ø³ØªÙ†Ø¯)
      const referrerDocRef = await getReferrerDocRef(referralBy);
      if (!referrerDocRef) {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø§Ø¹Ù Ù…Ø·Ø§Ø¨Ù‚ - Ù†Ø­Ø¯Ù‘Ø« Ø³Ø§Ø¨Ù‚ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙ‚Ø·
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{/* ignore */});
        return;
      }

      const reward = Math.floor(gainedToday * 0.10); // 10%

      if (reward <= 0) {
        await db.collection('users').doc(uid).update({
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        }).catch(()=>{/* ignore */});
        return;
      }

      // Ù†ÙÙ‘Ø° ÙƒØªÙ„Ø© Ù…Ø¶Ù…ÙˆÙ†Ø© Transaction Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¹ÙŠ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„ÙˆØ¬
      await db.runTransaction(async (tx) => {
        // Ø§Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø¹ÙŠ
        const refSnap = await tx.get(referrerDocRef);
        if (!refSnap.exists) {
          // Ø­Ø¯Ø«Øª Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©
          tx.update(db.collection('users').doc(uid), {
            previousPoints: currentPoints,
            lastReferralRewardDate: today
          });
          return;
        }

        // Ø²ÙŠØ§Ø¯Ø© referralPoints Ù„Ù„Ø¯Ø§Ø¹ÙŠ (Ù…ÙƒØ§ÙØ£Ø©)
        const curReferralPoints = Number(refSnap.data().referralPoints ?? 0);
        tx.update(referrerDocRef, {
          referralPoints: curReferralPoints + reward
        });

        // Ø³Ø¬Ù‘Ù„ Ø§Ù„Ù„ÙˆØ¬ (Ù…ÙÙŠØ¯ Ù„Ù„ØªØªØ¨Ø¹)
        const logRef = db.collection('referralLogs').doc();
        tx.set(logRef, {
          type: 'daily_bonus',
          referrer: referrerDocRef.id,
          referred: uid,
          rewardPoints: reward,
          gainedPoints: gainedToday,
          date: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ÙˆØ£Ø®ÙŠØ±Ø§Ù‹: Ø­Ø¯Ù‘Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨Ù‡ Ù„Ù‡
        tx.update(db.collection('users').doc(uid), {
          previousPoints: currentPoints,
          lastReferralRewardDate: today
        });
      });

      // show toast ÙˆConsole
      showToast(`ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${reward} Ù†Ù‚Ø·Ø© Ø¥Ù„Ù‰ Ø¯Ø§Ø¹ÙŠÙƒ!`);
      console.log(`Referral reward: added ${reward} points to ${referrerDocRef.id}`);

    } catch (err) {
      console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©:', err);
    }
  }

  // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  function renderData(data, user) {
    document.getElementById('userName').textContent = data.name || user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
    document.getElementById('userEmail').textContent = data.email || user.email || 'â€”';
    document.getElementById('userPoints').textContent = Number(data.points ?? 0);
    document.getElementById('referralPoints').textContent = Number(data.referralPoints ?? 0);
    document.getElementById('bonusPoint').textContent = Number(data.bonusPoint ?? 0);
    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡
    const egp = (Number(data.points ?? 0) * POINT_VALUE_EGP).toFixed(2);
    document.getElementById('pointsEgp').textContent = egp;
    // quick stats
    document.getElementById('quickStats').innerHTML = `
      <div class="small">Ø¥Ø­Ø§Ù„Ø§Øª: <strong>${data.referralCount ?? 0}</strong></div>
      <div class="small">Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: <strong>${data.totalWithdrawn ?? 0} Ø¬</strong></div>
    `;
  }

  // Ø§Ø³ØªÙ…Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }

    try {
      const userRef = db.collection('users').doc(user.uid);
      const docSnap = await userRef.get();
      loadingMsg.style.display = 'none';

      if (!docSnap.exists) {
        errorMsg.style.display = 'block';
        errorMsg.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….';
        return;
      }

      const data = docSnap.data();

      // ØªØ£ÙƒØ¯ Ø£Ù† previousPoints Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø®Ø²Ù†Ù‡ Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§ÙØ£Ø©)
      if (data.previousPoints === undefined) {
        await userRef.update({ previousPoints: Number(data.points ?? 0) }).catch(()=>{/* ignore */});
        data.previousPoints = Number(data.points ?? 0);
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      renderData(data, user);
      mainContent.style.display = 'block';

      // Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ù…Ø±Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§)
      await handleReferralReward(user.uid, data);

    } catch (err) {
      console.error(err);
      loadingMsg.style.display = 'none';
      errorMsg.style.display = 'block';
      errorMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
    }
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
  function logout() {
    auth.signOut().then(()=> location.href = 'index.html');
  }
  </script>
</body>
  </html>
