<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø© | Am Rewards</title>
<style>
  body{font-family:'Tajawal',sans-serif;background:#121212;color:#e0e0e0;margin:0;padding:20px;text-align:center}
  h2{color:#4caf50;font-size:28px;margin-bottom:20px}
  .link-box{background:#1e1e1e;padding:15px;border:1px solid #333;margin:12px auto;max-width:420px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.7);transition:.3s}
  .link-box:hover{background:#2a2a2a}
  .link-box p{margin:6px 0;font-size:16px}
  .link-box button{background:#4caf50;color:#121212;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:.3s}
  .link-box button[disabled]{background:#555;color:#aaa;cursor:not-allowed;}
  .link-box button:hover:not([disabled]){background:#388e3c}
  #user-points{background:#263238;padding:12px 20px;border-radius:10px;display:inline-block;margin:0 auto 20px;font-size:20px;border:1px solid #37474f}
  #status{font-size:18px;margin-bottom:8px;color:#81c784}
  #err{font-size:15px;color:#ff5252;margin-bottom:15px}
  .timer-lock{color:#ef4444;font-size:15px;margin-top:10px;}
  .back-buttons{margin-top:30px}
  .back-buttons button{background:#4caf50;border:none;color:#121212;padding:12px 24px;margin:8px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:.3s}
  .back-buttons button:hover{background:#388e3c}
</style>
</head>
<body>
  <h2>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø©</h2>
  <div id="user-points">Ù†Ù‚Ø§Ø·ÙŠ: 0</div>
  <div id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...</div>
  <div id="err"></div>
  <div id="links-container"></div>
  <div class="back-buttons">
    <button onclick="window.location.href='dashboard.html'">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="window.location.href='tasks.html'">ğŸ—‚ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain:"am--rewards.firebaseapp.com",
  projectId:"am--rewards"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const POINTS_PER_LINK = 2;
const LINK_COOLDOWN   = 24*60*60*1000; // 24 Ø³Ø§Ø¹Ø©
const MIN_WAIT_TIME   = 15000; // 15 Ø«Ø§Ù†ÙŠØ©

const shortlinks = [
  {title:"Ø±Ø§Ø¨Ø· 1",url:"https://swiftlnx.com/Lzt3c"},
  {title:"Ø±Ø§Ø¨Ø· 2",url:"https://exe.io/qEJR4"},
  {title:"Ø±Ø§Ø¨Ø· 3",url:"https://yshorten.com/woSf"},
  {title:"Ø±Ø§Ø¨Ø· 4",url:"https://oii.la/7o245qg"},
  {title:"Ø±Ø§Ø¨Ø· 5",url:"https://short-jambo.ink/oBRa"},
  {title:"Ø±Ø§Ø¨Ø· 6",url:"https://shrinkme.top/URiKQI"},
  {title:"Ø±Ø§Ø¨Ø· 7",url:"https://tpi.li/1yb5"},
  {title:"Ø±Ø§Ø¨Ø· 8",url:"https://srtslug.biz/8dwVH"},
];

const $ = (id)=>document.getElementById(id);
const setStatus = (t)=>{ $("status").textContent=t; };
const setErr    = (t)=>{ $("err").textContent=t||""; };

let currentUserRef = null;

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    location.href="index.html";
    return;
  }

  currentUserRef = doc(db,"users",user.uid);

  try {
    await handlePendingLink(currentUserRef);

    onSnapshot(currentUserRef, (snap)=>{
      const data = snap.data() || {};
      const points = data.points ?? 0;
      $("user-points").textContent = `Ù†Ù‚Ø§Ø·ÙŠ: ${points}`;
      renderLinks(data.lastLinks || {});
      setStatus("âœ… Ø§Ø®ØªØ± Ø£ÙŠ Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­");
      setErr("");
    }, (err)=> setErr("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙŠ: "+err.message) );

  } catch(e){
    console.error(e);
    setErr("Ø­Ø¯Ø« Ø®Ø·Ø£: "+e.message);
    setStatus("âš ï¸ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©");
    renderLinks({});
  }
});

// ---- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© ----
async function handlePendingLink(userRef){
  const raw = localStorage.getItem("pendingLink");
  const ts  = localStorage.getItem("pendingLinkTime");
  if(raw === null || ts === null) return;

  const idx = Number(raw);
  const visitTime = Number(ts);

  if(!Number.isInteger(idx) || idx < 0 || idx >= shortlinks.length){
    localStorage.removeItem("pendingLink");
    localStorage.removeItem("pendingLinkTime");
    return;
  }

  const now = Date.now();
  if(now - visitTime < MIN_WAIT_TIME){
    setErr("ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ø¯Ø© Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 15 Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¹ÙˆØ¯Ø©!");
    localStorage.removeItem("pendingLink");
    localStorage.removeItem("pendingLinkTime");
    return;
  }

  try{
    const snap = await getDoc(userRef);
    const data = snap.data() || {};
    const lastLinks = data.lastLinks || {};
    const last = lastLinks[idx] || 0;

    if(Date.now() - last < LINK_COOLDOWN){
      setErr("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù†. Ø¬Ø±Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
      return;
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· + ÙˆÙ‚Øª Ø¢Ø®Ø± ÙØªØ­ Ù„Ù„Ø±Ø§Ø¨Ø·
    await updateDoc(userRef, {
      points: increment(POINTS_PER_LINK),
      [`lastLinks.${idx}`]: Date.now()
    });

    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙŠ tasksCompleted
    const taskId = `shortlink-${idx}-${Date.now()}`;
    const taskRef = doc(db, "tasksCompleted", taskId);
    await setDoc(taskRef, {
      userId: userRef.id,
      taskId: `shortlink-${idx}`,
      taskType: "shortlinks",
      pointsEarned: POINTS_PER_LINK,
      date: new Date(),
      status: "done"
    });

    alert(`ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ!`);

  } catch(e){
    setErr("ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø±Ø§Ø¨Ø·: " + e.message);
  } finally {
    localStorage.removeItem("pendingLink");
    localStorage.removeItem("pendingLinkTime");
  }
}

function renderLinks(lastLinks){
  const container = $("links-container");
  container.innerHTML = "";

  shortlinks.forEach((item,index)=>{
    const last = lastLinks[index] || 0;
    let locked = false, timerText = "";

    if(last && Date.now() - last < LINK_COOLDOWN){
      locked = true;
      let remain = LINK_COOLDOWN - (Date.now()-last);
      let hours = Math.floor(remain/(1000*60*60));
      let minutes = Math.floor((remain%(1000*60*60))/(1000*60));
      timerText = `â³ Ø§Ù†ØªØ¸Ø± ${hours} Ø³Ø§Ø¹Ø© Ùˆ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
    }

    const div = document.createElement("div");
    div.className = "link-box";
    div.innerHTML =
      `<p>${item.title}</p>
       <button ${locked?"disabled":""} onclick="openLink(${index}, '${item.url}')">
          ${locked ? "ğŸ”’ ØºÙŠØ± Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†" : "Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·"}
       </button>
       ${locked ? `<div class="timer-lock">${timerText}</div>` : ""}`;
    container.appendChild(div);
  });
}

// ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· + ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„ÙØªØ­
window.openLink = function(index, url){
  try {
    localStorage.setItem("pendingLink", String(index));
    localStorage.setItem("pendingLinkTime", String(Date.now()));
  } catch {}
  location.href = url;
};
</script>
</body>
</html>
