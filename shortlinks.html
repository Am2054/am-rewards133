<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const POINTS_PER_LINK = 3;

  const shortlinks = [
    { title: "رابط 1", url: "https://swiftlnx.com/Lzt3c" },
    { title: "رابط 2", url: "https://exe.io/qEJR4" },
    { title: "رابط 3", url: "https://yshorten.com/woSf" },
    { title: "رابط 4", url: "https://oii.la/7o245qg" },
    { title: "رابط 5", url: "https://short-jambo.ink/oBRa" }
  ];

  let currentUser;

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      initShortLinks(user.uid);

      const userDocRef = doc(db, "users", user.uid);
      onSnapshot(userDocRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById("user-points").textContent =
            `نقاطي: ${data.points || 0}`;
        }
      });

      checkReturnFromLink(user.uid);

    } else {
      alert("⚠️ يجب تسجيل الدخول أولاً.");
      window.location.href = "index.html";
    }
  });

  async function initShortLinks(userId) {
    const userDocRef = doc(db, "users", userId);
    const userSnap = await getDoc(userDocRef);

    let completedLinks = {};
    if (userSnap.exists()) {
      completedLinks = userSnap.data().completedLinks || {};
    }

    const container = document.getElementById("links-container");
    container.innerHTML = "";

    shortlinks.forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "link-box";

      const lastDone = completedLinks[index];
      const now = Date.now();

      if (lastDone && now - lastDone < 24 * 60 * 60 * 1000) {
        const endTime = lastDone + 24 * 60 * 60 * 1000;
        const timerEl = document.createElement("p");
        timerEl.style.color = "#ff9800";
        div.innerHTML = `<p>${item.title}</p><p>🪙 ${POINTS_PER_LINK} نقطة</p>`;
        div.appendChild(timerEl);
        container.appendChild(div);

        updateTimer(timerEl, endTime, () => {
          div.innerHTML = `
            <p>${item.title}</p>
            <p>🪙 ${POINTS_PER_LINK} نقطة</p>
            <button onclick="goToLink(${index}, '${item.url}')">افتح الرابط</button>
          `;
        });
      } else {
        div.innerHTML = `
          <p>${item.title}</p>
          <p>🪙 ${POINTS_PER_LINK} نقطة</p>
          <button onclick="goToLink(${index}, '${item.url}')">افتح الرابط</button>
        `;
        container.appendChild(div);
      }
    });

    document.getElementById("status").textContent = "✅ اختر أي رابط متاح";
  }

  function updateTimer(element, endTime, onFinish) {
    function tick() {
      const now = Date.now();
      const diff = endTime - now;

      if (diff <= 0) {
        element.textContent = "✅ الرابط متاح الآن!";
        if (onFinish) onFinish();
        return;
      }

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      element.textContent = `⏳ متبقي: ${hours} س ${minutes} د ${seconds} ث`;
      setTimeout(tick, 1000);
    }
    tick();
  }

  // فتح الرابط وتسجيله كـ pending
  window.goToLink = function(index, url) {
    localStorage.setItem("pendingLink", JSON.stringify({ index, url }));
    window.open(url, "_blank");
  };

  // ✅ التحقق عند الرجوع
  async function checkReturnFromLink(userId) {
    const pending = localStorage.getItem("pendingLink");
    if (!pending) return;

    const { index } = JSON.parse(pending);
    const userRef = doc(db, "users", userId);

    await updateDoc(userRef, {
      points: increment(POINTS_PER_LINK),  // ⬅️ هنا التعديل الأساسي
      [`completedLinks.${index}`]: Date.now()
    });

    alert(`🎉 تم إضافة ${POINTS_PER_LINK} نقطة لحسابك!`);

    localStorage.removeItem("pendingLink");

    // إعادة تحميل القائمة لتختفي الأزرار
    initShortLinks(userId);
  }
        </script>
