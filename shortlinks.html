<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>مهمة الروابط المختصرة | Am Rewards</title>
<style>
  body{font-family:'Tajawal',sans-serif;background:#121212;color:#e0e0e0;margin:0;padding:20px;text-align:center}
  h2{color:#4caf50;font-size:28px;margin-bottom:20px}
  .link-box{background:#1e1e1e;padding:15px;border:1px solid #333;margin:12px auto;max-width:420px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.7);transition:.3s}
  .link-box:hover{background:#2a2a2a}
  .link-box p{margin:6px 0;font-size:16px}
  .link-box button{background:#4caf50;color:#121212;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:.3s}
  .link-box button[disabled]{background:#555;color:#aaa;cursor:not-allowed;}
  .link-box button:hover:not([disabled]){background:#388e3c}
  #user-points{background:#263238;padding:12px 20px;border-radius:10px;display:inline-block;margin:0 auto 20px;font-size:20px;border:1px solid #37474f}
  #status{font-size:18px;margin-bottom:8px;color:#81c784}
  #err{font-size:15px;color:#ff5252;margin-bottom:15px}
  .timer-lock{color:#ef4444;font-size:15px;margin-top:10px;}
  .back-buttons{margin-top:30px}
  .back-buttons button{background:#4caf50;border:none;color:#121212;padding:12px 24px;margin:8px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:.3s}
  .back-buttons button:hover{background:#388e3c}
</style>
</head>
<body>
  <h2>مهمة الروابط المختصرة</h2>
  <div id="user-points">نقاطي: 0</div>
  <div id="status">جاري تحميل الروابط...</div>
  <div id="err"></div>
  <div id="links-container"></div>
  <div class="back-buttons">
    <button onclick="window.location.href='dashboard.html'">🔙 العودة إلى الصفحة الرئيسية</button>
    <button onclick="window.location.href='tasks.html'">🗂️ العودة إلى صفحة المهام</button>
  </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const firebaseConfig = {
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain:"am--rewards.firebaseapp.com",
  projectId:"am--rewards"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const POINTS_PER_LINK = 2;
const LINK_COOLDOWN   = 24*60*60*1000; // 24 ساعة
const MIN_WAIT_TIME   = 15000; // الذكاء الاصطناعي: يجب الانتظار 15 ثانيه
const shortlinks = [
{title:"رابط 1",url:"https://ouo.io/uxTFpd"},
{title:"رابط 2",url:"https://swiftlnx.com/Lzt3c"},
{title:"رابط 3",url:"https://exe.io/qEJR4"},
{title:"رابط 4",url:"https://yshorten.com/woSf"},
{title:"رابط 5",url:"https://oii.la/7o245qg"},
{title:"رابط 6",url:"https://short-jambo.ink/oBRa"},
{title:"رابط 7",url:"https://shrinkme.top/URiKQI"},
{title:"رابط 8",url:"https://tpi.li/1yb5"},
{title:"رابط 9",url:"https://icutlink.com/b1adps8lg"},
{title:"رابط 10",url:"https://srtslug.biz/8dwVH"},
{title:"رابط 11",url:"http://easy4skip.com/mImjZeK"}
];

const $ = (id)=>document.getElementById(id);
const setStatus = (t)=>{ $("status").textContent=t; };
const setErr    = (t)=>{ $("err").textContent=t||""; };

onAuthStateChanged(auth, async (user)=>{
if(!user){
  alert("⚠️ يجب تسجيل الدخول أولاً.");
  location.href="index.html";
  return;
}

const userRef = doc(db,"users",user.uid);

try {
  await ensureUserDoc(userRef);
  await handlePendingLink(userRef);

  onSnapshot(userRef, (snap)=>{  
    const data = snap.data() || {};
    const points = data.points ?? 0;
    $("user-points").textContent = `نقاطي: ${points}`;
    renderLinks(data.completedLinks || {});
    setStatus("✅ اختر أي رابط متاح");
    setErr("");
  }, (err)=> setErr("خطأ في التحديث الحي: "+err.message) );

} catch(e){
  console.error(e);
  setErr("حدث خطأ: "+e.message);
  setStatus("⚠️ حاول تحديث الصفحة");
  renderLinks({});
}
});

// ---- Helpers ----
async function ensureUserDoc(userRef){
const snap = await getDoc(userRef);
if(!snap.exists()){
  await setDoc(userRef, {
    points: 0,
    completedLinks: {},
    completedAds: {}, completedApps: {}, completedGames: {},
    completedSurveys: {}, completedVideos: {}
  }, {merge:true});
} else {
  const data = snap.data() || {};
  const patch = {};
  if(!data.completedLinks || typeof data.completedLinks !== "object") patch.completedLinks = {};
  if(typeof data.points !== "number") patch.points = 0;
  if(Object.keys(patch).length) await updateDoc(userRef, patch);
}
}

// ذكاء اصطناعي: تحقق من الوقت بين فتح الرابط والعودة للصفحة
async function handlePendingLink(userRef){
const raw = localStorage.getItem("pendingLink");
const ts  = localStorage.getItem("pendingLinkTime");
if(raw === null || ts === null) return;

const idx = Number(raw);
const visitTime = Number(ts);

if(!Number.isInteger(idx) || idx < 0 || idx >= shortlinks.length){
  localStorage.removeItem("pendingLink");
  localStorage.removeItem("pendingLinkTime");
  return;
}

// تحقق من مرور وقت كافي على الرابط
const now = Date.now();
if(now - visitTime < MIN_WAIT_TIME){
  setErr("يجب عليك البقاء في الرابط لمدة لا تقل عن 15 ثانيه قبل العودة!");
  localStorage.removeItem("pendingLink");
  localStorage.removeItem("pendingLinkTime");
  return;
}

try{
  const snap = await getDoc(userRef);
  const completed = (snap.data() && snap.data().completedLinks) || {};
  const last = completed[idx] || 0;

  if(!last || (Date.now() - last) >= LINK_COOLDOWN){  
    await updateDoc(userRef, {  
      points: increment(POINTS_PER_LINK),  
      [`completedLinks.${idx}`]: Date.now()
    });
    alert(`🎉 تم إضافة ${POINTS_PER_LINK} نقطة لحسابك!`);
  }
} catch(e){
  setErr("تعذر تسجيل إنجاز الرابط: " + e.message);
} finally {
  localStorage.removeItem("pendingLink");
  localStorage.removeItem("pendingLinkTime");
}
}

function renderLinks(completedLinks={}){
const container = $("links-container");
container.innerHTML = "";
shortlinks.forEach((item,index)=>{
  const last = completedLinks[index] || 0;
  let locked = false, timerText = "";
  if(last){
    const diff = Date.now() - last;
    if(diff < LINK_COOLDOWN){
      locked = true;
      let remain = LINK_COOLDOWN - diff;
      let hours = Math.floor(remain/(60*60*1000));
      let minutes = Math.floor((remain%(60*60*1000))/(60*1000));
      timerText = `انتظر ${hours} ساعة و${minutes} دقيقة لإعادة تنفيذ المهمة`;
    }
  }
  const div = document.createElement("div");
  div.className = "link-box";
  div.innerHTML =
    `<p>${item.title}</p>
     <button ${locked?"disabled":""} onclick="openLink(${index}, '${item.url}')">
        ${locked ? "مغلق 24 ساعة" : "افتح الرابط"}
     </button>
     ${locked ? `<div class="timer-lock">${timerText}</div>` : ""}`;
  container.appendChild(div);
});
}

// فتح الرابط + تمييزه في localStorage مع تسجيل وقت الفتح
window.openLink = function(index, url){
try {
  localStorage.setItem("pendingLink", String(index));
  localStorage.setItem("pendingLinkTime", String(Date.now()));
} catch {}
location.href = url;
};
</script>
</body>
</html>
