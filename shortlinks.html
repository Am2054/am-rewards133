<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
    authDomain: "am--rewards.firebaseapp.com",
    projectId: "am--rewards"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const POINTS_PER_LINK = 3;

  const shortlinks = [
    { title: "Ø±Ø§Ø¨Ø· 1", url: "https://swiftlnx.com/Lzt3c" },
    { title: "Ø±Ø§Ø¨Ø· 2", url: "https://exe.io/qEJR4" },
    { title: "Ø±Ø§Ø¨Ø· 3", url: "https://yshorten.com/woSf" },
    { title: "Ø±Ø§Ø¨Ø· 4", url: "https://oii.la/7o245qg" },
    { title: "Ø±Ø§Ø¨Ø· 5", url: "https://short-jambo.ink/oBRa" }
  ];

  let currentUser;

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      initShortLinks(user.uid);

      const userDocRef = doc(db, "users", user.uid);
      onSnapshot(userDocRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById("user-points").textContent =
            `Ù†Ù‚Ø§Ø·ÙŠ: ${data.points || 0}`;
        }
      });

      checkReturnFromLink(user.uid);

    } else {
      alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
      window.location.href = "index.html";
    }
  });

  async function initShortLinks(userId) {
    const userDocRef = doc(db, "users", userId);
    const userSnap = await getDoc(userDocRef);

    let completedLinks = {};
    if (userSnap.exists()) {
      completedLinks = userSnap.data().completedLinks || {};
    }

    const container = document.getElementById("links-container");
    container.innerHTML = "";

    shortlinks.forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "link-box";

      const lastDone = completedLinks[index];
      const now = Date.now();

      if (lastDone && now - lastDone < 24 * 60 * 60 * 1000) {
        const endTime = lastDone + 24 * 60 * 60 * 1000;
        const timerEl = document.createElement("p");
        timerEl.style.color = "#ff9800";
        div.innerHTML = `<p>${item.title}</p><p>ğŸª™ ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø©</p>`;
        div.appendChild(timerEl);
        container.appendChild(div);

        updateTimer(timerEl, endTime, () => {
          div.innerHTML = `
            <p>${item.title}</p>
            <p>ğŸª™ ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø©</p>
            <button onclick="goToLink(${index}, '${item.url}')">Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
          `;
        });
      } else {
        div.innerHTML = `
          <p>${item.title}</p>
          <p>ğŸª™ ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø©</p>
          <button onclick="goToLink(${index}, '${item.url}')">Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        `;
        container.appendChild(div);
      }
    });

    document.getElementById("status").textContent = "âœ… Ø§Ø®ØªØ± Ø£ÙŠ Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­";
  }

  function updateTimer(element, endTime, onFinish) {
    function tick() {
      const now = Date.now();
      const diff = endTime - now;

      if (diff <= 0) {
        element.textContent = "âœ… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†!";
        if (onFinish) onFinish();
        return;
      }

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      element.textContent = `â³ Ù…ØªØ¨Ù‚ÙŠ: ${hours} Ø³ ${minutes} Ø¯ ${seconds} Ø«`;
      setTimeout(tick, 1000);
    }
    tick();
  }

  // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒÙ€ pending
  window.goToLink = function(index, url) {
    localStorage.setItem("pendingLink", JSON.stringify({ index, url }));
    window.open(url, "_blank");
  };

  // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹
  async function checkReturnFromLink(userId) {
    const pending = localStorage.getItem("pendingLink");
    if (!pending) return;

    const { index } = JSON.parse(pending);
    const userRef = doc(db, "users", userId);

    await updateDoc(userRef, {
      points: increment(POINTS_PER_LINK),  // â¬…ï¸ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
      [`completedLinks.${index}`]: Date.now()
    });

    alert(`ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ!`);

    localStorage.removeItem("pendingLink");

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ®ØªÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    initShortLinks(userId);
  }
        </script>
