<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø© | Am Rewards</title>
<style>
body{font-family:'Tajawal',sans-serif;background-color:#121212;color:#e0e0e0;margin:0;padding:20px;text-align:center;}
h2{color:#4caf50;font-size:28px;margin-bottom:20px;}
.link-box{background:#1e1e1e;padding:15px;border:1px solid #333;margin:12px auto;max-width:420px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.7);transition:0.3s;}
.link-box:hover{background-color:#2a2a2a;}
.link-box p{margin:6px 0;font-size:16px;}
.link-box button{background-color:#4caf50;color:#121212;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:0.3s;}
.link-box button:hover{background-color:#388e3c;}
#user-points{background:#263238;padding:12px 20px;border-radius:10px;display:inline-block;margin:0 auto 20px;font-size:20px;border:1px solid #37474f;}
#status{font-size:18px;margin-bottom:15px;color:#81c784;}
.back-buttons{margin-top:30px;}
.back-buttons button{background-color:#4caf50;border:none;color:#121212;padding:12px 24px;margin:8px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:0.3s;}
.back-buttons button:hover{background-color:#388e3c;}
</style>
</head>
<body>
<h2>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø©</h2>
<div id="user-points">Ù†Ù‚Ø§Ø·ÙŠ: 0</div>
<div id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...</div>
<div id="links-container"></div>    
<div class="back-buttons">
  <button onclick="window.location.href='dashboard.html'">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button onclick="window.location.href='tasks.html'">ğŸ—‚ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</button>
</div>    

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain:"am--rewards.firebaseapp.com",
  projectId:"am--rewards"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const POINTS_PER_LINK=3;
const LINK_COOLDOWN=24*60*60*1000; // 24 Ø³Ø§Ø¹Ø©
const shortlinks=[
  {title:"Ø±Ø§Ø¨Ø· 1",url:"https://swiftlnx.com/Lzt3c"},
  {title:"Ø±Ø§Ø¨Ø· 2",url:"https://exe.io/qEJR4"},
  {title:"Ø±Ø§Ø¨Ø· 3",url:"https://yshorten.com/woSf"},
  {title:"Ø±Ø§Ø¨Ø· 4",url:"https://oii.la/7o245qg"},
  {title:"Ø±Ø§Ø¨Ø· 5",url:"https://short-jambo.ink/oBRa"}
];

let currentUser;

onAuthStateChanged(auth, async user=>{
  if(!user){
    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."); 
    window.location.href="index.html"; 
    return;
  }
  currentUser=user;
  const userRef=doc(db,"users",user.uid);

  // âœ… Ø£ÙˆÙ„ Ù…Ø±Ø©: Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø£Ø¶Ù completedLinks
  const snap=await getDoc(userRef);
  if(!snap.exists()){
    await setDoc(userRef,{ points:0, completedLinks:{} },{ merge:true });
  } else if(!snap.data().completedLinks){
    await updateDoc(userRef,{ completedLinks:{} });
  }

  // âœ… ØªØ­Ù‚Ù‚ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¬Ø¹ Ù…Ù† Ø±Ø§Ø¨Ø·
  const pendingLink=localStorage.getItem("pendingLink");
  if(pendingLink!==null){
    const linkIndex=parseInt(pendingLink);
    const userSnap=await getDoc(userRef);
    const completedLinks=userSnap.exists()? (userSnap.data().completedLinks||{}) : {};

    if(!completedLinks[linkIndex] || Date.now()-completedLinks[linkIndex]>=LINK_COOLDOWN){
      await updateDoc(userRef,{
        points: increment(POINTS_PER_LINK),
        [`completedLinks.${linkIndex}`]: Date.now()
      });
      alert(`ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ!`);
    }
    localStorage.removeItem("pendingLink");
  }

  // âœ… snapshot Ø¯Ø§ÙŠÙ…Ù‹Ø§ ÙŠÙ…Ø±Ø± completedLinks Ø­ØªÙ‰ Ù„Ùˆ ÙØ§Ø¶ÙŠ
  onSnapshot(userRef,snap=>{
    const data=snap.data() || {};
    const points=data.points ?? 0;
    const completedLinks=data.completedLinks || {}; // âœ… Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…
    document.getElementById("user-points").textContent=`Ù†Ù‚Ø§Ø·ÙŠ: ${points}`;
    renderLinks(completedLinks);
  });
});

function renderLinks(completedLinks={}){
  const container=document.getElementById("links-container");
  container.innerHTML="";

  shortlinks.forEach((item,index)=>{
    const div=document.createElement("div");
    div.className="link-box";

    const lastDone=completedLinks[index]||0;
    const now=Date.now();

    if(lastDone && now-lastDone<LINK_COOLDOWN){
      const endTime=lastDone+LINK_COOLDOWN;
      const timerEl=document.createElement("p");
      timerEl.style.color="#ff9800";
      div.appendChild(timerEl);
      container.appendChild(div);
      startTimer(timerEl,endTime,()=>{renderButton(div,item,index);});
    } else {
      renderButton(div,item,index);
      container.appendChild(div);
    }
  });

  document.getElementById("status").textContent="âœ… Ø§Ø®ØªØ± Ø£ÙŠ Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­";
}

function renderButton(div,item,index){
  div.innerHTML=`
    <p>${item.title}</p>
    <button onclick="openLink(${index},'${item.url}')">Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
  `;
}

function startTimer(el,endTime,onFinish){
  function tick(){
    const now=Date.now();
    const diff=endTime-now;
    if(diff<=0){
      el.textContent="âœ… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†!"; 
      if(onFinish) onFinish(); 
      return;
    }
    const h=Math.floor(diff/(1000*60*60));
    const m=Math.floor((diff%(1000*60*60))/(1000*60));
    const s=Math.floor((diff%(1000*60))/1000);
    el.textContent=`â³ Ù…ØªØ¨Ù‚ÙŠ: ${h} Ø³ ${m} Ø¯ ${s} Ø«`;
    setTimeout(tick,1000);
  }
  tick();
}

// âœ… Ù‡Ù†Ø§ Ø¨Ø³ Ù†Ø®Ø²Ù† Ø¥Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ÙØªÙˆØ­
window.openLink=function(index,url){
  localStorage.setItem("pendingLink",index);
  window.open(url,"_blank");
};
</script>
</body>
</html>
