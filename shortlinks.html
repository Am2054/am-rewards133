<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family:'Tajawal',sans-serif;background:#121212;color:#e0e0e0;margin:0;padding:20px;text-align:center }
    h2 { color:#4caf50;margin-bottom:20px }
    .task-box { background:#1e1e1e;padding:15px;border-radius:10px;margin:12px auto;max-width:400px }
    button { background:#4caf50;color:#121212;border:none;padding:10px 20px;border-radius:8px;cursor:pointer }
    button:hover { background:#388e3c }
    #user-points { margin:20px 0;font-size:18px }
    #status { margin-top:15px;color:#81c784 }
    #err { margin-top:10px;color:#ff5252 }
  </style>
</head>
<body>
  <h2>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Ù†Ø³Ø®Ø© Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·)</h2>
  <div id="user-points">Ù†Ù‚Ø§Ø·ÙŠ: 0</div>
  <div id="tasks-container"></div>
  <div id="status"></div>
  <div id="err"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const POINTS_PER_TASK = 3;
    const tasks = [
      { title: "Ù…Ù‡Ù…Ø© 1" },
      { title: "Ù…Ù‡Ù…Ø© 2" },
      { title: "Ù…Ù‡Ù…Ø© 3" }
    ];

    const $ = (id) => document.getElementById(id);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§.");
        location.href = "index.html";
        return;
      }

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      const data = snap.data() || {};
      $("user-points").textContent = `Ù†Ù‚Ø§Ø·ÙŠ: ${data.points ?? 0}`;

      renderTasks(userRef, data.completedLinks || {});
    });

    function renderTasks(userRef, completedLinks) {
      const container = $("tasks-container");
      container.innerHTML = "";

      tasks.forEach((task, index) => {
        const div = document.createElement("div");
        div.className = "task-box";

        div.innerHTML = `
          <p>${task.title}</p>
          <button id="btn-${index}">âœ”ï¸ Ø£ØªÙ…Ù…Øª Ø§Ù„Ù…Ù‡Ù…Ø©</button>
        `;
        container.appendChild(div);

        document.getElementById(`btn-${index}`).onclick = async () => {
          try {
            await updateDoc(userRef, {
              points: increment(POINTS_PER_TASK),
              [`completedLinks.${index}`]: Date.now()
            });
            $("status").textContent = `ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${POINTS_PER_TASK} Ù†Ù‚Ø§Ø·!`;
          } catch (e) {
            $("err").textContent = "âš ï¸ Ø®Ø·Ø£: " + e.message;
          }
        };
      });
    }
  </script>
</body>
</html>
