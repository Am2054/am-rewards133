<!DOCTYPE html> 
<html lang="ar" dir="rtl">  <head>      <meta charset="UTF-8">      
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>      
<title>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø© | Am Rewards</title>      
<style>      
  body{font-family:'Tajawal',sans-serif;background:#121212;color:#e0e0e0;margin:0;padding:20px;text-align:center}      
  h2{color:#4caf50;font-size:28px;margin-bottom:20px}      
  .link-box{background:#1e1e1e;padding:15px;border:1px solid #333;margin:12px auto;max-width:420px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.7);transition:.3s}      
  .link-box:hover{background:#2a2a2a}      
  .link-box p{margin:6px 0;font-size:16px}      
  .link-box button{background:#4caf50;color:#121212;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:.3s}      
  .link-box button:hover{background:#388e3c}      
  #user-points{background:#263238;padding:12px 20px;border-radius:10px;display:inline-block;margin:0 auto 20px;font-size:20px;border:1px solid #37474f}      
  #status{font-size:18px;margin-bottom:8px;color:#81c784}      
  #err{font-size:15px;color:#ff5252;margin-bottom:15px}      
  .back-buttons{margin-top:30px}      
  .back-buttons button{background:#4caf50;border:none;color:#121212;padding:12px 24px;margin:8px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:.3s}      
  .back-buttons button:hover{background:#388e3c}      
</style>      
</head>      
<body>      
  <h2>Ù…Ù‡Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØµØ±Ø©</h2>      
  <div id="user-points">Ù†Ù‚Ø§Ø·ÙŠ: 0</div>      
  <div id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...</div>      
  <div id="err"></div>      
  <div id="links-container"></div>    <div class="back-buttons">      
    <button onclick="window.location.href='dashboard.html'">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>      
    <button onclick="window.location.href='tasks.html'">ğŸ—‚ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</button>      
  </div>  <script type="module">      
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";      
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";      
import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";    const firebaseConfig = {  
apiKey:"AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",  
authDomain:"am--rewards.firebaseapp.com",  
projectId:"am--rewards"  
};  const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const POINTS_PER_LINK = 3;
const LINK_COOLDOWN   = 246060*1000; // 24 Ø³Ø§Ø¹Ø©
const shortlinks = [
{title:"Ø±Ø§Ø¨Ø· 1",url:"https://swiftlnx.com/Lzt3c"},
{title:"Ø±Ø§Ø¨Ø· 2",url:"https://exe.io/qEJR4"},
{title:"Ø±Ø§Ø¨Ø· 3",url:"https://yshorten.com/woSf"},
{title:"Ø±Ø§Ø¨Ø· 4",url:"https://oii.la/7o245qg"},
{title:"Ø±Ø§Ø¨Ø· 5",url:"https://short-jambo.ink/oBRa"}
];

const $ = (id)=>document.getElementById(id);
const setStatus = (t)=>{ $("status").textContent=t; };
const setErr    = (t)=>{ $("err").textContent=t||""; };

onAuthStateChanged(auth, async (user)=>{
if(!user){
alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
location.href="index.html";
return;
}

const userRef = doc(db,"users",user.uid);

try {
await ensureUserDoc(userRef);            // 1) ØªØ£ÙƒÙŠØ¯ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
await handlePendingLink(userRef);        // 2) Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù† ÙˆÙØ¬Ø¯

// 3) Ø±Ù†Ø¯Ø± Ù…Ø¨Ø§Ø´Ø± ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø­ÙŠÙ‘Ø©
onSnapshot(userRef, (snap)=>{
const data = snap.data() || {};
const points = data.points ?? 0;
$("user-points").textContent = Ù†Ù‚Ø§Ø·ÙŠ: ${points};
renderLinks(data.completedLinks || {});
setStatus("âœ… Ø§Ø®ØªØ± Ø£ÙŠ Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­");
setErr("");
}, (err)=> setErr("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙŠ: "+err.message) );

} catch(e){
console.error(e);
setErr("Ø­Ø¯Ø« Ø®Ø·Ø£: "+e.message);
setStatus("âš ï¸ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©");
// Ø­ØªÙ‰ Ù…Ø¹ Ø§Ù„Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù†Ø±Ù†Ø¯Ø± Ø±ÙˆØ§Ø¨Ø· ÙØ§Ø¶ÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙØ­Ø© Ù…Ø§ ØªÙØ¶Ù„Ø´ ÙˆØ§Ù‚ÙØ©
renderLinks({});
}
});

// ---- Helpers ----
async function ensureUserDoc(userRef){
const snap = await getDoc(userRef);
if(!snap.exists()){
await setDoc(userRef, {
points: 0,
completedLinks: {},
// ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„Ø§ ÙŠØ¶Ø± Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø´ Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù‡Ù†Ø§
completedAds: {}, completedApps: {}, completedGames: {},
completedSurveys: {}, completedVideos: {}
}, {merge:true});
} else {
const data = snap.data() || {};
const patch = {};
if(!data.completedLinks || typeof data.completedLinks !== "object") patch.completedLinks = {};
if(typeof data.points !== "number") patch.points = 0;
if(Object.keys(patch).length) await updateDoc(userRef, patch);
}
}

async function handlePendingLink(userRef){
const raw = localStorage.getItem("pendingLink");
if(raw === null) return;

// ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø©
const idx = Number(raw);
if(!Number.isInteger(idx) || idx < 0 || idx >= shortlinks.length){
console.warn("pendingLink ØºÙŠØ± ØµØ§Ù„Ø­ØŒ ØªÙ… Ù…Ø³Ø­Ù‡");
localStorage.removeItem("pendingLink");
return;
}

try{
const snap = await getDoc(userRef);
const completed = (snap.data() && snap.data().completedLinks) || {};
const last = completed[idx] || 0;

if(!last || (Date.now() - last) >= LINK_COOLDOWN){
await updateDoc(userRef, {
points: increment(POINTS_PER_LINK),
[completedLinks.${idx}]: Date.now()
});
alert(ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${POINTS_PER_LINK} Ù†Ù‚Ø·Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ!);
}

} catch(e){
setErr("ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø±Ø§Ø¨Ø·: " + e.message);
} finally {
localStorage.removeItem("pendingLink");
}
}

function renderLinks(completedLinks={}){
const container = $("links-container");
container.innerHTML = "";

shortlinks.forEach((item,index)=>{
const div = document.createElement("div");
div.className = "link-box";

const lastDone = completedLinks[index] || 0;
const now = Date.now();

if(lastDone && (now - lastDone) < LINK_COOLDOWN){
const endTime = lastDone + LINK_COOLDOWN;
const timerEl = document.createElement("p");
timerEl.style.color = "#ff9800";
div.appendChild(timerEl);
container.appendChild(div);
startTimer(timerEl, endTime, ()=> renderButton(div,item,index));
} else {
renderButton(div,item,index);
container.appendChild(div);
}

});
}

function renderButton(div,item,index){
div.innerHTML =     <p>${item.title}</p>     <button onclick="openLink(${index}, '${item.url}')">Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</button>    ;
}

function startTimer(el,endTime,onFinish){
function tick(){
const diff = endTime - Date.now();
if(diff <= 0){
el.textContent = "âœ… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†!";
if(onFinish) onFinish();
return;
}
const h = Math.floor(diff/3600000);
const m = Math.floor((diff%3600000)/60000);
const s = Math.floor((diff%60000)/1000);
el.textContent = â³ Ù…ØªØ¨Ù‚ÙŠ: ${h} Ø³ ${m} Ø¯ ${s} Ø«;
setTimeout(tick, 1000);
}
tick();
}

// ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· + ØªÙ…ÙŠÙŠØ²Ù‡ ÙÙŠ localStorage
window.openLink = function(index, url){
try { localStorage.setItem("pendingLink", String(index)); } catch {}
// Ø§ÙØªØ­ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„ØªÙØ§Ø¯ÙŠ Ø­Ø¬Ø¨ Ø§Ù„Ù€ popup
location.href = url;
};
</script>  </body>

  </html>
