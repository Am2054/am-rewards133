<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ - Am Rewards</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: #f8f9fa;
      padding: 20px;
      direction: rtl;
    }
    h2 {
      color: #007bff;
      text-align: center;
    }
    .message-box {
      background: #fff;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .category {
      font-weight: bold;
      color: #28a745;
    }
    .auto-response {
      background: #e9f7ef;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      color: #155724;
    }
    .alert {
      color: red;
      font-weight: bold;
      text-align: center;
      background-color: #ffeaea;
      padding: 10px;
      border: 1px solid red;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .send-btn {
      margin-top: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .send-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ (Ø²Ø§ÙƒÙŠ)</h2>
  <div id="alerts"></div>
  <div id="messages"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const messagesRef = collection(db, "contactMessages");
    const responsesRef = collection(db, "contactReplies");
    const msgContainer = document.getElementById("messages");
    const alertBox = document.getElementById("alerts");
    const issuesCount = {};

    function autoReply(category) {
      switch (category) {
        case "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨":
          return "ğŸ“¦ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù„Ø§ØºÙƒ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø³Ø­Ø¨ØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.";
        case "Ø§Ù‚ØªØ±Ø§Ø­":
          return "ğŸ’¡ Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ! Ù†Ø¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨ØªÙƒ.";
        case "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·":
          return "ğŸ“Š ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø´ÙƒÙ„ØªÙƒ ÙÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·ØŒ ÙˆØ³ØªØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§.";
        default:
          return "âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„ØªÙƒØŒ Ø³Ù†Ø±Ø¯ Ù‚Ø±ÙŠØ¨Ù‹Ø§.";
      }
    }

    async function sendResponse(email, message) {
      await addDoc(responsesRef, {
        email,
        message,
        timestamp: new Date()
      });
      alert("ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
    }

    async function loadMessages() {
      const q = query(messagesRef, orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const category = data.category || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        issuesCount[category] = (issuesCount[category] || 0) + 1;

        const suggestedReply = autoReply(category);

        const box = document.createElement("div");
        box.className = "message-box";
        box.innerHTML = `
          <p><strong>ğŸ“§ Ø§Ù„Ø§Ø³Ù…:</strong> ${data.name}</p>
          <p><strong>âœ‰ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${data.email}</p>
          <p><strong class="category">ğŸ“Œ Ø§Ù„Ù†ÙˆØ¹:</strong> ${category}</p>
          <p><strong>ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong><br>${data.message}</p>
          <div class="auto-response">ğŸ¤– Ø²Ø§ÙƒÙŠ ÙŠÙ‚ØªØ±Ø­: ${suggestedReply}</div>
          <button class="send-btn" onclick="sendResponse('${data.email}', \`${suggestedReply}\`)">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
        `;
        msgContainer.appendChild(box);
      });

      if (issuesCount["Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨"] >= 5) {
        alertBox.innerHTML = "<div class='alert'>ğŸš¨ Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø¨Ù„Ø§ØºØ§Øª Ø¹Ù† Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…! ÙŠÙØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙˆØ±Ù‹Ø§.</div>";
        // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ØªÙ†Ø¨ÙŠÙ‡ Push Ù„Ø§Ø­Ù‚Ù‹Ø§
      }
    }

    window.sendResponse = sendResponse;
    loadMessages();
  </script>
</body>
</html>
