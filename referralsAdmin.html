<!DOCTYPE html>
<html lang="ar" dir="rtl">
<body>
  <div class="wrap">
    <header>
      <h1>REFERRALS <span style="color:#64748b; font-size:0.9rem;">NETWORK</span></h1>
      <a href="index.html" style="text-decoration:none;">
        <button class="btn-main" style="background:var(--accent); color:#000;">DASHBOARD HUB</button>
      </a>
    </header>

    <div class="chart-container">
        <h3 style="margin-top:0; font-family:'Syncopate'; font-size:0.8rem; color:var(--gold); text-align:center;">ðŸ”¥ TOP 5 ACTIVE CODES</h3>
        <canvas id="referralChart"></canvas>
    </div>

    <div class="metrics">
      <div class="stat-item">
        <strong id="totalReferrals">0</strong> <span>Total Conversions</span>
      </div>
      <div class="stat-item">
        <strong id="totalRewardPoints">0</strong> <span>Total Referral Earnings (EGP)</span>
      </div>
    </div>
    <div class="table-card">
        <div class="table-header">
            <h2 style="margin:0; font-family:'Syncopate'; font-size:1rem; border-right: 4px solid var(--gold); padding-right: 15px;">LEADERBOARD</h2>
            <div class="controls">
                <button id="sortByPointsBtn" class="btn-ghost active">BY EARNINGS</button>
                <button id="sortByCountBtn" class="btn-ghost">BY COUNT</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="topReferrersTable">
                <thead>
                    <tr>
                        <th>RANK</th>
                        <th>REFERRER NAME/CODE</th>
                        <th>FRIENDS JOINED</th>
                        <th>TOTAL EARNED</th>
                    </tr>
                </thead>
                <tbody id="topReferrersTableBody">
                    <tr><td colspan="4" style="text-align:center; color:var(--gold);">Initializing records...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); 

    let currentSort = 'points'; 
    let allReferrerData = []; 
    let myChart = null;
    
    const totalReferralsEl = document.getElementById('totalReferrals');
    const totalRewardPointsEl = document.getElementById('totalRewardPoints');
    const topReferrersTableBody = document.getElementById('topReferrersTableBody');
    const chartCtx = document.getElementById('referralChart');

    function formatNumber(n) { return Number(n || 0).toLocaleString(); }

    function updateChart(data) {
        if (myChart) myChart.destroy();
        const top5 = data.slice(0, 5);
        myChart = new Chart(chartCtx, {
            type: 'bar',
            data: {
                labels: top5.map(r => r.name || r.code),
                datasets: [{
                    label: 'Friends Joined',
                    data: top5.map(r => r.count),
                    backgroundColor: 'rgba(245,197,66,0.5)',
                    borderColor: '#f5c542',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } }, 
                scales: {
                    y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b' } },
                    x: { grid: { display: false }, ticks: { color: '#64748b' } }
                } 
            }
        });
    }

    async function fetchReferralsData() {
        try {
            const usersSnap = await getDocs(collection(db, "users"));
            const usersList = [];
            usersSnap.forEach(doc => usersList.push({ id: doc.id, ...doc.data() }));

            let globalRefCount = 0;
            let globalTotalEarnings = 0;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ "Ø¯Ø§Ø¹ÙŠ"
            const referrersMap = {};

            usersList.forEach(user => {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø¹ÙŠ (Ù„Ø¯ÙŠÙ‡ Ø£Ø±Ø¨Ø§Ø­ Ø£Ùˆ ÙƒÙˆØ¯)
                if (user.referralCode) {
                    if (!referrersMap[user.id]) {
                        referrersMap[user.id] = {
                            id: user.id,
                            name: user.name || 'Anonymous',
                            code: user.referralCode,
                            count: 0,
                            earnings: Number(user.totalReferralEarnings || 0)
                        };
                    }
                }

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¯ ØªÙ… Ø¯Ø¹ÙˆØªÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø®Øµ Ø¢Ø®Ø±
                if (user.referredBy) {
                    globalRefCount++;
                    const referrerId = user.referredBy;
                    if (referrersMap[referrerId]) {
                        referrersMap[referrerId].count += 1;
                    }
                }
                
                globalTotalEarnings += Number(user.totalReferralEarnings || 0);
            });

            allReferrerData = Object.values(referrersMap).filter(r => r.count > 0 || r.earnings > 0);
            
            totalReferralsEl.textContent = formatNumber(globalRefCount);
            totalRewardPointsEl.textContent = globalTotalEarnings.toFixed(2) + " EGP";

            renderTopReferrers();
        } catch (e) {
            console.error("Error fetching referrers:", e);
        }
    }

    function renderTopReferrers() {
        topReferrersTableBody.innerHTML = '';
        
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯
        const sorted = [...allReferrerData].sort((a,b) => {
            return currentSort === 'points' ? b.earnings - a.earnings : b.count - a.count;
        });
        
        sorted.forEach((item, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="rank-cell">#${String(i+1).padStart(2,'0')}</td>
                <td>
                    <div style="font-weight:bold;">${item.name}</div>
                    <span class="code-cell">${item.code}</span>
                </td>
                <td style="font-family:'Syncopate'; font-weight:700;">${item.count}</td>
                <td style="color:var(--gold); font-weight:900;">${item.earnings.toFixed(2)} EGP</td>
            `;
            topReferrersTableBody.appendChild(tr);
        });
        updateChart(sorted);
    }

    // Live Logs (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ÙŠØ¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø³Ø¬Ù„ÙˆØ§)
    async function renderLiveLogs() {
        const logsBody = document.getElementById('referralsTableBody');
        const usersSnap = await getDocs(collection(db, "users"));
        let logsHtml = "";
        
        // Ø¬Ù„Ø¨ Ø¢Ø®Ø± 10 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªÙ… Ø¯Ø¹ÙˆØªÙ‡Ù…
        const invitedUsers = [];
        usersSnap.forEach(doc => {
            const d = doc.data();
            if(d.referredBy) invitedUsers.push(d);
        });

        invitedUsers.slice(-10).reverse().forEach(u => {
            logsHtml += `
                <tr>
                    <td class="code-cell">NODE</td>
                    <td>${u.email || u.name}</td>
                    <td style="font-size:0.75rem; color:#64748b;">Recently Joined</td>
                    <td style="color:var(--gold); font-weight:700;">Active</td>
                    <td><span class="status-badge status-granted">DONE</span></td>
                </tr>`;
        });
        logsBody.innerHTML = logsHtml || "<tr><td colspan='5'>No recent logs</td></tr>";
    }

    sortByPointsBtn.onclick = () => { 
        currentSort = 'points'; 
        sortByPointsBtn.classList.add('active'); 
        sortByCountBtn.classList.remove('active'); 
        renderTopReferrers(); 
    };
    
    sortByCountBtn.onclick = () => { 
        currentSort = 'count'; 
        sortByCountBtn.classList.add('active'); 
        sortByPointsBtn.classList.remove('active'); 
        renderTopReferrers(); 
    };

    onAuthStateChanged(auth, user => { 
        if(user && user.email === "amirfg992005@gmail.com") {
            fetchReferralsData();
            renderLiveLogs();
        } 
    });
    
    document.getElementById('refreshBtn').onclick = () => {
        fetchReferralsData();
        renderLiveLogs();
    };
  </script>
</body>
</html>
