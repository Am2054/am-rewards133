<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:"Cairo",sans-serif;min-height:100vh;
  background: linear-gradient(135deg, #0b0f27, #020617);
  background-size: 400% 400%;
  animation: gradientMove 15s ease infinite;
  display:flex;align-items:center;justify-content:center;color:#f8fafc;
}
@keyframes gradientMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.center-box{
  width:100%;max-width:420px;background:#0f172a;
  border:1px solid rgba(56,189,248,.35);
  border-radius:28px;padding:40px 30px;
  text-align:center;box-shadow:0 8px 40px rgba(56,189,248,.15);
  transition: transform .2s;
}
.center-box:hover{transform: translateY(-4px);}
h2{color:#38bdf8;margin-bottom:8px;font-weight:900}
.gold-name{
  background:linear-gradient(90deg,#FFD369,#c9a93b);
  color:#3b2f00;padding:12px 24px;
  border-radius:16px;font-weight:900;margin-bottom:30px;display:inline-block;
  box-shadow:0 4px 12px rgba(0,0,0,.2);
}
.form-row{text-align:right;margin-bottom:18px}
label{display:block;margin-bottom:6px;font-weight:700;color:#cbd5f5}
.input-group{position:relative}
input{
  width:100%;padding:14px 46px 14px 14px;
  border-radius:16px;border:2px solid #334155;
  background:#020617;color:#fff;font-size:1rem;
  transition:border-color .2s, box-shadow .2s;
}
input:focus{border-color:#38bdf8;box-shadow:0 0 8px rgba(56,189,248,.5);}
.password-toggle{
  position:absolute;left:12px;top:50%;
  transform:translateY(-50%);
  background:none;border:none;cursor:pointer;
  font-size:1.1rem;color:#38bdf8
}
.login-btn{
  width:100%;padding:14px;border-radius:18px;border:none;
  font-size:1.1rem;font-weight:900;cursor:pointer;
  background:linear-gradient(90deg,#FFD369,#bfa243);
  color:#2e2300;transition: transform .2s;
}
.login-btn:hover{transform: translateY(-2px);}
.login-btn:disabled{opacity:.6;cursor:not-allowed}
.spinner{
  width:18px;height:18px;border:3px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;
  display:inline-block;animation:spin .8s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
.message{
  display:none;padding:12px;border-radius:12px;
  font-weight:800;margin-bottom:16px;
}
.message.error{background:#ffeaea;color:#b00000}
.message.success{background:#e7ffea;color:#047857}

/* ---------------- Confirm Card ---------------- */
#confirm-card{
  display:none;
  margin-top:16px;
  padding:20px;
  background:#1e293b;
  border-radius:18px;
  box-shadow:0 6px 20px rgba(0,0,0,.3);
  color:#f8fafc;
  font-weight:700;
  text-align:center;
}
#confirm-card p{
  margin-bottom:12px;
  font-size:1rem;
}
#confirm-btn{
  padding:12px 24px;
  border:none;border-radius:16px;
  background:#38bdf8;color:#fff;font-weight:700;
  cursor:pointer;transition: transform .2s;
}
#confirm-btn:hover{transform: translateY(-2px);}
</style>
</head>

<body>
<div class="center-box">
  <h2>Am Rewards</h2>
  <div class="gold-name">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>

  <div id="msg" class="message"></div>

  <form id="login-form">
    <div class="form-row">
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="email" required />
    </div>

    <div class="form-row">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <div class="input-group">
        <input type="password" id="password" required />
        <button type="button" class="password-toggle" id="toggle">ğŸ‘</button>
      </div>
    </div>

    <button type="submit" class="login-btn" id="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </form>

  <div id="confirm-card">
    <p>â— Ø£Ù†Øª ØªÙ‚ÙˆÙ… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ</p>
    <button id="confirm-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain: "am--rewards.firebaseapp.com",
  projectId: "am--rewards",
  storageBucket: "am--rewards.appspot.com",
  messagingSenderId: "744783579735",
  appId: "1:744783579735:web:45e00de9998893bbc9b112",
  measurementId: "G-CV3GLT2TTJ"
};
initializeApp(firebaseConfig);
const auth = getAuth();

// ---------------- UI ----------------
const form = document.getElementById("login-form");
const btn = document.getElementById("btn");
const msg = document.getElementById("msg");
const confirmCard = document.getElementById("confirm-card");
const confirmBtn = document.getElementById("confirm-btn");
const toggle = document.getElementById("toggle");
const pass = document.getElementById("password");

toggle.onclick = () => pass.type = pass.type === "password" ? "text" : "password";

function deviceId(){ 
  let id = localStorage.getItem("deviceId"); 
  if(!id){ id = crypto.randomUUID(); localStorage.setItem("deviceId", id); } 
  return id; 
}

// ---------------- Countdown Function ----------------
function startCountdown(ms){
  confirmBtn.disabled = true;
  let remaining = ms;
  const interval = setInterval(()=>{
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000)/1000);
    confirmBtn.textContent = `â³ Ø§Ù†ØªØ¸Ø± ${minutes} : ${seconds}`;
    remaining -= 1000;
    if(remaining <= 0){
      clearInterval(interval);
      confirmBtn.disabled = false;
      confirmBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯";
    }
  },1000);
}

// ---------------- Login Function ----------------
async function login(confirm=false){
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';
  msg.style.display = "none";
  confirmCard.style.display = "none";

  try{
    const email = document.getElementById("email").value.trim();
    const password = pass.value;

    const cred = await signInWithEmailAndPassword(auth,email,password);
    const idToken = await cred.user.getIdToken(true);

    const res = await fetch("/api/login",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ idToken, deviceId:deviceId(), confirmNewDevice:confirm })
    });

    const data = await res.json();

    if(res.status===403 && data.remainingTime){
      startCountdown(data.remainingTime);
      show(data.message,"error");
      return;
    }

    if(data.requireConfirmation){
      confirmCard.style.display="block";
      return;
    }

    if(!res.ok) throw data;

    show("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­","success");
    setTimeout(()=>location.href="dashboard.html",1000);

  }catch(err){
    let message="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹";
    if(err.code){
      switch(err.code){
        case "auth/user-not-found": message="âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"; break;
        case "auth/wrong-password": message="âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"; break;
        case "auth/invalid-credential": message="âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"; break;
        case "auth/too-many-requests": message="âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒØ«ÙŠØ±Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ù‹Ø§"; break;
        case "auth/network-request-failed": message="âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"; break;
        default: if(err.message) message="âŒ "+err.message;
      }
    }
    show(message,"error");
  }finally{
    btn.disabled=false;
    btn.innerHTML="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
  }
}

form.onsubmit = e => { e.preventDefault(); login(); };
confirmBtn.onclick = () => login(true);

function show(t,type){
  msg.textContent=t;
  msg.className="message "+type;
  msg.style.display="block";
}
</script>
</body>
</html>
