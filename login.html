<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تسجيل الدخول - Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    /* ... (احتفظ بكل تنسيقات CSS كما هي) ... */
    :root{  
      --main-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 60%, #38bdf8 100%);  
      --glass-bg: rgba(255,255,255,0.13);  
      --glass-border: rgba(56,189,248,0.18);  
      --input-bg: rgba(30,41,59,0.74);  
      --input-focus: #38bdf8;  
      --input-border: #334155;  
      --error: #f87171;  
      --success: #22c55e;  
      --muted: #a5f3fc;  
      --radius: 28px;  
      --shadow: 0 8px 32px 0 rgba(2,6,23,0.22);  
      --gold: #FFD369;  
      --gold-dark: #bfa243;  
    }  
    *{box-sizing:border-box}
    html, body {  
      height: 100%;  
      margin: 0;  
      padding: 0;  
      font-family: "Cairo", "Montserrat", sans-serif;  
      color: #f1f6fb;  
      direction: rtl;  
      background: var(--main-gradient), url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80');  
      background-size: cover;  
      background-attachment: fixed;  
      background-blend-mode: overlay;  
      overflow-y: auto !important;  
      scroll-behavior: smooth;  
    }  
    body {  
      min-height: 100vh;  
      display: block;  
    }  
    .bg-glass {  
      position: fixed;  
      inset: 0;  
      z-index: 0;  
      pointer-events: none;  
      background: radial-gradient(circle at 65% 17%, rgba(56,189,248,0.14) 0%, transparent 90%),  
                  radial-gradient(circle at 25% 80%, rgba(34,197,94,0.16) 0%, transparent 80%);  
      filter: blur(28px) saturate(1.3);  
      animation: floatGlass 16s ease-in-out infinite alternate;  
    }  
    @keyframes floatGlass {  
      0% { background-position: 65% 17%, 25% 80%;}  
      100% { background-position: 55% 27%, 20% 95%;}  
    }  
    .center-box {  
      width: 100%;  
      max-width: 420px;  
      margin: 56px auto 56px auto;  
      padding: 38px 18px 30px 18px;  
      border-radius: var(--radius);  
      background: var(--glass-bg);  
      box-shadow: var(--shadow), 0 6px 32px 0 #0008;  
      border: 2px solid var(--glass-border);  
      z-index: 2;  
      position: relative;  
      backdrop-filter: blur(20px) saturate(120%);  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
    }  
    h2 {  
      margin-bottom: 20px;  
      font-family: "Montserrat", "Cairo", sans-serif;  
      font-size: 1.7rem;  
      font-weight: 900;  
      letter-spacing: 1.1px;  
      text-shadow: 0 0 10px #38bdf8a2;  
      color: #38bdf8;  
    }  
    .subtitle {  
      color: var(--muted);  
      font-size: 1rem;  
      margin-bottom: 19px;  
      font-weight: 700;  
      text-shadow: 0 0 4px #38bdf8a1;  
      letter-spacing: 0.5px;  
    }  
    .gold-name {  
      display: block;  
      background: var(--gold);  
      color: var(--gold-dark);  
      padding: 10px 17px 8px 17px;  
      min-width: 120px;  
      border-radius: 12px;  
      font-size: 1.08rem;  
      font-family: "Montserrat","Cairo",sans-serif;  
      font-weight: 900;  
      margin: 0 auto 18px auto;  
      text-align: center;  
      box-shadow: 0 4px 10px #FFD36944, 0 2px 8px #0002;  
      letter-spacing: 1.1px;  
      border: 2px solid #bfa24333;  
      user-select: none;  
    }  
    .form-view { 
      width: 100%; 
      opacity: 1;
      transform: scale(1);
    }  
    .form-view.fade-out { 
        opacity: 0;
        transform: scale(0.95);
        height: 0; 
        overflow: hidden;
    }
    .form-view.hidden-display { 
        display: none;
    }

    .form-row {  
      margin-bottom: 18px;  
      text-align: right;  
      position: relative;  
    }  
    
    label {  
      font-size: 1.08rem;  
      color: var(--muted);  
      margin-bottom: 6px;  
      display: block;  
      font-weight: 700;  
    }  
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"] {  
      width: 100%;  
      padding: 16px 17px;  
      border-radius: 15px;  
      border: 2px solid var(--input-border);  
      background: var(--input-bg);  
      color: #fff;  
      font-size: 1.11rem;  
      font-family: "Cairo",sans-serif;  
      transition: box-shadow .18s, border-color .18s, transform .12s;  
      outline: none;  
      font-weight: 600;  
      margin-top: 2px;  
      box-sizing: border-box;  
    }  
    input:focus {  
      border-color: var(--input-focus);  
      box-shadow: 0 0 12px #38bdf8a6;  
      background: #1e293b;  
    }  
    .password-eye {  
      position: absolute;  
      left: 14px;  
      top: 50%;  
      transform: translateY(-50%);  
      background: none;  
      border: none;  
      cursor: pointer;  
      font-size: 1.35em;  
      color: #38bdf8;  
      opacity: 0.82;  
      z-index: 3;  
      transition: color .17s, opacity .14s;  
      padding: 0;  
      margin: 0;  
      line-height: 1;  
      outline: none;  
      display: flex;  
      align-items: center;  
      height: 28px;  
      width: 28px;  
      justify-content: center;  
    }  
    .password-eye svg {  
      width: 23px;  
      height: 23px;  
      display: block;  
    }  
    .password-eye:active,  
    .password-eye:focus { opacity: 1; color: var(--gold); }  
    .password-eye:hover { color: #FFD369; opacity: 1; }  
    button {  
      width: 100%;  
      padding: 14px 0;  
      border-radius: 15px;  
      font-size: 1.07rem;  
      font-weight: 900;  
      font-family: "Montserrat","Cairo",sans-serif;  
      letter-spacing: 0.7px;  
      cursor: pointer;  
      border: none;  
      transition: .17s;  
      margin-bottom: 14px;  
      box-shadow: 0 3px 18px rgba(56,189,248,0.10);  
    }  
    .login-btn {  
      background: linear-gradient(90deg,#FFD369 0%,#bfa243 100%);  
      color: #2e2300;  
      font-weight: 900;  
      letter-spacing: 1.2px;  
      border: 2px solid #bfa24366;  
    }  
    .login-btn:hover {  
      background: linear-gradient(90deg,#bfa243 0%,#FFD369 100%);  
      color: #fff;  
    }  
    .signup-btn {  
      background: linear-gradient(90deg,#fb8500 0%,#ffb703 100%);  
      color: #23272f;  
      font-weight: 900;  
    }  
    .signup-btn:hover { background: linear-gradient(90deg,#ffb703,#fb8500); color: #fff; }  
    .switcher, .forgot {  
      background: none;  
      border: none;  
      color: var(--muted);  
      font-size: 1rem;  
      margin-bottom: 2px;  
      text-decoration: underline;  
      cursor: pointer;  
      transition: color .13s;  
      font-weight: 700;  
    }  
    .switcher:hover { color: #38bdf8; }  
    
    .message {  
      min-height: 36px;  
      padding: 12px 0 7px 0;  
      margin-bottom: 13px;  
      border-radius: 11px;  
      font-size: 1.05rem;  
      font-weight: bold;  
      box-shadow: 0 2px 12px #0002;  
      transition: .14s;  
      background: #fff;  
      color: #2e2300;  
      text-shadow: none;  
      border: 2px solid #FFD369;  
      opacity: 1;  
      display: block;  
      text-align: center;  
      position: relative;  
    }  
    .message .site-name {  
      display: block;  
      font-family: "Montserrat","Cairo",sans-serif;  
      font-size: 1.13em;  
      font-weight: 900;  
      color: var(--gold);  
      margin-bottom: 3px;  
      letter-spacing: 1.1px;  
      text-shadow: 0 0 7px #FFD36977;  
    }  
    .error {  
      background: #ffeaea !important;  
      color: #c00 !important;  
      border-color: #ff6b6b;  
    }  
    .success {  
      background: #e7ffea !important;  
      color: #049c3f !important;  
      border-color: #22c55e;  
    }  
    .footer {  
      margin-top: 16px;  
      font-size: .99rem;  
      color: #94a3b8;  
      opacity: 0.9;  
      font-weight: 500;  
      text-align: center;  
    }  
    @media (max-width: 600px) {  
      .center-box {  
        padding: 8px 1vw 8px 1vw;  
        border-radius: 14px;  
        max-width: 97vw;  
      }  
      h2 { font-size: 1.1rem; }  
      .subtitle { font-size: .93rem; }  
      .footer { font-size: .83rem; }  
      input, button { font-size: .93rem; }  
      .form-row { margin-bottom: 9px; }  
      .gold-name { font-size: .97rem; }  
      .message { font-size: .93rem; }  
      label { font-size: .91rem; }  
    }  
  </style>  
</head>
<body>
  <div class="bg-glass" aria-hidden="true"></div>
  <div class="center-box">
    <h2 id="form-title">تسجيل الدخول إلى Am Rewards</h2>
    <div class="subtitle">انضم وابدأ رحلتك للربح بسهولة وأمان</div>
    <span class="gold-name">Am Rewards</span>
    <div id="msg" class="message" style="display:none;">
      <span class="site-name">Am Rewards</span>
      <span id="msg-text"></span>
    </div>
    
    <form id="login-form" class="form-view" autocomplete="on">
      <div class="form-row">
        <label for="login-email">البريد الإلكتروني</label>
        <input type="email" id="login-email" placeholder="example@mail.com" autocomplete="username" required />
      </div>
      <div class="form-row">
        <label for="login-password">كلمة المرور</label>
        <input type="password" id="login-password" placeholder="كلمة المرور" autocomplete="current-password" required />
        <button type="button" class="password-eye" onclick="togglePassword('login-password', this)" tabindex="-1" aria-label="عرض كلمة المرور">
          <svg class="eye-open" viewBox="0 0 24 24" fill="none"><path d="M1.5 12C3.5 7 8 3.5 12 3.5C16 3.5 20.5 7 22.5 12C20.5 17 16 20.5 12 20.5C8 20.5 3.5 17 1.5 12Z" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="2"/></svg>
          <svg class="eye-closed" viewBox="0 0 24 24" fill="none" style="display:none;"><path d="M2.93 2.93L21.07 21.07M22.5 12C20.5 17 16 20.5 12 20.5C10.6364 20.5 9.3242 20.2443 8.08 19.75M1.5 12C3.5 7 8 3.5 12 3.5C13.3636 3.5 14.6758 3.7557 15.92 4.25M17.169 7.765C16.3263 7.0253 15.2289 6.5 14 6.5C11.5147 6.5 9.5 8.51472 9.5 11C9.5 12.1648 9.94054 13.238 10.669 14.075" stroke="currentColor" stroke-width="2"/></svg>
        </button>
      </div>
      <button class="login-btn" id="login-btn" type="button" onclick="login()">تسجيل الدخول</button>
    </form>
    
    <a href="signup.html" class="switcher" type="button" style="text-decoration: none; display: block; text-align: center; width: 100%; margin-top: 0;">أو أنشئ حساب جديد</a>

    <div class="footer">© 2025 Am Rewards • كل الحقوق محفوظة</div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      serverTimestamp, // تم استيراد دالة serverTimestamp
      updateDoc // تم استيراد دالة updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // **1. إعدادات Firebase**
    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // **2. جلب عناصر DOM**
    const msgEl = document.getElementById("msg");
    const msgTextEl = document.getElementById("msg-text");
    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");
    const loginBtn = document.getElementById("login-btn");
    
    // **3. الدوال المساعدة**
    function showMessage(text, type="success") {
      msgTextEl.textContent = text;
      msgEl.className = "message " + type;
      msgEl.style.display = text ? "block" : "none";
      clearTimeout(window._msgTimeout);
      if (text) {
        window._msgTimeout = setTimeout(() => {
          if(type !== "error") msgEl.style.display = "none";
        }, type === "error" ? 10000 : 3000);
      }
    }

    function translateError(code) {
      switch(code) {
        case "auth/invalid-email": return "البريد الإلكتروني غير صالح";
        case "auth/user-not-found":
        case "auth/wrong-password":
          return "البريد الإلكتروني أو كلمة المرور غير صحيحة";
        case "auth/too-many-requests": return "تم حظر المحاولة مؤقتًا بسبب عدة محاولات خاطئة، انتظر قليلًا";
        default: return "حدث خطأ، حاول مرة أخرى أو تحقق من بياناتك.";
      }
    }

    /**
     * **[جديد]** دالة لتحديث حقل lastLogin في وثيقة المستخدم.
     */
    async function updateLastLogin(uid) {
        try {
            const userRef = doc(db, "users", uid);
            // استخدام updateDoc لتجنب إعادة كتابة الوثيقة بالكامل
            await updateDoc(userRef, {
                lastLogin: serverTimestamp()
            });
            console.log(`lastLogin updated for user: ${uid}`);
        } catch (error) {
            console.error("Failed to update lastLogin, check Firestore rules:", error);
            // إذا فشل التحديث (ربما بسبب مشاكل في قواعد الأمان)، لا نمنع المستخدم من الدخول.
        }
    }
    
    // **4. دالة تسجيل الدخول**
    window.login = async function () {
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      
      if (!email || !password) return showMessage("يرجى إدخال البريد وكلمة المرور", "error");
      
      loginBtn.textContent = "جاري الدخول...";
      loginBtn.disabled = true;
      
      // منطق المشرف (Admin)
      const ADMIN_EMAIL = "admin@am-rewards.com";
      const ADMIN_PASSWORD = "Admin@2025"; 
      const ADMIN_PAGE = "admin.html"; 
      
      if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
          showMessage("✅ تم تسجيل الدخول كمشرف بنجاح!", "success");
          sessionStorage.setItem('isAdmin', 'true');
          setTimeout(()=> window.location.href = ADMIN_PAGE, 1200);
          return; 
      }
      // نهاية منطق المشرف

      try {
        await setPersistence(auth, browserLocalPersistence);
        const result = await signInWithEmailAndPassword(auth, email, password);
        const uid = result.user.uid;
        
        // **[تعديل 1: تحديث حقل lastLogin]**
        // تنفيذ التحديث فور نجاح المصادقة
        await updateLastLogin(uid); 
        
        // **[تعديل 2: تحديث حقول أخرى (مثل الإيميل والـ UID) في حال كانت الوثيقة جديدة]**
        // نستخدم setDoc مع merge: true هنا للتأكد من وجود الوثيقة والبيانات الأساسية.
        const userRef = doc(db, "users", uid);
        await setDoc(userRef, {
            uid: uid,
            email: email,
            // لا نحتاج لـ lastLogin هنا، فقد تم تحديثه بالفعل في الدالة السابقة، 
            // لكن setDoc مع merge: true مفيد لضمان وجود حقول أخرى مثل createdAt إذا كانت أول عملية تسجيل دخول.
        }, { merge: true });
        
        showMessage("✅ تم تسجيل الدخول بنجاح!", "success");
        setTimeout(()=> window.location.href = "dashboard.html", 1200);
      } catch (error) {
        loginBtn.textContent = "تسجيل الدخول";
        loginBtn.disabled = false;
        showMessage(translateError(error.code), "error");
      }
    };

    // **5. دالة إظهار/إخفاء كلمة المرور**
    window.togglePassword = function(id, btn) {
      const input = document.getElementById(id);
      const openIcon = btn.querySelector('.eye-open');
      const closedIcon = btn.querySelector('.eye-closed');

      if (input.type === "password") {
        input.type = "text";
        openIcon.style.display = "none";
        closedIcon.style.display = "block";
      } else {
        input.type = "password";
        openIcon.style.display = "block";
        closedIcon.style.display = "none";
      }
    }
  </script>
</body>
  </html>
