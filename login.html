<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Cairo",sans-serif;
  min-height:100vh;
  background:radial-gradient(circle at top,#020617,#000);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#f8fafc;
}
.center-box{
  width:100%;
  max-width:420px;
  background:#020617;
  border:1px solid rgba(56,189,248,.35);
  border-radius:26px;
  padding:38px 26px;
  text-align:center;
  box-shadow:0 0 40px rgba(56,189,248,.08);
}
h2{
  color:#38bdf8;
  margin-bottom:6px;
  font-weight:900;
}
.gold-name{
  background:linear-gradient(90deg,#FFD369,#c9a93b);
  color:#3b2f00;
  padding:10px 22px;
  border-radius:14px;
  font-weight:900;
  margin-bottom:28px;
  display:inline-block;
}
.form-row{text-align:right;margin-bottom:18px}
label{
  display:block;
  margin-bottom:6px;
  font-weight:700;
  color:#cbd5f5;
}
.input-group{position:relative}
input{
  width:100%;
  padding:14px 46px 14px 14px;
  border-radius:14px;
  border:2px solid #334155;
  background:#020617;
  color:#fff;
  font-size:1rem;
  outline:none;
}
input:focus{border-color:#38bdf8}
.password-toggle{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  background:none;
  border:none;
  cursor:pointer;
  font-size:1.1rem;
  color:#38bdf8;
}
.login-btn{
  width:100%;
  padding:14px;
  border-radius:16px;
  border:none;
  font-size:1.1rem;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(90deg,#FFD369,#bfa243);
  color:#2e2300;
  transition:.2s;
}
.login-btn:disabled{
  opacity:.6;
  cursor:not-allowed;
}
.spinner{
  width:18px;
  height:18px;
  border:3px solid rgba(255,255,255,.3);
  border-top-color:#fff;
  border-radius:50%;
  display:inline-block;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.message{
  display:none;
  padding:12px;
  border-radius:12px;
  font-weight:800;
  margin-bottom:16px;
}
.message.error{background:#ffeaea;color:#b00000}
.message.success{background:#e7ffea;color:#047857}
.register-link{
  margin-top:20px;
  font-size:.95rem;
  color:#cbd5f5;
}
.register-link a{
  color:#38bdf8;
  font-weight:900;
  text-decoration:none;
  margin-right:6px;
}
</style>
</head>

<body>

<div class="center-box">
  <h2>Am Rewards</h2>
  <div class="gold-name">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>

  <div id="msg" class="message"></div>

  <form id="login-form">
    <div class="form-row">
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="login-email" required />
    </div>

    <div class="form-row">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <div class="input-group">
        <input type="password" id="login-password" required />
        <button type="button" class="password-toggle" id="toggle">ğŸ‘</button>
      </div>
    </div>

    <button type="submit" class="login-btn" id="btn-login">
      ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    </button>
  </form>

  <div class="register-link">
    Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ
    <a href="signup.html">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// ---------------- Firebase Config ----------------
const firebaseConfig = {
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain: "am--rewards.firebaseapp.com",
  projectId: "am--rewards"
};
initializeApp(firebaseConfig);
const auth = getAuth();

// ---------------- Elements ----------------
const form = document.getElementById("login-form");
const btn = document.getElementById("btn-login");
const pass = document.getElementById("login-password");
const msg = document.getElementById("msg");
const toggle = document.getElementById("toggle");

// ---------------- Toggle Password ----------------
toggle.onclick = () => {
  pass.type = pass.type === "password" ? "text" : "password";
};

// ---------------- Device ID ----------------
function getDeviceId(){
  let id = localStorage.getItem("deviceId");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("deviceId", id);
  }
  return id;
}

// ---------------- Login ----------------
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';
  msg.style.display = "none";
  confirmBtn.style.display = "none";

  const email = document.getElementById("login-email").value.trim();
  const password = pass.value;
  const deviceId = getDeviceId();

  try {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const idToken = await cred.user.getIdToken(true);

    const res = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idToken, deviceId })
    });

    const data = await res.json();

    if (data.requireConfirmation) {
      showMessage(data.message, "error");
      confirmBtn.style.display = "block";

      confirmBtn.onclick = async () => {
        confirmBtn.disabled = true;
        confirmBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯...";
        try {
          const confirmRes = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken, deviceId, confirmNewDevice: true })
          });

          const confirmData = await confirmRes.json();

          if (confirmData.success) {
            showMessage("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­", "success");
            setTimeout(() => location.href = "dashboard.html", 1000);
          } else {
            throw new Error(confirmData.message || "ÙØ´Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø²");
          }

        } catch (err) {
          showMessage("âŒ " + err.message, "error");
          confirmBtn.disabled = false;
          confirmBtn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯";
          btn.disabled = false;
          btn.innerHTML = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        }
      };

      // Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ±Ø¬Ø¹ Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ù…Ø¹ Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
      btn.disabled = false;
      btn.innerHTML = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      return;
    }

    if (!res.ok) throw new Error(data.message || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    showMessage("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­", "success");

    setTimeout(() => {
      btn.disabled = false;
      btn.innerHTML = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      location.href = "dashboard.html";
    }, 1000);

  } catch (err) {
    showMessage("âŒ " + err.message, "error");
    btn.disabled = false;
    btn.innerHTML = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
  }
});

// ---------------- Message ----------------
function showMessage(text,type){
  msg.textContent = text;
  msg.className = "message " + type;
  msg.style.display = "block";
}
</script>

</body>
      </html>
