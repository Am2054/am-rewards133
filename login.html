<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">

<style>
:root {
  --main-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 60%, #38bdf8 100%);
  --dark-box-bg: rgba(2,6,23,0.95);
  --glass-border: rgba(56,189,248,0.18);
  --input-bg: rgba(30,41,59,0.9);
  --input-border: #334155;
  --muted: #a5f3fc;
  --radius: 28px;
  --shadow: 0 8px 32px 0 rgba(2,6,23,0.4);
  --gold: #FFD369;
  --gold-dark: #bfa243;
}

* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Cairo", sans-serif;
  background: linear-gradient(rgba(0,0,0,.85), rgba(0,0,0,.9)), var(--main-gradient);
  color: #f1f6fb;
}

.center-box {
  max-width: 420px;
  margin: 70px auto;
  padding: 38px 25px;
  border-radius: var(--radius);
  background: var(--dark-box-bg);
  border: 2px solid var(--glass-border);
  box-shadow: var(--shadow);
  text-align: center;
}

h2 { color: #38bdf8; font-family: "Montserrat"; }

.gold-name {
  background: var(--gold);
  color: var(--gold-dark);
  padding: 10px 20px;
  border-radius: 12px;
  font-weight: 900;
  margin-bottom: 25px;
  display: inline-block;
}

.form-row { text-align: right; margin-bottom: 18px; }
label { display: block; margin-bottom: 8px; color: var(--muted); font-weight: 700; }

.input-group { position: relative; }

input {
  width: 100%;
  padding: 16px 45px 16px 15px;
  border-radius: 15px;
  border: 2px solid var(--input-border);
  background: var(--input-bg);
  color: #fff;
  font-size: 1.05rem;
}

.password-toggle {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #38bdf8;
  cursor: pointer;
  font-size: 1.1rem;
}

.login-btn {
  width: 100%;
  padding: 14px;
  border-radius: 15px;
  border: none;
  font-weight: 900;
  cursor: pointer;
  background: linear-gradient(90deg, #FFD369, #bfa243);
  color: #2e2300;
  font-size: 1.1rem;
}

.login-btn:disabled { opacity: .6; cursor: not-allowed; }

.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,.3);
  border-top-color: #fff;
  border-radius: 50%;
  display: inline-block;
  animation: spin .8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.message {
  display: none;
  padding: 12px;
  margin-bottom: 14px;
  border-radius: 10px;
  font-weight: bold;
}

.message.error { background:#ffeaea; color:#c00; }
.message.success { background:#e7ffea; color:#049c3f; }
.message.info { background:#e6f4ff; color:#075985; }
</style>
</head>

<body>

<div class="center-box">
  <h2>Am Rewards</h2>
  <span class="gold-name">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>

  <div id="msg" class="message"></div>

  <div class="form-row">
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="email" id="login-email">
  </div>

  <div class="form-row">
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <div class="input-group">
      <input type="password" id="login-password">
      <button type="button" class="password-toggle" id="toggle">ğŸ‘</button>
    </div>
  </div>

  <button class="login-btn" id="btn-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

  <a href="signup.html" style="color:var(--muted); margin-top:20px; display:block;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain: "am--rewards.firebaseapp.com",
  projectId: "am--rewards"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const emailInput = document.getElementById("login-email");
const passInput = document.getElementById("login-password");
const btn = document.getElementById("btn-login");
const msg = document.getElementById("msg");
const toggle = document.getElementById("toggle");

/* ===== ØªØ°ÙƒÙ‘Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ ===== */
const savedEmail = localStorage.getItem("rememberEmail");
if (savedEmail) emailInput.value = savedEmail;

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª ===== */
let attempts = Number(localStorage.getItem("loginAttempts")) || 0;
let lockUntil = Number(localStorage.getItem("lockUntil")) || 0;
const MAX_ATTEMPTS = 5;
const LOCK_TIME = 10 * 60 * 1000; // 10 Ø¯Ù‚Ø§Ø¦Ù‚

function resetButton() {
  btn.disabled = false;
  btn.innerHTML = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
}

function showMsg(text, type) {
  msg.textContent = text;
  msg.className = "message " + type;
  msg.style.display = "block";
}

/* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
if (Date.now() < lockUntil) {
  btn.disabled = true;
  showMsg("ğŸš« ØªÙ… ØªØ¹Ø·ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§ØŒ Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ 10 Ø¯Ù‚Ø§Ø¦Ù‚", "error");
} else {
  showMsg(`â„¹ï¸ Ù„Ø¯ÙŠÙƒ ${MAX_ATTEMPTS - attempts} Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„`, "info");
}

toggle.onclick = () => {
  passInput.type = passInput.type === "password" ? "text" : "password";
  toggle.textContent = passInput.type === "password" ? "ğŸ‘" : "ğŸ™ˆ";
};

btn.onclick = async () => {
  if (Date.now() < lockUntil) return;

  const email = emailInput.value.trim();
  const password = passInput.value;

  if (!email || !password) {
    showMsg("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "error");
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';

  try {
    await setPersistence(auth, browserLocalPersistence);
    const cred = await signInWithEmailAndPassword(auth, email, password);

    const userRef = doc(db, "users", cred.user.uid);
    const snap = await getDoc(userRef);
    if (!snap.exists() || snap.data().isBanned) throw new Error();

    await updateDoc(userRef, { lastLogin: serverTimestamp() });

    /* Ù†Ø¬Ø§Ø­ */
    localStorage.setItem("rememberEmail", email);
    localStorage.removeItem("loginAttempts");
    localStorage.removeItem("lockUntil");

    showMsg("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­", "success");

    setTimeout(() => {
      resetButton();
      location.href = "dashboard.html";
    }, 1000);

  } catch {
    attempts++;
    localStorage.setItem("loginAttempts", attempts);

    if (attempts >= MAX_ATTEMPTS) {
      lockUntil = Date.now() + LOCK_TIME;
      localStorage.setItem("lockUntil", lockUntil);
      showMsg("ğŸš« ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø®Ø§Ø·Ø¦Ø©", "error");
      btn.disabled = true;
    } else {
      showMsg(`âŒ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© (Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts} Ù…Ù† ${MAX_ATTEMPTS})`, "error");
      resetButton();
    }
  }
};
</script>

</body>
  </html>
