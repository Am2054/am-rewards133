<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">

<style>
:root {
  --main-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 60%, #38bdf8 100%);
  --dark-box-bg: rgba(2,6,23,0.95);
  --glass-border: rgba(56,189,248,0.18);
  --input-bg: rgba(30,41,59,0.9);
  --input-focus: #38bdf8;
  --input-border: #334155;
  --muted: #a5f3fc;
  --radius: 28px;
  --shadow: 0 8px 32px 0 rgba(2,6,23,0.4);
  --gold: #FFD369;
  --gold-dark: #bfa243;
}

* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Cairo", sans-serif;
  background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.9)), var(--main-gradient);
  color: #f1f6fb;
}

.center-box {
  max-width: 420px;
  margin: 70px auto;
  padding: 38px 25px;
  border-radius: var(--radius);
  background: var(--dark-box-bg);
  border: 2px solid var(--glass-border);
  box-shadow: var(--shadow);
  text-align: center;
}

h2 { color: #38bdf8; font-family: "Montserrat"; margin-bottom: 6px; }
.gold-name {
  background: var(--gold);
  color: var(--gold-dark);
  padding: 10px 20px;
  border-radius: 12px;
  font-weight: 900;
  margin-bottom: 25px;
  display: inline-block;
}

.form-row { text-align: right; margin-bottom: 18px; }
label { display: block; margin-bottom: 8px; color: var(--muted); font-weight: 700; }
input {
  width: 100%;
  padding: 16px 15px 16px 45px;
  border-radius: 15px;
  border: 2px solid var(--input-border);
  background: var(--input-bg);
  color: #fff;
  font-size: 1.1rem;
  outline: none;
}
.input-group { position: relative; }
.password-toggle {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #38bdf8;
  cursor: pointer;
  font-size: 1.1rem;
}

.login-btn {
  width: 100%;
  padding: 14px;
  border-radius: 15px;
  border: none;
  font-weight: 900;
  cursor: pointer;
  background: linear-gradient(90deg, #FFD369, #bfa243);
  color: #2e2300;
  font-size: 1.1rem;
}
.login-btn:disabled { opacity: .6; cursor: not-allowed; }

.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,.3);
  border-top-color: #fff;
  border-radius: 50%;
  display: inline-block;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.message {
  display: none;
  padding: 12px;
  margin-bottom: 14px;
  border-radius: 10px;
  font-weight: bold;
}
.message.error { background:#ffeaea; color:#c00; }
.message.success { background:#e7ffea; color:#049c3f; }

/* Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(6px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.modal-overlay.open { display: flex; }
.modal-content {
  background: var(--dark-box-bg);
  padding: 30px;
  border-radius: var(--radius);
  max-width: 400px;
  text-align: center;
  border: 2px solid var(--glass-border);
}
.modal-content h3 { color: #38bdf8; margin-bottom: 20px; }
.modal-content button {
  margin: 5px;
  padding: 12px 25px;
  border: none;
  border-radius: 15px;
  cursor: pointer;
  font-weight: 700;
}
.modal-content .confirm { background: #4ade80; color:#022; }
.modal-content .cancel { background: #ff6b6b; color:#fff; }
</style>
</head>

<body>
<div class="center-box">
  <h2>Am Rewards</h2>
  <span class="gold-name">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>

  <div id="msg" class="message"></div>

  <form id="login-form">
    <div class="form-row">
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="login-email" required />
    </div>

    <div class="form-row">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <div class="input-group">
        <input type="password" id="login-password" required />
        <button type="button" class="password-toggle" id="toggle">ğŸ‘</button>
      </div>
    </div>

    <button type="submit" class="login-btn" id="btn-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </form>

  <a href="signup.html" style="color:var(--muted); margin-top:20px; display:block;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<div id="deviceModal" class="modal-overlay">
  <div class="modal-content">
    <h3>ğŸ“± Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯</h3>
    <p>ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¬Ù‡Ø§Ø² Ù„Ù… ØªÙØ³Ø¬Ù‘ÙÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù…Ù† Ù‚Ø¨Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ</p>
    <button class="confirm" id="confirm-device">Ù†Ø¹Ù…</button>
    <button class="cancel" id="cancel-device">Ù„Ø§</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain: "am--rewards.firebaseapp.com",
  projectId: "am--rewards"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const msg = document.getElementById("msg");
const btn = document.getElementById("btn-login");
const pass = document.getElementById("login-password");

let loginAttempts = 0;
let pendingDevice = null;
let pendingUserRef = null;

function getDeviceId() {
  let id = localStorage.getItem("deviceId");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("deviceId", id);
  }
  return id;
}

document.getElementById("toggle").onclick = () => {
  pass.type = pass.type === "password" ? "text" : "password";
  document.getElementById("toggle").textContent = pass.type === "password" ? "ğŸ‘" : "ğŸ™ˆ";
};

const deviceModal = document.getElementById("deviceModal");
const confirmBtn = document.getElementById("confirm-device");
const cancelBtn = document.getElementById("cancel-device");

confirmBtn.onclick = async () => {
  if(pendingUserRef && pendingDevice){
    await updateDoc(pendingUserRef, {
      devices: arrayUnion(pendingDevice)
    });
    deviceModal.classList.remove("open");
    msg.textContent = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­";
    msg.className = "message success";
    msg.style.display = "block";
    setTimeout(() => location.href = "dashboard.html", 1000);
  }
};

cancelBtn.onclick = () => {
  deviceModal.classList.remove("open");
  msg.textContent = "ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²";
  msg.className = "message error";
  msg.style.display = "block";
  btn.disabled = false;
  btn.innerHTML = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
};

document.getElementById("login-form").onsubmit = async (e) => {
  e.preventDefault();
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
  msg.style.display = "none";

  const email = document.getElementById("login-email").value.trim();
  const password = pass.value;
  const deviceId = getDeviceId();

  try {
    await setPersistence(auth, browserLocalPersistence);
    const cred = await signInWithEmailAndPassword(auth, email, password);

    const userRef = doc(db, "users", cred.user.uid);
    const userSnap = await getDoc(userRef);

    if(!userSnap.exists()) throw new Error("USER_NOT_FOUND");
    const userData = userSnap.data();

    if(userData.isBanned) throw new Error("BANNED");

    if(!cred.user.emailVerified) throw new Error("EMAIL_NOT_VERIFIED");

    // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„ ÙˆØ³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
    await updateDoc(userRef, {
      lastLogin: serverTimestamp(),
      loginHistory: arrayUnion({timestamp: serverTimestamp(), deviceId, status: "success"})
    });

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
    if(userData.devices && !userData.devices.includes(deviceId)){
      // Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ â†’ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      pendingDevice = deviceId;
      pendingUserRef = userRef;
      deviceModal.classList.add("open");
      return;
    }

    msg.textContent = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
    msg.className = "message success";
    msg.style.display = "block";
    setTimeout(() => location.href = "dashboard.html", 1000);

  } catch (err) {
    loginAttempts++;
    let text = `âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© (${loginAttempts} Ù…Ø­Ø§ÙˆÙ„Ø©)`;
    if(err.message === "BANNED") text = "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚ÙˆÙ";
    else if(err.message === "EMAIL_NOT_VERIFIED") text = "âœ‰ï¸ ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ";

    msg.textContent = text;
    msg.className = "message error";
    msg.style.display = "block";

    btn.disabled = loginAttempts >= 5;
    btn.innerHTML = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
  }
};
</script>
</body>
  </html>
