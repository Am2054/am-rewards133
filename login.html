<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Am Rewards</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:"Cairo",sans-serif;min-height:100vh;
  background:linear-gradient(135deg,#0b0f27,#020617);
  display:flex;align-items:center;justify-content:center;color:#f8fafc
}
.center-box{
  width:100%;max-width:420px;background:#0f172a;
  border:1px solid rgba(56,189,248,.35);
  border-radius:28px;padding:40px 30px;
  text-align:center;box-shadow:0 10px 40px rgba(56,189,248,.15)
}
h2{color:#38bdf8;margin-bottom:8px;font-weight:900}
.gold-name{
  background:linear-gradient(90deg,#FFD369,#c9a93b);
  color:#3b2f00;padding:12px 24px;border-radius:16px;
  font-weight:900;margin-bottom:28px;display:inline-block
}
.form-row{text-align:right;margin-bottom:18px}
label{display:block;margin-bottom:6px;font-weight:700;color:#cbd5f5}
.input-group{position:relative}
input{
  width:100%;padding:14px 46px 14px 14px;
  border-radius:16px;border:2px solid #334155;
  background:#020617;color:#fff;font-size:1rem
}
input:focus{border-color:#38bdf8}
.password-toggle{
  position:absolute;left:12px;top:50%;
  transform:translateY(-50%);
  background:none;border:none;cursor:pointer;
  font-size:1.1rem;color:#38bdf8
}
.login-btn{
  width:100%;padding:14px;border-radius:18px;border:none;
  font-size:1.1rem;font-weight:900;cursor:pointer;
  background:linear-gradient(90deg,#FFD369,#bfa243);
  color:#2e2300
}
.login-btn:disabled{opacity:.6;cursor:not-allowed}
.spinner{
  width:18px;height:18px;border:3px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;
  display:inline-block;animation:spin .8s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
.message{
  display:none;padding:12px;border-radius:12px;
  font-weight:800;margin-bottom:16px
}
.message.error{background:#ffeaea;color:#b00000}
.message.success{background:#e7ffea;color:#047857}
</style>
</head>

<body>
<div class="center-box">
  <h2>Am Rewards</h2>
  <div class="gold-name">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>

  <div id="msg" class="message"></div>

  <form id="login-form">
    <div class="form-row">
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="email" required />
    </div>

    <div class="form-row">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <div class="input-group">
        <input type="password" id="password" required />
        <button type="button" class="password-toggle" id="toggle">ğŸ‘</button>
      </div>
    </div>

    <button type="submit" class="login-btn" id="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
  authDomain: "am--rewards.firebaseapp.com",
  projectId: "am--rewards"
};
initializeApp(firebaseConfig);
const auth = getAuth();

/* ---------------- UI ---------------- */
const form = document.getElementById("login-form");
const btn = document.getElementById("btn");
const msg = document.getElementById("msg");
const pass = document.getElementById("password");
const toggle = document.getElementById("toggle");

toggle.onclick = () =>
  pass.type = pass.type === "password" ? "text" : "password";

/* ---------------- Device ID ---------------- */
function deviceId(){
  let id = localStorage.getItem("deviceId");
  if(!id){ id = crypto.randomUUID(); localStorage.setItem("deviceId",id); }
  return id;
}

/* ---------------- Timer ---------------- */
let timerInterval = null;

function startTimer(ms){
  clearInterval(timerInterval);

  const end = Date.now() + ms;
  localStorage.setItem("loginBlockedUntil", end);

  btn.disabled = true;

  timerInterval = setInterval(()=>{
    const diff = end - Date.now();

    if(diff <= 0){
      clearInterval(timerInterval);
      btn.disabled = false;
      btn.textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      localStorage.removeItem("loginBlockedUntil");
      return;
    }

    const m = Math.floor(diff / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    btn.textContent = `â³ Ø§Ù†ØªØ¸Ø± ${m}:${s<10?"0"+s:s}`;
  },1000);
}

/* ---------------- Login ---------------- */
async function login(){
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';
  msg.style.display="none";

  try{
    const email = document.getElementById("email").value.trim();
    const password = pass.value;

    const cred = await signInWithEmailAndPassword(auth,email,password);
    const idToken = await cred.user.getIdToken(true);

    const res = await fetch("/api/login",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ idToken, deviceId:deviceId() })
    });

    const data = await res.json();

    if(res.status === 403 && data.remainingTime){
      show("âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒØ«ÙŠØ±Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ù‹Ø§","error");
      startTimer(data.remainingTime);
      return;
    }

    if(!res.ok) throw data;

    show("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­","success");
    setTimeout(()=>location.href="dashboard.html",1000);

  }catch(err){
    let message = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹";
    if(err.code){
      switch(err.code){
        case "auth/user-not-found": message="âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯";break;
        case "auth/wrong-password": message="âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";break;
        case "auth/invalid-credential": message="âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©";break;
        case "auth/too-many-requests": message="âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©";break;
      }
    }else if(err.message){
      message="âŒ "+err.message;
    }
    show(message,"error");
  }finally{
    if(!btn.disabled){
      btn.textContent="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
    }
  }
}

form.onsubmit = e => { e.preventDefault(); login(); };

/* ---------------- Restore Timer ---------------- */
const saved = localStorage.getItem("loginBlockedUntil");
if(saved){
  const diff = saved - Date.now();
  if(diff > 0) startTimer(diff);
  else localStorage.removeItem("loginBlockedUntil");
}

function show(text,type){
  msg.textContent=text;
  msg.className="message "+type;
  msg.style.display="block";
}
</script>
</body>
</html>
