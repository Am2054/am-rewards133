<!DOCTYPE html>  
<html lang="ar" dir="rtl">    
<head>        
  <meta charset="UTF-8" />      
  <title>تسجيل الدخول - Am Rewards</title>      
  <meta name="viewport" content="width=device-width, initial-scale=1" />      
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">      
  <style>      
    /* --- جميع أكواد CSS الخاصة بك كما هي بدون أي حذف --- */
    :root{        
      --main-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 60%, #38bdf8 100%);        
      --dark-box-bg: rgba(2,6,23,0.95);
      --glass-bg: rgba(255,255,255,0.13);        
      --glass-border: rgba(56,189,248,0.18);        
      --input-bg: rgba(30,41,59,0.9);
      --input-focus: #38bdf8;        
      --input-border: #334155;        
      --error: #f87171;        
      --success: #22c55e;        
      --muted: #a5f3fc;        
      --radius: 28px;        
      --shadow: 0 8px 32px 0 rgba(2,6,23,0.4);
      --gold: #FFD369;        
      --gold-dark: #bfa243;        
    }        
    *{box-sizing:border-box}      
    html, body {        
      height: 100%;        
      margin: 0;        
      padding: 0;        
      font-family: "Cairo", "Montserrat", sans-serif;        
      color: #f1f6fb;        
      direction: rtl;        
      background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), 
                  var(--main-gradient), 
                  url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80');        
      background-size: cover;        
      background-attachment: fixed;        
      background-blend-mode: overlay;        
      overflow-y: auto !important;        
      scroll-behavior: smooth;
    }        
    body { min-height: 100vh; display: block; }        
    .bg-glass { position: fixed; inset: 0; z-index: 0; pointer-events: none; background: radial-gradient(circle at 65% 17%, rgba(56,189,248,0.05) 0%, transparent 90%), radial-gradient(circle at 25% 80%, rgba(34,197,94,0.06) 0%, transparent 80%); filter: blur(28px) saturate(1.1); animation: floatGlass 16s ease-in-out infinite alternate; }        
    @keyframes floatGlass { 0% { background-position: 65% 17%, 25% 80%;} 100% { background-position: 55% 27%, 20% 95%;} }        
    .center-box { width: 100%; max-width: 420px; margin: 56px auto; padding: 38px 18px 30px 18px; border-radius: var(--radius); background: var(--dark-box-bg); box-shadow: var(--shadow), 0 0 10px #0008; border: 2px solid var(--glass-border); z-index: 2; position: relative; backdrop-filter: blur(0px) saturate(100%); display: flex; flex-direction: column; align-items: center; }        
    h2 { margin-bottom: 20px; font-family: "Montserrat", "Cairo", sans-serif; font-size: 1.7rem; font-weight: 900; letter-spacing: 1.1px; text-shadow: 0 0 10px #38bdf8a2; color: #38bdf8; }        
    .subtitle { color: var(--muted); font-size: 1rem; margin-bottom: 19px; font-weight: 700; text-shadow: 0 0 4px #38bdf8a1; letter-spacing: 0.5px; }        
    .gold-name { display: block; background: var(--gold); color: var(--gold-dark); padding: 10px 17px 8px 17px; min-width: 120px; border-radius: 12px; font-size: 1.08rem; font-family: "Montserrat","Cairo",sans-serif; font-weight: 900; margin: 0 auto 18px auto; text-align: center; box-shadow: 0 4px 10px #FFD36944, 0 2px 8px #0002; letter-spacing: 1.1px; border: 2px solid #bfa24333; user-select: none; }        
    .form-view { width: 100%; opacity: 1; transform: scale(1); }        
    .form-row { margin-bottom: 18px; text-align: right; position: relative; }      
    label { font-size: 1.08rem; color: var(--muted); margin-bottom: 6px; display: block; font-weight: 700; }  
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"] { width: 100%; padding: 16px 17px; border-radius: 15px; border: 2px solid var(--input-border); background: var(--input-bg); color: #fff; font-size: 1.11rem; font-family: "Cairo",sans-serif; transition: box-shadow .18s, border-color .18s, transform .12s; outline: none; font-weight: 600; margin-top: 2px; box-sizing: border-box; }  
    input:focus { border-color: var(--input-focus); box-shadow: 0 0 12px #38bdf8a6; background: #1e293b; }  
    .password-eye { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.35em; color: #38bdf8; opacity: 0.82; z-index: 3; transition: color .17s, opacity .14s; padding: 0; margin: 0; line-height: 1; outline: none; display: flex; align-items: center; height: 28px; width: 28px; justify-content: center; }  
    .password-eye svg { width: 23px; height: 23px; display: block; }  
    button { width: 100%; padding: 14px 0; border-radius: 15px; font-size: 1.07rem; font-weight: 900; font-family: "Montserrat","Cairo",sans-serif; letter-spacing: 0.7px; cursor: pointer; border: none; transition: .17s; margin-bottom: 14px; box-shadow: 0 3px 18px rgba(56,189,248,0.10); }  
    .login-btn { background: linear-gradient(90deg,#FFD369 0%,#bfa243 100%); color: #2e2300; font-weight: 900; letter-spacing: 1.2px; border: 2px solid #bfa24366; }  
    .login-btn:hover { background: linear-gradient(90deg,#bfa243 0%,#FFD369 100%); color: #fff; }  
    .login-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .switcher { background: none; border: none; color: var(--muted); font-size: 1rem; margin-bottom: 2px; text-decoration: underline; cursor: pointer; transition: color .13s; font-weight: 700; }  
    .switcher:hover { color: #38bdf8; }  
    .message { min-height: 36px; padding: 12px 0 7px 0; margin-bottom: 13px; border-radius: 11px; font-size: 1.05rem; font-weight: bold; box-shadow: 0 2px 12px #0002; transition: .14s; background: #fff; color: #2e2300; text-shadow: none; border: 2px solid #FFD369; opacity: 1; display: block; text-align: center; position: relative; }
    .message .site-name { display: block; font-family: "Montserrat","Cairo",sans-serif; font-size: 1.13em; font-weight: 900; color: var(--gold); margin-bottom: 3px; letter-spacing: 1.1px; text-shadow: 0 0 7px #FFD36977; }
    .error { background: #ffeaea !important; color: #c00 !important; border-color: #ff6b6b; }
    .success { background: #e7ffea !important; color: #049c3f !important; border-color: #22c55e; }
    .footer { margin-top: 16px; font-size: .99rem; color: #94a3b8; opacity: 0.9; font-weight: 500; text-align: center; }
  </style>        
</head>      
<body>      
  <div class="bg-glass" aria-hidden="true"></div>      
  <div class="center-box">      
    <h2 id="form-title">تسجيل الدخول إلى Am Rewards</h2>      
    <div class="subtitle">انضم وابدأ رحلتك للربح بسهولة وأمان</div>      
    <span class="gold-name">Am Rewards</span>      
    <div id="msg" class="message" style="display:none;">      
      <span class="site-name">Am Rewards</span>      
      <span id="msg-text"></span>      
    </div>  
    <form id="login-form" class="form-view" autocomplete="on">      
      <div class="form-row">      
        <label for="login-email">البريد الإلكتروني</label>      
        <input type="email" id="login-email" placeholder="example@mail.com" autocomplete="username" required />      
      </div>      
      <div class="form-row">      
        <label for="login-password">كلمة المرور</label>      
        <input type="password" id="login-password" placeholder="كلمة المرور" autocomplete="current-password" required />      
        <button type="button" class="password-eye" id="password-toggle-btn" tabindex="-1" aria-label="عرض كلمة المرور">      
          <svg class="eye-open" viewBox="0 0 24 24" fill="none"><path d="M1.5 12C3.5 7 8 3.5 12 3.5C16 3.5 20.5 7 22.5 12C20.5 17 16 20.5 12 20.5C8 20.5 3.5 17 1.5 12Z" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="2"/></svg>      
          <svg class="eye-closed" viewBox="0 0 24 24" fill="none" style="display:none;"><path d="M2.93 2.93L21.07 21.07M22.5 12C20.5 17 16 20.5 12 20.5C10.6364 20.5 9.3242 20.2443 8.08 19.75M1.5 12C3.5 7 8 3.5 12 3.5C13.3636 3.5 14.6758 3.7557 15.92 4.25M17.169 7.765C16.3263 7.0253 15.2289 6.5 14 6.5C11.5147 6.5 9.5 8.51472 9.5 11C9.5 12.1648 9.94054 13.238 10.669 14.075" stroke="currentColor" stroke-width="2"/></svg>      
        </button>      
      </div>      
      <button class="login-btn" id="login-btn" type="submit">تسجيل الدخول</button>      
    </form>    
    <a href="signup.html" class="switcher" type="button" style="text-decoration: none; display: block; text-align: center; width: 100%; margin-top: 0;">أو أنشئ حساب جديد</a>  
    <div class="footer">© 2025 Am Rewards • كل الحقوق محفوظة</div>    
  </div>    

  <script type="module">      
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";      
    import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";      
    import { getFirestore, doc, setDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";    
    
    const firebaseConfig = {      
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",      
      authDomain: "am--rewards.firebaseapp.com",      
      projectId: "am--rewards",      
    };      
    const app = initializeApp(firebaseConfig);      
    const auth = getAuth(app);      
    const db = getFirestore(app);      
    
    const loginForm = document.getElementById("login-form"); 
    const msgEl = document.getElementById("msg");
    const msgTextEl = document.getElementById("msg-text");
    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");
    const loginBtn = document.getElementById("login-btn");
    const passwordToggleBtn = document.getElementById("password-toggle-btn");

    const ADMIN_PAGE = "admin.html";
    const USER_PAGE = "dashboard.html"; 

    function showMessage(text, type="success") {
      msgTextEl.textContent = text;
      msgEl.className = "message " + type;
      msgEl.style.display = text ? "block" : "none";
      clearTimeout(window._msgTimeout);
      if (text) {
        window._msgTimeout = setTimeout(() => {
          if(type !== "error") msgEl.style.display = "none";
        }, type === "error" ? 10000 : 3000);
      }
    }

    function translateError(code) {
      switch(code) {
        case "auth/invalid-email": return "البريد الإلكتروني غير صالح";
        case "auth/user-not-found":
        case "auth/wrong-password":
        case "auth/invalid-credential": return "البريد الإلكتروني أو كلمة المرور غير صحيحة";
        case "auth/too-many-requests": return "تم حظر المحاولة مؤقتًا، انتظر قليلًا";
        case "USER_NOT_INITIALIZED": return "الحساب غير مكتمل، تواصل مع الدعم";
        default: return "حدث خطأ، تحقق من اتصالك أو بياناتك.";
      }
    }
    
    async function updateLastLogin(uid, email) {
      try {
        const userRef = doc(db, "users", uid);
        await setDoc(userRef, {
            uid: uid,      
            email: email,
            lastLogin: serverTimestamp()
        }, { merge: true });
      } catch (error) {
        console.error("Firestore update failed:", error);
      }
    }

        async function login(event) {
      if (event) event.preventDefault(); 
      
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();

      if (!email || !password) return showMessage("يرجى إدخال البريد وكلمة المرور", "error");

      loginBtn.textContent = "⏳ جاري التحقق...";
      loginBtn.disabled = true;

      try {
        await setPersistence(auth, browserLocalPersistence);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const uid = user.uid;

        const userDoc = await getDoc(doc(db, "users", uid));
        const adminRef = doc(db, "admins", email);
        const adminSnap = await getDoc(adminRef);

        if (!userDoc.exists() && !adminSnap.exists()) {
            throw new Error("USER_NOT_INITIALIZED");
        }
        
        await updateLastLogin(uid, email); 

        // التعديل هنا: إعادة الزر لحالته الأصلية فور النجاح وقبل التوجيه
        loginBtn.textContent = "تسجيل الدخول";
        loginBtn.disabled = false;

        if (adminSnap.exists() && adminSnap.data().active === true) {
          sessionStorage.setItem("isAdmin", "true");
          showMessage("✅ تم تسجيل الدخول كمشرف!", "success");
          setTimeout(() => window.location.href = ADMIN_PAGE, 1200);
        } else {
          sessionStorage.setItem("isAdmin", "false");
          showMessage("✅ تم تسجيل الدخول بنجاح!", "success");
          setTimeout(() => window.location.href = USER_PAGE, 1200);
        }

      } catch (error) {
        // العودة لحالة الزر الأصلية في حالة الخطأ أيضاً
        loginBtn.textContent = "تسجيل الدخول";
        loginBtn.disabled = false;
        
        showMessage(translateError(error.code || error.message), "error");
        sessionStorage.removeItem("isAdmin"); 
      }
    }

    }
    
    function togglePassword() {
      const input = document.getElementById("login-password");
      const openIcon = passwordToggleBtn.querySelector('.eye-open');
      const closedIcon = passwordToggleBtn.querySelector('.eye-closed');

      if (input.type === "password") {
        input.type = "text";
        openIcon.style.display = "none";
        closedIcon.style.display = "block";
      } else {
        input.type = "password";
        openIcon.style.display = "block";
        closedIcon.style.display = "none";
      }
    }

    loginForm.addEventListener("submit", login); 
    passwordToggleBtn.addEventListener("click", togglePassword);
  </script>  
</body>
</html>
